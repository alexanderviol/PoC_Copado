"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function GanttService(e,t){if(!t){this.sfdcType="service",this.fields={};for(var i in e.Fields)this.fields[i]=e.Fields[i];this.id=e.Fields.Id||null,this.name=e.Fields.AppointmentNumber||null,this.AssignedResourceLastModifiedDate=e.AssignedResourceLastModifiedDate||null,this.ServiceAppointmentLastModifiedDate=e.ServiceAppointmentLastModifiedDate||null,this.accountName=e.Fields["Account.Name"]||null,this.accountId=e.Fields.AccountId||null,this.latitude=e.Fields.Latitude||null,this.longitude=e.Fields.Longitude||null,this.arrivalWindowEndTime=e.Fields.ArrivalWindowEndTime||null,this.arrivalWindowStartTime=e.Fields.ArrivalWindowStartTime||null,this.dueDate=e.Fields.DueDate||null,this.ganttDisplay=e.Fields.Gantt_Display_Date__c||null,this.durationType=e.Fields.DurationType||null,this.earliestStartTime=e.Fields.EarliestStartTime||null,this.estDuration=e.Fields.Duration||null,this.travelTimeFrom=e.Fields.EstimatedTravelTimeFrom__c||null,this.travelTimeTo=e.Fields.EstimatedTravelTime||null,this.ganttLabel=e.Fields.GanttLabel__c||null,this.jeopardy=e.Fields.InJeopardy__c||null,this.jeopardyReason=e.Fields.InJeopardyReason__c||null,this.parentRecord=e.Fields.ParentRecordId||null,this.parentRecordStatus=e.Fields.ParentRecordStatusCategory||null,this.parentRecordType=e.Fields.ParentRecordType||null,this.pinned=e.Fields.Pinned__c||!1,this.schedEndTime=e.Fields.SchedEndTime||null,this.schedStartTime=e.Fields.SchedStartTime||null,this.serviceTerritory=e.Fields.ServiceTerritory||null,this.serviceTerritoryName=e.Fields["ServiceTerritory.Name"]||null,this.status=e.Fields.Status||null,this.statusCategory=e.Fields.StatusCategory||null,this.subject=e.Fields.Subject||null,this.ganttColor=e.Fields.GanttColor__c||null,this.resource=e.Resource||null,this.resourceName=e.ResourceName||null,this.resourceContractor=e.ResourceContractor||null,this.isAssignToCrew=e.IsAssignToCrew||null,this.assignedResource=e.AssignedResource||null,this.violations=null,this.relatedTo=e.relatedTo||null,this.relatedFather=null,this.priority=this.minPriority,this.relatedFather=e.relatedFather,this.policyUsed=e.Fields.Scheduling_Policy_Used__c||null,this.scheduleMode=e.Fields.Schedule_Mode__c||null,this.emergency=e.Fields.Emergency__c||!1,this.isServiceInChain=usingNewMstModel&&e.isServiceInChain,this.relatedService2=e.relatedService2||null,this.relatedService1=e.relatedService1||null,this.ganttPaletteColor=null,this.Use_Async_Logic=e.Fields.Use_Async_Logic__c||!1;var n="WorkOrder"==e.Fields.ParentRecordType?CustomSettings.woPriorityField:CustomSettings.woliPriorityField;n&&e.ParentFields&&e.ParentFields[n]&&(this.priority=e.ParentFields[n]);var r=fslNamespace?mdtBooleanField.replace(fslNamespace+"__",""):mdtBooleanField;this.isMDT=e.Fields[r]?!0:!1,e.Fields.MDT_Operational_Time__c?this.calculateMdtTimes(e.Fields.MDT_Operational_Time__c):this.isMDT&&(this.mdtTimes={travel:[],working:[]}),this.parentFields={};for(var s in e.ParentFields)this.parentFields[s]=e.ParentFields[s];this.setSchedulerProperties(),addFieldSetToServiceObject(GanttService.prototype.allFieldSetsSet,e.Fields,this),this.isMDT&&(this.travelTimeFrom=0,this.travelTimeTo=0)}}function getGanttResourceWithSecondaryStms(e){if(showSecondarySTMs){var t=e.resourceId.split(",");if(e.resourceBeforeDrag&&e.resourceBeforeDrag!=e.resourceId&&t.length>1)for(var i=0;i<t.length;i++)if(e.resourceBeforeDrag.split(",")[i]!=t[i]){e.resourceId=t[i];break}}}function addFieldSetToServiceObject(e,t,i){for(var n in e){var r=null;if(r=t[e[n].APIName],r||0==r){switch(e[n].Type){case"DATE":case"DATETIME":var s=60*new Date(r).getTimezoneOffset()*1e3;r=new Date(r+s),i.fields[e[n].APIName]=r.getTime();break;case"REFERENCE":var a=e[n].JsAPIName.replace("__r","__c");i[a]=t[a]}i[e[n].APIName]=r}}}function LastKnownPosition(e){this.id=e.Id,this.latitude=e[fieldNames.ServiceResource.LastKnownLocation__Latitude__s],this.longitude=e[fieldNames.ServiceResource.LastKnownLocation__Longitude__s],this.lastModifiedDate=e[fieldNames.ServiceResource.LastKnownLocationUpdate__c];var t=void 0;this.lastModifiedDate&&(t=60*new Date(this.lastModifiedDate).getTimezoneOffset()*1e3),this.lastModifiedDate=this.lastModifiedDate?new Date(this.lastModifiedDate+t):null}function OptimizationRequest(e){if(this.id=e.Id,this.lastModifiedDate=e.LastModifiedDate,this.name=e.Name,this.scheduledAmount=e[fieldNames.Optimization_Request.Objects_Scheduled__c],this.objectToScheduled=e[fieldNames.Optimization_Request.Objects_To_Schedule__c],this.status=e[fieldNames.Optimization_Request.Status__c]||null,this.statusLabel=e.statusLabel||e[fieldNames.Optimization_Request.Status__c]||null,this.allTasks=e[fieldNames.Optimization_Request.All_Tasks_Mode__c]||null,this.includeEmptyLocations=e[fieldNames.Optimization_Request.Include_Services_With_Empty_Location__c]||null,this.type=e[fieldNames.Optimization_Request.Type__c]||null,this.failureReason=e[fieldNames.Optimization_Request.Failure_Reason__c]||null,this.optimizationData=e[fieldNames.Optimization_Request.Optimization_Data__c]||null,this.orgResourceAbsence=e[fieldNames.Optimization_Request.Originating_Resource_Absence__c]||null,this.orgServiceAppointment=e[fieldNames.Optimization_Request.Originating_Service_Appointment__c]||null,this.policy=e[fieldNames.Optimization_Request.Scheduling_Policy__c]||null,this.serviceAppointment=e[fieldNames.Optimization_Request.Service_Appointment__c]||null,this.resource=e[fieldNames.Optimization_Request.Service_Resource__c]||null,this.result=e[fieldNames.Optimization_Request.Result__c]||null,this.timespan=null,this.finish=e[fieldNames.Optimization_Request.Finish__c]?new Date(e[fieldNames.Optimization_Request.Finish__c]):null,this.start=e[fieldNames.Optimization_Request.Start__c]?new Date(e[fieldNames.Optimization_Request.Start__c]):null,this.start){var t=60*new Date(this.start).getTimezoneOffset()*1e3;this.start=new Date(this.start.valueOf()+t)}if(this.finish){var i=60*new Date(this.finish).getTimezoneOffset()*1e3;this.finish=new Date(this.finish.valueOf()+i)}}function ResourceAbsence(e){this.id=e.Id,this.end=e[fieldNames.ResourceAbsence.End],this.resource=e[fieldNames.ResourceAbsence.Resource],this.start=e[fieldNames.ResourceAbsence.Start],this.absenceType=e.TypeLabel||e[fieldNames.ResourceAbsence.Type]||"",this.reason=e.TypeLabel||e[fieldNames.ResourceAbsence.Type]||"",this.ganttLabel=e[fieldNames.ResourceAbsence.GanttLabel__c]||null,this.lastModifiedDate=e.LastModifiedDate||null,this.name=e.AbsenceNumber,this.resourceName=e[fieldNames.ResourceAbsence.Resource__r].Name,this.ganttColor=e[fieldNames.ResourceAbsence.Gantt_Color__c],this.approved=e[fieldNames.ResourceAbsence.Approved__c],this.latitude=e.Latitude,this.longitude=e.Longitude,this.travelTo=e[fieldNames.ResourceAbsence.EstTravelTime__c]?60*e[fieldNames.ResourceAbsence.EstTravelTime__c]:0,this.travelFrom=e[fieldNames.ResourceAbsence.EstTravelTimeFrom__c]?60*e[fieldNames.ResourceAbsence.EstTravelTimeFrom__c]:0,this.sfdcType="absence",e.RecordType&&e.RecordType.DeveloperName&&"Non_Availability"==e.RecordType.DeveloperName?this.type="na":this.type="break",this.setSchedulerProperties()}function ResourceCapacity(e){this.sfdcType="capacity",this.id=e.Id,this.end=e[fieldNames.ResourceCapacity.EndDate],this.resource=e[fieldNames.ResourceCapacity.ServiceResource],this.resourceId=e[fieldNames.ResourceCapacity.ServiceResource],this.resourceName=e[fieldNames.ResourceCapacity.ServiceResource__r]?e[fieldNames.ResourceCapacity.ServiceResource__r].Name:null,this.start=e[fieldNames.ResourceCapacity.StartDate],this.hoursInUse=e[fieldNames.ResourceCapacity.HoursInUse__c],this.hoursPerTimePeriod=e[fieldNames.ResourceCapacity.CapacityInHours]||0,this.minutesUsed=e[fieldNames.ResourceCapacity.MinutesUsed__c],this.lastModifiedDate=e.LastModifiedDate||null,this.name=e.CapacityNumber,this.timePeriod=e[fieldNames.ResourceCapacity.TimePeriod],this.workItemsAllocated=e[fieldNames.ResourceCapacity.Work_Items_Allocated__c],this.workItemsPerTimePeriod=e[fieldNames.ResourceCapacity.CapacityInWorkItems]||0,this.setSchedulerProperties()}function addDaysToDate(e,t){var i=864e5*t;return new Date(e.getTime()+i)}function calcCapacityPercentage(e,t){return parseFloat((e/t*100).toFixed(2))}function ResourcesAndTerritories(e){this.id=e.Id,this.name=e.MemberNumber,this.effectiveEndDate=e[fieldNames.ServiceTerritoryMember.EffectiveEndDate]||null,this.effectiveStartDate=e[fieldNames.ServiceTerritoryMember.EffectiveStartDate],this.latitude=e[fieldNames.ServiceTerritoryMember.Latitude],this.longitude=e[fieldNames.ServiceTerritoryMember.Longitude],this.serviceResource=e[fieldNames.ServiceTerritoryMember.ServiceResource],this.serviceResource__r=e[fieldNames.ServiceTerritoryMember.ServiceResource__r],this.serviceTerritory=e[fieldNames.ServiceTerritoryMember.ServiceTerritory],this.serviceTerritory__r=e[fieldNames.ServiceTerritoryMember.ServiceTerritory__r],this.serviceTerritoryType=e[fieldNames.ServiceTerritoryMember.TerritoryType],this.operatingHours=e[fieldNames.ServiceTerritoryMember.OperatingHours],this.operatingHours__r=e[fieldNames.ServiceTerritoryMember.OperatingHours__r];var t=void 0,i=void 0;this.effectiveStartDate&&(t=60*new Date(this.effectiveStartDate).getTimezoneOffset()*1e3),this.effectiveEndDate&&(i=60*new Date(this.effectiveEndDate).getTimezoneOffset()*1e3),this.effectiveStartDate=this.effectiveStartDate?new Date(this.effectiveStartDate+t):new Date(0),this.effectiveEndDate=this.effectiveEndDate?new Date(this.effectiveEndDate+i):new Date(24e11),this.timezone=e[fieldNames.ServiceTerritoryMember.ServiceTerritory__r][fieldNames.ServiceTerritory.OperatingHours__r][fieldNames.OperatingHours.Timezone]}function ServiceCrewMember(e){this.id=e.Id,this.name=e.Name,this.endDate=e[fieldNames.ServiceCrewMember.EndDate]||null,this.startDate=e[fieldNames.ServiceCrewMember.StartDate],this.serviceResource=e[fieldNames.ServiceCrewMember.ServiceResource],this.serviceResource__r=e[fieldNames.ServiceCrewMember.ServiceResource__r],this.serviceCrew=e[fieldNames.ServiceCrewMember.ServiceCrew],this.serviceCrew__r=e[fieldNames.ServiceCrewMember.ServiceCrew__r],this.leader=e[fieldNames.ServiceCrewMember.Leader],this.ganttLabel=e[fieldNames.ServiceCrewMember.GanttLabel];var t=void 0,i=void 0;this.startDate&&(t=60*new Date(this.startDate).getTimezoneOffset()*1e3),this.endDate&&(i=60*new Date(this.endDate).getTimezoneOffset()*1e3),this.startDate=this.startDate?new Date(this.startDate+t):new Date(24e11),this.endDate=this.endDate?new Date(this.endDate+i):new Date(24e11)}function ServiceResource(e){var t=this;this.id=e.Id,this.online=!1,this.isUndestaffOrOverStaff=!1,this.name=e.Name,this.isCapacityBased=e[fieldNames.ServiceResource.IsCapacityBased],this.description=e[fieldNames.ServiceResource.Description]||"",this.isOptimizationCapable=e[fieldNames.ServiceResource.IsOptimizationCapable],this.relatedRecord=e[fieldNames.ServiceResource.RelatedRecord],this.relatedRecord__r=e[fieldNames.ServiceResource.RelatedRecord__r],this.resourceType=e[fieldNames.ServiceResource.ResourceType],this.ganttLabel=e[fieldNames.ServiceResource.GanttLabel__c],this.lastKnownLongitude=e[fieldNames.ServiceResource.LastKnownLongitude],this.lastKnownLocationDate=e[fieldNames.ServiceResource.LastKnownLocationDate],this.lastKnownLatitude=e[fieldNames.ServiceResource.LastKnownLatitude],this.serviceCrew=e[fieldNames.ServiceResource.ServiceCrew],this.serviceCrew__r=e[fieldNames.ServiceResource.ServiceCrew__r],this.relatedRecord__r&&(this.pictureLink=this.relatedRecord__r.SmallPhotoUrl),this.onlineOffset=e[fieldNames.ServiceResource.Online_Offset__c]||orgOnlineOffset,this.pictureLink&&this.pictureLink.endsWith("profilephoto/005/T")&&(this.pictureLink=null),e[fieldNames.ServiceResource.PictureLink]&&(this.pictureLink=e[fieldNames.ServiceResource.PictureLink]),this.skills={},this.sobject=e,e[fieldNames.ServiceResource.Skills]&&e[fieldNames.ServiceResource.Skills].forEach(function(e){t.skills[e[fieldNames.ServiceResourceSkill.Skill]]=new ServiceResourceSkill(e)})}function ServiceResourceSkill(e){this.id=e.Id,this.name=e.SkillNumber,this.effectiveEndDate=e[fieldNames.ServiceResourceSkill.EffectiveEndDate],this.effectiveStartDate=e[fieldNames.ServiceResourceSkill.EffectiveStartDate],this.level=e[fieldNames.ServiceResourceSkill.SkillLevel],this.serviceResource=e[fieldNames.ServiceResourceSkill.ServiceResource],this.skill=e[fieldNames.ServiceResourceSkill.Skill];var t=void 0,i=void 0;this.effectiveStartDate&&(t=60*new Date(this.effectiveStartDate).getTimezoneOffset()*1e3),this.effectiveEndDate&&(i=60*new Date(this.effectiveEndDate).getTimezoneOffset()*1e3),this.effectiveStartDate=this.effectiveStartDate?new Date(this.effectiveStartDate+t):new Date(0),this.effectiveEndDate=this.effectiveEndDate?new Date(this.effectiveEndDate+i):new Date(864e11)}function ServiceTerritory(e){this.id=e.Id,this.name=e.Name,this.latitude=e[fieldNames.ServiceTerritory.Latitude],this.longitude=e[fieldNames.ServiceTerritory.Longitude],this.operatingHours=e[fieldNames.ServiceTerritory.OperatingHours],this.operatingHours__r=e[fieldNames.ServiceTerritory.OperatingHours__r],this.description=e[fieldNames.ServiceTerritory.Description],this.parentTerritory=e[fieldNames.ServiceTerritory.ParentTerritory],this.isActive=e[fieldNames.ServiceTerritory.IsActive],e[fieldNames.ServiceTerritory.ParentTerritory]&&e[fieldNames.ServiceTerritory.ParentTerritory]&&(this.parentTerritory=new ServiceTerritory(e[fieldNames.ServiceTerritory.ParentTerritory__r]))}function handleTabSettingAndRecordTypesPermissions(e){var t=new Promise(function(t,i){var n=JSON.parse(e.Admin.replace(/&quot;/g,'"')),r=JSON.parse(e.Agent.replace(/&quot;/g,'"')),s=JSON.parse(e.Community.replace(/&quot;/g,'"')),a=JSON.parse(e.Dispatcher.replace(/&quot;/g,'"')),o=JSON.parse(e.Resource.replace(/&quot;/g,'"'));Promise.all([createTabAndRecordTypePermission("FSL_Admin","FSL Admin",n.tabSettings,n.recordTypeVisibilities),createTabAndRecordTypePermission("FSL_Agent","FSL Agent",r.tabSettings,r.recordTypeVisibilities),createTabAndRecordTypePermission("FSL_Dispatcher","FSL Dispatcher",a.tabSettings,a.recordTypeVisibilities),createTabAndRecordTypePermission("FSL_Community_Self_Service","FSL Self Service",s.tabSettings,s.recordTypeVisibilities),createTabAndRecordTypePermission("FSL_Resource","FSL Resource",o.tabSettings,o.recordTypeVisibilities)]).then(function(){t()},function(){t()})});return t}function createTabAndRecordTypePermission(e,t,i,n){new Promise(function(r,s){for(var a=window.location.origin,o='<soapenv:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:met="http://soap.sforce.com/2006/04/metadata"><soapenv:Header><met:SessionHeader><met:sessionId>'+sessionId+'</met:sessionId></met:SessionHeader></soapenv:Header><soapenv:Body><met:updateMetadata><met:metadata xsi:type="met:PermissionSet"><fullName>'+e+"_Permissions</fullName><label>"+t+" Permissions</label>",c=0;c<i.length;c++)o+="<tabSettings><tab>"+i[c].tab+"</tab><visibility>"+i[c].visibility+"</visibility></tabSettings>";for(var l=0;l<n.length;l++)o+="<recordTypeVisibilities><recordType>"+n[l].recordType+"</recordType><visible>"+n[l].visible+"</visible></recordTypeVisibilities>";o+="</met:metadata></met:updateMetadata></soapenv:Body></soapenv:Envelope>",window.$.ajax({url:a+"/services/Soap/m/38.0",type:"POST",dataType:"xml",data:o,beforeSend:function(e){e.setRequestHeader("Content-Type","text/xml"),e.setRequestHeader("SOAPAction",'""')}}).then(function(e,t,i){r()},function(e,t,i){console.log("Failed to update permissions on load of VF"),r()})})}function setHoursToDisplay(e,t,i){minHourToDisplay=e,maxHourToDisplay=t,includeWeekends=i}function updateTimesToSnapIn(){if(void 0!==cachedDomElements&&void 0!==cachedDomElements.timesDragFix){var e=cachedDomElements.timesDragFix.html(),t=null;0!==e.indexOf(customLabels.SchedulingTimesGantSnap)||ctrlPressed?0!==e.indexOf(customLabels.SchedulingTimesGantSnap)&&ctrlPressed&&(t=customLabels.SchedulingTimesGantSnap+" "+e.substr(customLabels.SchedulingTimesGant.length,e.length),cachedDomElements.timesDragFix.html(t)):(t=customLabels.SchedulingTimesGant+" "+e.substr(customLabels.SchedulingTimesGantSnap.length,e.length),cachedDomElements.timesDragFix.html(t))}}function showTimesWhenDragging(e,t){cachedDomElements.timesDragFix=cachedDomElements.timesDragFix||$("#timesDragFix");var i=(t.start_date.getMinutes()+t.travelTo/60)%60,n=i%serviceJumpsOnGantt,r=serviceJumpsOnGantt-i%serviceJumpsOnGantt;if(scheduler.getState().drag_id!==t.id)return void(scheduler.getState().drag_id||cachedDomElements.timesDragFix.hide());var s=t.finish-t.start,a=new Date(e);a.setSeconds(0),t.travelTo&&a.setSeconds(a.getSeconds()+t.travelTo),a=n>r?new Date(a.getTime()+60*r*1e3):new Date(a.getTime()-60*n*1e3);var o=new Date(a.getTime()+s),c=moment(a).format("lll"),l=moment(o).format("lll"),u=customLabels.SchedulingTimesGant+"<br/>"+c+" - "+l;ctrlPressed&&(u=customLabels.SchedulingTimesGantSnap+"<br/>"+c+" - "+l),cachedDomElements.timesDragFix.html(u).show()}function generateBreakEventHtml(e){var t="Break_Laebl",i="breakIcon";return"ZoomLevel2"!=scheduler._mode&&"ZoomLevel3"!=scheduler._mode&&(t="Break_Laebl BreakLabelSmall",i="breakIconSmall"),e.ganttLabel?'<span class="'+t+'">\n                    <img src="'+lsdIcons.breakImg+'" class="'+i+'" draggable="false"/>\n                    '+e.ganttLabel+"\n                </span>":'<span class="'+t+'">\n                <img src="'+lsdIcons.breakImg+'" class="'+i+' NA_Break_NoLabel_Icon" draggable="false"/>\n            </span>'}function generateCapacityHtml(e){var t="",i="contractorCapacityHoursUsed ",n="fa-battery-empty",r=0;return e.hoursPerTimePeriod>0?r=e.hoursInUse/e.hoursPerTimePeriod*100:e.workItemsPerTimePeriod>0&&(r=e.workItemsAllocated/e.workItemsPerTimePeriod*100),n=25>=r?"fa-battery-empty":50>=r?"fa-battery-quarter":75>=r?"fa-battery-half":90>=r?"fa-battery-three-quarters":"fa-battery-full",r=r>100?100:r,t+='<span class="'+i+'" style="width:calc('+r+'% - 5px);"></span>',e.text&&(t+="ZoomLevel6"===scheduler._mode?'<div class="ServiceEventPadding"><span class="Capacity_Label"><i class="fa '+n+'"></i>'+e.text.split(" ")[0]+"</span></div>":"MonthlyView"===scheduler._mode?'<div class="ServiceEventPadding"><span class="Capacity_Label">'+e.text.split(" ")[0]+"</span></div>":'<div class="ServiceEventPadding"><span class="Capacity_Label"><i class="fa '+n+'"></i>'+e.text+"</span></div>"),t}function generateNAhtml(e,t,i){return i?'<div class="ServiceEvent" style="'+t+'">\n                    <div class="ServiceEventPadding">\n                        <svg aria-hidden="true" class="slds-icon naIcon">\n                            <use xlink:href="'+lsdIcons.na+'"></use>\n                        </svg>\n                        <span class="NA_Label">\n                            '+(e.ganttLabel||e.reason)+"\n                        </span>\n                    </div>\n                </div>":'<div class="ServiceEventPadding" style="'+t+'">\n                <svg aria-hidden="true" class="slds-icon naIcon">\n                    <use xlink:href="'+lsdIcons.na+'"></use>\n                </svg>\n                <span class="NA_Label">\n                    '+(e.ganttLabel||e.reason)+"\n                </span>\n            </div>"}function generateIconsHtmlForService(e){var t="";if(e.violations&&(t="<div class='violationsOnService'><i class='fa fa-warning'></i></div>"),e.jeopardy&&(t='<div class="jeopardyOnService"><img src="'+lsdIcons.jeopardyImg+'"></div>'),e.emergency&&(t+='<svg aria-hidden="true" class="slds-icon emergencyOnService"><use xlink:href="'+lsdIcons.emergency+'"></use></svg>'),e.pinned&&(t+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.pin+'"></use></svg>'),flaggedServices[e.id]&&(t+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.flag+'"></use></svg>'),(e.relatedFather||e.relatedTo||e.isServiceInChain)&&(t+='<svg aria-hidden="true" class="slds-icon onServiceIcon"><use xlink:href="'+lsdIcons.related+'"></use></svg>'),e.isMDT){var i='<svg aria-hidden="true" class="slds-icon onServiceIcon">\n                                <use xlink:href="'+lsdIcons.clock+'"></use>\n                            </svg>',n='<svg aria-hidden="true" class="slds-icon onServiceIcon forwardIcon">\n                                <use xlink:href="'+lsdIcons.forward+'"></use>\n                            </svg>';t+=i+n}return t}function generateServiceColorAndFont(e){var t="";if("na"==e.type&&e.ganttColor&&e.travelTo&&(t+="margin-right:-6px;"),(e.ganttPaletteColor||e.ganttColor)&&!globalSelectedGanttServices[e.id]){var i=e.ganttColor;if(paletteViewActive&&e.ganttPaletteColor&&(i=e.ganttPaletteColor.color),i){var n=generateGanttTextColor(i.substr(1,7));t+="color:#"+n+";background:"+i+";"}}return"ZoomLevel3"!=scheduler._mode&&"ZoomLevel2"!=scheduler._mode&&(t+="font-size:10px;"),t}function attchDatalessSchedulerEvents(){function e(e){if(t(e))return!0;var i=n();return!(e.getHours()>=i.min&&e.getHours()<i.max)}function t(e){if("ZoomLevel6"==scheduler.getState().mode||"MonthlyView"==scheduler.getState().mode||"MTDView"==scheduler.getState().mode){var t=0==firstDayOfTheWeek?6:0,i=0==firstDayOfTheWeek?5:6;if(!includeWeekends&&(e.getDay()==i||e.getDay()==t))return!0}return!1}function i(e){var i=n();if(t(e.start_date)&&t(e.end_date))return!1;var r=[];if("ZoomLevel2"===scheduler._mode)r.push({start:scheduler._min_date.getTime(),finish:scheduler._max_date.getTime()});else for(var s=scheduler._min_date.getTime(),a=scheduler._max_date.getTime(),o=s;a>o;o+=864e5){var c={start:o+1e3*i.min*60*60,finish:o+1e3*i.max*60*60};r.push(c)}return isMultipleIntersection({start:e.start_date.getTime(),finish:e.end_date.getTime()},r)}function n(){var e=scheduler.getState().mode,t=minHourToDisplay,i=maxHourToDisplay,n=null;switch(e){case"ZoomLevel4":n=2;break;case"ZoomLevel5":n=4;break;case"ZoomLevel6":n=6}if(null!=n){t-=t%n;var r=n-i%n;r!=n&&(i+=r)}return{min:t,max:i}}function r(e,t){if(gameOn)return!1;var n=i(t),r=!0;return contractorSupport&&(t.resourceContractor&&(r=!1),"contractorcapacity"==t.type&&t.timePeriod!=capacityDurationFilter&&(r=!1)),n&&r}scheduler.date.ZoomLevel1_start=function(e){var t=scheduler.date.day_start(new Date(e));return t.setHours(e.getHours()),t},scheduler.date.ZoomLevel2_start=function(e){var t=scheduler.date.day_start(new Date(e));return t.setHours(e.getHours()),t},scheduler.templates.event_bar_text=function(e,t,i){var r=void 0,s=void 0,a=void 0,o=void 0,c=void 0,l=void 0,u=n(),d=i.finish-i.start,v=new Date(e),p=void 0;if(v.setSeconds(0),i.travelTo&&v.setSeconds(v.getSeconds()+i.travelTo),p=new Date(v.getTime()+d),showTimesWhenDragging(e,i),"break"===i.type)return generateBreakEventHtml(i);if("contractorcapacity"===i.type)return generateCapacityHtml(i);var h=generateIconsHtmlForService(i),g=generateServiceColorAndFont(i),m=!0,f=new Date(scheduler._min_date),S=new Date(scheduler._max_date);if(f.setHours(u.min),S.setHours(u.max),isIntersect(v,p,f,S)||"ZoomLevel2"===scheduler._mode||(m=!1),m&&(i.travelTo||i.travelFrom)){if(r=getXPositionOfEvent({start_date:v,end_date:p},!1,scheduler.matrix[scheduler._mode]),s=getXPositionOfEvent({start_date:v,end_date:p},!0,scheduler.matrix[scheduler._mode]),a=s-r+12,2>=a&&(a=3),g+="width:"+a+"px;",i.travelTo){var b=new Date(e);b.setMinutes(b.getMinutes()+i.travelTo/60),o=getXPositionOfEvent({start_date:i.start_date,end_date:b},!1,scheduler.matrix[scheduler._mode]),c=getXPositionOfEvent({start_date:i.start_date,end_date:b},!0,scheduler.matrix[scheduler._mode]),l=c-o+7,g+="margin-left:"+l+"px;"}return"na"==i.type?generateNAhtml(i,g,!0):'<div class="ServiceEvent" territory_id="'+i.getGanttTerritory()+'" style="'+g+'");"><div class="ServiceEventPadding">'+h+i.text+"</div></div>"}if("na"==i.type)return generateNAhtml(i,g,!1);var y=h+i.text;return m||i.isDummy||(y=""),'<div class="ServiceEventPadding" style="'+g+'">'+y+"</div>"},scheduler.templates.event_class=function(e,t,i){if("break"===i.type)return"NA_Break";var n="";return"na"==i.type&&(n+=" NA_Absence "),"na"==i.type&&i.ganttColor&&!i.travelTo&&(n+=" na_with_color_no_travel_to "),"na"==i.type&&i.ganttColor&&i.travelTo&&(n+=" na_with_color "),"contractorcapacity"===i.type?(n+=" eventContractorCapacity",i.hoursPerTimePeriod>0?i.hoursInUse>0&&i.hoursInUse>i.hoursPerTimePeriod&&(n+=" overCapacityPattern"):i.workItemsPerTimePeriod>0&&i.workItemsAllocated>0&&i.workItemsAllocated>i.workItemsPerTimePeriod&&(n+=" overCapacityPattern"),showCandidates.on&&(n+=" fadedSlot"),n):("service"===i.type&&(n+=getClassByStatus(i.statusCategory),i.isDummy&&(n+=" savingDummyService ")),i.isMDT&&(n+=" mdtEvent"),showCandidates.on&&i.id!==showCandidates.id&&(n+=" fadedSlot"),i.hiddenTravelFrom&&(n+=" dhx_long_travel_from_time_background"),i.hiddenTravelTo&&(n+=" dhx_long_travel_to_time_background"),n+=i.travelTo&&i.travelFrom?" dhx_travelToFrom dhx_travel_time_background":i.travelTo&&!i.travelFrom?" dhx_travelTo dhx_travel_time_background":!i.travelTo&&i.travelFrom?" dhx_travelFrom dhx_travel_time_background":"na"==i.type?" NA_Absence_NoTravel":" dhx_noTravel","service"==i.type&&(globalSelectedGanttServices[i.id]&&(i.travelTo||i.travelFrom)?n+=" selectedEvent":globalSelectedGanttServices[i.id]?n+=" selectedEventNoTravel":i.id==scheduler._select_id&&(i.travelTo||i.travelFrom)?n+=" selectedEvent":i.id==scheduler._select_id&&(n+=" selectedEventNoTravel")),i.status&&(n+=" GanttCustomStatus_"+i.status.split(" ").join("")),n)},scheduler.templates.tooltip_text=function(e,t,i){var n;if(contextShown)return!1;var r="",s=getLocationdIdByResource(i.resourceId);if(!s)return!1;var a=utils.getLocationOffset(e,s)-utils.getUserOffset(e),o=new Date(i.start);o.setMinutes(o.getMinutes()+a);var c=new Date(i.finish);c.setMinutes(c.getMinutes()+a);var l=0,u=0;if(r+='<div class="tooltipBody">',"contractorcapacity"==i.type)return n="fa-battery-empty",i.hoursPerTimePeriod>0?(l=i.hoursInUse/i.hoursPerTimePeriod*100,u=Math.floor(i.hoursInUse/i.hoursPerTimePeriod*100*100)/100):i.workItemsPerTimePeriod>0&&(l=i.workItemsAllocated/i.workItemsPerTimePeriod*100,u=Math.floor(i.workItemsAllocated/i.workItemsPerTimePeriod*100*100)/100),n=25>=l?"fa-battery-empty":50>=l?"fa-battery-quarter":75>=l?"fa-battery-half":90>=l?"fa-battery-three-quarters":"fa-battery-full",r+='<div class="tooltipLine"><b style="font-size:15px"><i class="fa '+n+'"></i> '+i.resourceName+"</b> ("+u+"%)</div>",i.workItemsPerTimePeriod&&(r+='<div class="tooltipLine">'+customLabels.NumServicesScheduled.replaceAll(i.workItemsAllocated,i.workItemsPerTimePeriod)+"</div>"),i.hoursPerTimePeriod&&(r+='<div class="tooltipLine">'+customLabels.NumHoursScheduled.replace("{0}",i.hoursInUse).replace("{1}",i.hoursPerTimePeriod)+"</div>"),r+='<div class="tooltipHR"></div>',r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Start+"</span> "+moment(i.start_date).format("llll")+"</div>",r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Finish+"</span> "+moment(i.end_date).format("llll")+"</div>",r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Duration_Type+"</span> "+i.timePeriod+"</div>",i.workItemsAllocated>0&&(r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.NumberOfServices+"</span> "+i.workItemsAllocated+"</div>"),r+="</div>";if("service"!=i.type)return n=absenceTypeIcon(i.type),r+=i.ganttLabel?'<div class="tooltipLine"><b>'+n+'<span class="tooltipName">'+i.ganttLabel+"</span> </b> </div>":'<div class="tooltipLine"><b>'+n+'<span class="tooltipName">'+i.name+"</span> </b> </div>",r+='<div class="tooltipHR"></div>',r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Start+"</span> "+moment(i.start).format("llll")+"</div>",r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Finish+"</span> "+moment(i.finish).format("llll")+"</div>",a&&!useLocationTimezone&&(r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Resource_start+"</span> "+moment(o).format("llll")+"</div>",r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Resource_finish+"</span> "+moment(c).format("llll")+"</div>"),i.travelTo&&(r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(i.travelTo/60)+"</div>"),i.travelFrom&&(r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(i.travelFrom/60)+"</div>"),(i.reason||i.comment)&&(r+='<div class="tooltipHR"></div>'),i.reason&&(r+='<div class="tooltipLine"><span class="tooltipCell tooltipCell">'+customLabels.Reason+"</span> "+i.reason+"</div>"),r+="</div>";var d='<svg aria-hidden="true" class="slds-icon tooltipJeopardyIcon">\n                                <use xlink:href="'+lsdIcons.jeopardy+'"></use>\n                            </svg>',v='<svg aria-hidden="true" class="slds-icon tooltipMDTIcon">\n                                <use xlink:href="'+lsdIcons.clock+'"></use>\n                            </svg>',p='<svg aria-hidden="true" class="slds-icon tooltipMDTArrowIcon">\n                                <use xlink:href="'+lsdIcons.forward+'"></use>\n                            </svg>',h='<svg aria-hidden="true" class="slds-icon tooltipMDTArrowIcon">\n                                <use xlink:href="'+lsdIcons.emergency+'"></use>\n                            </svg>',g="",m=i.ganttColor;paletteViewActive&&i.ganttPaletteColor&&(m=i.ganttPaletteColor.color),m&&(g='style="background:'+m+'"'),r+=i.ganttLabel?'<div class="tooltipLine"><div '+g+' class="tooltipStatus '+getClassByStatus(i.statusCategory)+'"></div><b style="font-size:15px">'+i.name+" / "+i.ganttLabel+"</b> ("+statusTranslations[i.status]+")</div>":'<div class="tooltipLine"><div '+g+' class="tooltipStatus '+getClassByStatus(i.statusCategory)+'"></div><b style="font-size:15px">'+i.name+"</b> ("+statusTranslations[i.status]+")</div>",i.jeopardy&&i.jeopardyReason&&(r+='<div class="tooltipJeopardy">'+d+"<span>"+customLabels.JeopardyTooltip+" "+i.jeopardyReason+"</span></div>"),i.emergency?r+='<div class="tooltipJEmergency">'+h+"<span>"+customLabels.ScheduledWithEmergency+"</span></div>":i.jeopardy&&(r+='<div class="tooltipJeopardy">'+d+"<span>"+customLabels.JeopardyTooltipLong+"</span></div>"),i.pinned&&(r+='<div class="tooltipLine tooltipPinned"><i>'+customLabels.Pinned_Tooltip+"</i></div>");var f=GanttService.prototype.allFieldSets.GanttToolTip;if(f)for(var S=0;S<f.length;S++){var b=i[f[S].APIName];"Status"===f[S].APIName?b=statusTranslations[i.status]:"DATETIME"==f[S].Type&&b?b=moment(b).format("llll"):"DATE"==f[S].Type&&b&&(b=moment(b).format("L")),
b&&(r+='<div class="tooltipLine"><b>'+f[S].Label+": </b> "+b+"</div>")}if(r+='<div class="tooltipHR"></div>',r+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Start+"</span> "+moment(i.start).format("llll")+"</div>",r+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Finish+"</span> "+moment(i.finish).format("llll")+"</div>",!a&&!alwaysShowLocalTimeTooltip||useLocationTimezone||(r+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Resource_start+"</span> "+moment(o).format("llll")+"</div>",r+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Resource_finish+"</span> "+moment(c).format("llll")+"</div>"),i.hiddenTravelTo?r+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(i.hiddenTravelTo.hiddenTravel/60)+"</div>":i.travelTo&&(r+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_to+"</span> "+generateHoursMinutes(i.travelTo/60)+"</div>"),i.hiddenTravelFrom?r+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(i.hiddenTravelFrom.hiddenTravel/60)+"</div>":i.travelFrom&&(r+='<div class="tooltipLine"><span class="tooltipCell truncate">'+customLabels.Travel_from+"</span> "+generateHoursMinutes(i.travelFrom/60)+"</div>"),i.tooltipText&&(r+='<div class="tooltipHR"></div>',r+='<div class="tooltipLine tooltipTitle">'+customLabels.Custom_Tooltip_Field+'</div><div class="tooltipLine">'+i.tooltipText+"</div>"),r+="</div>",(i.hiddenTravelTo||i.hiddenTravelFrom||i.isMDT)&&(r+='<div class="tooltipTravel">',(i.hiddenTravelTo||i.hiddenTravelFrom)&&(r+='<div class="tooltipLine tooltipTitle"><i class="fa fa-car"></i>'+customLabels.Travel_time+"</div><div>",r+=customLabels.Travel_time_too_long.replace("{0}",maxTravelTimeInSeconds/60/60)+'<div class="travelExplain">'+customLabels.To_change_maximum_travel_hours+"</div>",r+="</div>"),i.isMDT&&(r+='<div class="tooltipLine tooltipTitle">'+v+p+customLabels.Multi_Day_Service+"</div><div>",r+=customLabels.This_service_spans_across_more_than_one_day,r+="</div>"),r+="</div>"),i.violations){r+='<div class="tooltipViolation">',r+='<div class="tooltipLine tooltipTitle"><i class="fa fa-warning"></i>'+customLabels.Rule_violations_Tooltip+"</div><div>";for(var S=0;S<i.violations.length;S++)-1!=i.violations[S].ViolationString.indexOf(violationDelimiter)?(r+=i.violations[S].RuleName+" - ",r+=i.violations[S].ViolationString.substring(0,i.violations[S].ViolationString.indexOf(violationDelimiter))+"<br/>",r+=i.violations[S].ViolationString.substring(i.violations[S].ViolationString.indexOf(violationDelimiter)+violationDelimiter.length)+"<br/>"):r+=i.violations[S].RuleName+" - "+i.violations[S].ViolationString+"<br/>";r+="</div>"}return r};var s=!1;return dhtmlxEvent(scheduler._obj,"mouseleave",function(e){scheduler.getState().drag_id&&(s=!0,scheduler._on_mouse_up(e),cachedDomElements.timesDragFix.hide(),window.getSelection().removeAllRanges())}),scheduler.attachEvent("onBeforeEventChanged",function(){return s?(s=!1,!1):!0}),scheduler._hover=null,scheduler.attachEvent("onMouseMove",function(e,t){if(!e)return void(scheduler._hover&&($(".dhx_cal_event_line, .ServiceEvent").removeClass("hoverRelated"),scheduler._hover=null));if(scheduler._events[e].relatedTo||scheduler._events[e].relatedFather){var i=$(scheduler.getRenderedEvent(e)).find(".ServiceEvent"),n=null;if(0===i.length&&(i=$(scheduler.getRenderedEvent(e))),scheduler._events[e].relatedFather?(n=$(scheduler.getRenderedEvent(scheduler._events[e].relatedFather)).find(".ServiceEvent"),0===n.length&&(n=$(scheduler.getRenderedEvent(scheduler._events[e].relatedFather)))):(n=$(scheduler.getRenderedEvent(scheduler._events[e].relatedTo)).find(".ServiceEvent"),0===n.length&&(n=$(scheduler.getRenderedEvent(scheduler._events[e].relatedTo)))),scheduler._hover=e,i&&n){if($(i).hasClass("hoverRelated"))return;$(i).addClass("hoverRelated"),$(n).addClass("hoverRelated")}}}),scheduler.templates.ZoomLevel2_scale_date=function(e){var t=e.getHours(),i=e.getMinutes()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getMinutes()):formatNumberToLocaleString(e.getMinutes());return isAMPM?0===t?formatNumberToLocaleString(12)+":"+i+" AM":12===t?formatNumberToLocaleString(12)+":"+i+" PM":t>12?formatNumberToLocaleString(t-12)+":"+i+" PM":formatNumberToLocaleString(t)+":"+i+" AM":formatNumberToLocaleString(t)+":"+i},scheduler.templates.ZoomLevel3_scale_date=function(e){var t=e.getHours(),i=e.getMinutes()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getMinutes()):formatNumberToLocaleString(e.getMinutes());return isAMPM?0===t?formatNumberToLocaleString(12)+" AM":12==t?formatNumberToLocaleString(12)+" PM":t>12?formatNumberToLocaleString(t-12)+" PM":formatNumberToLocaleString(t)+" AM":(e.getHours()<10?formatNumberToLocaleString(0)+formatNumberToLocaleString(e.getHours()):formatNumberToLocaleString(e.getHours()))+":"+i},scheduler.templates.ZoomLevel4_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel5_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel6_scale_date=scheduler.templates.ZoomLevel3_scale_date,scheduler.templates.ZoomLevel4_cell_class=function(e,t,i){return!i.children&&shouldSeparateCell(t)?"BorderForDayChange":""},scheduler.templates.ZoomLevel2_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel5_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.templates.ZoomLevel6_cell_class=scheduler.templates.ZoomLevel4_cell_class,scheduler.filter_ZoomLevel1=r,scheduler.filter_ZoomLevel2=r,scheduler.filter_ZoomLevel3=r,scheduler.filter_ZoomLevel4=r,scheduler.filter_ZoomLevel5=r,scheduler.filter_ZoomLevel6=r,scheduler.filter_MonthlyView=function(e,t){return"contractorcapacity"===t.type},scheduler.filter_MTDView=function(e,t){return"contractorcapacity"===t.type||t.isMDT},scheduler.ignore_ZoomLevel3=e,scheduler.ignore_ZoomLevel4=e,scheduler.ignore_ZoomLevel5=e,scheduler.ignore_ZoomLevel6=e,scheduler.ignore_MonthlyView=function(e){return t(e)},scheduler.ignore_MTDView=scheduler.ignore_MonthlyView,{isDateInsideWeekend:t}}function shouldSeparateCell(e){var t=getMinAndMaxHoursToDisplay();switch(scheduler._mode){case"ZoomLevel4":t.max-=2;break;case"ZoomLevel5":t.max-=4;break;case"ZoomLevel6":t.max-=6}if("ZoomLevel2"===scheduler._mode&&23===e.getHours()&&30===e.getMinutes())return!0;if(e.getHours()==t.max){var i=new Date(e);if(i.setHours(i.getHours()+24),i<=scheduler._max_date)return!0}return!1}function getXPositionOfEvent(e,t,i){var n=0,r=i._step,s=i.round_position,a=0,o=t?e.end_date:e.start_date;o.valueOf()>scheduler._max_date.valueOf()&&(o=scheduler._max_date);var c=o-scheduler._min_date_timeline;if(c>0){var l=scheduler._get_date_index(i,o);scheduler._ignores[l]&&(s=!0);for(var u=0;l>u;u++)n+=scheduler._cols[u];var d=scheduler.date.add(scheduler._min_date_timeline,scheduler.matrix[scheduler._mode].x_step*l,scheduler.matrix[scheduler._mode].x_unit);s?+o>+d&&t&&(a=scheduler._cols[l]):(c=o-d,i.first_hour||i.last_hour?(c-=i._start_correction,0>c&&(c=0),a=Math.round(c/r),a>scheduler._cols[l]&&(a=scheduler._cols[l])):a=Math.round(c/r))}return n+=t?0===c||s?a-14:a-12:a+1}function getResourceEventsIds(e,t,i){var n=[];for(var r in scheduler._events)"service"==scheduler._events[r].type&&scheduler._events[r].start_date>=e&&scheduler._events[r].end_date<=t&&scheduler._events[r].resourceId==i&&(n.push(r),scheduler._events[r].relatedTo&&n.push(scheduler._events[r].relatedTo),scheduler._events[r].relatedFather&&n.push(scheduler._events[r].relatedFather));return n}function getEventIdsOfResources(e){var t=[];for(var i in scheduler._events)"service"==scheduler._events[i].type&&e.indexOf(scheduler._events[i].resourceId)>-1&&(t.push(i),scheduler._events[i].relatedTo&&t.push(scheduler._events[i].relatedTo),scheduler._events[i].relatedFather&&t.push(scheduler._events[i].relatedFather));return t}function getEventIdsOfLocation(e,t,i){var n=[];for(var r in scheduler._events)"service"==scheduler._events[r].type&&scheduler._events[r].start_date>=e&&scheduler._events[r].end_date<=t&&i.indexOf(scheduler._events[r].location)>-1&&n.push(r);return n}function setCapacityFilter(e,t){contractorSupport&&(capacityDurationFilter=e,t&&scheduler._is_initialized()&&updateViewDebounced())}function cantLoadGantt(e){$(".keypressEvents")&&($(".bodyDiv").css("background","#fff"),$(".keypressEvents").remove(),$("#ErrorLoadingGantt").show()),$("#ErrorContainer").append(e),e.toUpperCase().indexOf("CPU TIME")>-1?($("#OpenTerritoryButton").show(),$("#OpenTerritoryMessage").show(),$("#OpenTerritoryButton").click(function(){__openLocationFilteringAndReload()})):($("#OpenTerritoryButton").hide(),$("#OpenTerritoryMessage").hide())}function getLocationdIdByResource(e){for(var t=scheduler.serverList("resources"),i=0;i<t.length;i++)for(var n=0;n<t[i].children.length;n++)if(e.split(",")[0]==t[i].children[n].key)return t[i].key;return null}function absenceTypeIcon(e){return"break"==e?'<svg aria-hidden="true" class="slds-icon tooltipBreakIcon">\n                    <use xlink:href="'+lsdIcons["break"]+'"></use>\n                </svg>':'<svg aria-hidden="true" class="slds-icon tooltipNAIcon">\n                <use xlink:href="'+lsdIcons.na+'"></use>\n            </svg>'}function getClassByStatus(e){switch(e){case globalCategories.NONE:return"eventStatusNew";case globalCategories.SCHEDULED:return"eventStatusAssigned";case globalCategories.DISPATCHED:return"eventStatusDispatched";case globalCategories.IN_PROGRESS:return"eventStatusTravel";case globalCategories.RUNNING_LONG:return"eventStatusOnSite";case globalCategories.COMPLETED:return"eventStatusCompleted";case globalCategories.MISSED:return"eventStatusIncomplete";case globalCategories.COULD_NOT_COMPLETE:return"eventStatusCouldntComplete";case globalCategories.CANCELED:return"eventStatusCancelled";default:return"eventCustomStatus"}}function getMinAndMaxHoursToDisplay(){var e=scheduler.getState().mode,t=minHourToDisplay,i=maxHourToDisplay,n=null;switch(e){case"ZoomLevel4":n=2;break;case"ZoomLevel5":n=4;break;case"ZoomLevel6":n=6}if(null!==n){t-=t%n;var r=n-i%n;r!=n&&(i+=r)}return{min:t,max:i}}function isIntersect(e,t,i,n){return n>e&&t>i}function isIntersectIncludeLimits(e,t,i,n){return n>=e&&t>=i}function isMultipleIntersection(e,t){for(var i=0;i<t.length;i++)if(isIntersect(e.start,e.finish,t[i].start,t[i].finish))return!0;return!1}function generateGanttTextColor(e){var t=parseInt("0x888888",16),i=parseInt("0x"+e,16);return i>t?"000000":"ffffff"}function formatNumberToLocaleString(e){try{return e.toLocaleString(jsUserLocale)}catch(t){console.warn("Something wrong with your locale settings: "+jsUserLocale)}return e}function generateHoursMinutes(e){if(60>e)return customLabels.MinutesGanttTooltip.replace("$0",e);var t=e%60,i=Math.floor(e/60);return customLabels.MinutesHoursGanttTooltip.replace("$0",i).replace("$1",t)}function calculateColor(e){if(e instanceof GanttService){var t=e.start.getHours();switch(t){case 0:e.ganttColor="#e21818";break;case 1:e.ganttColor="#e24818";break;case 2:e.ganttColor="#e27c18";break;case 3:e.ganttColor="#e29418";break;case 4:e.ganttColor="#e29418";break;case 5:e.ganttColor="#e2ab18";break;case 6:e.ganttColor="#e2ab18";break;case 7:e.ganttColor="#e2ab18";break;case 8:e.ganttColor="#e8db0f";break;case 9:e.ganttColor="#fcff00";break;case 10:e.ganttColor="#d2ff00";break;case 11:e.ganttColor="#8aff00";break;case 12:e.ganttColor="#00ff72";break;case 13:e.ganttColor="#00ffa8";break;case 14:e.ganttColor="#00ffea";break;case 15:e.ganttColor="#00e4ff";break;case 16:e.ganttColor="#00aeff";break;case 17:e.ganttColor="#007eff";break;case 18:e.ganttColor="#005aff";break;case 19:e.ganttColor="#001eff";break;case 20:e.ganttColor="#4800ff";break;case 21:e.ganttColor="#b400ff";break;case 22:e.ganttColor="#f000ff";break;case 23:e.ganttColor="#ff00d2"}}}function removeLightboxLoading(){$("#lightbox-loading-cover").remove()}!function(){String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var i=this.toString();("number"!=typeof t||!isFinite(t)||Math.floor(t)!==t||t>i.length)&&(t=i.length),t-=e.length;var n=i.lastIndexOf(e,t);return-1!==n&&n===t})}(),function(){var e=angular.module("serviceExpert",["uiGmapgoogle-maps","angularMoment","ui.bootstrap","chart.js","MstResolver"]);e.run(["amMoment",function(e){e.changeLocale(userLocale)}]),e.config(["$sceDelegateProvider","$compileProvider","MstResolverProvider",function(e,t,i){var n=null,r=_.debounce(window.scheduler.updateView,100).bind(window.scheduler);window.updateViewDebounced=function(){return n||0!==document.body.clientWidth?void(0!==document.body.clientWidth&&(n&&(clearInterval(n),n=null),r())):void(n=setInterval(window.updateViewDebounced,1e3))},debugMode||t.debugInfoEnabled(!1),i.setConfig({fslOperationRemoteAction:RemoteActions.getFslOperation,getAsyncApexJobRemoteAction:RemoteActions.getAsyncApexJob,apiVersion:"41.0",fieldNames:fieldNames.FslOperation,autoConnect:!1}),e.resourceUrlWhitelist(["self","https://**.force.com"])}])}(),function(){angular.module("serviceExpert").controller("ctrlGantt",["$scope","$rootScope","$q","sfdcService","servicesService","utils","calendarsService","userSettingsManager","resourceFilterHelper","monthlyViewHelperService","ResourcesAndTerritoriesService","TimePhasedDataService","StateService","CapacityLightboxService","ResourceSmallMenu","AbsencesService","SkillsService","DeltaService","AbsenceLightboxService","ResourceLightboxService","ServiceAppointmentLightboxService","kpiCalculationsService","ResourceCapacitiesService","ResourceCrewsService","SERVICE_STATUS","SERVICE_CATEGORY","GetSlotsService","bulkScheduleService","GeneralLightbox","StreamingClientResolverService","StreamingAPIService","RegisterService",function(e,t,i,n,r,s,a,o,c,l,u,d,v,p,h,g,m,f,S,b,y,T,w,L,C,k,D,A,R,I,F,x){function M(){if(J)return void(J=!1);setHoursToDisplay(e.businessHoursRange.start,e.businessHoursRange.end,e.businessHoursRange.includeWeekends),scheduler.setCurrentView(),s.ganttSettings.startHour=e.businessHoursRange.start,s.ganttSettings.finishHour=e.businessHoursRange.end;var t={};t.Gantt_View_Start_Hour__c=s.ganttSettings.startHour,t.Gantt_View_Finish_Hour__c=s.ganttSettings.finishHour,t.Include_Weekends__c=e.businessHoursRange.includeWeekends,o.SetUserSettingProperties(t)}function O(e,t){if(""===t&&(t=prompt(customLabels.msg_to_post_to_chatter,"")),null!==t){if(""===t)return void alert(customLabels.no_empty_msg_to_chatter);1===e.length&&(r.recentlyUsed[e[0]]=!0),r.postToChatter(e,t).then(function(e){})}}function P(){for(var t in e.selectedGanttServices)delete e.selectedGanttServices[t]}function E(t){for(var i=!1,n=0;n<e.pinnedStatusesSF.length;n++)scheduler._events[t].status===e.pinnedStatusesSF[n]&&(i=!0);scheduler._events[t].pinned||i?(K.hideItem("reschedule"),K.hideItem("candidates"),K.hideItem("unschedule"),K.hideItem("status"),K.hideItem("reshuffle"),K.hideItem("groupNearby")):(K.showItem("reschedule"),K.showItem("candidates"),K.showItem("unschedule"),K.showItem("status"),K.showItem("reshuffle"),K.showItem("groupNearby")),scheduler._events[t].pinned?K.hideItem("status"):K.showItem("status"),scheduler._events[t].latitude&&scheduler._events[t].longitude&&s.hasCustomPermission("Group_Nearby")?K.showItem("groupNearby"):K.hideItem("groupNearby"),s.hasCustomPermission("Schedule")?K.showItem("reschedule"):K.hideItem("reschedule"),s.hasCustomPermission("Reshuffle")?K.showItem("reshuffle"):K.hideItem("reshuffle"),K.removeItem("showRelated"),(scheduler._events[t].isServiceInChain||scheduler._events[t].relatedTo||scheduler._events[t].relatedFather)&&K.addNewChild(K.topId,5,"showRelated",s.getSVGIconHTML(lsdIcons.related)+customLabels.Show_related,!1),v.isMapEnabled()&&null!==scheduler._events[t].latitude?K.showItem("map"):K.hideItem("map"),K.removeItem("flag"),r.flagged[t]?K.addNewChild(K.topId,1,"flag","<span class='emptyFlag'>"+s.getSVGIconHTML(lsdIcons.flag)+"</span> "+customLabels.Unflag,!1):K.addNewChild(K.topId,1,"flag","<span class='fullFlag'>"+s.getSVGIconHTML(lsdIcons.flag)+"</span> "+customLabels.Flag,!1),K.removeItem("pin"),scheduler._events[t].pinned?K.addNewChild(K.topId,9,"pin","<span class='emptyFlag'>"+s.getSVGIconHTML(lsdIcons.unpin)+"</span> "+customLabels.Unpin,!1):K.addNewChild(K.topId,9,"pin","<span class='fullFlag'>"+s.getSVGIconHTML(lsdIcons.pin)+"</span> "+customLabels.Pin,!1),K.removeItem("consoleTab"),e.isInConsole()&&K.addNewChild(K.topId,1,"consoleTab",s.getSVGIconHTML(lsdIcons.external)+customLabels.Open_Tab,!1)}function N(e){var t=void 0,i=0;if(_.isEmpty(s.statusFlow)){K.removeItem("status"),K.addNewChild(K.topId,5,"status",s.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1);for(var n in s.statuses)t="ContextMenu_"+s.statusTranslations[s.statuses[n]].split(" ").join(""),K.addNewChild("status",i,"status_change_"+i,"<span class='StatusColorChanger "+t+" "+s.getCSSClassForContext(s.statusTranslations[s.statuses[n]],C)+"'></span>"+s.statusTranslations[s.statuses[n]],!1),Q["status_change_"+i++]=s.statuses[n]}else{if(!(s.statusFlow[e]&&s.statusFlow[e].length>0))return void K.removeItem("status");for(K.removeItem("status"),K.addNewChild(K.topId,5,"status",s.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),Q={},i=0;i<s.statusFlow[e].length;i++)t="ContextMenu_"+s.statusFlow[e][i].split(" ").join(""),K.addNewChild("status",i,"status_change_"+i,"<span class='StatusColorChanger "+t+" "+s.getCSSClassForContext(s.statusFlow[e][i],C)+"'></span>"+s.statusTranslations[s.statusFlow[e][i]],!1),Q["status_change_"+i]=s.statusFlow[e][i]}}function G(t){for(var i in e.selectedGanttServices)e.selectedGanttServices[i]&&(r.flagged[i]=t);updateViewDebounced()}function B(){if(scheduler._is_initialized()&&e.datalessMethods){for(var t=0;t<e.nowTimespans.length;t++)scheduler.deleteMarkedTimespan(e.nowTimespans[t]);e.nowTimespans.length=0;for(var i=scheduler.serverList("resources"),n=getMinAndMaxHoursToDisplay(),r=0;r<i.length;r++){var a=new Date,o=new Date(a.valueOf()+6e4*a.getTimezoneOffset());if(useLocationTimezone?o.setMinutes(o.getMinutes()+s.getLocationOffset(o,i[r].key)):o=s.convertDateBetweenTimeZones(o,"GMT",userTimeZone),n.min<=o.getHours()&&o.getHours()<n.max&&!e.datalessMethods.isDateInsideWeekend(o)&&"MonthlyView"!==scheduler._mode){var c={};c[scheduler.getState().mode]=[];for(var l=0;l<i[r].children.length;l++)c[scheduler.getState().mode].push(i[r].children[l].key);e.nowTimespans.push(scheduler.addMarkedTimespan({start_date:o,end_date:scheduler.date.add(o,1,"minute"),css:"dhx_now_time dhx_matrix_now_time",sections:c}))}}}}function H(e){if(!confirm(customLabels.are_you_sure_unschedule))return!0;var t=[],i=[];e.forEach(function(e){i.push(d.serviceAppointments()[e]),t.push(d.serviceAppointments()[e].resource),r.recentlyUsed[e]=!0}),r.unscheduleServices(e).then(function(e){r.drawServicesAndAbsences(e.services,e.absences),T.calculateKpis(),P()})["catch"](function(e){s.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)})}function V(e,t){if(t===C.CANCELED&&!confirm(customLabels.AreYouSureYouWantToCancel))return!0;var i=[],n=[];e.forEach(function(e){n.push(d.serviceAppointments()[e]),i.push(d.serviceAppointments()[e].resource),r.recentlyUsed[e]=!0}),r.changeStatus(e,t).then(function(e){r.drawServicesAndAbsences(e.services),P()})["catch"](function(e){s.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)})}function U(e){var t=(e.start_date.getMinutes()+e.travelTo/60)%60,i="na"===e.type?e.end-e.start:e.schedEndTime-e.schedStartTime,n=t%serviceJumpsOnGantt,r=serviceJumpsOnGantt-t%serviceJumpsOnGantt;0!==n&&(n>r?e.start_date=new Date(e.start_date.getTime()+60*r*1e3):e.start_date=new Date(e.start_date.getTime()-60*n*1e3),e.end_date=new Date(e.start_date.getTime()+i+1e3*e.travelFrom+1e3*e.travelTo),e.schedStartTime=e.start_date.getTime()+1e3*e.travelTo,e.schedEndTime=e.end_date.getTime()-1e3*e.travelFrom)}var j="",z="",q={},W=!0,K=new dhtmlXMenuObject({parent:"contextZone_A",context:!0}),Z=new dhtmlXMenuObject({parent:"contextZone_A",context:!0});K.setOverflowHeight(15),Z.setOverflowHeight(15),e.selectedGanttServices={},e.resourceFilterHelper=c,e.StateService=v,e.resources=[],e.searchEmployee="",e.resourceFieldToSortyBy="Name",e.successfullyScheduled=0,e.currentSchedulingIndex=0,e.ganttLocked=o.GetUserSettingsProperty("Lock_Gantt__c")||!1,e.timelineName="",e.nowTimespans=[],e.selectedSkills={},e.pinnedStatusesSF=CustomSettings.pinnedStatusesSF.split(","),e.hasCustomPermission=s.hasCustomPermission,e.crewViewActive=!1,e.crewsFilter=s.crewsFilter,e.useResourceSkillFilter=useResourceSkillFilter,e.numberOfDaysInUtilizationView=14,e.editPalette=s.hasCustomPermission("Gantt_Palettes_Edit"),e.viewPalette=s.hasCustomPermission("Gantt_Palettes_View"),scheduler.attachEvent("onTemplatesReady",function(){scheduler.matrix.MonthlyView&&(scheduler.matrix.MonthlyView.x_size=o.GetUserSettingsProperty("DaysInUtilizationView__c")||14,e.numberOfDaysInUtilizationView=scheduler.matrix.MonthlyView.x_size)}),e.paletteViewActive=!1,e.showPaletteView=function(){window.paletteViewActive=!0,e.paletteViewActive=!0,updateViewDebounced()},e.hidePaletteView=function(){window.paletteViewActive=!1,e.paletteViewActive=!1,updateViewDebounced()},e.$watch("StateService.isLoadingNewLocations",function(t,i){void 0!==i&&i!==!1||1!=t||(e.paletteViewActive=!1)}),t.statusTranslations=s.statusTranslations,t.$on("moveToCrewView",function(){e.crewViewActive=!0,d.isCrewViewActive=!0}),e.$watch("resourceFilterHelper",function(t,i){$("#resourceExplainCrap").html(e.resourceFilterHelper.generateFilterExplanation(e.resourceFilters.showWorkingResource)),angular.equals(t,i)||o.SetUserSettingsProperty("Resource_Filter__c",JSON.stringify({sortBy:e.resourceFilterHelper.resourceFieldToSortyBy,asc:e.resourceFilterHelper.descending,showWorkingResource:e.resourceFilters.showWorkingResource,booleanFields:e.resourceFilterHelper.selectionInfo.resourceFilteringOptions,picklistField:e.resourceFilterHelper.selectionInfo.selectedPicklist,picklistOptions:e.resourceFilterHelper.selectionInfo.picklistOptions,picklistOptionsModel:e.resourceFilterHelper.selectionInfo.picklistOptionsModel,picklistNullValues:e.resourceFilterHelper.selectionInfo.picklistNullValues,crewsOption:e.resourceFilterHelper.selectionInfo.crewsSelectionOptions.selectedPicklist}))},!0),g.getEmployeeAbsenceTypes().then(function(t){e.nonAvailabilityTypes=t,e.defaultDragNa={selectedNaDuration:JSON.parse(o.GetUserSettingsProperty("Drag_Na_Duration__c"))||60,selectedNaType:o.GetUserSettingsProperty("Drag_Na_Type__c")||e.nonAvailabilityTypes[Object.keys(e.nonAvailabilityTypes)[0]],selectedNaLabel:o.GetUserSettingsProperty("Drag_Na_Label__c")}}),e.businessHoursRange={start:s.ganttSettings.startHour,end:s.ganttSettings.finishHour,includeWeekends:o.GetUserSettingsProperty("Include_Weekends__c")},e.resourceFilters={showWorkingResource:JSON.parse(o.GetUserSettingsProperty("Resource_Filter__c"))?JSON.parse(o.GetUserSettingsProperty("Resource_Filter__c")).showWorkingResource:!1,resourcesWorkingInRange:{}},e.isInConsole=v.isInConsole,e.openConsoleTab=s.openConsoleTab,e.capacityFields=l.capacityCalculationFields,Object.defineProperty(e.selectedGanttServices,"getSelected",{enumrable:!1,value:function(){var e=[];for(var t in this)this[t]&&e.push(t);return e}}),e.isGanttFilterApplied=function(){return s.crewsFilter||e.skillsFilter||c.isResourceFilterApplied()||e.resourceFilters.showWorkingResource},cachedDomElements.timesDragFix||(cachedDomElements.timesDragFix=$("#timesDragFix"));var J=!0;e.$watchCollection("businessHoursRange",M),u.promises.resources().then(function(){e.resources=u.getResources}),e.saveDragNaDefaults=function(t){switch(t){case"duration":o.SetUserSettingsProperty("Drag_Na_Duration__c",e.defaultDragNa.selectedNaDuration);break;case"type":o.SetUserSettingsProperty("Drag_Na_Type__c",e.defaultDragNa.selectedNaType);break;case"label":o.SetUserSettingsProperty("Drag_Na_Label__c",e.defaultDragNa.selectedNaLabel)}},e.getTimePhasedObjects=function(e){var i=scheduler.getState().min_date,n=scheduler.getState().max_date;return"undefined"!=typeof e&&("left"===e?(n.setDate(i.getDate()+1),i.setDate(i.getDate()-1)):"right"===e&&(i.setDate(n.getDate()-1),n.setDate(n.getDate()+1))),d.getTimePhasedObjects(i,n).then(function(e){if(t.$broadcast("ganttFinishedLoadingServices"),W){W=!1,updateViewDebounced();var i=null;document.URL.indexOf("service=")>-1&&(i=document.URL.substr(document.URL.indexOf("service=")+8,18)),scheduler._events[i]?(scheduler._select_id=i,scheduler.select(i),setTimeout(function(){s.showOnGantt(i)},0)):i&&alert(customLabels.cant_display_service)}})},e.changeDatesByArrows=function(t){e.getTimePhasedObjects(t)},scheduler.attachEvent("onDblClick",function(t,i){s.safeApply(e,function(){"service"===scheduler.getEvent(t).type?(r.recentlyUsed[t]=!0,y.open(t)):"contractorcapacity"===scheduler.getEvent(t).type?p.open(t):S.open(t)})}),scheduler.attachEvent("onBeforeFolderToggle",function(t,i){return folderJustToggled=!0,s.safeApply(e,function(){v.ganttOpenedTerritories[t.key]=i,Y()}),!0});var Y=_.debounce(function(){o.SetUserSettingsProperty("Toggled_Territories__c",JSON.stringify(v.ganttOpenedTerritories))},800);scheduler.attachEvent("onBeforeViewChange",function(e,t,i,n){return"MonthlyView"===e&&"MonthlyView"!==i&&"__Utilization__"===c.resourceFieldToSortyBy&&(c.resourceFieldToSortyBy="Name"),!0}),scheduler.attachEvent("onViewChange",function(t,i){s.safeApply(e,function(){switch(scheduler._mode){case"ZoomLevel2":e.timelineName=customLabels.In_Day;break;case"ZoomLevel3":e.timelineName=customLabels.Daily;break;case"ZoomLevel4":e.timelineName=customLabels.X2_Days;break;case"ZoomLevel5":e.timelineName=customLabels.X3_Days;break;case"ZoomLevel6":e.timelineName=customLabels.Weekly;break;case"MonthlyView":e.timelineName=customLabels.Utilization;break;case"MTDView":e.timelineName=customLabels.MDTVIEW}$("#MonthlyLocationViewTooltip").remove(),B(),updateViewDebounced(),(scheduler._old.mode!==t||scheduler._old.date!==i)&&T.calculateKpis()})}),scheduler.attachEvent("onBeforeDrag",function(t,i,n){if(!t||!scheduler._events[t].isDummy){var r=void 0,s=n.ctrlKey||n.metaKey;if(!t||"create"===i){if(!s)for(r in e.selectedGanttServices)e.selectedGanttServices[r]=!1,scheduler.getRenderedEvent(r)&&scheduler.updateEvent(r);return!1}if(t&&"service"===scheduler.getEvent(t).type){if(s)return Z.hide(),e.selectedGanttServices[t]?(e.selectedGanttServices[t]=!1,scheduler.updateEvent(t)):(e.selectedGanttServices[t]=!0,scheduler.updateEvent(t)),!1;e.selectedGanttServices[t]=!0;for(r in e.selectedGanttServices)r!==t&&(e.selectedGanttServices[r]=!1,scheduler.getEvent(r)&&scheduler.getSection(scheduler.getEvent(r).resourceId)&&scheduler.updateEvent(r))}else if(!s&&e.selectedGanttServices.getSelected().length>=1)for(r in e.selectedGanttServices)e.selectedGanttServices[r]=!1,scheduler.getRenderedEvent(r)&&scheduler.updateEvent(r);if(!("service"!==scheduler.getEvent(t).type&&"na"!==scheduler.getEvent(t).type||t&&"service"===scheduler.getEvent(t).type&&scheduler.getEvent(t).pinned&&preventUpdateOfPinned))return!0}}),e.$watchCollection("selectedGanttServices",function(t,i){globalSelectedGanttServices=e.selectedGanttServices}),e.jumpToDate=function(){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"JumpToDate",date:scheduler._date,navigation:!0,handler:function(t,i){scheduler.setCurrentView(t),scheduler.destroyCalendar(),e.changeDatesByArrows()}})};var X=new dhtmlXMenuObject({parent:"contextZone_A",context:!0});X.setOverflowHeight(15),X.addNewChild(X.topId,0,"details",s.getSVGIconHTML(lsdIcons.info)+customLabels.Details,!1),X.attachEvent("onClick",function(t,i,r){switch(t){case"details":s.safeApply(e,function(){S.open(z)});break;case"delete":s.safeApply(e,function(){confirm(customLabels.naDeleteConfirm)&&g.deleteAbsence(z).then(function(e){e?scheduler.deleteEvent(z):alert(customLabels.Failed_To_Delete_Break)})});break;default:if(0===t.indexOf("custom_")){var a=scheduler._events[z].type,o=parseInt(t.split("_")[1]),c=s.getCustomActions(a)[o];if(c.visualforce){var l=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),u=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();R.open(c.name,c.visualforce+"?id="+z+"&type="+a+"&start="+l+"&end="+u);break}n.runCustomAbsenceAction(c.className,z,a,scheduler._min_date,scheduler._max_date).then(function(e){e&&s.addNotification(c.name,e,null,null)})["catch"](function(e){return s.addNotification(c.name,e.message,null,null)});break}}}),function(){K.addNewChild(K.topId,0,"details",s.getSVGIconHTML(lsdIcons.info)+customLabels.Details,!1),K.addNewChild(K.topId,3,"reschedule",s.getSVGIconHTML(lsdIcons.calendar)+customLabels.Reschedule,!1),K.addNewChild(K.topId,4,"candidates",s.getSVGIconHTML(lsdIcons.candidates)+customLabels.Get_Candidates,!1),K.addNewChild(K.topId,10,"reshuffle",s.getSVGIconHTML(lsdIcons.retweet)+customLabels.Reshuffle,!1),K.addNewChild(K.topId,11,"groupNearby",s.getSVGIconHTML(lsdIcons.groupNearby)+customLabels.GroupNearby,!1),K.addNewChild(K.topId,5,"status",s.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),K.addNewChild(K.topId,6,"map",s.getSVGIconHTML(lsdIcons.world)+customLabels.Map,!1),K.addNewChild(K.topId,8,"unschedule",s.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,!1),fieldTrackingEnabled.service&&(K.addNewChild(K.topId,7,"chatter",s.getSVGIconHTML(lsdIcons.chat)+customLabels.Chatter+"<i id='chatterArrowContext' class='fa fa-caret-right chatter-carret'></i>",!1),K.addNewChild("chatter",0,"chatter_welldone",s.getSVGIconHTML(lsdIcons.like)+customLabels.well_done,!1),K.addNewChild("chatter",1,"chatter_hurryup",s.getSVGIconHTML(lsdIcons.hurry)+customLabels.Hurry_up,!1),K.addNewChild("chatter",2,"chatter_requestupdate",s.getSVGIconHTML(lsdIcons.help)+customLabels.Request_update,!1),K.addNewChild("chatter",3,"chatter_custom",s.getSVGIconHTML(lsdIcons.threedots)+customLabels.Custom_message,!1)),s.customActionsPromise.then(function(){var e=s.getCustomActions("gantt");e.forEach(function(e,t){e.icon?K.addNewChild(K.topId,12+t,"custom_"+t,s.getSVGIconHTML(e.icon)+e.name,!1):K.addNewChild(K.topId,12+t,"custom_"+t,e.name,!1)})})}();var Q={};scheduler.attachEvent("onContextMenu",function(t,i){if(scheduler.config.readonly)return!0;if(t&&"service"!==scheduler.getEvent(t).type&&"break"!==scheduler.getEvent(t).type&&"na"!==scheduler.getEvent(t).type)return!1;if(t){K.hide(),Z.hide(),X.hide(),scheduler.dhtmlXTooltip.hide();var n=0,r=0;if(i.pageX||i.pageY?(n=i.pageX,r=i.pageY):(i.clientX||i.clientY)&&(n=i.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,r=i.clientY+document.body.scrollTop+document.documentElement.scrollTop),e.selectedGanttServices.getSelected().length<2)return"break"===scheduler._events[t].type?(X.removeItem("delete"),s.getCustomActions("na").forEach(function(e,t){X.removeItem("custom_"+t)}),s.getCustomActions("break").forEach(function(e,t){X.removeItem("custom_"+t)}),s.getCustomActions("break").forEach(function(e,t){X.addNewChild(K.topId,t+10,"custom_"+t,s.getSVGIconHTML(e.icon)+e.name,!1)}),X.showContextMenu(n,r),z=t,!1):"na"===scheduler._events[t].type?(X.removeItem("delete"),X.addNewChild(X.topId,1,"delete",s.getSVGIconHTML(lsdIcons["delete"])+customLabels.Delete,!1),s.getCustomActions("na").forEach(function(e,t){X.removeItem("custom_"+t)}),s.getCustomActions("break").forEach(function(e,t){X.removeItem("custom_"+t)}),s.getCustomActions("na").forEach(function(e,t){
X.addNewChild(K.topId,12+t,"custom_"+t,s.getSVGIconHTML(e.icon)+e.name,!1)}),X.showContextMenu(n,r),z=t,!1):(E(t),scheduler.getEvent(t).pinned||N(scheduler.getEvent(t).status),K.showContextMenu(n,r),j=t,!1);Z.removeItem("selectedNumber"),Z.addNewChild(Z.topId,0,"selectedNumber","<i class='fa fa-check-square-o'></i> "+customLabels.x_services_selected.replaceAll(e.selectedGanttServices.getSelected().length),!0),Z.removeItem("status"),Z.addNewChild(Z.topId,4,"status",s.getSVGIconHTML(lsdIcons.replace)+customLabels.Change_status+"<i class='fa fa-caret-right status-change-carret'></i>",!1),Q={};var a=0;for(var o in s.statuses){var c="ContextMenu_"+s.statusTranslations[s.statuses[o]].split(" ").join("");Z.addNewChild("status",a,"status_change_"+a,"<span class='StatusColorChanger "+c+" "+s.getCSSClassForContext(s.statusTranslations[s.statuses[o]],C)+"'></span>"+s.statusTranslations[s.statuses[o]],!1),Q["status_change_"+a++]=s.statuses[o]}return Z.showContextMenu(n,r),!1}return j="",z="",!0}),K.attachEvent("onShow",function(e){contextShown=!0}),K.attachEvent("onHide",function(e){contextShown=!1}),X.attachEvent("onShow",function(e){contextShown=!0}),X.attachEvent("onHide",function(e){contextShown=!1}),K.attachEvent("onClick",function(t,i,a){e.$evalAsync(function(){switch(t){case"details":s.safeApply(e,function(){y.open(j)});break;case"consoleTab":e.openConsoleTab(null,j);break;case"flag":e.$evalAsync(function(){r.flagged[j]=!r.flagged[j],scheduler.updateEvent(j)});break;case"pin":r.changePin([scheduler._events[j].id],!scheduler._events[j].pinned).then(function(){return updateViewDebounced()});break;case"reschedule":e.$evalAsync(function(){r.autoScheduleService(j).then(function(e){0===e.services.length&&alert(customLabels.NoCandidates),r.drawServicesAndAbsences(e.services,e.absences)})["catch"](function(e){var t=d.serviceAppointments()[j].name;s.addNotification(t+" - "+customLabels.Action_Could_Not_Be_Performed,e.message,function(){y.open(j)})})});break;case"reshuffle":e.$evalAsync(function(){n.runReshuffle(j,v.selectedPolicyId).then(function(e){f.updateOptimizationRequest(e)},function(){s.addNotification(customLabels.Action_Could_Not_Be_Performed,err.message)})});break;case"groupNearby":e.$evalAsync(function(){n.runGroupNearby(j,v.selectedPolicyId).then(function(e){f.updateOptimizationRequest(e)},function(){s.addNotification(customLabels.Action_Could_Not_Be_Performed,err.message)})});break;case"candidates":D.get(j);break;case"chatter_welldone":O([j],customLabels.Well_done_mate);break;case"chatter_hurryup":O([j],customLabels.hurry_up_with_this_service);break;case"chatter_requestupdate":O([j],customLabels.please_update_service);break;case"chatter_custom":O([j],"");break;case"unschedule":e.$evalAsync(function(){H([j])});break;case"map":e.showOnMap(j);break;case"showRelated":if(usingNewMstModel)return void R.open("Related Services For "+scheduler._events[j].name,mstPage+"?ingantt=true&id="+j);if(scheduler._events[scheduler._events[j].relatedFather])return void s.showOnGantt(scheduler._events[j].relatedFather);if(scheduler._events[scheduler._events[j].relatedTo])return void s.showOnGantt(scheduler._events[j].relatedTo);scheduler._events[j].relatedFather?alert(customLabels.related_x_not_scheduled_no_display.replaceAll(d.serviceAppointments()[scheduler._events[j].relatedFather].name)):alert(customLabels.related_x_not_scheduled_no_display.replaceAll(d.serviceAppointments()[scheduler._events[j].relatedTo].name));break;default:if(0===t.indexOf("custom_")){var i=parseInt(t.split("_")[1]),a=[j],o=s.getCustomActions("gantt")[i];if(o.visualforce){var c=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),l=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();R.open(o.name,o.visualforce+"?id="+j+"&start="+c+"&end="+l);break}n.runCustomServiceAction(o.className,a,scheduler._min_date,scheduler._max_date).then(function(e){e&&s.addNotification(o.name,e,null,null)})["catch"](function(e){return s.addNotification(o.name,e.message,null,null)});break}e.$evalAsync(function(){V([j],Q[t])})}})}),$(".dhtmlxMenu_dhx_skyblue_SubLevelArea_Polygon").mouseover(function(){scheduler.dhtmlXTooltip.hide()}),Z.addNewChild(Z.topId,1,"flag",s.getSVGIconHTML(lsdIcons.flag)+customLabels.Flag,!1),Z.addNewChild(Z.topId,2,"unflag","<span class='emptyFlag'>"+s.getSVGIconHTML(lsdIcons.flag)+"</span>"+customLabels.Unflag,!1),Z.addNewChild(Z.topId,3,"reschedule",s.getSVGIconHTML(lsdIcons.calendar)+customLabels.Reschedule,!1),Z.addNewChild(Z.topId,5,"unschedule",s.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,!1),Z.addNewChild(Z.topId,7,"pin",s.getSVGIconHTML(lsdIcons.pin)+customLabels.Pin,!1),Z.addNewChild(Z.topId,8,"unpin","<span class='emptyFlag'>"+s.getSVGIconHTML(lsdIcons.unpin)+"</span>"+customLabels.Unpin,!1),s.customActionsPromise.then(function(){var e=s.getCustomActions("gantt");e.forEach(function(e,t){e.icon?Z.addNewChild(Z.topId,t+12,"custom_"+t,s.getSVGIconHTML(e.icon)+e.name,!1):Z.addNewChild(Z.topId,t+12,"custom_"+t,e.name,!1)})}),Z.attachEvent("onShow",function(e){contextShown=!0}),Z.attachEvent("onHide",function(e){contextShown=!1}),Z.attachEvent("onClick",function(t,i,a){e.$evalAsync(function(){switch(t){case"flag":s.safeApply(e,function(){G(!0)});break;case"unflag":s.safeApply(e,function(){G(!1)});break;case"reschedule":A.schedule(e.selectedGanttServices.getSelected());break;case"pin":r.changePin(e.selectedGanttServices.getSelected(),!0).then(function(){return updateViewDebounced()});break;case"unpin":r.changePin(e.selectedGanttServices.getSelected(),!1).then(function(){return updateViewDebounced()});break;case"unschedule":H(e.selectedGanttServices.getSelected());break;default:if(0===t.indexOf("custom_")){var i=parseInt(t.split("_")[1]),a=e.selectedGanttServices.getSelected(),o=s.getCustomActions("gantt")[i];if(o.visualforce){var c=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),l=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();R.open(o.name,o.visualforce+"?services="+a.join(",")+"&start="+c+"&end="+l);break}n.runCustomServiceAction(o.className,e.selectedGanttServices.getSelected(),scheduler._min_date,scheduler._max_date).then(function(e){e&&s.addNotification(o.name,e,null,null)})["catch"](function(e){return s.addNotification(o.name,e.message,null,null)});break}V(e.selectedGanttServices.getSelected(),Q[t])}})}),e.lockGanttToggle=function(){scheduler.config.readonly=!scheduler.config.readonly,e.ganttLocked=scheduler.config.readonly,o.SetUserSettingsProperty("Lock_Gantt__c",e.ganttLocked)},e.unSelecteAllSkills=function(){for(var t in e.selectedSkills)e.selectedSkills[t]=!1},e.selectAllSkills=function(){for(var t in e.selectedSkills)e.selectedSkills[t]=!0},m.promises.skills().then(function(t){e.skills=t}),scheduler.attachEvent("onYScaleClick",function(e,t,i){window.__lastResourceClicked=t;for(var n=["resourceMenuBtn","resourceMenuIcon"],r=0;r<n.length;r++)if(i.target.classList&&i.target.classList.contains(n[r])||i.target.parentNode&&i.target.parentNode.classList.contains(n[r]))return void h.open(t.resourceId,t.key,i.target);t.children||b.open(t.resourceId,t.key)}),scheduler.attachEvent("onBeforeTooltip",function(e){return setTimeout(function(){var e=$(".dhtmlXTooltip");0!==e.length&&(e.position().top<0?e.css("height",e.height()+e.position().top-15+"px"):e.position().top>15&&e.css("height","initial"))},400),!0}),e.$on("keypress",function(t,i){if($("#MonthlyViewTooltip").remove(),!v.isLightboxOpened()&&!$("*:focus").is("textarea, input"))switch(i.which){case 13:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&(r.recentlyUsed[scheduler._selected_id]=!0,y.open(scheduler._select_id));break;case 37:$(".dhx_cal_prev_button").click();break;case 38:var n=$(".dhx_cal_data").scrollTop();$(".dhx_cal_data").scrollTop(n-30);break;case 39:$(".dhx_cal_next_button").click();break;case 40:n=$(".dhx_cal_data").scrollTop(),$(".dhx_cal_data").scrollTop(n+30);break;case 87:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&scheduler.getEvent(scheduler._select_id).parentRecord&&(e.isInConsole()?sforce.console.generateConsoleUrl(["/"+scheduler._events[scheduler._select_id].parentRecord],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):s.openLightningPrimaryTab(scheduler._events[scheduler._select_id].parentRecord)}):window.open("../"+scheduler._events[scheduler._select_id].parentRecord));break;case 83:""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&!scheduler.getEvent(scheduler._select_id).isDummy&&(e.isInConsole()?sforce.console.generateConsoleUrl(["/"+scheduler._select_id],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):s.openLightningPrimaryTab(scheduler._select_id)}):window.open("../"+scheduler._select_id));break;case 84:e.jumpToToday();break;case 70:1===e.selectedGanttServices.getSelected().length&&""!==scheduler._select_id&&scheduler._select_id&&"service"===scheduler.getEvent(scheduler._select_id).type&&(r.flagged[scheduler._select_id]?(r.flagged[scheduler._select_id]=!1,scheduler.updateEvent(scheduler._select_id)):(r.flagged[scheduler._select_id]=!0,scheduler.updateEvent(scheduler._select_id)));break;case 48:e.changeTimeline(0);break;case 96:e.changeTimeline(0);break;case 49:e.changeTimeline(1);break;case 97:e.changeTimeline(1);break;case 50:e.changeTimeline(2);break;case 98:e.changeTimeline(2);break;case 51:e.changeTimeline(3);break;case 99:e.changeTimeline(3);break;case 55:e.changeTimeline(7);break;case 77:s.hasCustomPermission("MDT_View")&&monthlyViewSettings.isMonthlyAvailable&&e.changeTimeline(35);break;case 85:s.hasCustomPermission("Monthly_Utilization")&&monthlyViewSettings.isMonthlyAvailable&&e.changeTimeline(30);break;case 103:e.changeTimeline(7)}}),e.changeTimeline=function(t){var i=scheduler._min_date,n=scheduler._max_date,r=void 0;switch(t){case 0:if(r="ZoomLevel2",r===scheduler._mode)return;e.timelineName=customLabels.In_Day;break;case 1:if(r="ZoomLevel3",r===scheduler._mode)return;e.timelineName=customLabels.Daily;break;case 2:if(r="ZoomLevel4",r===scheduler._mode)return;e.timelineName=customLabels.X2_Days;break;case 3:if(r="ZoomLevel5",r===scheduler._mode)return;e.timelineName=customLabels.X3_Days;break;case 7:if(r="ZoomLevel6",r===scheduler._mode)return;e.timelineName=customLabels.Weekly;break;case 30:if(r="MonthlyView",r===scheduler._mode)return;e.timelineName=customLabels.Utilization;break;case 35:if(r="MTDView",r===scheduler._mode)return;e.timelineName=customLabels.MDTVIEW}scheduler.setCurrentView(i,r),e.changeDatesByArrows(n)},setInterval(B,6e5),e.jumpToToday=function(){var t=new Date;t.setHours(0),t.setMinutes(0),t.setSeconds(0),t.setMilliseconds(0),scheduler.setCurrentView(t),e.changeDatesByArrows()},t.$on("afterShowEvent",function(){setTimeout(function(){e.changeDatesByArrows(),B(),updateViewDebounced()},800)}),e.showOnMap=function(i){t.$broadcast("showServiceOnMap",i),s.safeApply(e)},scheduler.attachEvent("onBeforeEventChanged",function(e,t,i,n){var s=void 0,a=void 0,o=void 0,c=void 0;if(r.handleSnap(e,t),e.resourceId===n.resourceId){if(s=e.start_date.getTime(),a=e.end_date.getTime(),o=n.start_date.getTime(),c=n.end_date.getTime(),Math.abs((s-o)/1e3/60)<minDragMinutes||Math.abs((a-c)/1e3/60)<minDragMinutes)return cachedDomElements.timesDragFix.hide(),!1}else if("na"===e.type)return!1;if(v.areContractorsSupported()&&"service"===e.type&&u.getResources()[e.getGanttResource()].isCapacityBased){for(var l in d.resourceCapacities()){var p=d.resourceCapacities()[l];if(p.resource===u.getResources()[e.getGanttResource()].id&&e.start.getTime()>=p.start_date.getTime()&&e.start.getTime()<=p.end_date.getTime())return e.resourceBeforeDrag=n.resourceId,e.eventBeforeDrag=n,U(e),!0}return cachedDomElements.timesDragFix.hide(),alert(customLabels.serviceCantBeAssignedWithoutCapacity),!1}return q=GanttService.copy(n),snapTo=t.ctrlKey,U(e),e.resourceBeforeDrag=n.resourceId,e.eventBeforeDrag=n,!0}),e.updateMonthlyKpi=function(){"MonthlyView"===scheduler._mode&&updateViewDebounced(),ee()};var ee=_.debounce(function(){o.SetUserSettingsProperty("Utilization_Properties__c",JSON.stringify(e.capacityFields))},800);e.cancelCrewView=function(){e.crewViewActive=!1,d.isCrewViewActive=!1},t.$on("gotNewTimePhasedObjects",function(e,t){r.drawServicesAndAbsences(t.serviceAppointments,t.resourceAbsences,[],t.resourceCapacities)}),t.$on("timePhasedObjectsCheckRules",function(e,t){r.checkRules(t).then(r.drawViolationsOnGantt)}),n.isStreamingShouldBeActive().then(function(e){"true"===e?v.setStreamingActiveState(!0):(v.setStreamingActiveState(!1),"false"!==e&&s.addNotification(customLabels.GanttLiveRefreshNotSupported,e,null,null)),I.initStreaming()}),x.register("services",function(e){r.drawServicesAndAbsences(e.updated||[],[],e.deleted||[])}),x.register("absences",function(e){r.drawServicesAndAbsences([],e.updated||[],e.deleted||[])}),x.register("capacities",function(e){r.drawServicesAndAbsences([],[],e.deleted||[],e.updated||[])}),x.register("rules",function(e){r.checkRules(e).then(r.drawViolationsOnGantt)}),scheduler.attachEvent("onEventChanged",function(t,i){("service"===i.type||"na"===i.type)&&s.safeApply(e,function(){return"na"===i.type?void g.saveChangesToAbsence(q,i).then(function(e){})["catch"](function(e){console.warn("Couldn't update absence"),e[0].error?s.addNotification(customLabels.Action_Could_Not_Be_Performed,e[0].error):s.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action),scheduler.parse([e[1]],"json")}):void r.saveChangesToServiceAppointment(q,i).then(function(e){})["catch"](function(e){console.warn("Couldn't update service. "+e[2]),s.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2]||e[0].message.substr(e[0].message.indexOf(",")+1)||customLabels.user_is_not_allowed_to_perform_action),scheduler.parse([e[1]],"json")})})}),e.$on("JumpToDate",function(t,i){scheduler.setCurrentView(i),e.changeDatesByArrows()}),e.$on("GotSlots",function(t,i){var n=getMinAndMaxHoursToDisplay();(i.minDateOfCandidate.getHours()<n.min||i.minDateOfCandidate.getHours()>=n.max)&&confirm(customLabels.confirmChangeBusinessHours)&&(i.minDateOfCandidate.getHours()<n.min?e.businessHoursRange.start=i.minDateOfCandidate.getHours():e.businessHoursRange.end=24,M())}),e.changeUtilizaionDays=function(t){(-1!==t||1!==e.numberOfDaysInUtilizationView)&&(1!==t||30!==e.numberOfDaysInUtilizationView)&&(e.numberOfDaysInUtilizationView+=t,e.daysInUtilizationChanged())},e.daysInUtilizationChanged=function(){scheduler.matrix.MonthlyView.x_size=e.numberOfDaysInUtilizationView,o.SetUserSettingsProperty("DaysInUtilizationView__c",e.numberOfDaysInUtilizationView),"MonthlyView"===scheduler._mode&&(scheduler.updateView(),e.getTimePhasedObjects())}}])}(),function(){angular.module("serviceExpert").controller("mainController",["$scope","StateService",function(e,t){e.isOSX=t.isOSX,e.lang=t.lang}])}(),function(){angular.module("serviceExpert").controller("ctrlMap",["$scope","sfdcService","$rootScope","$q","userSettingsManager","servicesService","bulkScheduleService","$timeout","$filter","utils","ServiceAppointmentLightboxService","ResourceLightboxService","TimePhasedDataService","FieldSetFieldsService","ResourcesAndTerritoriesService","LastKnownPositionService","DeltaService","SERVICE_STATUS","SERVICE_CATEGORY","DRAWING_STATES","StreamingAPIService","RegisterService","GeneralLightbox",function(e,t,i,n,r,s,a,o,c,l,u,d,v,p,h,g,m,f,S,b,y,T,w){function L(t){e.allMarkersArray=[],e.showResources&&F(),e.showServices&&M(),e.showLivePositions&&R(),e.showTerritories&&N(),D(t)}function C(t){var i=t.type;switch(e.serviceInfoWindow.show=!1,e.resourceInfoWindow.show=!1,e.territoryInfoWindow.show=!1,e.reportInfoWindow.show=!1,e.livePosInfoWindow.show=!1,e.currentMarker=t,i){case"service":e.serviceInfoWindow.show=!0,e.currentMarker.item=v.serviceAppointments()[t.id];break;case"lastKnownPosition":e.livePosInfoWindow.show=!0;break;case"resource":e.resourceInfoWindow.show=!0;break;case"territory":e.territoryInfoWindow.show=!0;break;case"report":e.reportFields=[],e.reportFields.push.apply(e.reportFields,t.item.otherProperties),e.reportInfoWindow.show=!0}o(function(){e.$apply(),l.setMapCloseButtonPosition()},0)}function k(){e.resourcesFilterList=[];var t=scheduler.getState().min_date,i=scheduler.getState().max_date,n=v.resourcesAndTerritories(),r=h.getResources();for(var s in r){var a=n[s],o=r[s];for(var c in a){var l=a[c];if(isIntersect(t,i,l.effectiveStartDate,l.effectiveEndDate)){e.resourcesFilterList.push({label:o.name,value:o.id});break}}}}function D(t){var i=maxReportMarkers;for(var n in e.reportsData){var r=e.reportsData[n];if(r.show){r.displayCount=0;for(var s=0;s<r.data.length;s++){var a=r.data[s];if(0==i){t&&(e.showTooManyReportsAlert=!0);break}var o=A(a,n+r.displayCount);o&&(r.displayCount++,i--)}}}}function A(t,i){if(t.latitude){var n=staticResources.report;"ServiceAppointment"===t.sObjectType?n=staticResources.service_png:void 0!==staticResources[t.sObjectType.toLowerCase().replace(/ /g,"_")]&&(n=staticResources[t.sObjectType.toLowerCase().replace(/ /g,"_")]);var r={id:i,icon:n,type:"report",coords:{latitude:t.latitude,longitude:t.longitude},item:t};return e.allMarkersArray.push(r),!0}}function R(){var e=scheduler.getState().min_date,t=scheduler.getState().max_date,i=v.resourcesAndTerritories(),n=g.lastKnownPositions();for(var r in n){var s=i[r];for(var a in s){var o=s[a];if(isIntersect(e,t,o.effectiveStartDate,o.effectiveEndDate)){I(n[r]);break}}}}function I(t){var i=h.getResources()[t.id];if(e.isEmpty(e.filteredResources)||e.filteredResources[i.id]){var n={id:t.id+"_position",icon:staticResources.livepos_png,type:"lastKnownPosition",resourceId:t.id,coords:{latitude:t.latitude,longitude:t.longitude},item:angular.extend(angular.copy(t),{resourceName:i.name})};n.item.lastModifiedDate=l.convertDateBetweenTimeZones(n.item.lastModifiedDate,"UTC",userTimeZone),e.allMarkersArray.push(n)}}function F(){var e=scheduler.getState().min_date,t=scheduler.getState().max_date,i=v.resourcesByPrimariesAndRelocations();for(var n in i){var r=i[n];for(var s in r){var a=r[s];isIntersect(e,t,a.effectiveStartDate,a.effectiveEndDate)&&x(a)}}}function x(t){if(t.latitude){var i=h.getResources()[t.serviceResource];if(i&&(e.isEmpty(e.filteredResources)||e.filteredResources[i.id])){var n={id:t.id,icon:staticResources.homebase_png,type:"resource",resourceId:i.id,serviceTerritory:t.serviceTerritory,coords:{latitude:t.latitude,longitude:t.longitude},item:angular.extend(angular.copy(t),{resourceName:i.name})};e.allMarkersArray.push(n)}}}function M(){for(var t=e.filteredServices.servicesArray,i=0;i<t.length;i++){var n=t[i];n.id!=e.currentShowOnMapServiceId&&E(n)}e.currentShowOnMapServiceId&&E(v.serviceAppointments()[e.currentShowOnMapServiceId])}function O(e,t){for(var i=new google.maps.LatLngBounds,n=0;n<e.length;n++){var r=t?e[n].coords.latitude:e[n].latitude,s=t?e[n].coords.longitude:e[n].longitude;if(r&&s){var a=new google.maps.LatLng(r,s);i.extend(a)}}return i}function P(){var t=new google.maps.LatLng(37.794024,-122.394837),i=e.filteredServices.servicesArray,n=O(i);n.isEmpty()&&(n=O(_.values(v.serviceAppointments()))),n.isEmpty()?e.map.setCenter(t):e.map.fitBounds(n)}function E(t){if(!t.latitude)return!1;if(!e.showServices)return!1;var i=t.getGanttResource();if(!(e.isEmpty(e.filteredResources)||null!=i&&e.filteredResources[i]))return!1;var n=staticResources.service_png;t.statusCategory==S.COMPLETED&&(n=staticResources.service_completed_png);var r={id:t.id,icon:n,type:"service",animation:2,coords:{latitude:t.latitude,longitude:t.longitude},item:t};e.allMarkersArray.push(r)}function N(){var t=h.territories;for(var i in t)t[i].latitude&&e.allMarkersArray.push({id:i,icon:staticResources.territory_map_icon,type:"territory",animation:2,coords:{latitude:t[i].latitude,longitude:t[i].longitude},item:t[i]})}function G(t,i){if(e.polygons[t])e.polygons[t].polygon.setVisible(i),U(t,i);else if(h.territories[t]||"NoTerritoryPolygon"==t){U(t);for(var n=e.myTreeView.getSubItems(t),r=0;r<n.length;r++)B(n[r],i)}V()}function B(t,i){i?e.myTreeView.checkItem(t):e.myTreeView.uncheckItem(t)}function H(){var e=r.GetUserSettingsProperty("Invisible_Polygons__c");return void 0==e?[]:JSON.parse(r.GetUserSettingsProperty("Invisible_Polygons__c"))}function V(){return r.SetUserSettingsProperty("Invisible_Polygons__c",JSON.stringify(e.InvisiblePolygons))}function U(t,i){for(var n=0;n<e.InvisiblePolygons.length;n++)if(e.InvisiblePolygons[n]==t)return void e.InvisiblePolygons.splice(n,1);i||e.InvisiblePolygons.push(t)}function j(t){if(t)for(var i=0;i<t.length;i++)t[i][fieldNames.Polygon.KML__c]&&(e.polygons[t[i].Id]=t[i])}function z(){function t(e){if(e.id&&e.parent){if(s[e.parent.id])return e.parent;var i={};return h.allTerritories[e.parent.id]&&(i={id:h.allTerritories[e.parent.id].id,parent:h.allTerritories[e.parent.id].parentTerritory?h.allTerritories[e.parent.id].parentTerritory:0}),t(i)}}var i=n.defer(),r=h.territories,s={},a=[],o=(l.getFilteredLocations(),{NoTerritoryPolygon:{id:"NoTerritoryPolygon"}});for(var c in e.polygons)s[c]={id:c,parent:e.polygons[c][fieldNames.Polygon.Service_Territory__c]?r[e.polygons[c][fieldNames.Polygon.Service_Territory__c]]:o.NoTerritoryPolygon,text:e.polygons[c].Name,icons:{file:"fa-square"},icon_color:e.polygons[c][fieldNames.Polygon.Color__c],checked:-1==e.InvisiblePolygons.indexOf(c)?1:0,items:[]};for(var u in r)s[u]={id:u,parent:h.territories[u].parentTerritory?h.territories[u].parentTerritory:0,text:h.territories[u].name,icons:{file:"fa-building-o"},checked:-1==e.InvisiblePolygons.indexOf(u)?1:0,items:[]};s.NoTerritoryPolygon={id:"NoTerritoryPolygon",parent:0,text:customLabels.Polygons_without_Service_Territory,icons:{file:"fa-building-o"},checked:-1==e.InvisiblePolygons.indexOf("NoTerritoryPolygon")?1:0,items:[]};for(var d in s){var v=s[d],p=t(v);0!==v.parent&&p?s[p.id].items.push(v):a.push(v)}return i.resolve(a),i.promise}function q(){if(e.geoXmlParser=new geoXML3.parser({map:e.map,suppressInfoWindows:!0,zoom:!1}),!e.isEmpty(e.polygons)){var t=0;try{for(var i in e.polygons){e.geoXmlParser.parseKmlString(e.polygons[i][fieldNames.Polygon.KML__c]);for(var n=0;n<e.geoXmlParser.docs[t].placemarks.length;n++)if(e.geoXmlParser.docs[t].placemarks[n].polygon){e.geoXmlParser.docs[t].placemarks[n].id=e.polygons[i].Id,e.geoXmlParser.docs[t].placemarks[n].polygon.id=e.polygons[i].Id,e.geoXmlParser.docs[t].placemarks[n].polygon.name=e.polygons[i].Name,e.geoXmlParser.docs[t].placemarks[n].polygon.territory=e.polygons[i][fieldNames.Polygon.Service_Territory__c];var r=-1==e.InvisiblePolygons.indexOf(i)?!0:!1;e.geoXmlParser.docs[t].placemarks[n].polygon.setVisible(r),e.geoXmlParser.docs[t].placemarks[n].polygon.addListener("click",function(){e.shouldBound=!1,he.hide(),Z(this)}),e.geoXmlParser.docs[t].placemarks[n].polygon.addListener("rightclick",ae),e.polygons[i].polygon=e.geoXmlParser.docs[t].placemarks[n].polygon}t++}}catch(s){alert("Problem parsing KML string"),console.error(s)}}}function W(){google.maps.event.addListener(e.drawingManager,"overlaycomplete",function(t){var i=t.overlay;return e.cancelDrawingShape?(e.cancelDrawingShape=!1,void i.setMap(null)):(i.type=t.type,i.set("fillColor",e.selectedColor),i.set("name",e.polygonName),i.set("territory",e.polygonTerritory),e.drawingManager.setDrawingMode(null),google.maps.event.addListener(i,"click",function(e){if(void 0!==e.vertex&&i.type===google.maps.drawing.OverlayType.POLYGON){var t=i.getPaths().getAt(e.path);t.removeAt(e.vertex),t.length<3&&i.setMap(null)}Z(i)}),void Z(i))}),"function"!=typeof google.maps.Polygon.prototype.ToWKT&&(google.maps.Polygon.prototype.ToWKT=function(){for(var e=this,t="POLYGON(",i=e.getPaths(),n=0;n<i.getLength();n++){var r=i.getAt(n);t+="(";for(var s=0;s<r.getLength();s++)t+=r.getAt(s).lng().toString()+" "+r.getAt(s).lat().toString()+",";t+=r.getAt(0).lng().toString()+" "+r.getAt(0).lat().toString()+"),"}return t=t.substring(0,t.length-1)+")"})}function K(){e.selectedShape&&("marker"!==e.selectedShape.type&&e.selectedShape.setEditable(!1),e.selectedShape.set("strokeWeight",1),e.selectedShape=null,e.currentEditPolygon=null,e.polygonName="",e.polygonTerritory="null"),e.drawState=e.drawState==b.DRAW?b.EDIT:b.NONE}function Z(t){if(this&&(t=this),e.drawState==b.INTERSECT){if(e.currentIntersectingId==t.id)return;return e.selectedIntersectingPolygons[t.id]?delete e.selectedIntersectingPolygons[t.id]:e.selectedIntersectingPolygons[t.id]=!0,void e.$apply()}"marker"!==t.type&&(K(),e.selectedColor=e.selectedShapeColor=t.get("fillColor"),e.drawState!=b.EDIT&&(e.drawState=b.SELECTED)),e.polygonName=t.name,e.polygonTerritory=t.territory||"null",e.selectedShape=t,Y(),t.id!=e.myTreeView.getSelectedId()&&(e.shouldBound=!1,e.myTreeView.selectItem(t.id)),e.$apply()}function J(t){e.selectedShape&&(e.selectedShape.set("fillColor",t),e.selectedShapeColor=t),e.selectedColor=t}function Y(){e.selectedShape&&e.selectedShape.set("strokeWeight",3)}function X(){e.selectedShape&&(e.selectedShape.setMap(null),o(function(){e.currentEditPolygon&&re(e.currentEditPolygon),e.polygonName="",e.polygonTerritory="null"},0))}function Q(t){var i=e.drawingManager.get("polygonOptions");i.fillColor=t,e.drawingManager.set("polygonOptions",i)}function ee(t,i){i&&e.myTreeView.deleteItem(i);var n=t[fieldNames.Polygon.Service_Territory__c]?t[fieldNames.Polygon.Service_Territory__c]:"NoTerritoryPolygon";e.myTreeView.addItem(t.Id,t.Name,n),e.myTreeView.checkItem(t.Id),e.myTreeView.setItemIcons(t.Id,{file:"fa-square"}),e.myTreeView.setIconColor(t.Id,t[fieldNames.Polygon.Color__c])}function te(e,t){return t+e.substring(5,7)+e.substring(3,5)+e.substring(1,3)}function ie(e){for(var t="",i=0;i<e.length;i++)t+=e[i].lng+","+e[i].lat+",0\n";return t+=e[0].lng+","+e[0].lat+",0"}function ne(e,t,i){return'<?xml version="1.0" encoding="UTF-8"?> \n                            <kml xmlns="http://www.opengis.net/kml/2.2">\n                                <Style id="'+i.replace(" ","")+'Style"> \n                                    <LineStyle> \n                                        <width>1</width> \n                                    </LineStyle> \n                                    <PolyStyle> \n                                        <color>'+te(t,80)+"</color> \n                                    </PolyStyle> \n                                </Style> \n                                <Placemark> \n                                    <name>"+i.replace(" ","")+"</name> \n                                    <styleUrl>#"+i.replace(" ","")+"Style</styleUrl> \n                                    <Polygon> \n                                        <outerBoundaryIs> \n                                            <LinearRing>\n                                                <coordinates>"+ie(e)+"</coordinates> \n                                            </LinearRing> \n                                        </outerBoundaryIs> \n                                    </Polygon> \n                                </Placemark> \n                            </kml>"}function re(t){e.geoXmlParser.parseKmlString(t[fieldNames.Polygon.KML__c]);for(var i=e.geoXmlParser.docs.length-1,n=0;n<e.geoXmlParser.docs[i].placemarks.length;n++)e.geoXmlParser.docs[i].placemarks[n].id=t.Id,e.geoXmlParser.docs[i].placemarks[n].polygon.id=t.Id,e.geoXmlParser.docs[i].placemarks[n].polygon.name=t.Name,e.geoXmlParser.docs[i].placemarks[n].polygon.territory=t[fieldNames.Polygon.Service_Territory__c],e.geoXmlParser.docs[i].placemarks[n].polygon.addListener("click",function(){e.shouldBound=!1,he.hide(),Z(this)}),e.geoXmlParser.docs[i].placemarks[n].polygon.addListener("rightclick",ae),e.polygons[t.Id]=t,e.polygons[t.Id].polygon=e.geoXmlParser.docs[i].placemarks[n].polygon}function se(e,t){t=t||{},this.setMap(e),this.mapDiv=e.getDiv(),this.menuItems=t.menuItems||{},this.isVisible=!1}function ae(t){he.hide(),this.clickedPolygon_=this,Z(this);var i=he.getProjection(),n=i.fromLatLngToDivPixel(t.latLng);he.show(n),e.map.setOptions({draggableCursor:"pointer"})}function oe(i){switch(i){case"menu-edit-polygon":e.mapOptionsToggle=!0,$(".polygonsTab").click(),e.editPolygon();break;case"menu-intersect-polygon":e.mapOptionsToggle=!0,$(".polygonsTab").click(),e.currentIntersectingId=angular.copy(e.selectedShape.id),e.drawState=b.INTERSECT,e.$apply();break;case"menu-delete-polygon":e.deletePolygon();break;case"menu-schedule-polygon":a.schedule(ce(e.selectedShape)),e.$apply();break;case"menu-unschedule-polygon":s.unscheduleServices(ce(e.selectedShape));break;case"menu-dispatch-polygon":s.changeStatus(ce(e.selectedShape),f.DISPATCHED).then(function(e){s.drawServicesAndAbsences(e.services)})["catch"](function(e){l.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)});break;case"menu-joepardy-polygon":s.setInJeopardy(ce(e.selectedShape));break;default:if(0===i.indexOf("custom_")){var n=parseInt(i.split("_")[1]),r=ce(e.selectedShape),o=l.getCustomActions("map")[n];if(o.visualforce){var c=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),u=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();1===r.length?w.open(o.name,o.visualforce+"?id="+r[0]+"&start="+c+"&end="+u):w.open(o.name,o.visualforce+"?services="+r.join(",")+"&start="+c+"&end="+u);break}t.runCustomServiceAction(o.className,ce(e.selectedShape),scheduler._min_date,scheduler._max_date).then(function(e){e&&l.addNotification(o.name,e,null,null)})["catch"](function(e){return l.addNotification(o.name,e.message,null,null)});break}}}function ce(t){for(var i=[],n=0;n<e.filteredServices.servicesArray.length;n++){var r=e.filteredServices.servicesArray[n];if(null!=r.latitude&&null!=r.longitude){var s=new google.maps.LatLng(r.latitude,r.longitude);google.maps.geometry.poly.containsLocation(s,t)&&i.push(r.id)}}return i}function le(t){for(var i=t.slice(9,t.length-2).split(","),n=[],r=0;r<i.length;r++){var s=i[r].split(" ");n.push(new google.maps.LatLng({lat:parseFloat(s[1]),lng:parseFloat(s[0])}))}e.selectedShape.setPath(n),e.savePolygon(),e.selectedIntersectingPolygons={}}e.SERVICE_STATUS=f,e.invokedActions={},e.allMarkersArray=[],e.reports={},e.reportsData={},e.map=null,e.markersControl={},e.territoriesMarkers=[],e.firstMapShow=!0,e.trafficLayerEnabled=!1,e.mapControl={},e.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP}};var ue={services:!0,resources:!0,positions:!0,territories:!0},de=JSON.parse(r.GetUserSettingsProperty("Map_Object_Markers__c"))||ue;e.showServices=de.services,e.showResources=de.resources,e.showLivePositions=de.positions,e.showTerritories=de.territories,e.showOnMap=!1,e.setMapMarkerUserSettings=function(){r.SetUserSettingsProperty("Map_Object_Markers__c",JSON.stringify({services:e.showServices,resources:e.showResources,positions:e.showLivePositions,territories:e.showTerritories}))},e.showTooManyReportsAlert=!1,e.resourcesFilterList=[],e.filterResourceInputValue="",e.filteredResources={},e.selectedReport="null",e.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},resource:{pixelOffset:new google.maps.Size(0,-38)},report:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)}},e.serviceInfoWindow={show:!1,control:{}},e.resourceInfoWindow={show:!1,control:{}},e.territoryInfoWindow={show:!1,control:{}},e.reportInfoWindow={show:!1,control:{}},e.livePosInfoWindow={show:!1,control:{}},e.filteredServices=s.filteredServices,
e.filter=s.filter,e.currentShowOnMapServiceId=null,e.drawingStates=b,e.drawState=b.NONE,e.selectedShape=null,e.selectedShapeColor=e.selectedColor,e.drawingManager,e.setSelectedShapeColor=J,e.polygons={},e.polygonName="",e.polygonTerritory="null",e.territories={},e.selectedIntersectingPolygons={},e.shouldBound=!0,e.cancelDrawingShape=!1,e.InvisiblePolygons=H(),e.hasCustomPermission=l.hasCustomPermission,e.getServiceInfoRowClass=l.getServiceInfoRowClass,e.pinnedStatusesSF=CustomSettings.pinnedStatusesSF,e.getReportsError=function(){return e.reportsError},l.getReports().then(function(t){if(t)for(var i=0;i<t.length;i++)e.reports[t[i].Id]=t[i]})["catch"](function(t){e.reportsError=!0}),g.getLastKnownPositions(),e.redrawAllMarkers=L,e.$watch("workingState",function(t){"map"==t?(e.map=e.mapControl.getGMap(),o(function(){if(k(),L(),google.maps.event.trigger(e.mapControl.getGMap(),"resize"),e.firstMapShow){e.showOnMap||P();var t=e.map.getStreetView(),i={fullscreenControl:!1,addressControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER}};t.setOptions(i);var n={fillOpacity:.5,strokeWeight:1,editable:!0,draggable:!0,fillColor:e.selectedColor};e.drawingManager=new google.maps.drawing.DrawingManager({drawingMode:null,drawingControl:!1,drawingControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER,drawingModes:["polygon"]},polygonOptions:n,rectangleOptions:n}),e.drawingManager.setMap(e.map),W(),q(),google.maps.event.addListener(e.map,"click",function(){e.map.setOptions({draggableCursor:"grab"}),he.hide()}),he=new se(e.map,ve),e.firstMapShow=!1,e.showOnMap=!1}},0)):e.currentShowOnMapServiceId=null}),e.$on("resizeMap",function(t,i){google.maps.event.trigger(e.mapControl.getGMap(),"resize")}),e.$on("showServiceOnMap",function(t,n){e.currentShowOnMapServiceId=n,i.$broadcast("changeWorkingState","map"),e.map=e.mapControl.getGMap(),e.showOnMap=!0,o(function(){google.maps.event.trigger(e.mapControl.getGMap(),"resize");var t=v.serviceAppointments()[n],i=new google.maps.LatLng(t.latitude,t.longitude);e.map.setCenter(i),e.map.setZoom(20),o(function(){e.markersControl.getPlurals().get(n)&&e.markersControl.getPlurals().get(n).gObject.setAnimation(google.maps.Animation.BOUNCE),o(function(){var t=e.markersControl.getPlurals().get(n);t&&t.gObject.setAnimation(null)},3500)},150)},0)}),p.fieldsSetFields().then(function(t){e.serviceFields=t.MapInfo}),e.isEmpty=function(e){return e?_.isEmpty(e):!0},e.markerCloseClicked=function(){e.serviceInfoWindow.show=!1,e.resourceInfoWindow.show=!1,e.territoryInfoWindow.show=!1,e.reportInfoWindow.show=!1,e.livePosInfoWindow.show=!1,e.$apply()},e.openLink=function(t,i){return"Resource__r"==i.APIName?void e.openLightbox(t.resourceId,"resource"):void l.openLink(t,i)},e.openReportLink=function(t){if(t.isReference){if("ServiceResource"==t.APIName)return void e.openLightbox(t.Value,"resource");if("ServiceAppointment"==t.APIName)return void e.openLightbox(t.Value,"service");var i=l.openConsoleTab(null,t.Value);i||window.open("../"+t.Value,"_blank")}},e.markerClicked=function(e,t,i){C(i)},e.openLightbox=function(t,i,n){var r=null;switch(n&&(r=l.generateResourceId(t,n)),i){case"service":s.recentlyUsed[t]=!0,u.open(t);break;case"resource":d.open(t,r);break;case"homeBase":e.$emit("showResourceLightbox",e.resources[t])}},e.$watch("filter",function(t,i){"map"===e.workingState&&L()},!0),e.clearResource=function(t){delete e.filteredResources[t],L()},e.clearAllResources=function(){e.filteredResources={},L()},e.addResourceToFilterList=function(){var t=h.getResources();""!=e.filterResourceInputValue&&t[e.filterResourceInputValue.value]&&(e.filteredResources[e.filterResourceInputValue.value]=t[e.filterResourceInputValue.value],e.filterResourceInputValue="",L())},e.toggleReportMarkers=function(t){var i=e.reportsData[t];i.show=!i.show,L()},e.removeReportFromMap=function(t){delete e.reportsData[t],L()},e.removeAllReportsFromMap=function(){e.reportsData={},L()},e.showReportOnMap=function(){"null"!=e.selectedReport&&t.getReportRowsForMap(e.selectedReport).then(function(t){e.reportsData[e.selectedReport]={show:!0,data:t,displayCount:0};var i=!0;L(i)})},T.register("positions",function(e){L()}),e.isPinnedStatus=function(){if(e.currentMarker){for(var t=e.pinnedStatusesSF.split(","),i=0;i<t.length;i++)if(e.currentMarker.item.status===t[i])return!0;return!1}},e.needToShowDispatchButton=function(){return e.currentMarker&&"service"==e.currentMarker.type&&e.currentMarker.item.statusCategory!=S.DISPATCHED&&e.currentMarker.item.statusCategory==S.SCHEDULED},e.isServiceCurrentlyDispatching=function(){return e.currentMarker&&"dispatched"==e.invokedActions[e.currentMarker.id]},e.changeStatusToDispatch=function(t){return e.invokedActions[t]?void alert(customLabels.another_operation_running):(e.invokedActions[e.currentMarker.id]="dispatched",void s.changeStatus([t],f.DISPATCHED).then(function(t){t.services.length>0&&(e.currentMarker.item=t.services[0])})["finally"](function(){delete e.invokedActions[e.currentMarker.id]}))},e.isServiceCurrentlyScheduling=function(){return e.currentMarker&&"schedule"==e.invokedActions[e.currentMarker.id]},e.autoScheduleService=function(t){var t=e.currentMarker.id;return e.invokedActions[t]?void alert(customLabels.another_operation_running):(s.recentlyUsed[t]=!0,e.invokedActions[t]="schedule",void s.autoScheduleService(t).then(function(i){s.drawServicesAndAbsences(i.services,i.absences),delete e.invokedActions[t]}))},e.myTreeView={},e.lastSelectedLeafId=null,n.all([l.getPolygons(),h.promises.territories()]).then(function(t){j(t[0]);for(var i in h.territories)-1!=l.getFilteredLocations().indexOf(i)&&(e.territories[i]=h.territories[i]);N(),z().then(function(t){e.locationsTree=t,e.myTreeView=new dhtmlXTreeView({parent:"polygonsByTerritoriesTree",iconset:"font_awesome",checkboxes:!0,items:e.locationsTree}),e.myTreeView.attachEvent("onSelect",function(t,i){return e.drawState!=b.NONE&&e.drawState!=b.SELECTED?!1:(e.lastSelectedLeafId||(e.lastSelectedLeafId=t),!e.polygons[t]||void 0==e.lastSelectedLeafId||e.lastSelectedLeafId==t&&void 0==e.polygons[t]?void K():(i&&(Z(e.polygons[t].polygon),e.shouldBound&&e.selectedShape.getVisible()&&e.map.fitBounds(e.selectedShape.bounds),e.shouldBound=!0),void(e.lastSelectedLeafId=e.polygons[t].Id)))}),e.myTreeView.attachEvent("onCheck",G)})}),e.toggleDrawMode=function(){e.drawState!=b.INTERSECT&&(e.drawingManager.setDrawingMode("polygon"),K(),Q(e.selectedColor),e.drawState=b.DRAW)},e.cancelPolygon=function(){null!=e.drawingManager.getDrawingMode()&&(e.cancelDrawingShape=!0,e.drawingManager.setDrawingMode(null)),e.drawState==b.EDIT&&X(),e.drawState=b.NONE,e.selectedIntersectingPolygons={}},e.editPolygon=function(){e.drawState==b.SELECTED&&e.selectedShape.getVisible()&&(e.currentEditPolygon=e.polygons[e.selectedShape.id],e.drawState=b.EDIT,e.selectedShape.setEditable(!0),e.selectedShape.setDraggable(!0))},e.savePolygon=function(){if(e.selectedShape){var i=[];e.selectedShape.getPath().forEach(function(e,t){i.push({lat:e.lat(),lng:e.lng()})});var n=e.selectedShape.id||null,r="null"!=e.polygonTerritory?e.polygonTerritory:null;if(!e.polygonName)return void alert(customLabels.Polygon_name_field_is_empty);t.savePolygon(ne(i,e.selectedShapeColor,e.polygonName),e.selectedShapeColor,e.polygonName,r,n).then(function(t){e.selectedShape.setMap(null),re(t),ee(t,n),e.selectedShape=e.polygons[t.Id].polygon}),e.drawState=b.NONE}},e.deletePolygon=function(){if(!e.selectedShape)return void(e.drawState=b.NONE);if(confirm(customLabels.This_will_delete_the_selected_polygon.replaceAll(e.selectedShape.name))){var i=e.selectedShape.id||null;t.deletePolygon(i).then(function(t){e.selectedShape.setMap(null),e.myTreeView.deleteItem(i),K()}),e.drawState=b.NONE}};var ve={},pe=[],he=void 0;se.prototype=new google.maps.OverlayView,se.prototype.onAdd=function(){$("<div id='cMenu' class='context-menu-polygon'></div>").appendTo($("#map"));for(var e=$("#cMenu").get(0),t=0;t<this.menuItems.length;t++){var i=this.menuItems[t];$('<div id="'+i.id+'" class="truncate context-menu-polygon-item" title="'+i.name+'">'+i.label+"</div>").appendTo(e)}this.div_=e;var n=this.getPanes();n.overlayMouseTarget.appendChild(this.div_);for(var r=this,t=0;t<this.menuItems.length;t++){var i=this.menuItems[t],s=function(){r.clickedItem=this.id,google.maps.event.trigger(r,"click")};google.maps.event.addDomListener($("#"+i.id).get(0),"click",$.proxy(s,i))}google.maps.event.addListener(r,"click",function(){oe(r.clickedItem),event.stopPropagation(),he.hide()})},se.prototype.draw=function(){},se.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_),this.div_=null},se.prototype.hide=function(){this.div_&&(this.div_.style.visibility="hidden")},se.prototype.show=function(e){if(this.div_){var t=this.div_;t.style.left=e.x+5+"px",t.style.top=e.y+10+"px",this.div_.style.visibility="visible"}},e.hasCustomPermission("Polygons_create_update")&&pe.push({id:"menu-intersect-polygon",className:"context_menu_item",eventName:"intersect",label:l.getSVGIconHTML(lsdIcons.cut)+customLabels.Cut_Intersections,name:customLabels.Cut_Intersections}),e.hasCustomPermission("Bulk_Schedule")&&pe.push({id:"menu-schedule-polygon",className:"context_menu_item",eventName:"schedule",label:l.getSVGIconHTML(lsdIcons.calendar)+customLabels.Schedule,name:customLabels.Schedule}),pe.push({id:"menu-unschedule-polygon",className:"context_menu_item",eventName:"unschedule",label:l.getSVGIconHTML(lsdIcons.na)+customLabels.Unschedule,name:customLabels.Unschedule}),e.hasCustomPermission("Bulk_Dispatch")&&pe.push({id:"menu-dispatch-polygon",className:"context_menu_item",eventName:"dispatch",label:l.getSVGIconHTML(lsdIcons.dispatch)+customLabels.Dispatch,name:customLabels.Dispatch}),pe.push({id:"menu-joepardy-polygon",className:"context_menu_item",eventName:"joepardy",label:l.getSVGIconHTML(lsdIcons.jeopardy)+customLabels.In_Jeopardy,name:customLabels.In_Jeopardy}),e.hasCustomPermission("Polygons_create_update")&&pe.push({id:"menu-delete-polygon",className:"context_menu_item",eventName:"delete",label:l.getSVGIconHTML(lsdIcons["delete"])+customLabels.Delete_polygon,name:customLabels.Delete_polygon}),ve.menuItems=pe,l.customActionsPromise.then(function(){var e=l.getCustomActions("map");e.forEach(function(e,t){pe.push({id:"custom_"+t,className:"context_menu_item",eventName:"custom_"+t,label:e.icon?l.getSVGIconHTML(e.icon)+e.name:e.name,name:e.name})})}),e.getIntersectionsForPolygons=function(){if(!e.isEmpty(e.selectedIntersectingPolygons))try{var t=new jsts.io.WKTReader,i=t.read(e.selectedShape.ToWKT());for(var n in e.selectedIntersectingPolygons){var r=t.read(e.polygons[n].polygon.ToWKT());i=i.difference(r)}var s=new jsts.io.WKTWriter,a=s.write(i);le(a)}catch(o){alert("Problem finding intersections in given polygons."),console.error(o)}}}])}(),function(){angular.module("serviceExpert").controller("ctrlRightSide",["$q","$scope","$rootScope","$filter","$sce","sfdcService","utils","servicesService","kpiCalculationsService","StateService","DeltaService","TimePhasedDataService","StreamingAPIService","RegisterService",function(e,t,i,n,r,s,a,o,c,l,u,d,v,p){function h(e){"Failed"!==e.status&&"Completed"!==e.status&&"Global Optimization"!==e.type&&e.start&&e.finish&&(e.timespan=g(e))}function g(e){if(!e.resource)return(new Date).getTime();var t=void 0,i=d.getResoruceGanttIdByDate(e.resource,e.start),n="reshufle-on-gantt",r="";if(!i)return(new Date).getTime();switch(t=i.split(","),e.type){case"Fix Overlaps":n="fix-overlaps-on-gantt",r=customLabels.FixOverlaps;break;case"SA Reshuffle":n="reshufle-on-gantt",r=customLabels.Reshuffle;break;case"Fill-In Schedule":n="fillin-on-gantt",r=customLabels.Fill_in_Schedule;break;case"Group Nearby SAs":n="group-near-on-gantt",r=customLabels.GroupNearby;break;case"Resource Schedule Optimization":n="resource-day-on-gantt",r=customLabels.RDOptimize;break;default:n="reshufle-on-gantt"}return scheduler.addMarkedTimespan({start_date:e.start,end_date:e.finish,sections:{ZoomLevel2:t,ZoomLevel3:t,ZoomLevel4:t,ZoomLevel5:t,ZoomLevel6:t},css:"smart-on-gantt "+n,html:"<div><span>"+r+"</span></div>"})}t.isMapEnabled=l.isMapEnabled(),t.servicesObjects=o.servicesObjects,t.servicesScheduledToCapacity={},t.notifications=a.butlerNotifications,t.unreadNotifications=0,t.showServiceList=a.showServiceList,t.optimizationRequests={},t.workingState="gantt",t.openConsoleTab=a.openConsoleTab,t.openSObjectLink=a.openSObjectLink,t.activeRequests=s.activeRequests,t.activeRuleCheckRequests=s.activeRuleCheckRequests,t.kpi=c.kpis,t.optimizationRequsts={},t.marginLeftForBox=0,t.mapAvailable=mapMode,t.$watch("workingState",function(e){"gantt"===e&&setTimeout(function(){scheduler._is_initialized()&&updateViewDebounced()},0)}),s.getServiceMapInfoWindowFields().then(function(e){t.serviceFields=e}),t.getServiceInfoRowClass=a.getServiceInfoRowClass,t.openLink=a.openLink,t.order=function(e,i){t.orderByField=e,t.reverse=i},t.$on("changeWorkingState",function(e,i){t.workingState=i,"gantt"===i?setTimeout(function(){updateViewDebounced()},100):$(".dhtmlXTooltip").remove()}),t.showNotifications=function(){t.unreadNotifications=0,a.butlerNotifications().forEach(function(e){return e.unread=!1})},t.calcUnreadNotifications=function(){return t.unreadNotifications=0,a.butlerNotifications().forEach(function(e){e.unread&&t.unreadNotifications++}),t.unreadNotifications},t.numOfNotifications=function(){var e=0;return a.butlerNotifications().forEach(function(t){t.show&&e++}),e},t.formatTravel=function(e){var t=Math.floor(e/60/60),i=Math.floor(e/60%60);return t+customLabels.kpi_h+" "+i+customLabels.kpi_m},t.toggleServiceList=function(){t.showServiceList.show=!0,setTimeout(function(){updateViewDebounced(),i.$broadcast("resizeMap",{})},830)},t.isEmpty=function(e){return Object.keys(e).length},e.all([d.promises.initialPhasedData,s.getOptimizationRequests()]).then(function(e){e[1].forEach(function(e){t.optimizationRequsts[e.Id]=new OptimizationRequest(e),h(t.optimizationRequsts[e.Id])})}),t.getRequestCss=function(e){switch(e){case"In Progress":return"smart_in_progress";case"Completed":return"smart_completed";case"Failed":return"smart_failed";case"Open":return"smart_open";case"Queued":return"smart_queued"}},p.register("optimizationRequests",function(e){e.forEach(function(e){var i=new OptimizationRequest(e);t.optimizationRequsts[e.Id]&&t.optimizationRequsts[e.Id].timespan&&scheduler.deleteMarkedTimespan(t.optimizationRequsts[e.Id].timespan),t.optimizationRequsts[e.Id]=i,h(i)}),updateViewDebounced()}),t.getNumOfRunningRequests=function(){var e=0;for(var i in t.optimizationRequsts)"Completed"!==t.optimizationRequsts[i].status&&"Failed"!==t.optimizationRequsts[i].status&&e++;return e},t.openSomethingBox=function(e,i){"smart"===i?t.marginLeftForBox=e.target.offsetLeft-227:t.marginLeftForBox=e.target.offsetLeft-200}}])}(),function(){angular.module("serviceExpert").controller("serviceListCtrl",["$scope","$compile","$rootScope","$filter","utils","$timeout","$sce","servicesService","sfdcService","ResourcesAndTerritoriesService","GetSlotsService","userSettingsManager","StateService","TimePhasedDataService","LoadServiceListService","FieldSetFieldsService","ServiceAppointmentLightboxService","ServiceSelectorService","LocationFilteringService","SERVICE_STATUS","SERVICE_CATEGORY","DeltaService","RegisterService","GanttFilterService","GeneralLightbox","LeftSideLocationFilteringService",function(e,t,i,n,r,s,a,o,c,l,u,d,v,p,h,g,m,f,S,b,y,T,w,L,C,k){function D(t){delete e.filtersMap[t];for(var i=-1,n=0;n<e.filterOptions.length;n++)if(e.filterOptions[n].Id===t){i=n;break}-1!==i&&e.filterOptions.splice(i,1),e.filter.selectedFilter="All",d.GetUserSettingsProperty("Selected_List_View__c")!==e.filter.selectedFilter&&d.SetUserSettingsProperty("Selected_List_View__c",e.filter.selectedFilter)}function A(){if(!e.filtersMap)return!1;var t=e.filtersMap[e.filter.selectedFilter];if(!t||t.old)return!1;var i=new Date(e.filter.endDate),n=new Date(e.filter.endDate);"Invalid Date"===e.filter.endDate.toString()&&(i=new Date(scheduler._max_date),n=new Date(scheduler._max_date)),t.List_only_appointments_on_the_gantt?(i=scheduler._min_date,n=scheduler._max_date):(i.setDate(i.getDate()-t.Days_before_horizon),n.setDate(n.getDate()+t.Days_after_horizon));var r=Math.ceil((n-i)/1e3/60/60/24),s=[];R(n,r,s)}function R(t,i,n){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return null===s&&(R.loadedSoFar=0),R.loadedSoFar>=maxNumberOfServicesToLoad?(r.addNotification(customLabels.Too_Many_Services_Header_Services_List,customLabels.Too_Many_Services_Services_List),void(R.loadedSoFar=0)):(e.loadingServicesToList++,void h.loadServicesInBulk(e.servicesObjects(),e.servicesListVisitedDays,t,i,s).then(function(e){e.totalFetched===numberOfServicesToLoadInEachBulk?(R.loadedSoFar+=e.totalFetched,n.push.apply(n,_toConsumableArray(e.needToCheckRules)),R(t,i,n,e.lastFetchedId)):(n.push.apply(n,_toConsumableArray(e.needToCheckRules)),n.length>0&&o.checkRules(n).then(o.drawViolationsOnGantt))})["catch"](function(e){console.warn("loadServiceAppointmentsToList failed "+e)})["finally"](function(){return e.loadingServicesToList--}))}function I(){var e=scheduler.getState().max_date;return 0===e.getHours()&&0===e.getMinutes()?e=new Date(e.getTime()-6e4):(e.setHours(23),e.setMinutes(59),e.setSeconds(0)),e}function F(e,t){for(var i=0;i<t.length;i++)if(t[i].name==e)return t[i].filter;return!1}function x(){var e=d.GetUserSettingsProperty("Filters__c");return e?JSON.parse(d.GetUserSettingsProperty("Filters__c")):[]}function M(){return d.SetUserSettingsProperty("Filters__c",JSON.stringify(e.storageFilters))}function O(){if(!useNewFilters){e.storageFilters=x();for(var t=0;t<e.storageFilters.length;t++)e.filterOptions.push({name:e.storageFilters[t].name,value:e.storageFilters[t].name});P(e.storageFilters.length>0?e.storageFilters[0].name:null)}}function P(t){if(e.lastSelectedFilter=t,t){for(var i=0;i<e.storageFilters.length;i++)e.storageFilters[i].name===t&&(e.filter.advancedFilter=angular.copy(e.storageFilters[i].filter));e.customFilterName=t,e.DisplayComboBowArrow=!0,e.IsCustomFilterReadonly=!0,e.displayNew=!0,e.displayEdit=!0,e.displayDelete=!0}else e.filter.advancedFilter=E(),e.customFilterName="",e.DisplayComboBowArrow=!1,e.IsCustomFilterReadonly=!0,e.displayNew=!0,e.displayEdit=!1,e.displayDelete=!1}function E(){var t={statusCheckboxs:{},minDate:new Date,maxDate:new Date,servicePriority:10,unScheduled:!0,violations:!0,jeopardies:!0,noLocation:!0,locationsCheckboxs:{}};if(Object.keys(e.statusTranslations).length>0)for(var n in e.statusTranslations)t.statusCheckboxs[e.statusTranslations[n]]=!0;else i.$on("gotStatuses",function(){for(var i in e.statusTranslations)t.statusCheckboxs[e.statusTranslations[i]]=!0});for(var r=0;r<e.territories.length;r++){var s=e.territories[r];t.locationsCheckboxs[s.name]=!0}return t}function N(t){for(var i=0;i<e.filterOptions.length;i++)e.filterOptions[i].name===t&&e.filterOptions.splice(i,1)}angular.element(document).ready(function(){function e(){var e=d.GetUserSettingsProperty("Left_Panel_Width_Percentage__c"),i=400,n=$("#contentWrapper"),r=d.GetUserSettingsProperty("Services_List_Height_Percentage__c"),a=250,o=$("#SmartPanelContainer");if(0===n.length&&(n=$(window)),0===o.length&&(o=$(window)),0==!n.width()&&!t){t=!0,null!=e&&e>0&&100>e&&(i=n.width()*e*.01),400>i&&(i=400);var c=i+3;$("#RightSideContainer").width("calc(100% - "+c+"px)"),Split(["#LeftSideContainer","#RightSideContainer"],{sizes:[i+"px"],minSize:[400,700],snapOffset:10,gutterSize:3,onDragEnd:function(){updateViewDebounced();var e=$("#LeftSideContainer").width()/n.width();e*=100,d.SetUserSettingsProperty("Left_Panel_Width_Percentage__c",e)}})}s(function(){if(0==!o.height()){null!=r&&r>0&&100>r&&(a=o.height()*r*.01),a>250&&(a=250);var e=a+5;$("#ServiceListBottomContainer").height("calc(100% - "+e+"px");var t=o.height()-250,i=o.find(".gutter-vertical");i.length&&i.remove(),Split(["#ServiceListTopContainer","#ServiceListBottomContainer"],{direction:"vertical",sizes:[a+"px"],minSize:[5,t],snapOffset:10,gutterSize:5,onDragEnd:function(){var e=$("#ServiceListTopContainer").height()/o.height();e*=100,d.SetUserSettingsProperty("Services_List_Height_Percentage__c",e)}})}},0)}var t=!1;e(),$(window).bind("resize",e)}),useNewFilters&&L.filtersPromise.then(function(t){var i=[];e.filterOptions.forEach(function(e){var t={};for(var n in e)t[n]=e[n];t.Name=e.name,t.old=!0,t.Id=e.value,i.push(t)}),e.filterOptions=[].concat(i,_toConsumableArray(t)),e.filtersMap={},e.filterOptions.forEach(function(t){return e.filtersMap[t.Id]=t})})["finally"](function(){e.filterOptions.sort(function(e,t){return e.Name>t.Name?1:e.Name<t.Name?-1:0}),L.setFilterMap(e.filtersMap)}),window.__closeFilterLightbox=function(t){r.safeApply(e,function(){var i=C.closeLightboxFromOutside();i&&i(),t&&L.getFilterFromSalesforce(t).then(function(t){if(e.filtersMap[t.Id]){for(var i=0;i<e.filterOptions.length;i++)if(e.filterOptions[i].Id===t.Id){e.filterOptions[i]=t;break}}else e.filterOptions.push(t),e.filterOptions.sort(function(e,t){return e.Name>t.Name?1:e.Name<t.Name?-1:0});e.filtersMap[t.Id]=t})})},e.openGanttFilterLightbox=function(t){var i=e.filtersMap[e.filter.selectedFilter];switch(t){case"new":C.open(customLabels.FilterEditor,filterEditorPage);break;case"edit":C.open(customLabels.FilterEditor,filterEditorPage+"?&id="+i.Id);break;case"delete":if(!confirm(customLabels.ConfirmFilterDelete))return;L.deleteFilter(i.Id).then(D);break;case"hide":if(!confirm(customLabels.ConfirmFilterHide))return;L.hideFilter(i.Id).then(D)}},e.showNewFilterButton=function(){return customPermissions.Create_custom_Gantt_filters},e.showEditFilterButton=function(){if(!e.filtersMap)return!1;var t=e.filtersMap[e.filter.selectedFilter];return!t||t.old?!1:customPermissions.Create_custom_Gantt_filters&&!customPermissions.Publish_custom_Gantt_filters&&t.CreatedById===userId?!0:customPermissions.Publish_custom_Gantt_filters?!0:!1},e.showDeleteFilterButton=function(){if(!e.filtersMap)return!1;var t=e.filtersMap[e.filter.selectedFilter];return!t||t.old?!1:customPermissions.Create_custom_Gantt_filters&&t.CreatedById===userId},e.showHideFilterButton=function(){if(!e.filtersMap)return!1;var t=e.filtersMap[e.filter.selectedFilter];return!t||t.old?!1:customPermissions.Publish_custom_Gantt_filters&&customPermissions.Create_custom_Gantt_filters},e.newFilterChanged=function(){if("SearchOnServer"!==e.filterOptions[e.filterOptions.length-1].Id){if("SearchOnServer"!==e.filter.selectedFilter.Id&&"SearchOnServer"===e.filterOptions[e.filterOptions.length-1].Id&&e.filterOptions.pop(),!useNewFilters)return void e.loadServiceAppointmentsToList();if(!e.filtersMap)return!1;var t=e.filtersMap[e.filter.selectedFilter]||e.filtersMap.All;return e.filtersMap[e.filter.selectedFilter]||(e.filter.selectedFilter="All",t.selectedFilter="All"),d.GetUserSettingsProperty("Selected_List_View__c")!==e.filter.selectedFilter&&d.SetUserSettingsProperty("Selected_List_View__c",e.filter.selectedFilter),!t||t.old?void e.loadServiceAppointmentsToList():void A()}},e.fieldsTypes=r.fieldsTypes,e.openConsoleTab=r.openConsoleTab,e.useNewFilters=window.useNewFilters,e.isMapEnabled=v.isMapEnabled(),e.contractorSupport=v.areContractorsSupported(),e.statuses=b,e.statusTranslations=r.statusTranslations,e.pinnedStatusesSF=CustomSettings.pinnedStatusesSF,e.ganttSettings=r.ganttSettings,e.showServiceList=r.showServiceList,e.hasCustomPermission=r.hasCustomPermission,e.isLightning=r.isLightning,e.loadingServicesToList=0,e.isOptimizationEnabled=isOptimizationEnabled,e.bulkActionsOrder=bulkActionsOrder,e.isInConsole=v.isInConsole,e.matchGantt=d.GetUserSettingsProperty("Match_Gantt_Dates__c"),e.fullScreen=!1,window.location.search.match(/[&?]fullScreen=(\d)/)&&(e.fullScreen="1"===window.location.search.match(/[&?]fullScreen=(\d)/)[1]?"0":"1"),e.servicesObjects=p.serviceAppointments,e.selectedServiceId=null,e.lastSelectedServiceId=null,e.servicesListVisitedDays={},e.servicesListInited=!1;var G={},B=[];e.flagged=o.flagged,e.loadedTerritories=[],e.selectorService=f,e.servicesSelection=e.selectorService.SelectedServices,e.selectedPolicy=null,e.policyOptions=[],e.showGanttSettings=!1,e.ganttSettingDraft=null,e.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],e.reallyHideList=!1,e.showAdvancedFilter=!1,e.invokedAction={},e.invokedActionFor={},e.showCustomFilterDropdown=!1,e.storageFilters=null,e.prevEndDate=null,e.sortingColumn="start",e.sortingColumnName={start:customLabels.Start_time,finish:customLabels.Finish_time,accountName:customLabels.Account,serviceTypeName:customLabels.Service_type,priority:customLabels.Priority,resourceName:customLabels.Resource,earlyStart:customLabels.Early_start,dueDate:customLabels.Due_date,locationName:customLabels.Location},e.selectedDates={earlyStart:customLabels.Early_start,dueDate:customLabels.Due_date,appStart:customLabels.Appointment_start,appEnd:customLabels.Appointment_finish,start_date:customLabels.Start,end_date:customLabels.Finish},e.filter=o.filter,e.orderByField=o.filter.orderByField,e.reverse=o.filter.reverse,e.filteredServices=o.filteredServices,e.filterOptions=[],r.hasCustomPermission("Service_List_Todo")&&e.filterOptions.push({name:customLabels.Todo,value:"Todo"}),e.filterOptions.push({name:customLabels.AllServices,value:"All"}),e.filterOptions.push({name:customLabels.Recently_used,value:"Recent"}),r.hasCustomPermission("Service_List_Flagged")&&e.filterOptions.push({name:customLabels.Flagged,value:"Flagged"}),r.hasCustomPermission("Service_List_Selected")&&e.filterOptions.push({name:customLabels.Selected_Capital,value:"Selected"}),r.hasCustomPermission("Service_List_Unscheduled")&&e.filterOptions.push({name:customLabels.UnscheduledCapital,value:"Unscheduled"}),r.hasCustomPermission("Service_List_Scheuled")&&e.filterOptions.push({name:customLabels.Scheduled,value:"Scheduled"}),r.hasCustomPermission("Service_List_In_Jeopardy")&&e.filterOptions.push({name:customLabels.In_Jeopardy,value:"inJeopardy"}),r.hasCustomPermission("Service_List_Rule_Violating")&&e.filterOptions.push({name:customLabels.Rules_violating,value:"Violating"}),r.hasCustomPermission("Service_List_Gantt")&&e.filterOptions.push({name:customLabels.Gantt,value:"Gantt filter"}),r.hasCustomPermission("Service_List_Canceled")&&e.filterOptions.push({name:customLabels.Cancelled,value:"Cancelled filter"}),v.areContractorsSupported()&&r.hasCustomPermission("Service_List_Contractors")&&e.filterOptions.push({name:customLabels.Contractors,value:"Contractors filter"}),v.areCrewsSupported()&&r.hasCustomPermission("Service_List_Crews")&&e.filterOptions.push({name:customLabels.crews,value:"Crews filter"}),g.fieldsSetFields().then(function(t){G=t;for(var i in t)t[i].forEach(function(e){B[e.FullAPIName]=e});e.clickedServiceFieldPairs=[];for(var n=0;n<t.ListExpanded.length;){for(var r=n+2,s=[];n<t.ListExpanded.length&&r>n;n++)s.push(t.ListExpanded[n]);e.clickedServiceFieldPairs.push(s)}}),e.getColumnsToDisplay=function(){var t=L.getFilterById(e.filter.selectedFilter);if(t&&t.Displayed_Fields&&t.Displayed_Fields.length>0){var i=[];return t.Displayed_Fields.forEach(function(e){return i.push(B[e])}),i}return G.ListColumns},e.isPinnedStatus=function(t){for(var i=e.pinnedStatusesSF.split(","),n=0;n<i.length;n++)if(t===i[n])return!0;return!1},e.getSingleTaskColumnClass=function(e){var t={SingleTaskColumn:!0,truncate:!0};return t["Field-"+e.Type]=!0,t},e.getHeaderTaskColumnClass=function(e){var t={SortingTasksListColumn:!0};return t["Field-"+e.Type]=!0,t},e.loadServiceAppointmentsToList=function(){R(e.endDate,r.ganttSettings.backHorizon,[])},e.formatServiceField=function(e,t){var i=e[t.APIName];switch(t.Type){case r.fieldsTypes.DateTime:i=n("amDateFormat")(i,"lll");break;case r.fieldsTypes.Date:i=n("amDateFormat")(i,"L")}return i},e.getRefFieldID=function(e,t){return e[t.JsAPIName.replace("__r","__c")]},e.isFieldEmpty=function(e,t){return"undefined"==typeof n("displayFieldSetField")(e,t)},e.openCalendarAdvanceFilterStart=function(){e.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMin",date:new Date(e.filter.endDate),navigation:!0,handler:function(t,i){r.safeApply(e,function(){t>new Date(e.filter.advancedFilter.maxDate)?alert(customLabels.startBeforeEnd):e.filter.advancedFilter.minDate=t}),scheduler.destroyCalendar()}}))},e.openCalendarAdvanceFilterFinish=function(){e.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMax",date:new Date(e.endDate),navigation:!0,handler:function(t,i){r.safeApply(e,function(){t<new Date(e.filter.advancedFilter.minDate)?alert(customLabels.startBeforeEnd):e.filter.advancedFilter.maxDate=t}),scheduler.destroyCalendar()}}))},e.openCalendarAdvanceFilterStart=function(){e.IsCustomFilterReadonly||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"calendarMin",date:new Date(e.filter.endDate),navigation:!0,handler:function(t,i){r.safeApply(e,function(){t>new Date(e.filter.advancedFilter.maxDate)?alert(customLabels.startBeforeEnd):e.filter.advancedFilter.minDate=t}),scheduler.destroyCalendar()}}))},v.promises.policies().then(function(t){e.policyOptions=t;for(var i=!1,n=d.GetUserSettingsProperty("Gantt_Policy__c"),r=0;r<t.length;r++)if(n){if(t[r].Id===n){e.selectedPolicy=t[r],i=!0;break}}else if(t[r].Id===defaultPolicy){e.selectedPolicy=t[r],i=!0;break}i||(e.selectedPolicy=e.policyOptions[0]),v.selectedPolicyId=e.selectedPolicy.Id})["catch"](function(e){console.warn(e),cantLoadGantt(customLabels.no_policy_found)}),e.changePolicy=function(){v.selectedPolicyId=e.selectedPolicy.Id,d.SetUserSettingsProperty("Gantt_Policy__c",e.selectedPolicy.Id);var t=[];for(var i in scheduler._events)"service"===scheduler._events[i].type&&t.push(i);t.length>0&&o.checkRules(t).then(o.drawViolationsOnGantt)},e.order=function(t,i){e.filter.orderByField=t,e.filter.reverse=i},e.selectService=function(t){t===e.selectedServiceId?(e.selectedServiceId=null,e.lastSelectedServiceId=t):(e.lastSelectedServiceId=e.selectedServiceId,e.selectedServiceId=t)},e.violationsTooltip=function(e){if(e.isMDT&&!e.violations&&!e.jeopardy)return customLabels.Multi_Day_Service;if(e.violations||e.jeopardy){if(e.jeopardy&&e.jeopardyReason)return e.jeopardyReason;if(e.violations){for(var t="",i=0;i<e.violations.length;i++)t+=e.violations[i].RuleName+"\n";return t&&(t=t.substring(0,t.length-1)),t}}},e.getStatusClass=function(e){return r.getCSSClassForContext(e.statusCategory,y)},e.$on("initCompleted",function(t){e.initEndDate();var i=d.GetUserSettingsProperty("locations");e.territories=[];for(var n=0;n<i.length;n++)void 0!==l.territories[i[n]]&&e.territories.push(l.territories[i[n]]);O()}),e.initEndDate=function(){e.endDate=I(),e.endDate=r.addDaysToDate(e.endDate,1),e.prevEndDate=e.endDate,e.filter.endDate=e.endDate},e.$on("ganttFinishedLoadingServices",function(){(e.matchGantt||e.servicesListInited===!1)&&(e.servicesListInited||(null===e.endDate||isNaN(e.endDate.getTime()))&&e.initEndDate(),e.servicesListInited=!0,e.newFilterChanged())}),scheduler.attachEvent("onBeforeViewChange",function(e,t){return scheduler._old={mode:e,date:t},!0});var H=!0;scheduler.attachEvent("onViewChange",function(t,i){(scheduler._old.mode!==t||i!==scheduler._old.date)&&(v.isLoadingNewLocations||r.safeApply(e,function(){if(e.matchGantt){var t=I();e.filter.endDate=t,e.endDate=t,e.matchGantt&&!H?e.newFilterChanged():H=!1}}))}),e.matchGanttClicked=function(){if(e.matchGantt)e.prevEndDate=e.endDate,e.filter.endDate=I(),e.endDate=e.filter.endDate,d.SetUserSettingsProperty("Match_Gantt_Dates__c",!0);else{var t=e.prevEndDate;"Invalid Date"===t.toString()&&(t=scheduler._min_date),e.filter.endDate=t,e.endDate=t,d.SetUserSettingsProperty("Match_Gantt_Dates__c",!1)}e.newFilterChanged()},e.openLightBox=function(e){o.recentlyUsed[e]=!0,m.open(e)},e.flagging=function(e){return o.flagged[e]?void(o.flagged[e]&&(o.flagged[e]=!o.flagged[e],scheduler.updateEvent(e))):(o.flagged[e]=!0,
void scheduler.updateEvent(e))},e.showOnGantt=function(e){o.recentlyUsed[e.id]=!0,scheduler._events[e.id]?"none"===$("#GanttMapContainer").css("display")?(i.$broadcast("changeWorkingState","gantt"),s(function(){updateViewDebounced()},20),s(function(){r.showOnGantt(e.id)},120)):r.showOnGantt(e.id):alert(customLabels.location_not_loaded)},e.changeStatusToDispatch=function(t){if(e.invokedActionFor[t]||v.schedulingRunningFor[t])return void alert(customLabels.another_operation_running);o.recentlyUsed[t]=!0,e.invokedAction[t]="dispatch",e.invokedActionFor[t]=!0;var i=[t];o.changeStatus(i,b.DISPATCHED).then(function(i){o.drawServicesAndAbsences(i.services),e.invokedAction[t]=null,e.invokedActionFor[t]=!1})},e.showOnMap=function(e){i.$broadcast("showServiceOnMap",e)},e.openDateEndCalendar=function(){e.matchGantt||(scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"DateStart",date:new Date(e.filter.endDate),navigation:!0,handler:function(t,i){r.safeApply(e,function(){e.endDate=t,e.endDate.setHours(23),e.endDate.setMinutes(59),e.endDate.setSeconds(0),e.filter.endDate=e.endDate,e.newFilterChanged()}),scheduler.destroyCalendar()}}))},e.openFullScreen=function(){var e=window.location.search.match(/[&?]fullScreen=(\d)/),t=0;if(e){var i="1"===e[1]?"0":"1";window.location.search=window.location.search.replace(/[&?]fullScreen=\d/,"&fullScreen="+i)}else window.location.search+="&fullScreen=1",t=1},e.getSlots=function(t){return o.recentlyUsed[t]=!0,"none"===$("#GanttMapContainer").css("display")&&(i.$broadcast("changeWorkingState","gantt"),setTimeout(function(){updateViewDebounced()},20)),e.invokedActionFor[t]||v.schedulingRunningFor[t]?void alert(customLabels.another_operation_running):void u.get(t)},e.scheduleAndReshuffle=function(t){return e.invokedActionFor[t]?void alert(customLabels.another_operation_running):(o.recentlyUsed[t]=!0,e.invokedAction[t]="reshuffle",e.invokedActionFor[t]=!0,void c.runReshuffle(t,v.selectedPolicyId).then(function(i){T.updateOptimizationRequest(i);var n=function r(n){n.forEach(function(n){var s=new OptimizationRequest(n);s.id!==i.Id||"Completed"!==s.status&&"Failed"!==s.status||(e.invokedAction[t]=null,e.invokedActionFor[t]=!1,w.unRegister("optimizationRequests",r))})};w.register("optimizationRequests",n)},function(){r.addNotification(customLabels.Action_Could_Not_Be_Performed,err.message),e.invokedAction[t]=null,e.invokedActionFor[t]=!1}))},e.groupNearby=function(t){return e.invokedActionFor[t]?void alert(customLabels.another_operation_running):(o.recentlyUsed[t]=!0,e.invokedAction[t]="groupNearby",e.invokedActionFor[t]=!0,void c.runGroupNearby(t,v.selectedPolicyId).then(function(i){T.updateOptimizationRequest(i);var n=function r(n){n.forEach(function(n){var s=new OptimizationRequest(n);s.id!==i.Id||"Completed"!==s.status&&"Failed"!==s.status||(e.invokedAction[t]=null,e.invokedActionFor[t]=!1,w.unRegister("optimizationRequests",r))})};w.register("optimizationRequests",n)},function(){r.addNotification(customLabels.Action_Could_Not_Be_Performed,err.message),e.invokedAction[t]=null,e.invokedActionFor[t]=!1}))},e.autoScheduleService=function(t){return e.invokedActionFor[t]||v.schedulingRunningFor[t]?void alert(customLabels.another_operation_running):(o.recentlyUsed[t]=!0,e.invokedAction[t]="schedule",e.invokedActionFor[t]=!0,void o.autoScheduleService(t).then(function(e){0===e.services.length&&alert(customLabels.NoCandidates),o.drawServicesAndAbsences(e.services,e.absences)})["catch"](function(e){r.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message)})["finally"](function(){e.invokedAction[t]=null,e.invokedActionFor[t]=!1}))},e.$on("autoScheduleServiceFinished",function(t,i){e.invokedAction[i]=null,e.invokedActionFor[i]=!1}),e.openGanttSettings=function(){e.showGanttSettings=!0,r.ganttSettings?e.ganttSettings=r.ganttSettings:(e.ganttSettings.filterCandidates=!0,e.ganttSettings.servicesPerPage=200,e.ganttSettings.backHorizon=14,e.ganttSettings.capacityDuration="Day"),e.ganttSettingDraft=angular.copy(e.ganttSettings)},e.closeSettingsLightbox=function(){e.showGanttSettings=!1,$("#ganttSettingsLightbox").attr("style",""),e.ganttSettingDraft=angular.copy(e.ganttSettings)},e.parseGanttSettingsToUserSetting=function(e){var t={};return t.Gantt_View_Start_Hour__c=e.startHour,t.Gantt_View_Finish_Hour__c=e.finishHour,t.Filter_Candidates__c=e.filterCandidates,t.Services_Per_Page__c=e.servicesPerPage,t.Resource_Row_Height__c=e.resourceRowHeight,t.Scheduling_horizon_limit__c=e.backHorizon,t.View_Capacity_Type__c=e.capacityDuration,t.Load_On_Today__c=e.loadOnToday,t},e.saveGanttSettings=function(){return"undefined"==typeof e.ganttSettingDraft.backHorizon?void alert(customLabels.backHorizonInvalid):(schedulerConfig.setRowHeights(e.ganttSettingDraft.resourceRowHeight,!0),setCapacityFilter(e.ganttSettingDraft.capacityDuration,!0),e.ganttSettings=angular.copy(e.ganttSettingDraft),r.ganttSettings=angular.copy(e.ganttSettingDraft),e.filter.servicesPerPage=parseInt(e.ganttSettings.servicesPerPage),d.SetUserSettingProperties(e.parseGanttSettingsToUserSetting(e.ganttSettings)).then(function(){e.loadServiceAppointmentsToList()}),void(e.showGanttSettings=!1))},e.$on("keypress",function(t,i){27===i.which&&e.closeSettingsLightbox()}),e.createArray=function(e,t){if("number"!=typeof e||isNaN(e))return[];if("number"!=typeof t||isNaN(t))return[];var i=Math.floor(e/t);return e%t>0&&i++,new Array(i)},e.changePage=function(t){switch(t){case"right":e.filter.totalPages!==e.filter.currentPage&&(e.filter.currentPage=parseInt(e.filter.currentPage)+1,e.filter.currentPage=e.filter.currentPage.toString());break;case"left":e.filter.currentPage>1&&(e.filter.currentPage=parseInt(e.filter.currentPage)-1,e.filter.currentPage=e.filter.currentPage.toString());break;case"first":e.filter.currentPage>1&&(e.filter.currentPage="1");break;case"last":e.filter.totalPages!==e.filter.currentPage&&(e.filter.currentPage=e.filter.totalPages.toString())}},e.hideServiceList=function(){e.showServiceList.show=!1,e.reallyHideList=!0,s(function(){updateViewDebounced(),i.$broadcast("resizeMap",{})},0)},e.$watch("showServiceList.show",function(t,i){t&&(e.reallyHideList=!1)}),e.isDraggable=function(t){var i=e.servicesObjects()[t];return i?scheduler._events[i.id+"_dummy"]?!1:!i.resourceId&&i.statusCategory===y.NONE&&(!i.pinned||i.pinned&&!preventUpdateOfPinned):!1},e.isBeingSavedNow=function(e){return!!scheduler._events[e+"_dummy"]},e.showAdvancedFilterFunc=function(){$("#AdvancedFilteringOptions").css("display","block"),s(function(){$("#SmartPanelContainer").find(".gutter-vertical").hide(),e.showAdvancedFilter=!0},100)},e.hideAdvancedFilterFunc=function(){e.showAdvancedFilter=!1,setTimeout(function(){$("#SmartPanelContainer").find(".gutter-vertical").show(),$("#AdvancedFilteringOptions").css("display","none")},700)},e.removeSpaces=function(e){return e?e.split(" ").join("+"):""},e.filterChanged=function(){var t=x(),i=F(e.filter.selectedFilter,t);i?(e.filter.advancedFilter=i,e.customFilterSelected=!0,e.customFilterName=e.filter.selectedFilter):e.customFilterSelected=!1,d.GetUserSettingsProperty("Selected_List_View__c")!==e.filter.selectedFilter&&d.SetUserSettingsProperty("Selected_List_View__c",e.filter.selectedFilter)},e.$on("gotNewResources",function(t,i){e.territories=[];for(var n=i.show,r=0;r<n.length;r++)void 0!==l.territories[n[r]]&&e.territories.push(l.territories[n[r]]);e.servicesListVisitedDays={},e.newFilterChanged()}),e.createCustomFilter=function(){e.isEditMode=!1,e.customFilterName="",e.displayCancel=!0,e.IsCustomFilterReadonly=!1,e.DisplayComboBowArrow=!1,e.displayNew=!1,e.displayEdit=!1,e.displaySave=!0,e.displayDelete=!1,e.filter.advancedFilter=E()},e.CancelSaveOrEditCustomFilter=function(){e.displayNew=!0,e.displayEdit=!0,e.DisplayComboBowArrow=!0,e.displaySave=!1,e.displayDelete=!0,e.displayCancel=!1,e.IsCustomFilterReadonly=!0,P(e.lastSelectedFilter)},e.saveCustomFilter=function(){if(0===e.customFilterName.length)return void alert(customLabels.Please_give_a_name_to_the_custom_filter);for(var t=0;t<e.filterOptions.length;t++)if(!e.isEditMode&&e.filterOptions[t].name===e.customFilterName||e.isEditMode&&e.filterOptions[t].name===e.customFilterName&&e.filterOptions[t].name!==e.lastSelectedFilter)return void alert("Please select another name");if(e.displayNew=!0,e.displayEdit=!0,e.DisplayComboBowArrow=!0,e.displaySave=!1,e.displayDelete=!0,e.displayCancel=!1,e.IsCustomFilterReadonly=!0,e.isEditMode){for(var i=0;i<e.storageFilters.length;i++)if(e.storageFilters[i].name===e.lastSelectedFilter){for(e.storageFilters[i].filter=e.filter.advancedFilter,e.storageFilters[i].name=e.customFilterName,M(),j=0;j<e.filterOptions.length;j++)if(e.filterOptions[j].name===e.lastSelectedFilter){e.filterOptions[j].name=e.customFilterName,e.filterOptions[j].value=e.customFilterName;break}e.filter.selectedFilter===e.lastSelectedFilter&&(e.filter.selectedFilter=e.customFilterName);break}}else e.storageFilters.push({name:angular.copy(e.customFilterName),filter:angular.copy(e.filter.advancedFilter)}),e.filterOptions.push({name:angular.copy(e.customFilterName),value:angular.copy(e.customFilterName)}),M(),e.customFilterSelected=!0,e.filter.selectedFilter=e.customFilterName;e.lastSelectedFilter=e.customFilterName},e.EditCustomFilter=function(){e.isEditMode=!0,e.displayCancel=!0,e.DisplayComboBowArrow=!1,e.displayNew=!1,e.displayEdit=!1,e.displaySave=!0,e.displayDelete=!1,e.IsCustomFilterReadonly=!1,e.DisplayComboBowArrow=!1,e.filter.advancedFilter=angular.copy(e.filter.advancedFilter)},e.deleteCustomFilter=function(){e.IsCustomFilterReadonly=!0,e.DisplayComboBowArrow=!0,e.displayNew=!0,e.displayEdit=!0,e.displaySave=!1,e.displayDelete=!0;for(var t=0;t<e.storageFilters.length;t++)if(e.storageFilters[t].name===e.customFilterName){e.storageFilters.splice(t,1);break}N(e.customFilterName),M(),e.filter.selectedFilter===e.customFilterName&&(e.filter.selectedFilter=customPermissions.Service_List_Todo?"Todo":"All"),P(e.storageFilters.length>0?e.storageFilters[0].name:null)},e.customFilterChanged=function(t){e.customFilterName=t,P(t)},e.showDropdownCustomFilters=function(t){t.stopPropagation(),e.storageFilters.length>0&&(e.showCustomFilterDropdown=!e.showCustomFilterDropdown)},e.toggleStatus=function(t,i){e.IsCustomFilterReadonly||(e.filter.advancedFilter.statusCheckboxs[i]=!e.filter.advancedFilter.statusCheckboxs[i])},e.toggleLocation=function(t){e.IsCustomFilterReadonly||(t?e.filter.advancedFilter.locationsCheckboxs[t]=!e.filter.advancedFilter.locationsCheckboxs[t]:e.filter.advancedFilter.noLocation=!e.filter.advancedFilter.noLocation)},e.clearRecentlyViewed=function(){for(var e in o.recentlyUsed)delete o.recentlyUsed[e]},e.openLocationFiltering=function(){S.open()},e.getStyleForServiceInList=function(e){return window.paletteViewActive&&e.ganttPaletteColor?{background:e.ganttPaletteColor.color}:{background:e.ganttColor}};var V=_.debounce(function(){r.safeApply(e,function(){var t=n("servicesListFilter"),i=n("pagination"),r=t(e.servicesObjects(),e.filter,e.getColumnsToDisplay(),e.filtersMap);e.filteredServices.servicesArray=i(r,e.filter.currentPage,e.filter.servicesPerPage)})},350,{maxWait:1400});e.getServiceListFilter=function(){return V(),e.filteredServices.servicesArray},e.searchServiceByIdOrName=function(t){e.notFoundOnServer=!1,o.searchServiceByIdOrName(t).then(function(t){t?(o.checkRules([t]).then(o.drawViolationsOnGantt),e.filter.searchOnServer=t,e.filterOptions.push({Name:customLabels.searchOnServer,name:customLabels.searchOnServer,old:!0,Id:"SearchOnServer",value:"SearchOnServer"}),e.filter.lastSelectedFilter=e.filter.selectedFilter,e.filter.selectedFilter="SearchOnServer"):e.notFoundOnServer=!0})["catch"](function(e){console.warn(e)})},e.resetSearchText=function(){e.notFoundOnServer=null,e.filter.SearchText="","SearchOnServer"===e.filter.selectedFilter&&(e.filter.selectedFilter=e.filter.lastSelectedFilter,"SearchOnServer"===e.filterOptions[e.filterOptions.length-1].Id&&e.filterOptions.pop())},e.saveSettingsOfHorizonDates=function(){U()};var U=_.debounce(function(){d.SetUserSettingsProperty("Date_Horizon_Properties__c",JSON.stringify(e.filter.selectedFiled))},800);e.customActions=[],r.customActionsPromise.then(function(){var t,i=r.getCustomActions("list");(t=e.customActions).push.apply(t,_toConsumableArray(i))}),e.runCustomServiceAction=function(e,t){var i=parseInt($(e.currentTarget).attr("actionId")),n=[t],s=r.getCustomActions("list")[i];if(s.visualforce){var a=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),o=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();1===n.length?C.open(s.name,s.visualforce+"?id="+n[0]+"&start="+a+"&end="+o):C.open(s.name,s.visualforce+"?services="+n.join(",")+"&start="+a+"&end="+o)}else c.runCustomServiceAction(s.className,n,scheduler._min_date,scheduler._max_date).then(function(e){e&&r.addNotification(s.name,e,null,null)})["catch"](function(e){return r.addNotification(s.name,e.message,null,null)})},e.showTerritoriesFiltering=function(){k.open()}}])}(),function(){angular.module("serviceExpert").filter("ampmOr24",function(){return function(e,t,i){var n=parseInt(e),r=i?":00":"";return"ampm"==t?12===e?"12PM":0===e||24===e?"12AM":n>12?n-12+"PM":n+"AM":"24"==t?10>n?"0"+n+r:n+r:e}})}(),function(){angular.module("serviceExpert").filter("displayFieldSetField",["utils","$filter",function(e,t){return function(i,n){if(i&&n){var r=i[n.APIName];if(r)if("Status"===n.APIName)r=e.statusTranslations[i.status]||i.status;else switch(n.Type){case e.fieldsTypes.DateTime:r=t("amDateFormat")(r,"l LT");break;case e.fieldsTypes.Date:r=t("amDateFormat")(r,"L");break;case e.fieldsTypes.Currency:r=t("currency")(r,defaultCurrency)}return null==r&&(r=void 0),r}}}]).filter("displayReportField",["utils","$filter",function(e,t){return function(e){if(e){var i=e.Label;switch(e.Type){case"DATETIME_DATA":i=t("amDateFormat")(i,"l LT");break;case"DATE_DATA":i=t("amDateFormat")(i,"L")}return null==i&&(i=void 0),i}}}])}(),function(){angular.module("serviceExpert").filter("orderObjectBy",function(){return function(e,t,i){var n=[];return angular.forEach(e,function(e){n.push(e)}),n.sort(function(e,i){return e[t]>i[t]?1:-1}),i&&n.reverse(),n}})}(),function(){angular.module("serviceExpert").filter("pagination",["servicesService",function(e){return function(t,i,n){e.filter.totalServices=t.length,parseInt(e.filter.currentPage)>e.filter.totalPages&&(e.filter.currentPage="1",i=1);var r=[],s=(i-1)*n,a=(i-1)*n+n;return r=t.length<=n?t:t.slice(s,a),t.length==e.filter.servicesPerPage?e.filter.totalPages=1:(e.filter.totalPages=Math.floor(t.length/e.filter.servicesPerPage),t.length%e.filter.servicesPerPage>0&&e.filter.totalPages++),e.filter.firstVisibleService=s+1,e.filter.lastVisibleService=a,t.length<=n?e.filter.lastVisibleService=t.length:a>t.length&&(e.filter.lastVisibleService=t.length),r}}])}(),function(){angular.module("serviceExpert").filter("replaceLabels",function(){return function(e){for(var t=e,i=arguments.length,n=Array(i>1?i-1:0),r=1;i>r;r++)n[r-1]=arguments[r];for(var s=0;s<n.length;s++)t=t.replace("$"+s,n[s]);return t}})}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){angular.module("serviceExpert").filter("servicesListFilter",["utils","$filter","servicesService","userSettingsManager","ServiceSelectorService","SERVICE_STATUS","SERVICE_CATEGORY",function(e,t,i,n,r,s,a){function o(t,i,n){if(t.name&&-1!=t.name.toLowerCase().indexOf(i.toLowerCase()))return!0;if(t.ganttLabel&&-1!=t.ganttLabel.toLowerCase().indexOf(i.toLowerCase()))return!0;if(t.accountName&&-1!=t.accountName.toLowerCase().indexOf(i.toLowerCase()))return!0;if(t.resourceName&&-1!=t.resourceName.toLowerCase().indexOf(i.toLowerCase()))return!0;if(t.id&&-1!=t.id.toLowerCase().indexOf(i.toLowerCase()))return!0;if(t.serviceTerritoryName&&-1!=t.serviceTerritoryName.toLowerCase().indexOf(i.toLowerCase()))return!0;if(t.status&&-1!=t.status.toLowerCase().indexOf(i.toLowerCase()))return!0;for(var r=0;r<n.length;r++)if((n[r].Type==e.fieldsTypes.String||n[r].Type==e.fieldsTypes.TextArea||n[r].Type==e.fieldsTypes.Reference||n[r].Type==e.fieldsTypes.Picklist)&&t[n[r].APIName]&&-1!=t[n[r].APIName].toLowerCase().indexOf(i.toLowerCase()))return!0;return!1}function c(e,t,i,n){var r=new Date(n);return"undefined"!=typeof t.earlyStart&&t.earlyStart&&e.earlyStart&&e.earlyStart>i&&e.earlyStart<=r?!0:"undefined"!=typeof t.dueDate&&t.dueDate&&e.dueDate&&e.dueDate>i&&e.dueDate<=r?!0:"undefined"!=typeof t.appStart&&t.appStart&&e.appStart&&e.appStart>i&&e.appStart<=r?!0:"undefined"!=typeof t.appEnd&&t.appEnd&&e.appEnd&&e.appEnd>i&&e.appEnd<=r?!0:"undefined"!=typeof t.finish&&t.finish&&e.finish&&e.finish>i&&e.finish<=r?!0:"undefined"!=typeof t.start&&t.start&&e.start&&e.start>i&&e.start<=r?!0:"undefined"!=typeof t.display&&t.display&&e.ganttDisplay&&e.ganttDisplay>i&&e.ganttDisplay<=r?!0:!1}function l(e,t,i){var n=new Date(e.minDate);n.setHours(0),n.setMinutes(0);var r=new Date(e.maxDate);r.setDate(r.getDate()+1),r.setHours(0),r.setMinutes(0);for(var s in t)if(t[s]&&u(i,s,n,r))return!0;return!1}function u(e,t,i,n){if("undefined"==typeof e[t])return!1;var r=e[t];return r>=i&&n>=r?!0:!1}function d(e,t){return e.priority<=t}function v(e,t){return e.jeopardy&&!t.jeopardies?!1:e.violations&&!t.violations?!1:null!==e.start_date||t.unScheduled?!0:!1}function p(e,t,i){if(i&&!e.location)return!0;for(var n in t)if(e.serviceTerritoryName==n&&t[n])return!0;return!1}function h(e){if(void 0==n.GetUserSettingsProperty("Filters__c"))return null;for(var t="object"==_typeof(n.GetUserSettingsProperty("Filters__c"))?n.GetUserSettingsProperty("Filters__c"):JSON.parse(n.GetUserSettingsProperty("Filters__c")),i=0;i<t.length;i++)if(t[i].name==e)return t[i].filter;return null}return function(n,s,u,g){if("SearchOnServer"===s.selectedFilter)return[n[s.searchOnServer]];var m=g&&g[s.selectedFilter]&&g[s.selectedFilter].old;if(useNewFilters&&!m)return t("servicesListFilterNew")(n,s,u);var f=[],S=new Date(s.endDate),b=e.addDaysToDate(S,-e.ganttSettings.backHorizon),y=scheduler.getState().min_date,_=scheduler.getState().max_date,T=h(s.selectedFilter),w=null,L=[];s.SearchText.indexOf(",")>-1&&(w=s.SearchText.replace(/, /g,",").split(","),""===w[w.length-1]&&w.length--),w?L=w:L.push(s.SearchText);for(var C in n)for(var k=0;k<L.length;k++){var D=o(n[C],L[k],u),A=c(n[C],s.selectedFiled,b,S);if("Selected"==s.selectedFilter){if(r.SelectedServices[C]&&r.SelectedServices[C]&&D){f.push(n[C]);break}}else if("Flagged"==s.selectedFilter&&D){if(i.flagged[C]){f.push(n[C]);break}}else if("Recent"==s.selectedFilter&&D){if(i.recentlyUsed[C]){f.push(n[C]);break}}else if("Todo"==s.selectedFilter){if((n[C].statusCategory==a.NONE||n[C].violations||n[C].jeopardy)&&n[C].statusCategory!=a.CANCELED&&n[C].statusCategory!=a.COMPLETED&&A){if(L[k].length>1&&D){f.push(n[C]);break}if(L[k].length<=1){f.push(n[C]);break}}}else if("All"==s.selectedFilter){if(A){if(L[k].length>1&&D){f.push(n[C]);break}if(L[k].length<=1){f.push(n[C]);break}}}else if("Unscheduled"==s.selectedFilter){if(!n[C].resource&&n[C].statusCategory!=a.CANCELED&&A){if(L[k].length>1&&D){f.push(n[C]);break}if(L[k].length<=1){f.push(n[C]);break}}}else if("Violating"==s.selectedFilter){if(n[C].violations&&n[C].statusCategory!=a.CANCELED&&A){if(L[k].length>1&&D){f.push(n[C]);break}if(L[k].length<=1){f.push(n[C]);break}}}else if("inJeopardy"==s.selectedFilter){if(n[C].jeopardy&&n[C].statusCategory!=a.CANCELED&&A){if(L[k].length>1&&D){f.push(n[C]);break}if(L[k].length<=1){f.push(n[C]);break}}}else if("Scheduled"==s.selectedFilter){if(n[C].resource&&A){if(L[k].length>1&&D){f.push(n[C]);break}if(L[k].length<=1){f.push(n[C]);break}}}else if("Gantt filter"==s.selectedFilter){if(n[C].resource&&(n[C].start<=_&&n[C].start>=y||n[C].finish<=_&&n[C].finish>=y)){if(L[k].length>1&&D){f.push(n[C]);break}if(L[k].length<=1){f.push(n[C]);break}}}else if("Contractors filter"==s.selectedFilter){if(n[C].resourceContractor&&A){if(L[k].length>1&&D){f.push(n[C]);break}if(L[k].length<=1){f.push(n[C]);break}}}else if("Cancelled filter"==s.selectedFilter){if(n[C].statusCategory==a.CANCELED&&A){if(L[k].length>1&&D){f.push(n[C]);break}if(L[k].length<=1){f.push(n[C]);break}}}else if("Crews filter"==s.selectedFilter){if(n[C].isAssignToCrew){if(L[k].length>1&&D){f.push(n[C]);break}if(L[k].length<=1){f.push(n[C]);break}}else if(void 0!=n[C].parentFields.MinimumCrewSize||void 0!=n[C].parentFields.RecommendedCrewSize){if(L[k].length>1&&D){f.push(n[C]);break}if(L[k].length<=1){f.push(n[C]);break}}}else if(T&&T.statusCheckboxs[statusTranslations[n[C].status]]&&l(T,s.selectedFiled,n[C])&&d(n[C],T.servicePriority)&&v(n[C],T)&&p(n[C],T.locationsCheckboxs,T.noLocation)){if(L[k].length>1&&D){f.push(n[C]);break}if(L[k].length<=1){f.push(n[C]);break}}}return t("orderBy")(f,s.orderByField,s.reverse)}}])}(),function(){function e(e,o,c,l,u,d,v,p,h,g,m,f,S,b,y){var _=(new Date).getTime();return setInterval(function(){return _+=6e4},6e4),y.register("positions",function(e){var t=c.getResources();for(var i in e)t[i]&&(t[i].lastKnownLongitude=e[i].longitude,t[i].lastKnownLocationDate=e[i].lastModifiedDate.getTime()-1e3*e[i].lastModifiedDate.getTimezoneOffset()*60,t[i].lastKnownLatitude=e[i].latitude)}),function(u,f,b,y,T,w){function L(e){return e.lastKnownLocationDate&&e.lastKnownLocationDate&&e.onlineOffset&&(e.lastSeen=parseInt((_-e.lastKnownLocationDate)/1e3/60),e.lastKnownLocationDate+60*e.onlineOffset*1e3>_)?(e.online=!0,!0):(e.online=!1,!1)}function C(e,t){var i=c.getResources()[e.resourceId].sobject[m.resourceFieldToSortyBy],n=c.getResources()[t.resourceId].sobject[m.resourceFieldToSortyBy],r=m.descending?1:-1;return i>n?r:n>i?-1*r:0}var k=[],D={},A=[],R=f.replace(/, /g,",").split(","),I=l.resourcesAndTerritories(),F=l.resourceToServiceCrewMembers(),x=o.getTerritoriesSortedByTree();if(x.forEach(function(e){k.push(new s(e,c.operatingHours[e.operatingHours],g)),D[e.id]=k.length-1}),b)for(var M in y)y[M]&&A.push(M);var O=p.GetUserSettingsProperty("locations"),P=e.ganttSettings&&e.ganttSettings.filterCandidates;for(var E in I){var N=I[E],$=c.getResources()[E];if($&&i($.name,R)&&(!b||d.doesHaveSkills(E,A,scheduler._min_date,scheduler._max_date))){var G=!1;for(var B in w.resourceFilteringOptions)if(w.resourceFilteringOptions[B]&&!$.sobject[B]){G=!0;break}if(!G){if("select_a_field"!==w.selectedPicklist){if(w.picklistOptions.length>0&&-1===w.picklistOptions.indexOf($.sobject[w.selectedPicklist])){if(!w.picklistNullValues)continue;if("undefined"!=typeof $.sobject[w.selectedPicklist])continue}if(0===w.picklistOptions.length&&w.picklistNullValues&&"undefined"!=typeof $.sobject[w.selectedPicklist])continue}if(l.isCrewViewActive){var H=l.currentCrewToShow;if(void 0===H[E])continue;if(void 0!==H[E].members){var V=!1;for(var U in H[E].members){var j,z;if(useLocationTimezone)for(var q in N)r(scheduler._min_date,scheduler._max_date,N[q].effectiveStartDate,N[q].effectiveEndDate)&&(j=e.convertDateBetweenTimeZones(H[E].members[U].startDate,"GMT",N[q].timezone),z=e.convertDateBetweenTimeZones(H[E].members[U].endDate,"GMT",N[q].timezone),r(scheduler._min_date,scheduler._max_date,j,z)&&(V=!0));else j=e.convertDateBetweenTimeZones(H[E].members[U].startDate,"GMT",userTimeZone),z=e.convertDateBetweenTimeZones(H[E].members[U].endDate,"GMT",userTimeZone),r(scheduler._min_date,scheduler._max_date,j,z)&&(V=!0)}if(V===!1)continue}}if(w.crewsSelectionOptions.selectedPicklist!==customLabels.showAll){if(e.crewsFilter=!0,w.crewsSelectionOptions.selectedPicklist===customLabels.hideCrewMembers){if("C"!==$.sobject.ResourceType){var W=!1;for(var K in F[E])r(scheduler._min_date,scheduler._max_date,F[E][K].startDate,F[E][K].endDate)&&(W=!0);if(W===!0)continue}}else if(w.crewsSelectionOptions.selectedPicklist===customLabels.showCrewsAndCrewMembers){if("C"!==$.sobject.ResourceType){var Z=!1;for(var J in F[E])r(scheduler._min_date,scheduler._max_date,F[E][J].startDate,F[E][J].endDate)&&(Z=!0);if(Z!==!0)continue}}else if(w.crewsSelectionOptions.selectedPicklist===customLabels.showOnlyCrews){if("C"!==$.sobject.ResourceType)continue}else if(w.crewsSelectionOptions.selectedPicklist===customLabels.hideCrewsAndCrewMembers){if("C"===$.sobject.ResourceType)continue;var Y=!1;for(var X in F[E])r(scheduler._min_date,scheduler._max_date,F[E][X].startDate,F[E][X].endDate)&&(Y=!0);if(Y===!0)continue}}else e.crewsFilter=!1;if(!P||!h.getCandidatesIds()||h.getCandidatesIds()[E])for(var Q in N){var ee=e.generateResourceId(N[Q].serviceResource,N[Q].serviceTerritory);if((!T.showWorkingResource||t(ee,v,e))&&(!O||-1!=O.indexOf(N[Q].serviceTerritory))&&r(scheduler._min_date,scheduler._max_date,N[Q].effectiveStartDate,N[Q].effectiveEndDate)){var te=k[D[N[Q].serviceTerritory]],ie=new a(e.generateResourceId,c.getResources()[N[Q].serviceResource],N[Q].serviceTerritory,L(c.getResources()[N[Q].serviceResource]),!1,n(N[Q]),S);-1===te.children.map(function(e){return e.key}).indexOf(ie.key)&&te.children.push(ie)}}}}}var ne=[],re=0;return k.forEach(function(e,t){return 0===e.children.length&&ne.push(t)}),ne.forEach(function(e){return k.splice(e-re++,1)}),k.forEach(function(e){return e.children.sort(C)}),e.hasCustomPermission("Utilization_on_Service_Territory")&&showDailyUtilization&&"MonthlyView"!==scheduler._mode&&"MTDView"!==scheduler._mode&&k.forEach(function(e){for(var t=void 0,i=[],n=new Date(scheduler._min_date);n<scheduler._max_date;n.setDate(n.getDate()+1))i.push(S.calculateLocation(e.children,n));var r=i.reduce(function(e,t){return e["break"]+=t["break"],e.capacity+=t.capacity,e.overtime+=t.overtime,e.service+=t.service,e.travel+=t.travel,e.na+=t.na,e},{"break":0,capacity:0,overtime:0,service:0,travel:0,na:0});t=S.calculateLocationUtilization(r),e.addUtilizationHtml(t)}),k}}function t(e,t,i){var n=new Date(scheduler._min_date),r=t.resourceToWorkingDates[e];if(!r)return!1;for(;n<scheduler._max_date;){var s=r[i.formatDayToString(n)];if(s&&(s.regular>0||s.overtime>0))return!0;n.setDate(n.getDate()+1)}return!1}function i(e,t){if(0===t.length)return!0;for(var i=0;i<t.length;i++)if(e.toLowerCase().indexOf(t[i].toLowerCase())>-1)return!0;return!1}function n(e){return"S"===e.serviceTerritoryType}function r(e,t,i,n){return isIntersect(e,t,i,n)}function s(e,t,i){this.key=e.id,this.name=e.name,this.children=[],this.generateHtml(e,t.timezone),void 0===i.ganttOpenedTerritories[e.id]&&(i.ganttOpenedTerritories[e.id]=!0),this.open=i.ganttOpenedTerritories[e.id]}function a(e,t,i,n,r,s,a){this.key=e(t.id,i),this.resourceId=t.id,this.name=t.name,this.contractor=t.isCapacityBased,this.online=n,this.lastSeen=t.lastSeen,this.secondary=s,this.isUndestaffOrOverstaff=r,this.utilization=null,this.calculatePeriodUtilization(a,t),t.isUndestaffOrOverstaff=r,this.generateHtml(t)}angular.module("serviceExpert").filter("timelineFilter",e),e.$inject=["utils","LocationFilteringService","ResourcesAndTerritoriesService","TimePhasedDataService","ResourceCrewsService","SkillsService","calendarsService","userSettingsManager","GetSlotsService","StateService","resourceFilterHelper","LastKnownPositionService","monthlyViewHelperService","DeltaService","RegisterService"],s.prototype.generateHtml=function(e,t){if(e.parentTerritory?this.label="<div class='truncate ParentName'>"+e.parentTerritory.name+"</div><div class='truncate LocationName'>"+e.name+"</div>":this.label="<div class='truncate LocationName'>"+e.name+"</div>","MonthlyView"!==scheduler._mode&&"MTDView"!==scheduler._mode){var i=new Date,n=e.parentTerritory?"margin-top:-26px;":"";i=new Date(i.valueOf()+6e4*i.getTimezoneOffset()),i.setMinutes(i.getMinutes()+utils.getLocationOffset(i,e.id)),this.label+="<div class='timeZoneFolder' style=\""+n+'">'+t+" - "+moment(i).format("llll")+"</div>"}},s.prototype.addUtilizationHtml=function(e){var t=this.label.indexOf("Parent")>-1?'style="margin-top: -9px"':"",i=this.label.indexOf("</div>"),n="green-daily-utlz";if(e>=monthlyViewSettings.high&&e<monthlyViewSettings.critical?n="yellow-daily-utlz":e>=monthlyViewSettings.critical&&(n="red-daily-utlz"),null!==e){var r='<b class="'+n+'">'+e+"%</b>";e='<div class="dailyViewUtilization" '+t+">"+customLabels.UtilizationDaily.replace("$0",r)+" </div>",this.label=this.label.slice(0,i+6)+e+this.label.slice(i+6)}},a.prototype.calculatePeriodUtilization=function(e,t){if("MonthlyView"===scheduler._mode){for(var i=[],n=new Date(scheduler._min_date);n<scheduler._max_date;n.setDate(n.getDate()+1))i.push(e.calculateDailyResourceCapacity(this,n));var r=i.reduce(function(e,t){return e["break"]+=t["break"],e.capacity+=t.capacity,e.overtime+=t.overtime,e.service+=t.service,e.travel+=t.travel,e.na+=t.na,e},{"break":0,capacity:0,overtime:0,service:0,travel:0,na:0});this.utilization=e.calculateLocationUtilization(r),t.sobject.__Utilization__=this.utilization}},a.prototype.generateHtml=function(e){this.label="";var t=this.online?"online-indicator":"online-indicator offline-indicator",i=this.secondary?"<span class='secondaryGanttLabel' title=\""+customLabels.Secondary+'">('+customLabels.Secondary+")</span>":"",n=e.lastKnownLocationDate&&this.lastSeen<1440?'<div class="'+t+'" title="'+utils.hoursMinutes(this.lastSeen,customLabels.SeenXMinsHoursAgo,customLabels.SeenXAgoHours,customLabels.SeenXAgo)+'"></div>':"";if(void 0!==e.serviceCrew__r){var r=scheduler.matrix.ZoomLevel3.dy<33?"SmallResourceCrewPhoto":"ResourceCrewPhoto",s="";e.pictureLink?this.label+="<img src='"+e.pictureLink+"' title='"+e.description+"' class='"+r+"' />":this.label+="<span class='"+r+'\'><svg aria-hidden="true" class="crew-slds-icon crewContextMenuIcon"><use xlink:href=\''+lsdIcons.crew+"'></use></svg></span>",this.label+=""+s+n}else if(e.pictureLink){var a=scheduler.matrix.ZoomLevel3.dy<33?"SmallResourcePhoto":"ResourcePhoto";this.label+="<img src='"+e.pictureLink+"' title='"+e.description+"' class='"+a+"' />"+n}else{var o=scheduler.matrix.ZoomLevel3.dy<33?"SmallResourcePhotoDefault":"NormalResourcePhotoDefault";this.label+="<div title='"+e.description+"' class=\"ResourcePhotoIcon "+o+'"></div>'+n}if(this.label+='<div class="resourceMenuBtn">\n                            <svg aria-hidden="true" class="slds-icon resourceMenuIcon">\n                                <use xlink:href="'+lsdIcons.threedots+'"></use>\n                            </svg>\n                        </div>',e.ganttLabel||"MonthlyView"===scheduler._mode){var c=e.ganttLabel||"";if("MonthlyView"===scheduler._mode&&null!==this.utilization){var l="resource-utiliz-low";c=customLabels.TotalUtilizationResource,monthlyViewSettings.critical<=this.utilization?l="resource-utiliz-high":monthlyViewSettings.high<=this.utilization&&(l="resource-utiliz-med"),c+=' <span class="'+l+'">'+this.utilization+"%</span>"}scheduler.matrix.ZoomLevel3.dy<33?this.label+="<a resource='"+this.id+"' title='"+e.description+"'>"+this.name+" "+i+"</a>\n                <div class='smallResourceGanttLabel truncate'>"+c+"</div>":this.label+="<a resource='"+this.id+"' class='smallResourceName' title='"+e.description+"'>"+this.name+" "+i+"</a>\n                <div class='resourceGanttLabel truncate'>"+c+"</div>"}else scheduler.matrix.ZoomLevel3.dy<33?this.label+="<a resource='"+this.id+"' class='smallResourceName' style='margin-top:6px;' title='"+e.description+"'>"+this.name+" "+i+"</a>":this.label+="<a resource='"+this.id+"' style='margin-top:6px;' title='"+e.description+"'>"+this.name+" "+i+"</a>"}}(),function(){angular.module("serviceExpert").filter("toArray",function(){return function(e){var t=[];return angular.forEach(e,function(e,i){t.push(e)}),t}})}(),function(){function stringifySingleCondition(e,t,i){if(e[getPropertyName(t.property)]||e[getPropertyName(t.property)]===!1||(e[getPropertyName(t.property)]=""),"FSL__RULE_VIOLATIONS__FSL"===t.property){var n="true"===t.value.toString();return"equals"===t.operator&&n||"not equal to"===t.operator&&!n?"(Array.isArray(__evalRealService.violations) && __evalRealService.violations.length > 0)":"(!__evalRealService.violations || (Array.isArray(__evalRealService.violations) && __evalRealService.violations.length === 0))";
}var r=evaluateOperator(t.operator);if(t.value&&t.value.indexOf&&t.value.indexOf(",")>-1&&(t.value=t.value.replace(/, /g,",").split(",")),Array.isArray(t.value))return t.value=t.value.map(function(e){return e.toLowerCase?e.toLowerCase():e}),__picklistArrayForFilter[i]=t.value,evaluateArrayValue(t.operator,t.property,i);if(evaluateValue(t.property,t.value,__ganttFilterFieldSet,i),r){var s=__ganttFilterFieldSet[t.property].Type;return"STRING"===s||"TEXTAREA"===s||"EMAIL"===s||"REFERENCE"===s?"__evalService."+getPropertyName(t.property)+".toLowerCase() "+evaluateOperator(t.operator)+" __evalConditionValue."+t.property+"_"+i+".toLowerCase()":"__evalService."+getPropertyName(t.property)+" "+evaluateOperator(t.operator)+" __evalConditionValue."+t.property+"_"+i}return evaluateSepcialOperator(t.operator,t.value,t.property)}function evaluateArrayValue(e,t,i){switch(e){case"contains":return"new RegExp(__picklistArrayForFilter["+i+"].join(\"|\"), 'i').test(__evalService."+getPropertyName(t)+") === true";case"does not contain":return"new RegExp(__picklistArrayForFilter["+i+"].join(\"|\"), 'i').test(__evalService."+getPropertyName(t)+") === false";case"start with":return"new RegExp('^' + __picklistArrayForFilter["+i+"].join(\"|\"), 'i').test(__evalService."+getPropertyName(t)+") === true";case"equals":return"__picklistArrayForFilter["+i+"].indexOf(__evalService."+getPropertyName(t)+".toLowerCase()) > -1";case"not equal to":return"__picklistArrayForFilter["+i+"].indexOf(__evalService."+getPropertyName(t)+".toLowerCase()) === -1";default:return"__picklistArrayForFilter["+i+"].some( element => __evalService."+getPropertyName(t)+" "+evaluateOperator(e)+" element)"}}function getPropertyName(e){return"FSL__RULE_VIOLATIONS__FSL"===e?"FSL__RULE_VIOLATIONS__FSL":removeNamespace(__ganttFilterFieldSet[e].APIName)}function evaluateCondition(service,conditions,logic){var serviceFields=service.fields;window.__evalService=serviceFields,window.__evalRealService=service;var stringConditions=logic?replaceLogicOperators(logic):"",conditionsMapped={};for(var i in conditions)conditionsMapped[i]=stringifySingleCondition(serviceFields,conditions[i],i-1),logic||(stringConditions+="{"+i.toString()+"} && ");logic||(stringConditions=stringConditions.substr(0,stringConditions.length-3));for(var _i in conditionsMapped)stringConditions=stringConditions.replace("{"+_i+"}",conditionsMapped[_i]);return""===stringConditions?!0:eval(stringConditions)}function evaluateValue(e,t,i,n){if(!i[e])return void(window.__evalConditionValue[e]=null);switch(i[e].Type){case"BOOLEAN":window.__evalConditionValue[e+"_"+n]=t===!0;break;case"DATE":case"DATETIME":window.__evalConditionValue[e+"_"+n]=new Date(t);break;case"STRING":case"EMAIL":case"TEXTAREA":case"REFERENCE":t?window.__evalConditionValue[e+"_"+n]=t.toLowerCase():window.__evalConditionValue[e+"_"+n]="";break;default:window.__evalConditionValue[e+"_"+n]=t}}function evaluateOperator(e){switch(e){case"equals":return"==";case"not equal to":return"!=";case"less than":return"<";case"greater than":return">";case"less or equal":return"<=";case"greater or equal":return">=";default:return null}}function evaluateSepcialOperator(e,t,i){switch(e){case"contains":return"__evalService."+getPropertyName(i)+".toLowerCase().indexOf('"+t.toLowerCase()+"') > -1";case"does not contain":return"__evalService."+getPropertyName(i)+".toLowerCase().indexOf('"+t.toLowerCase()+"') === -1";case"start with":return"__evalService."+getPropertyName(i)+".toLowerCase().indexOf('"+t.toLowerCase()+"') === 0"}}function replaceLogicOperators(e){return e=e.split("AND").join("&&"),e=e.split("OR").join("||"),e=e.split("NOT").join("!")}function removeNamespace(e){if(fslNamespace&&0===e.indexOf(fslNamespace)){var t=fslNamespace.length+2;return e.substr(t,e.length-t)}return e}function isServiceInDateRange(e,t,i,n){var r=scheduler._min_date,s=scheduler._max_date;return n.List_only_appointments_on_the_gantt?e.end_date&&isIntersectIncludeLimits(r,s,e.end_date,e.end_date)?!0:e.start_date&&isIntersectIncludeLimits(r,s,e.start_date,e.start_date)?!0:!1:(r=new Date(i),s=new Date(i),r.setDate(r.getDate()-n.Days_before_horizon),s.setDate(s.getDate()+n.Days_after_horizon+1),t.earlyStart&&e.earliestStartTime&&isIntersectIncludeLimits(r,s,e.earliestStartTime,e.earliestStartTime)?!0:t.dueDate&&e.dueDate&&isIntersectIncludeLimits(r,s,e.dueDate,e.dueDate)?!0:t.start&&e.start&&isIntersectIncludeLimits(r,s,e.start,e.start)?!0:t.finish&&e.finish&&isIntersectIncludeLimits(r,s,e.finish,e.finish)?!0:t.appStart&&e.appStart&&isIntersectIncludeLimits(r,s,e.appStart,e.appStart)?!0:t.appEnd&&e.appEnd&&isIntersectIncludeLimits(r,s,e.appEnd,e.appEnd)?!0:t.display&&e.ganttDisplay&&isIntersectIncludeLimits(r,s,e.ganttDisplay,e.ganttDisplay)?!0:!1)}function searchOnService(e,t,i){if(e.name&&-1!==e.name.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.ganttLabel&&-1!==e.ganttLabel.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.accountName&&-1!==e.accountName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.resourceName&&-1!==e.resourceName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.id&&-1!==e.id.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.serviceTerritoryName&&-1!==e.serviceTerritoryName.toLowerCase().indexOf(t.toLowerCase()))return!0;if(e.status&&-1!==e.status.toLowerCase().indexOf(t.toLowerCase()))return!0;for(var n=0;n<i.length;n++)if((i[n].Type===utils.fieldsTypes.String||i[n].Type===utils.fieldsTypes.TextArea||i[n].Type===utils.fieldsTypes.Reference||i[n].Type===utils.fieldsTypes.Picklist)&&e[i[n].APIName]&&-1!==e[i[n].APIName].toLowerCase().indexOf(t.toLowerCase()))return!0;return!1}window.__ganttFilterFieldSet={},window.__picklistArrayForFilter=[],window.__evalConditionValue={},angular.module("serviceExpert").filter("servicesListFilterNew",["utils","$filter","GanttFilterService","FieldSetFieldsService",function(e,t,i,n){return n.fieldsSetFields().then(function(e){e.ganttFilter.forEach(function(e){return __ganttFilterFieldSet[e.FullAPIName]=e})}),function(e,n,r){var s=[],a=i.getFilterById(n.selectedFilter);if(a){var o=null,c=[];n.SearchText.indexOf(",")>-1&&(o=n.SearchText.replace(/, /g,",").split(","),""===o[o.length-1]&&o.length--),o?c=o:c.push(n.SearchText);for(var l in e){if(n.SearchText){for(var u=!1,d=0;d<c.length;d++)if(searchOnService(e[l],c[d],r)){u=!0;break}if(!u)continue}n.pivotDate=new Date(n.endDate),n.pivotDate.setHours(0),n.pivotDate.setMinutes(0),isServiceInDateRange(e[l],n.selectedFiled,n.pivotDate,a)&&evaluateCondition(e[l],a.Criterias,a.Logic)&&s.push(e[l])}}else for(var v in e)s.push(e[v]);return t("orderBy")(s,n.orderByField,n.reverse)}}])}(),function(){function e(){function e(e,t,i,n,r,s,a,o,c,l,u,d){e.bulkActionsOrder=bulkActionsOrder,e.customActions=[],e.actionNames={Schedule:{name:customLabels.Schedule,icon:lsdIcons.calendar},Dispatch:{name:customLabels.Dispatch,icon:lsdIcons.dispatch},Optimize:{name:customLabels.Optimize,icon:lsdIcons.magicwand},"Flag-Unflag":{name:customLabels.Flag_Unflag,icon:lsdIcons.flag},Unschedule:{name:customLabels.Unschedule,icon:lsdIcons.na}},i.customActionsPromise.then(function(){var t,n=i.getCustomActions("bulk");(t=e.customActions).push.apply(t,_toConsumableArray(n))}),e.runCustomServiceAction=function(e){var n=s.getSelected();if(e.visualforce){var r=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),a=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();1===n.length?u.open(e.name,e.visualforce+"?id="+n[0]+"&start="+r+"&end="+a):u.open(e.name,e.visualforce+"?services="+n.join(",")+"&start="+r+"&end="+a)}else{if(0===n.length)return;l.runCustomServiceAction(e.className,n,scheduler._min_date,scheduler._max_date).then(function(r){l.getServicesById(n).then(function(n){var s=d.updateTimePhaseData(n,"service").services;t.drawServicesAndAbsences(s,[],[],[]),r&&i.addNotification(e.name,r,null,null)})})["catch"](function(t){return i.addNotification(e.name,t.message,null,null)})}},e.checkHasCustomPermission=function(e){return void 0==i.hasCustomPermission("Bulk_"+e)?!0:i.hasCustomPermission("Bulk_"+e)},e.openBulkAction=function(e){switch(e){case"Schedule":o.schedule(s.getSelected());break;case"Dispatch":n.open();break;case"Unschedule":r.open();break;case"Optimize":a.open();break;case"Flag-Unflag":for(var i=s.getSelected(),c=0;c<i.length;c++)t.flagged[i[c]]=!t.flagged[i[c]];updateViewDebounced()}}}e.$inject=["$scope","servicesService","utils","bulkDispatchService","bulkUnscheduleService","ServiceSelectorService","optimizeLightboxService","bulkScheduleService","rdOptimizeLightboxService","sfdcService","GeneralLightbox","TimePhasedDataService"];var t='<div id="quickActionsButtons">\n			                    <div id="actionQuickFirst" class="truncate quickActionBtn" ng-show="bulkActionsOrder.first.length && checkHasCustomPermission(actionNames[bulkActionsOrder.first[0].title].name)" ng-click="openBulkAction(bulkActionsOrder.first[0].title)" title="{{actionNames[bulkActionsOrder.first[0].title].name}}">\n									{{actionNames[bulkActionsOrder.first[0].title].name}}\n								</div>\n	                        	<div id="actionQuickSecond"\n									 class="truncate quickActionBtn"\n									 ng-show="bulkActionsOrder.second.length && checkHasCustomPermission(actionNames[bulkActionsOrder.second[0].title].name)"\n									 ng-click="openBulkAction(bulkActionsOrder.second[0].title)"\n									 title="{{actionNames[bulkActionsOrder.second[0].title].name}}">{{actionNames[bulkActionsOrder.second[0].title].name}}</div>\n		                    	<div class="truncate" id="ActionButton" ng-show="bulkActionsOrder.dropdown.length" cs-toggle="MainActionContainer">\n                                    <span ng-show="(!bulkActionsOrder.first.length &&\n                                                   !bulkActionsOrder.second.length) ||\n                                                   (!checkHasCustomPermission(actionNames[bulkActionsOrder.first[0].title].name) &&\n                                                   !checkHasCustomPermission(actionNames[bulkActionsOrder.second[0].title].name))">\n                                           '+customLabels.Actions+'\n                                    </span>\n                                    <i class="fa fa-caret-down"></i>\n		                    	</div>\n	                    	</div>\n	                    	\n	                        <div id="MainActionContainer">\n			                    <div class="truncate BulkActionMenuItem" ng-repeat="action in bulkActionsOrder.dropdown" ng-show="checkHasCustomPermission(actionNames[action.title].name)" ng-click="openBulkAction(action.title)">\n									<svg aria-hidden="true" class="slds-icon mainActionIcon">\n										\u2028<use xlink:href="{{actionNames[action.title].icon}}"></use>\n									\u2028</svg>\n									{{actionNames[action.title].name}}\n                                </div>\n                                \n                                \n                                <div class="truncate BulkActionMenuItem" ng-repeat="action in customActions" ng-click="runCustomServiceAction(action)">\n                                \n                                    <svg aria-hidden="true" class="slds-icon mainCustomActionIcon">\n										\u2028<use xlink:href="{{action.icon}}"></use>\n									\u2028</svg>\n                                \n									{{action.name}}\n                                </div>\n                                                               \n                                \n	                        </div>';return{restrict:"E",template:t,scope:{},controller:e}}angular.module("serviceExpert").directive("bulkActionsButton",e),e.$inject=[]}(),function(){function e(){return customLabels.starting_from_x_until_y_including_z_services.replace("$0",'<u id="bulkStartOptimize" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>').replace("$1",'<u id="bulkFinishOptimize" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>').replace("$2",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="optimizeAllServices">\n								<option value="all">'+customLabels.All+'</option>\n								<option value="unscheduled">'+customLabels.UnscheduledCapital+"</option>\n							</select>")}function t(){return customLabels.Use_the_following_policy_x_and_y.replace("$0",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="selectedPolicy" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions"></select>').replace("$1",'<select ng-model="optimizeSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n								 	<option ng-repeat="(fieldName, fieldLbl) in checkBoxFields" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n								 	<option value="noFilter">'+customLabels.None+"</option>\n								 </select>")}function i(){return customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartChangeStatus" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartChangeStatus\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>').replace("$1",'<u id="bulkFinishChangeStatus" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishChangeStatus\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>')}function n(){return customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesStart()" ng-model="startMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n							</select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect" ng-change="validateDatesEnd()" ng-model="endMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>')}function r(){return customLabels.changeStatusBulkMsg.replace("$0",'<select class="selectChangeStatusBulk bulkStatusWidth" ng-model="bulkStatus">\n								<option ng-repeat="(statusType,statusLabel) in statuses" value="{{statusLabel}}" >{{getStatusTranslations()[statusLabel]}}</option>\n							</select>')}angular.module("serviceExpert").directive("bulkOptimizeOptions",function(){return{template:e()}}).directive("bulkOptimizePolicy",function(){return{template:t()}}).directive("bulkChangeStatusDates",function(){return{template:i()}}).directive("bulkUnscheduleDates",function(){return{template:n()}}).directive("bulkChangeStatusPicklist",function(){return{template:r()}})}(),function(){function e(){function e(e){e.colors=[{Name:"Red",Hex:"#E53935"},{Name:"Pink",Hex:"#D81B60"},{Name:"Purple",Hex:"#8E24AA"},{Name:"Indigo",Hex:"#3949AB"},{Name:"Blue",Hex:"#1E88E5"},{Name:"Cyan",Hex:"#00ACC1"},{Name:"Teal",Hex:"#00897B"},{Name:"Green",Hex:"#43A047"},{Name:"Lime",Hex:"#C0CA33"},{Name:"Yellow",Hex:"#FDD835"},{Name:"Amber",Hex:"#FFB300"},{Name:"Orange",Hex:"#FB8C00"},{Name:"Brown",Hex:"#6D4C41"},{Name:"Grey",Hex:"#757575"},{Name:"Blue Grey",Hex:"#546E7A"},{Name:"Black",Hex:"#000"}],e.selectColor=function(t){e.selectedColor=t.Hex,e.setSelectedShapeColor(t.Hex),e.showColorMenu=!1},e.showMenuClick=function(t){(e.drawState==e.drawingStates.EDIT||e.drawState==e.drawingStates.DRAW)&&(e.showColorMenu=!e.showColorMenu)},e.selectedColor="#546E7A",e.showColorMenu=!1,angular.element("#mapOptionsContainer").on("click",function(t){for(var i=["color-square","color-button"],n=0;n<i.length;n++)if(t.target.classList.contains(i[n])||t.target.parentNode&&t.target.parentNode.classList.contains(i[n]))return;e.showColorMenu&&(e.showColorMenu=!1)})}e.$inject=["$scope"];var t='<div id="select-color-btn" title="'+customLabels.Select_color+'" class="color-button truncate"  ng-click="showMenuClick()" ng-class="{disabledButton: drawState != drawingStates.EDIT && drawState != drawingStates.DRAW}">\n                            <span class="color-square" ng-style="{\'background-color\': selectedColor}"></span><span>'+customLabels.Select_color+'</span>\n                        </div>\n                        <div class="color-menu" id="colorMenu" ng-show="showColorMenu == true">\n                            <span class="color-box" ng-repeat="color in colors" ng-click="selectColor(color)" ng-style="{\'background-color\': color.Hex}"></span>\n                        </div>';return{restrict:"E",template:t,scope:!1,controller:e}}angular.module("serviceExpert").directive("csColorPicker",e),e.$inject=[]}(),function(){function e(){function e(e,r,a,o,c,l){e.isEmpty=r.isEmpty,e.paletteApplied=!1,e.updatePaletteView=function(){if(e.calculatePaletteColors=!1,e.paletteDataIsValid=!0,e.paletteApplied===!0&&e.clearPalette(),void 0!==e.GanttPalettes[e.selectedPalette]){var a,o;e.currentPalette=e.GanttPalettes[e.selectedPalette],e.picklistMap={},r.serviceFieldsMap().then(function(r){var c=r[e.currentPalette.ServiceProperty];try{if(c.Type===FieldTypes.PICKLIST&&(a=Object.keys(e.currentPalette.ColorScheme.picklist[c.Name]),o=Object.values(e.currentPalette.ColorScheme.picklist[c.Name])),c.Type===FieldTypes.BOOLEAN&&(a=[customLabels.Selected,customLabels.Deselected],o=[e.currentPalette.ColorScheme.max.color,e.currentPalette.ColorScheme.min.color]),c.Type===FieldTypes.DATE||c.Type===FieldTypes.DATETIME){var u=l.convertMomentDtToDt(moment().tz(userTimeZone));o=s(e.currentPalette.ColorScheme.min.color,e.currentPalette.ColorScheme.max.color,e.currentPalette.ColorLevel),a=n(u,e.currentPalette.ColorScheme.min.value,e.currentPalette.ColorScheme.max.value,e.currentPalette.ColorScheme.min.type,e.currentPalette.ColorScheme.max.type,e.currentPalette.ColorLevel)}c.Type===FieldTypes.DOUBLE&&(o=s(e.currentPalette.ColorScheme.min.color,e.currentPalette.ColorScheme.max.color,e.currentPalette.ColorLevel),a=t(e.currentPalette.ColorScheme.min.value,e.currentPalette.ColorScheme.max.value,e.currentPalette.ColorLevel)),(c.Type===FieldTypes.INTEGER||c.Type===FieldTypes.PERCENT)&&(o=s(e.currentPalette.ColorScheme.min.color,e.currentPalette.ColorScheme.max.color,e.currentPalette.ColorLevel),a=i(e.currentPalette.ColorScheme.min.value,e.currentPalette.ColorScheme.max.value,e.currentPalette.ColorLevel)),(c.Type===FieldTypes.LOCATION||c.Type===FieldTypes.ADDRESS)&&(o=s(e.currentPalette.ColorScheme.min.color,e.currentPalette.ColorScheme.max.color,e.currentPalette.ColorLevel),a=t(e.currentPalette.ColorScheme.min.value,e.currentPalette.ColorScheme.max.value,e.currentPalette.ColorLevel,!0)),e.picklistLength=o.length;for(var d=0;d<o.length;d++)e.picklistMap[a[d]]=o[d]}catch(v){e.paletteDataIsValid=!1}})}},e.clearPalette=function(){e.hidePaletteView(),e.paletteApplied=!1},e.applyPalette=function(){if(e.calculatePaletteColors)return void alert("Still applying last palette");e.calculatePaletteColors=!0;var t=e.GanttPalettes[e.selectedPalette];return void 0===t?(alert("No palette selected"),void(e.calculatePaletteColors=!1)):void r.applyNewPaletteForGantt(t,a.serviceAppointments()).then(function(t){e.showPaletteView(),e.paletteApplied=!0,e.calculatePaletteColors=!1})},e.openPalettesLightbox=function(e){switch(e){case"edit":o.open(customLabels.GanttPalettes,GanttPalettePage)}},e.calculatePalettePortionStyle=function(t){return{background:t,width:100/e.picklistLength+"%",height:"12px"}},r.getGanttPalettes().then(function(t){e.GanttPalettes=t,e.selectedPalette=c.GetUserSettingsProperty("Gantt_Palette__c")||(void 0==e.GanttPalettes||e.isEmpty(e.GanttPalettes)?customLabels.NoPalettes:customLabels.None),e.updatePaletteView()})}function t(e,t,i,n){e=parseFloat(e),t=parseFloat(t);for(var r=(t-e)/i,s=[],o=0;i>o;o++){var c=e+o*r,l=e+(o+1)*r;n?0===o?s.push(a([l,distanceUnit,customLabels.OrLower])):o===i-1?s.push(a([customLabels.HigherThan,c,distanceUnit])):s.push(customLabels.Between_x_and_y.replaceAll(a([c,distanceUnit]),a([l,distanceUnit]))):0===o?s.push(a([l,customLabels.OrLower])):o===i-1?s.push(a([customLabels.HigherThan,c])):s.push(customLabels.Between_x_and_y.replaceAll(c,l))}return s}function i(e,t,i){e=parseInt(e),t=parseInt(t);var n=(t-e)/i;n=Math.round(n);for(var r=[],s=0;i>s;s++){var o=e+s*n,c=e+(s+1)*n;0===s?r.push(a([c,customLabels.OrLower])):s===i-1?r.push(a([customLabels.HigherThan,o])):r.push(customLabels.Between_x_and_y.replaceAll(o,c))}return r}function n(e,t,i,n,s,o){for(var c=r(n,t),l=r(s,i),u=e.getTime()+c,d=e.getTime()+l,v=(d-u)/o,p=[],h=0;o>h;h++){var g=u+h*v,m=moment(g),f=u+(h+1)*v,S=moment(f);0===h?p.push(a([customLabels.Earlierthan,S.format("dddd, MMMM Do YYYY, h:mm:ss a")])):h===o-1?p.push(a([customLabels.LaterThan,m.format("dddd, MMMM Do YYYY, h:mm:ss a")])):p.push(customLabels.Between_x_and_y.replaceAll(m.format("dddd, MMMM Do YYYY, h:mm:ss a"),S.format("dddd, MMMM Do YYYY, h:mm:ss a")))}return p}function r(e,t){var i;switch(e){case"Minutes":i=60*t*1e3;break;case"Hours":i=60*t*60*1e3;break;case"Days":i=24*t*60*60*1e3}return i}function s(e,t,i){for(var n=[],r=e.substr(1,2),s=e.substr(3,4).substr(0,2),a=e.substr(5,6),o=t.substr(1,2),c=t.substr(3,4).substr(0,2),l=t.substr(5,6),u=parseInt(r,16),d=parseInt(s,16),v=parseInt(a,16),p=parseInt(o,16),h=parseInt(c,16),g=parseInt(l,16),m=p-u,f=m/i,S=h-d,b=S/i,y=g-v,_=y/i,T=0;i>T;T++){var w=Math.round(Math.abs(u+f*T))%256,L=Math.round(Math.abs(d+b*T))%256,C=Math.round(Math.abs(v+_*T))%256,k=w.toString(16);1===k.length&&(k="0"+k);var D=L.toString(16);1===D.length&&(D="0"+D);var A=C.toString(16);1===A.length&&(A="0"+A);var R="#"+k+D+A;n.push(R)}return n}function a(e){for(var t="",i=0;i<e.length;i++)t+=e[i]+" ";return t}e.$inject=["$scope","GanttPalettesService","TimePhasedDataService","GeneralLightbox","userSettingsManager","utils"];var o='<div>\n                            <div class="palette-explain-headline">\n                                <div class="palette-explain">\n                                    '+customLabels.PaletteChangeExplain+'\n                                </div>\n\n                                <div ng-if="showPaletteEdit" class="globalWhiteButton palette-editor-button" title="'+customLabels.OpenPaletteEditor+'" ng-click="openPalettesLightbox(\'edit\')">\n                                    <span>\n                                        <svg aria-hidden="true" class="slds-icon palette-icon">\n                                            <use xlink:href=\''+lsdIcons.colorSwatch+'\'></use>\n                                        \u2028</svg>\n                                    </span>\n                                </div>\n                            </div>\n\n                            <div>\n                                <span>\n                                    <select class="ganttPaletteSelector" ng-model="selectedPalette" ng-change="updatePaletteView()">\n                                        <option ng-if="isEmpty(GanttPalettes) == true" value="'+customLabels.NoPalettes+'">--- '+customLabels.NoPalettes+' ---</option>\n                                        <option ng-if="isEmpty(GanttPalettes) == false" value="'+customLabels.None+'">--- '+customLabels.None+' ---</option>\n                                        <option ng-repeat="(key,value) in GanttPalettes" value="{{key}}">{{value.Name}}</option>\n                                    </select>\n                                </span>\n                            </div>\n\n                            <div class="palette-details-container" ng-if="GanttPalettes[selectedPalette] !== undefined">\n                                \n                                <div ng-if="paletteDataIsValid">\n\n                                    '+customLabels.HoverPaletteColor+'\n                                \n                                    <div style="padding-top: 10px">\n                                        <div class="paletteBox">\n                                            <span title="{{key}}" ng-class="{\'roundBoxRight\': $last, \'roundBoxLeft\': $first}" ng-style="calculatePalettePortionStyle(value)" ng-repeat="(key, value) in picklistMap"></span>\n                                        </div>\n                                    </div>\n\n                                    <div class="palette-description" ng-hide="currentPalette.Description === \'\' || currentPalette.Description === undefined">\n                                        <div class="description-label-heading">\n                                            '+customLabels.Description+'\n                                        </div>\n                                        <div class="palette-description-content">\n                                            {{currentPalette.Description}}\n                                        </div>\n                                    </div>\n                                    \n                                    <div class="apply-palette-button-container">\n                                        <span ng-show="paletteApplied === false" ng-class="{ quickActionBtnForPaletteDisabled : calculatePaletteColors, quickActionBtnForPalette: !calculatePaletteColors}"  class="" ng-click="applyPalette()">'+customLabels.ApplyPalette+'</span>\n                                        <span ng-show="paletteApplied === true" ng-class="{ quickActionBtnForPaletteDisabled : calculatePaletteColors, quickActionBtnForPalette: !calculatePaletteColors}"  class="" ng-click="clearPalette()">'+customLabels.UseDefaultPalette+'</span>\n                                    </div>\n\n                                </div>\n\n                                <div class="palette-details-error" ng-if="paletteDataIsValid == false">\n                                    '+customLabels.PaletteDataIsInvalid+"\n                                </div>\n\n                            </div>\n                        </div>";return{restrict:"E",template:o,scope:{showPaletteView:"=",showPaletteEdit:"=",hidePaletteView:"="},controller:e}}angular.module("serviceExpert").directive("ganttPalette",e),e.$inject=[]}(),function(){angular.module("serviceExpert").directive("csRange",["$filter","utils",function(e,t){function i(i,n,r){var s=$($(n[0]).find(".showingDates")),a=isAMPM?"ampm":"24",o=$($(n[0]).find(".sliderSelector"));i.$watchCollection(r.ngModel,function(t,i){!o.slider("instance")||t.start===i.start&&t.end===i.end||(o.slider("values",[t.start,t.end]),s.text(r.showingText.replace("{1}",e("ampmOr24")(parseInt(t.start),a,!0)).replace("{2}",e("ampmOr24")(parseInt(t.end),a,!0))))}),o.slider({range:!0,min:parseInt(r.min),max:parseInt(r.max),values:[parseInt(r.defaultStart),parseInt(r.defaultEnd)],slide:function(t,i){s.text(r.showingText.replace("{1}",e("ampmOr24")(parseInt(i.values[0]),a,!0)).replace("{2}",e("ampmOr24")(parseInt(i.values[1]),a,!0)))},stop:function(e,n){t.safeApply(i,function(){i[r.ngModel].start=n.values[0],i[r.ngModel].end=n.values[1]})}}),s.text(r.showingText.replace("{1}",e("ampmOr24")(parseInt(r.defaultStart),a,!0)).replace("{2}",e("ampmOr24")(parseInt(r.defaultEnd),a,!0)))}return{restrict:"CAE",link:i,scope:!0,template:'<div class="sliderSelector"></div><span class="showingDates"></span>'}}])}(),function(){angular.module("serviceExpert").directive("safeBinder",[function(){function e(e,t,i){$(t[0]).html(e.safeBinder)}return{restrict:"A",scope:{safeBinder:"="},link:e}}])}(),function(){function e(){function e(e){e.callMe=function(e,t,i,n){var r=i+" "+n;return sendCTIMessage("/CLICK_TO_DIAL?DN="+encodeURIComponent(e)+"&amp;ID="+t+"&amp;ENTITY_NAME=User&amp;OBJECT_NAME="+encodeURIComponent(r)+"&amp;DISPLAY_NAME="+encodeURIComponent("User")),!1}}e.$inject=["$scope"];var t='<span class="tel" style="display: none;">\n                                <img src="/img/s.gif" alt="" width="1" height="1" title="" onload="if (self.registerClickToDial) registerClickToDial(this.parentNode, false);"></img>{{number}}\n                                <img src="/img/btn_nodial_inline.gif" alt="Click to dial disabled" width="16" height="10" title="Click to dial disabled"></img>\n                            </span> \n                            <span style="display: block;">\n                                <img src="/img/s.gif" alt="" width="1" height="1" title="" onload="if (self.registerClickToDial) registerClickToDial(this.parentNode, true);"></img>\n                                <a href="javascript:void(0);" onclick="disableClicked(this, \'Click to dial disabled\');" ng-click="callMe(number, userId, userFirstName, userLastName)" title="">{{number}}\n                                    <img src="/img/btn_dial_inline.gif" alt="Click to dial" width="16" height="10" title="Click to dial" style="display: inline;"></img>\n                                    <img src="/img/btn_nodial_inline.gif" alt="Click to dial disabled" width="16" height="10" style="display: none;" title="Click to dial disabled"></img>\n                                </a>\n                            </span>';return{restrict:"E",template:t,scope:{number:"@",userId:"@",userFirstName:"@",userLastName:"@"},controller:e}}angular.module("serviceExpert").directive("csClickToDial",e),e.$inject=[]}(),function(){angular.module("serviceExpert").directive("dhxScheduler",["$rootScope","$timeout","userSettingsManager","$q","sfdcService","ResourcesAndTerritoriesService","FieldSetFieldsService",function(e,t,i,n,r,s,a){return{restrict:"C",transclude:!0,template:'<div class="dhx_cal_navline" ng-transclude></div><div class="dhx_cal_header"></div><div class="dhx_cal_data"></div>',link:function(r,o,c){window.utils=angular.element("#serviceExpertApp").injector().get("utils");var l=_.debounce(function(e){scheduler.updateCollection("resources",e)},500);r.$watch(c.resources,function(e){return folderJustToggled?void(folderJustToggled=!1):void l(e)},!0),o.addClass("dhx_cal_container"),schedulerConfig.configTimelines(),schedulerConfig.setConfigurations();var u=i.GetUserSettingsProperty("Gantt_View_Start_Hour__c"),d=i.GetUserSettingsProperty("Gantt_View_Finish_Hour__c"),v=i.GetUserSettingsProperty("Resource_Row_Height__c"),p=i.GetUserSettingsProperty("View_Capacity_Type__c"),h=i.GetUserSettingsProperty("Include_Weekends__c"),g=i.GetUserSettingsProperty("Load_On_Today__c"),m=i.GetUserSettingsProperty("Lock_Gantt__c");
null!==m&&schedulerConfig.setReadOnly(m),null!==v&&schedulerConfig.setRowHeights(v,!1),null!==p&&setCapacityFilter(p),null!==u&&null!==d&&setHoursToDisplay(u,d,h),e.policy=defaultPolicy;var f=n.all([s.promises.territories(),s.promises.resources(),a.fieldsSetFields()]);f.then(function(){scheduler.init(o[0],new Date,"ZoomLevel3"),r.scheduler=scheduler,r.datalessMethods=attchDatalessSchedulerEvents(),t(function(){switch(g&&scheduler.setCurrentView(new Date),r.getTimePhasedObjects().then(function(){$("#FirstTimeLoading").remove()})["catch"](function(e){bootstrap.handleError(e)}),scheduler._mode){case"ZoomLevel2":r.timelineName=customLabels.In_Day;break;case"ZoomLevel3":r.timelineName=customLabels.Daily;break;case"ZoomLevel4":r.timelineName=customLabels.X2_Days;break;case"ZoomLevel5":r.timelineName=customLabels.X3_Days;break;case"ZoomLevel6":r.timelineName=customLabels.Weekly}},0),e.$broadcast("initCompleted")}),function(e){console.log("err:"+e)}}}}])}(),function(){angular.module("serviceExpert").directive("dragNA",function(){return{restrict:"CAE",scope:{dragService:"="},link:function(e,t,i,n){cachedDomElements.draggedBreak||(cachedDomElements.draggedBreak=$("#draggedBreak")),cachedDomElements.draggedBreakDiv||(cachedDomElements.draggedBreakDiv=$("#draggedBreak div")),t.bind("dragstart",function(e){var t=$("#breakDuration").val();e.originalEvent.dataTransfer.setData("text","absenceNA_"+t),cachedDomElements.draggedBreakDiv.html(t);var i=getMinAndMaxHoursToDisplay(),n=new Date(scheduler._min_date.getTime()+1e3*i.min*60*60),r=new Date(scheduler._min_date.getTime()+1e3*i.min*60*60);r.setMinutes(r.getMinutes()+t);var s=getXPositionOfEvent({start_date:n,end_date:r},!1,scheduler.matrix[scheduler._mode]),a=getXPositionOfEvent({start_date:n,end_date:r},!0,scheduler.matrix[scheduler._mode]),o=a-s+4;cachedDomElements.draggedBreak.css("width",o+"px");var c=document.getElementById("draggedBreak").cloneNode(!0);document.body.appendChild(c);var l=window.DataTransfer;"setDragImage"in l.prototype&&e.originalEvent.dataTransfer.setDragImage(c,0,40)})}}})}(),function(){angular.module("serviceExpert").directive("draggableService",["utils","servicesService","SERVICE_STATUS","SERVICE_CATEGORY",function(e,t,i,n){return{restrict:"CAE",scope:{dragService:"="},link:function(t,i,r,s){cachedDomElements.draggedEvent||(cachedDomElements.draggedEvent=$("#draggedEvent")),cachedDomElements.draggedEventDiv||(cachedDomElements.draggedEventDiv=$("#draggedEvent div")),i.bind("dragstart",function(i){i.originalEvent.dataTransfer.setData("text",t.dragService.id);var r=t.dragService.ganttLabel?t.dragService.ganttLabel:t.dragService.name,s="<b>"+r+"</b><br/>"+t.dragService.estDuration+" "+t.dragService.durationType;cachedDomElements.draggedEventDiv.html(s);var a=getMinAndMaxHoursToDisplay(),o=new Date(scheduler._min_date.getTime()+1e3*a.min*60*60),c=new Date(scheduler._min_date.getTime()+1e3*a.min*60*60);t.dragService.durationType?t.dragService.durationType===e.durationTypes.minutes?c.setMinutes(c.getMinutes()+t.dragService.estDuration):t.dragService.durationType===e.durationTypes.hours?c.setMinutes(c.getMinutes()+Math.floor(60*t.dragService.estDuration)):t.dragService.durationType===e.durationTypes.days&&c.setMinutes(c.getMinutes()+Math.floor(60*t.dragService.estDuration*24)):t.dragService.setMinutes(c.getMinutes()+60);var l=getXPositionOfEvent({start_date:o,end_date:c},!1,scheduler.matrix[scheduler._mode]),u=getXPositionOfEvent({start_date:o,end_date:c},!0,scheduler.matrix[scheduler._mode]),d=u-l+4,v="";switch(t.dragService.statusCategory){case n.NONE:v=" eventStatusNew";break;case n.SCHEDULED:v=" eventStatusAssigned";break;case n.DISPATCHED:v="eventStatusDispatched";break;case n.IN_PROGRESS:v=" eventStatusTravel";break;case n.COMPLETED:v=" eventStatusCompleted";break;case n.COULD_NOT_COMPLETE:v=" eventStatusCouldntComplete";break;case n.CANCELED:v=" eventStatusCancelled";break;default:v=" eventCustomStatus"}cachedDomElements.draggedEvent.css("width",d+"px"),cachedDomElements.draggedEvent.removeClass(),cachedDomElements.draggedEvent.addClass(v),t.dragService.ganttColor?cachedDomElements.draggedEvent.css("background",t.dragService.ganttColor):cachedDomElements.draggedEvent.css("background","");var p=document.getElementById("draggedEvent").cloneNode(!0);document.body.appendChild(p);var h=window.DataTransfer;"setDragImage"in h.prototype&&i.originalEvent.dataTransfer.setDragImage(p,0,28)})}}}]).directive("dragTarget",["$rootScope","$filter","utils","servicesService","sfdcService","kpiCalculationsService","ResourcesAndTerritoriesService","AbsencesService","TimePhasedDataService","SERVICE_CATEGORY",function(e,t,i,n,r,s,a,o,c,l){return{restrict:"CAE",link:function(e,t,r,u){var d=Date.now();t.bind("dragover",function(e){if(cachedDomElements.timesDragFix||(cachedDomElements.timesDragFix=$("#timesDragFix")),e.preventDefault(),!scheduler.config.readonly){var t=Date.now();if(!(500>t-d)){d=Date.now();var n=scheduler.getActionData(e.originalEvent),r=a.getResources()[n.section.split("_")[0]],s=n.section.split("_")[1];if(r&&s){var o=i.getLocationOffset(n.date,s)-i.getUserOffset(n.date),c=new Date(n.date);if(c.setMinutes(c.getMinutes()+o),r.name&&(!r.isCapacityBased||r.isCapacityBased&&!contractorSupport)){var l=new Date(n.date),u=n.date.getMinutes(),v=u%serviceJumpsOnGantt,p=serviceJumpsOnGantt-u%serviceJumpsOnGantt;l=v>p?new Date(l.getTime()+60*p*1e3):new Date(l.getTime()-60*v*1e3);var h=moment(l).format("lll"),g=new Date(l);g.setMinutes(g.getMinutes()+o);var m=moment(g).format("lll");e.originalEvent.ctrlKey?cachedDomElements.timesDragFix.html("<b>"+r.name+"</b> "+customLabels.SnapOn+" "+h+"<br/> "+(useLocationTimezone?"":customLabels.Location_time+" "+m)):cachedDomElements.timesDragFix.html("<b>"+r.name+"</b> "+customLabels.on+" "+h+"<br/> "+(useLocationTimezone?"":customLabels.Location_time+" "+m)),cachedDomElements.timesDragFix.show()}else cachedDomElements.timesDragFix.hide()}}}}),t.bind("dragleave",function(e){cachedDomElements.timesDragFix.hide(),e.preventDefault()}),t.bind("drop",function(t){if(t.preventDefault(),void 0!==cachedDomElements.draggedEvent&&cachedDomElements.draggedEvent.removeClass(),cachedDomElements.timesDragFix.hide(),!scheduler.config.readonly){var r=scheduler.getActionData(t.originalEvent),u=new Date(r.date),d=r.date.getMinutes(),v=d%serviceJumpsOnGantt,p=serviceJumpsOnGantt-d%serviceJumpsOnGantt;u=v>p?new Date(u.getTime()+60*p*1e3):new Date(u.getTime()-60*v*1e3),r.date=u;var h=a.getResources()[r.section.split("_")[0]];a.territories[r.section.split("_")[1]];if(h&&h.name){var g=t.originalEvent.dataTransfer.getData("text");if(g.indexOf("absenceNA_")>-1){$("#naOptionsContainer").hide();var m=g.substr(10,g.length-10);m=parseInt(m);var f=new Date(r.date);f.setMinutes(f.getMinutes()+m);var S={end_date:f,resource:h.id,start_date:r.date,start:r.date,absenceType:"None"==e.defaultDragNa.selectedNaType?null:e.defaultDragNa.selectedNaType,ganttLabel:e.defaultDragNa.selectedNaLabel};return void i.safeApply(e,function(){n.handleSnap(S,t),o.saveNewAbsence(S).then(function(e){})["catch"](function(e){console.warn("Couldn't update absence"),e.error?i.addNotification(customLabels.Action_Could_Not_Be_Performed,e.error):i.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)})})}var b=c.serviceAppointments()[g];if(b){var y=new Date(r.date),_=60;if(b.durationType?b.durationType==i.durationTypes.minutes?y.setMinutes(y.getMinutes()+b.estDuration):b.durationType==i.durationTypes.hours?y.setMinutes(y.getMinutes()+Math.floor(60*b.estDuration)):b.durationType==i.durationTypes.days&&y.setDate(y.getDate()+Math.floor(b.estDuration)):y.setMinutes(y.getMinutes()+_),contractorSupport&&h.isCapacityBased){for(var T=!1,w=!0,L=scheduler.getEvents(r.date,y),C=0;C<L.length;C++)L[C].resourceId.indexOf(r.section)>-1&&"contractorcapacity"==L[C].type&&(T=!0,L[C].timePeriod==i.ganttSettings.capacityDuration&&(w=!1));if(!T)return void alert(customLabels.serviceCantBeAssignedWithoutCapacity);w&&alert(customLabels.is_assigned_to_contractor.replaceAll(b.name,h.name)+".\n"+customLabels.This_capacity_duration_is_filtered_out+".\n"+customLabels.To_change_the_capacity_duration)}var k=angular.copy(b);k.end_date=y,k.resourceId=r.section,k.start_date=new Date(r.date),k.assignedResource=null;var D={statusCategory:l.SCHEDULED,isDummy:!0,id:k.id+"_dummy"},A=void 0,R=angular.copy(k);for(var I in D)R[I]=D[I];A=scheduler.addEvent(R),i.safeApply(e,function(){n.handleSnap(k,t.originalEvent),n.saveChangesToServiceAppointment(b,k).then(function(e){scheduler.deleteEvent(A),s.calculateKpis()})["catch"](function(e){console.warn("Couldn't update service. "+e[2]),i.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2]||e[0].message||customLabels.user_is_not_allowed_to_perform_action),scheduler.deleteEvent(A)&&scheduler.parse([e[1]],"json")})})}}}})}}}])}(),function(){angular.module("serviceExpert").directive("googlePlaces",function(){return{restrict:"E",replace:!0,scope:{myMap:"=",searchMarker:"="},template:'<input id="google_places_ac" name="google_places_ac" type="text" class="input-block-level"/>',link:function(e,t,i){var n=new google.maps.places.Autocomplete($("#google_places_ac")[0],{});google.maps.event.addListener(n,"place_changed",function(){var t=n.getPlace();e.searchMarker?e.searchMarker.setPosition(t.geometry.location):e.searchMarker=new google.maps.Marker({map:e.myMap,position:t.geometry.location}),t.geometry.viewport?e.myMap.fitBounds(t.geometry.viewport):(e.myMap.setCenter(t.geometry.location),e.myMap.setZoom(17))})}}})}(),function(){angular.module("serviceExpert").directive("csGroupActions",["$compile",function(e){function t(t,n){var r=$('<ul class="moreQuickActionsContainer"></ul>'),s=void 0,a=void 0;angular.element(n[0]).on("click",function(o){o.stopPropagation(),$("#MainActionContainer").hide();var c=$(n).parent().parent().children(),l=$(c).last(),u=$(c).first(),d=$(u).offset().top,v=$(u).outerHeight(!0);if(r.hasClass("viewMoreActive"))return r.removeClass("viewMoreActive"),r.empty(),void r.remove();if(i($(l),d,v)){for(var p=c.length-1;p>1;p--)if(s=$(c[p]),a=i(s,d,v)){var h=$("<li></li>");s.find("> div:first-child").clone().removeClass("quickActionGoLeft").addClass("menuQuickAction").css({marginBottom:"0",border:"none",width:"87%"}).appendTo(h),h.css({display:"block"}).appendTo(r),e(h)(t)}$(r.children().get().reverse()).appendTo(r),$(n).append(r),r.addClass("viewMoreActive"),r.show();var g=r.offset().top,m=r.outerHeight(!0);i($("#TaskListPagination"),g,m)||$("#TaskListItems").animate({scrollTop:$("#TaskListItems").scrollTop()+(36*r.children().length>180?180:36*r.children().length)},500)}angular.element("body").on("mousedown",function(e){for(var t=["moreQuickActionsBtn","menuQuickAction","fa-caret-down"],i=0;i<t.length;i++)if(e.target.classList.contains(t[i])||e.target.parentNode&&e.target.parentNode.classList.contains(t[i]))return;r.hasClass("viewMoreActive")&&(r.removeClass("viewMoreActive"),r.empty(),r.remove(),angular.element("body").off("mousedown"))})})}function i(e,t,i){return Math.ceil($(e).offset().top)>=t+i}return{restrict:"A",link:t}}]).directive("csLastAction",["utils","SERVICE_STATUS","StateService",function(e,t,i){function n(n,r,s){var a=$(r),o=n.service,c=s.csLastAction,l=e.getCustomActions("list");switch(c){case"edit":!o.pinned&&e.hasCustomPermission("Reshuffle")||o.isScheduled()&&(o.latitude||o.longitude)&&e.hasCustomPermission("Group_Nearby")||!o.pinned&&o.status===t.SCHEDULED||o.isScheduled()||i.isMapEnabled()&&(o.latitude||o.longitude)||0!==l.length||a.hide();break;case"reshuffle":o.isScheduled()&&(o.latitude||o.longitude)&&e.hasCustomPermission("Group_Nearby")||!o.pinned&&o.status===t.SCHEDULED||o.isScheduled()||i.isMapEnabled()&&(o.latitude||o.longitude)||0!==l.length||a.hide();break;case"groupNearby":!o.pinned&&o.status===t.SCHEDULED||o.isScheduled()||i.isMapEnabled()&&(o.latitude||o.longitude)||0!==l.length||a.hide();break;case"dispatch":o.isScheduled()||i.isMapEnabled()&&(o.latitude||o.longitude)||0!==l.length||a.hide();break;case"gantt":i.isMapEnabled()&&(o.latitude||o.longitude)||0!==l.length||a.hide();break;case"map":0===l.length&&a.hide();break;default:parseInt(c)}}return{restrict:"A",link:n}}])}(),function(){angular.module("serviceExpert").directive("keypressEvents",["$rootScope",function(e){var t=[13,16,18,27,37,38,39,40,48,49,50,51,55,69,70,73,77,79,83,84,85,87,90,96,97,98,99,103];return{restrict:"C",link:function(){angular.element("body").bind("keydown",function(i){t.indexOf(i.which)>-1?e.$broadcast("keypress",i):i.stopPropagation()})}}}])}(),function(){function e(e,t,i){function n(e){e.optimizationRequests={},e.optRunning=0,e.optQueued=0,e.replaceText=function(e,t){var i=customLabels[e];return i.replaceAll(t.toString())},i.register("optimizationRequests",function(i){for(var n=0,r=0,s=0;s<i.length;s++){var a=new OptimizationRequest(i[s]);"Queued"==a.status&&r++,"In Progress"==a.status&&n++,e.optimizationRequests[a.id]&&"Completed"==a.status&&"Completed"!=e.optimizationRequests[a.id].status&&t.addNotification(customLabels.Optimization_Completed,customLabels.x_services_were_sched_out_of.replaceAll(a.scheduledAmount,a.objectToScheduled)+".",function(e){t.openSObjectLink("../"+e)},a.id),e.optimizationRequests[a.id]&&"Failed"==a.status&&"Failed"!=e.optimizationRequests[a.id].status&&t.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){t.openSObjectLink("../"+e)},a.id),e.optimizationRequests[a.id]=a}e.optQueued=r,e.optRunning=n})}return{restrict:"E",link:n,scope:{},template:'\n                <div id="optInProgress" ng-show="optRunning">\n                    '+customLabels.Optimization_in_progress+"\n	            	<span ng-show=\"optRunning > 1\">{{ replaceText('XoptimizationRunning',optRunning) }}</span>\n	            	<span ng-show=\"optQueued\">{{ replaceText('XoptimizationQueued',optQueued) }}</span>\n        		</div>"}}e.$inject=["DeltaService","utils","RegisterService"],angular.module("serviceExpert").directive("optimizationIndicator",e)}(),function(){angular.module("serviceExpert").directive("csStopPropagation",[function(){function e(e,t,i){angular.element(t[0]).on(i.csStopPropagation,function(e){e.stopPropagation()})}return{restrict:"A",link:e}}])}(),function(){angular.module("serviceExpert").directive("csToggle",[function(){function e(e,t,i){for(var n=$("#"+i.csToggle),r=$("[cs-toggle]"),s={},a=0;a<r.length;a++){var o=$(r[a]);s[o.attr("id")]=$("#"+o.attr("cs-toggle"))}1===n.length&&(angular.element(t[0]).on("click",function(e){e.stopPropagation(),$(".moreQuickActionsContainer").hide();for(var t in s)t!==e.currentTarget.id?(s[t].hide(),$(".dhx_mini_calendar").hide()):n.toggle()}),angular.element("body").on("click",function(e){for(var t in s)s[t].hide()}))}return{restrict:"A",link:e}}])}(),function(){angular.module("serviceExpert").factory("SERVICE_CATEGORY",function(){return{NONE:"None",SCHEDULED:"Scheduled",DISPATCHED:"Dispatched",IN_PROGRESS:"InProgress",COULD_NOT_COMPLETE:"CannotComplete",COMPLETED:"Completed",CANCELED:"Canceled"}})}(),function(){angular.module("serviceExpert").factory("SERVICE_STATUS",function(){return serviceStatuses})}(),function(){angular.module("serviceExpert").constant("dhtmlxDays",{Sunday:"0",Monday:"1",Tuesday:"2",Wednesday:"3",Thursday:"4",Friday:"5",Saturday:"6"})}(),function(){angular.module("serviceExpert").constant("PARENT_RECORD_TYPE",{WORKORDER:"WorkOrder",LINEITEM:"WorkOrderLineItem",ACCOUNT:"Account"})}(),function(){angular.module("serviceExpert").constant("DRAWING_STATES",{NONE:0,EDIT:1,DRAW:2,SELECTED:3,INTERSECT:4})}(),function(){angular.module("serviceExpert").constant("POST_MESSAGE_TYPE",{INIT:0,SHOW_ON_MAP:1,DRAW_MARKERS:2})}(),function(){angular.module("serviceExpert").factory("servicesService",["$q","$rootScope","sfdcService","utils","userSettingsManager","monthlyViewHelperService","TimePhasedDataService","ServiceAppointmentLightboxService","kpiCalculationsService","bulkResultsService","SERVICE_STATUS","SERVICE_CATEGORY","StateService","MstResolver","DeltaService",function(e,t,i,n,r,s,a,o,c,l,u,d,v,p,h){function g(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}function m(e){var t=40,i=7,n=190,r={},s=[],o=null,c=null,l={},u=0,d=0,v=0,p=0;e.forEach(function(e){var t=a.serviceAppointments()[e],i=g(t.start);o?o>t.start&&(o=t.start):o=t.start,c?c<t.start&&(c=t.start):c=t.start,r[t.resource]=r[t.resource]||{},r[t.resource][i]=r[t.resource][i]||[],r[t.resource][i].push(e)}),c=new Date(c.getFullYear(),c.getMonth(),c.getDate()+1);for(var h=new Date(o);c>h;h.setDate(h.getDate()+1)){var m=g(h);p++,p===i&&(v++,d=0,u=0,p=0,l={});for(var f in r){if(r[f][m]){var S;if(s[v]=s[v]||[],(S=s[v]).push.apply(S,_toConsumableArray(r[f][m])),d+=r[f][m].length,d>=n&&(v++,d=0,u=0,p=0,l={}),!l[f]&&(l[f]=!0,u++,u===t)){if(n>=d){var b=new Date(h);b.setDate(b.getDate()+1);var y=new Date(b);y.setDate(y.getDate()+i-p+1);for(var _=b;y>_;_.setDate(_.getDate()+1)){var T=g(_);for(var w in l){if(r[w][T]){var L;(L=s[v]).push.apply(L,_toConsumableArray(r[w][T])),d+=r[w][T].length}if(delete r[w][T],d>=n)break}if(d>=n)break}}v++,d=0,u=0,p=0,l={}}}delete r[f][m]}}return s=s.filter(function(e){return e})}function f(e,t,s){var o={};e.schedulingResult&&Array.isArray(e.schedulingResult)&&e.schedulingResult[0]?(o.partialResults=e.schedulingResult[0].PartialResults||[],0===e.services.length?i.getServicesById([s]).then(function(i){var c;o.absences=a.updateTimePhaseData(e.na,"na",!0).absences,o.services=a.updateTimePhaseData(e.services,"service",!0).services,(c=o.services).push.apply(c,_toConsumableArray(a.updateTimePhaseData(i,"service",!0).services));var l=r.GetUserSettingsProperty("locations");1===i.length&&-1===l.indexOf(o.services[o.services.length-1].ServiceTerritoryId)&&n.addNotification(customLabels.SchedulingResult,customLabels.WasScheduledToFilteredTeritory.replace("$0",o.services[o.services.length-1].AppointmentNumber)),t.resolve(o),T.checkRules(n.getRelatedServices(s)).then(T.drawViolationsOnGantt)}):(o.absences=a.updateTimePhaseData(e.na,"na",!0).absences,o.services=a.updateTimePhaseData(e.services,"service",!0).services,t.resolve(o),T.checkRules(n.getRelatedServices(s)).then(T.drawViolationsOnGantt))):(o.absences=a.updateTimePhaseData(e.na,"na",!0).absences,o.services=a.updateTimePhaseData(e.services,"service",!0).services,t.resolve(o),T.checkRules(n.getRelatedServices(s)).then(T.drawViolationsOnGantt))}function S(e){return e.isScheduled()?(e.setGanttResource(a.resourcesAndTerritories(),n.generateResourceId),!0):(scheduler._events[e.id]&&delete scheduler._events[e.id],!1)}var b=200,y=7,_=new Date;_.setDate(_.getDate()+3),window.globalStatuses=u,window.globalCategories=d;var T={servicesObjects:{},recentlyUsed:{},flagged:flaggedServices,filteredServices:{servicesArray:[]},filter:{searchOnServer:null,advancedFilter:{statusCheckboxs:{New:!0,Assigned:!0,Dispatched:!0,Travel:!0,"On Site":!0,Incomplete:!0},selectedDates:{dueDate:!0,appEnd:!0,end_date:!0},minDate:new Date(Date.now()-6048e5),maxDate:new Date(Date.now()+6048e5),servicePriority:10,jeopardies:!0,violations:!0,unScheduled:!0},selectedFiled:{appEnd:!0,appStart:!0,dueDate:!0,earlyStart:!0,finish:!0,start:!0,display:!0},selectedFilter:r.GetUserSettingsProperty("Selected_List_View__c")||(customPermissions.Service_List_Todo?"Todo":"All"),orderByField:"start",reverse:!1,SearchText:"",endDate:_,currentPage:1,servicesPerPage:200,totalServices:0,totalPages:1}};if(r.GetUserSettingsProperty("Date_Horizon_Properties__c")){var w=JSON.parse(r.GetUserSettingsProperty("Date_Horizon_Properties__c"));for(var L in w)T.filter.selectedFiled[L]=w[L]}return n.ganttSettings&&(T.filter.servicesPerPage=parseInt(n.ganttSettings.servicesPerPage)),T.checkRules=function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(t=t.filter(function(e){return a.serviceAppointments()[e]&&a.serviceAppointments()[e].start}),0===t.length){var s=e.defer();return s.resolve([]),s.promise}for(var o=m(t),l=[],u={},d=e.defer(),p=0;p<o.length;p++)l.push(e.defer()),l[p].promise.then(function(e){i.checkRules(o[e],v.selectedPolicyId).then(function(t){o[e].forEach(function(e){return u[e]=!0});for(var i in t){delete u[i];var n=a.serviceAppointments()[i];t[i].length>0&&n?(n.violations=t[i],r.push(i)):n&&(n.violations=null)}l[e+1]?l[e+1].resolve(e+1):0===Object.keys(u).length?(c.calculateKpis(),d.resolve(r)):T.checkRules(Object.keys(u),r).then(function(e){c.calculateKpis(),d.resolve([].concat(_toConsumableArray(e),_toConsumableArray(r)))})})["catch"](function(e){n.addNotification(customLabels.Rule_validation_failed,e.message),d.reject(e),console.warn("rule checking failed"),console.log(e)})});return l[0].resolve(0),d.promise},T.checkRules2=function(t){var r=e.defer(),s=[],o=[],l=[],u=1,d=0,p=void 0,h=[],g={};if(Array.isArray(t)&&0===t.length)return r.resolve([]),r.promise;m(t);t.sort(function(e,t){return a.serviceAppointments()[e]||a.serviceAppointments()[t]?!a.serviceAppointments()[e]&&a.serviceAppointments()[t]?-1:a.serviceAppointments()[e]&&!a.serviceAppointments()[t]?1:a.serviceAppointments()[e].start==a.serviceAppointments()[t].start?0:a.serviceAppointments()[e].start>a.serviceAppointments()[t].start?1:-1:0});for(var f=t.slice(0);f.length>0;){d=0,p=null,g[u-1]={};for(var S=0;S<f.length;S++)if(g[u-1][f[S]]=!0,a.serviceAppointments()[f[S]]&&a.serviceAppointments()[f[S]].start){p||(p=moment(a.serviceAppointments()[f[S]].start));var _=moment(a.serviceAppointments()[f[S]].start);if(!(_.diff(p,"days")<=y&&b>d))break;d++}else d++;l.push(f.splice(0,d)),o.push(e.defer()),u++,o[o.length-1].promise.then(function(e){i.checkRules(l[e],v.selectedPolicyId).then(function(t){for(var i in t)if(delete g[e][i],t[i].length>0){if(!a.serviceAppointments()[i])continue;a.serviceAppointments()[i].violations=t[i],s.push(i)}else a.serviceAppointments()[i]&&(a.serviceAppointments()[i].violations=null);for(var n in g[e])"undefined"!=n&&a.serviceAppointments()[n]&&a.serviceAppointments()[n].resourceId&&h.push(n);o[e+1]?o[e+1].resolve(e+1):(c.calculateKpis(),r.resolve(s),h.length>0&&(debugMode&&console.log("Calling check rules again on "+h.length+" services"),maxNumberOfChecks?maxNumberOfChecks--:maxNumberOfChecks=10,T.checkRules(h,maxNumberOfChecks).then(function(){scheduler.updateView()})))})["catch"](function(e){n.addNotification(customLabels.Rule_validation_failed,e.message),r.reject(e),console.warn("rule checking failed"),console.log(e)})})}return o[0].resolve(0),r.promise},T.postToChatter=function(t,n){var r=e.defer();return i.postToChatter(t,n).then(function(e){r.resolve(e)}),r.promise},T.sortServicesByPriority=function(t){var n=e.defer();return i.sortServicesByPriority(t).then(function(e){n.resolve(e)}),n.promise},T.autoScheduleService=function(t){var r=e.defer();return void 0==window.userHasAdminPermissions&&i.userHasAdminPermissions().then(function(e){window.userHasAdminPermissions=e}),i.autoScheduleService(t,v.selectedPolicyId).then(function(e){if(e.schedulingResult&&Array.isArray(e.schedulingResult)&&e.schedulingResult[0]){var i=e.schedulingResult[0].PartialResults||[],s="";i.length>0&&(window.userHasAdminPermissions?i.forEach(function(e){s+=customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)+"<br/>"}):s+=customLabels.ContactSysAdmin,""!==s&&n.addNotification(customLabels.NotAllResult.replace("$0",e.schedulingResult[0].Service.AppointmentNumber),s))}if(e.schedulingResult&&Array.isArray(e.schedulingResult)&&e.schedulingResult[0]&&e.schedulingResult[0].LongOperationId)return void p.getUpdates(e.schedulingResult[0].LongOperationId).then(function(e){f(e,r,t)})["catch"](function(e){console.error(e);var t="string"==typeof e?{eventType:"exception",message:e}:e;r.reject(t)});if(e.services=e.deltaResult.updatedGanttServices,e.na=e.deltaResult.updatedAbsence,h.handleDeltaResponse(e.deltaResult),e.schedulingResult&&Array.isArray(e.schedulingResult)&&e.schedulingResult[0]){var a=e.schedulingResult[0].PartialResults||[],o="";a.length>0&&(window.userHasAdminPermissions?a.forEach(function(e){o+=customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)+"<br/>"}):o+=customLabels.ContactSysAdmin,""!==o&&n.addNotification(customLabels.NotAllResult.replace("$0",e.schedulingResult[0].Service.AppointmentNumber),o))}f(e,r,t)})["catch"](function(e){e.message&&(e.message.includes("Too many SOQL queries")||e.message.includes("Apex CPU time limit"))?h.getDelta():console.log(e),r.reject(e)}),r.promise},T.saveChangesToServiceAppointment=function(t,r){var s=e.defer(),o=new Date(r.start_date.getTime()+1e3*r.travelTo),c=new Date(r.end_date.getTime()-1e3*r.travelFrom);if(useLocationTimezone){var l=a.getIntersectingSrstOffset(r,r.getGanttResource()),u=n.getUserOffset(o),d=n.getUserOffset(c);o.setMinutes(o.getMinutes()+u-l),c.setMinutes(c.getMinutes()+d-l)}T.recentlyUsed[t.id]=!0,r.snapToId&&r.ServiceAppointmentLastModifiedDate--;var p=null,g=null;if(r.snapToId){var m=[],f=scheduler._events[r.snapToId].end||scheduler._events[r.snapToId].finish;for(var S in scheduler._events)if(S!==r.id){var b=scheduler._events[S];b.resourceId===r.resourceId&&"break"!==b.type&&b.latitude&&isIntersect(b.start_date,b.end_date,scheduler._min_date,f)&&m.push(S)}m.sort(function(e,t){return scheduler._events[e].start>scheduler._events[t].start?-1:scheduler._events[e].start<scheduler._events[t].start?1:0}),m.length>0&&(p=scheduler._events[m[0]].latitude,g=scheduler._events[m[0]].longitude)}return i.saveChangesToServiceAppointment(r.id,r.getGanttResource(showSecondarySTMs),r.assignedResource,o,c,v.selectedPolicyId,r.scheduleMode,r.snapToId||null,r.snapToType||null,r.snapDirection||null,p,g).then(function(e){h.handleDeltaResponse(e),e.ValidationError?s.reject(["",t,e.ValidationError]):s.resolve()})["catch"](function(e){s.reject([e,t,""]),console.warn(e)}),s.promise},T.handleSnap=function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1;if(t.ctrlKey){var n=[];for(var r in scheduler._events){var s=scheduler._events[r];("service"===s.type||"na"===s.type)&&(s.id===e.id||e.resourceId&&-1===s.resourceId.indexOf(e.resourceId)||isIntersect(s.start_date,s.end_date,e.start_date,e.end_date)&&n.push(s))}n.sort(function(e,t){return e.start>t.start?1:e.start<t.start?-1:0});var a=i?1:0;if(n.length>a){var o=new Date(e.start_date);e.travelTo&&(o=o.setSeconds(o.getSeconds()+e.travelTo));var c="right",l=n[0].isDummy?1:0;o<n[l].start&&(c="left");var u=0;n[0].isDummy&&(u=1),n[u]?(e.snapToId=n[u].id,e.snapToType=n[u].type,e.snapDirection=c):(e.snapToId=null,e.snapToType=null,e.snapDirection=null)}else e.snapToId=null,e.snapToType=null,e.snapDirection=null}},T.unscheduleServices=function(t,r,s){var c=e.defer(),u=s?i.unscheduleServicesByLocationsId:i.unscheduleServicesByServicesId,d=null;return s||(d=n.getRelatedServices(t)),u(t,r,s).then(function(u){var v={};if(u.nothingToUnschedule)return void c.resolve(u);var h=e.defer();u.fslOperation?p.getUpdates(u.fslOperation).then(function(e){console.log(e);var t=e.fslOperation.result.services;i.getServicesById(t).then(function(t){a.updateTimePhaseData(t,"service").services,h.resolve({services:t,resourceAbsences:[],resourceCapacities:[],failedResults:e.fslOperation.result.failedResults})})})["catch"](function(e){var t="string"==typeof e?{eventType:"exception",message:e}:e;h.reject(t)}):h.resolve(u),h.promise.then(function(e){v.absences=a.updateTimePhaseData(e.resourceAbsences,"na",!0).absences,v.services=a.updateTimePhaseData(e.services,"service",!0).services,v.capacities=a.updateTimePhaseData(e.resourceCapacities,"capacity").capacities,v.failedResults=e.failedResults,T.drawServicesAndAbsences(v.services,v.absences),!s&&T.checkRules(d).then(T.drawViolationsOnGantt),s&&T.checkRules(n.getServicesOfLocations(t,r,s)).then(T.drawViolationsOnGantt);var i=void 0,u=void 0;if(1!==t.length||s){var p=[],h=[];if(s?e.services.forEach(function(t){e.failedResults[t.Id]&&a.serviceAppointments()[t.Id].isScheduled()?h.push(t.Id):p.push(t.Id)}):t.forEach(function(e){a.serviceAppointments()[e].isScheduled()?h.push(e):p.push(e)}),i=customLabels.x_services_were_unscheduled.replaceAll(p.length),u=s?customLabels.x_services_were_unscheduled_out_of_y.replaceAll(p.length,p.length,h.length+p.length):customLabels.x_services_were_unscheduled_out_of_y.replaceAll(p.length,p.length,t.length),h.length>0){var g=h.map(function(e){return a.serviceAppointments()[e].name}).join(", ");u+="<div title='"+g+"' class='dashedBorder' style='display:inline-block;'> "+customLabels.failed_to_unschedule.replaceAll(h.length)+". "+customLabels.View_services+"</div>"}var m=angular.copy(e),f=[];m.services.forEach(function(e){if(s)e.Fields.SchedStartTime||f.push(e);else for(var i=0;i<t.length;i++)e.Id===t[i]&&f.push(e)}),m.services=f,n.addNotification(i,u,function(){var e={success:customLabels.SuccessfullyUnscheduled,fail:customLabels.FailToUnschedule};l.open(m,e)})}else{var S=a.serviceAppointments()[t[0]].name;a.serviceAppointments()[t[0]].isScheduled()?(i=customLabels.Couldnt_unschedule.replaceAll(S),u=customLabels.Couldnt_unschedule.replaceAll(S)+". "+e.failedResults[t[0]].errorMessage):(i=customLabels.was_unscheduled.replaceAll(S),u=customLabels.was_unscheduled_successfully.replaceAll(S)),n.addNotification(i,u,function(){T.recentlyUsed[t[0]]=!0,o.open(t[0])})}c.resolve(v)})})["catch"](function(e){c.reject(e),console.warn(e)}),c.promise},T.drawServicesAndAbsences=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];if(0!==e.length||0!==t.length||0!==i.length||0!==n.length){var r=void 0,s={},a={},o={},c={scheduledServices:[],unscheduledServices:[],deletedIds:i};Array.isArray(e)?e.forEach(function(e){return s[e.id]=e}):s=e,Array.isArray(t)?t.forEach(function(e){return a[e.id]=e}):a=t,Array.isArray(n)?n.forEach(function(e){return o[e.id]=e}):o=n,r=angular.extend({},s,a,o);for(var l in r){var u=r[l];S(u)?c.scheduledServices.push(u):c.unscheduledServices.push(u)}if(i.forEach(function(e){return delete scheduler._events[e]}),c.scheduledServices.length>0)scheduler.parse(c.scheduledServices,"json");else for(var d in c)if(Array.isArray(c[d])&&c[d].length>0){updateViewDebounced();break}return c}},T.changeStatus=function(t,r,s,c){var u=e.defer(),d=c?i.changeStatusServicesByLocationsId:i.changeStatusServicesByServicesId;return d(t,r,s,c).then(function(e){var i={};if(e.nothingToDispatch)return void u.resolve(e);i.services=a.updateTimePhaseData(e.services,"service").services,i.failedResults=e.failedResults;var s=void 0,d=void 0;if(1!==t.length||c){var v=[],p=[];if(c?e.services.forEach(function(e){a.serviceAppointments()[e.Id].status!==r?v.push(e.Id):p.push(e.Id)}):t.forEach(function(e){a.serviceAppointments()[e].status===r?p.push(e):v.push(e)}),s=customLabels.x_services_were_changed.replaceAll(p.length,n.statusTranslations[r]||r),d=customLabels.x_services_were_changed_out_of_y.replaceAll(p.length,p.length,p.length+v.length,n.statusTranslations[r]||r),v.length>0){var h=v.map(function(e){return a.serviceAppointments()[e].name}).join(", "),g=customLabels.failed_to_change_status.replaceAll(v.length);d+="<div title='"+h+"' class='dashedBorder' style='display:inline-block;'> "+g+". "+customLabels.View_services+"</div>"}n.addNotification(s,d,function(){var t={success:customLabels.SuccessfullyDispatched,fail:customLabels.FailToDispatch};l.open(e,t)})}else{var m=a.serviceAppointments()[t[0]].name;a.serviceAppointments()[t[0]].status!==r&&(s=customLabels.could_not_change_title.replaceAll(m),d=e.failedResults&&!n.isEmpty(e.failedResults)?customLabels.could_not_change_status.replaceAll(m,n.statusTranslations[r],e.failedResults[t[0]].errorMessage):customLabels.could_not_change_status.replaceAll(m,n.statusTranslations[r],""),n.addNotification(s,d,function(){o.open(t[0])})),T.recentlyUsed[t[0]]=!0}u.resolve(i)})["catch"](function(e){u.reject(e),console.warn(e)}),u.promise;
},T.changePin=function(t,n){var r=e.defer();return i.changePin(t,n).then(function(e){var t=fieldNames.Service_Appointment.pinned;e.forEach(function(e){return a.serviceAppointments()[e.Id].pinned=e[t]}),r.resolve()})["catch"](function(e){r.reject(e),console.warn(e)}),r.promise},T.setInJeopardy=function(t){var r=e.defer();return i.setServiceAppointmentsInJeopardy(t).then(function(e){e.forEach(function(e){return a.serviceAppointments()[e.Id].jeopardy=e[fieldNames.Service_Appointment.InJeopardy__c]}),n.addNotification("In Jeopardy Service Appointments",e.length+" service appointments were marked as in jeopardy"),r.resolve()})["catch"](function(e){r.reject(e),console.warn(e)}),r.promise},T.drawViolationsOnGantt=function(e){updateViewDebounced()},T.searchServiceByIdOrName=function(t){var n=e.defer();return i.searchServiceByIdOrName(t).then(function(e){null===e?n.resolve(null):(a.updateTimePhaseData(e,"service"),n.resolve(e[0].Id))})["catch"](function(e){n.reject(e),console.warn(e)}),n.promise},T}])}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){angular.module("serviceExpert").factory("userSettingsManager",["$q",function(e){function t(e){return bootstrap.loadedUserSettings[e]}function i(t,i){var n=e.defer(),r="undefined"==typeof i?"undefined":_typeof(i);return Visualforce.remoting.Manager.invokeAction(RemoteActions.SetUserSettingsProperty,t,i,r,function(e,t){null!==t.result&&(bootstrap.loadedUserSettings=JSON.parse(t.result),n.resolve())},{buffer:!1,escape:!1,timeout:12e4}),n.promise}function n(t){var i=e.defer();for(var n in t){var r=t[n];t[n]=r+":"+("undefined"==typeof r?"undefined":_typeof(r))}return Visualforce.remoting.Manager.invokeAction(RemoteActions.SetUserSettingsProperties,t,function(e,t){var n=JSON.parse(t.result);n.FailedLocations?(bootstrap.loadedUserSettings=n,i.reject(n)):(bootstrap.loadedUserSettings=n,i.resolve())},{buffer:!1,escape:!1,timeout:12e4}),i.promise}function r(t){var i=e.defer();return n(t),bootstrap.loadedUserSettings=JSON.parse(ev.result),i.promise}return{GetUserSettingsProperty:t,SetUserSettingsProperty:i,SetUserSettingProperties:n,SetUserSettingPropertiesPromise:r}}])}();var _slicedToArray=function(){function e(e,t){var i=[],n=!0,r=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(n=(a=o.next()).done)&&(i.push(a.value),!t||i.length!==t);n=!0);}catch(c){r=!0,s=c}finally{try{!n&&o["return"]&&o["return"]()}finally{if(r)throw s}}return i}return function(t,i){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();!function(){function e(e,t,i,n,r,s,a,o,c,l){function u(e){var t=_slicedToArray(e,2),i=t[0],n=t[1];return window.lsdIcons.globalIcon+"/"+i+"-sprite/svg/symbols.svg#"+n}function d(e){this.name=e[fieldNames.CustomGanttAction.Label],this.className=e[fieldNames.CustomGanttAction.Class],this.order=e[fieldNames.CustomGanttAction.Order],this.permission=e[fieldNames.CustomGanttAction.Permission],this.section=e[fieldNames.CustomGanttAction.Section],this.visualforce=e[fieldNames.CustomGanttAction.Visualforce],e[fieldNames.CustomGanttAction.Icon]&&(this.icon=u(e[fieldNames.CustomGanttAction.Icon].split(",")))}function v(e,t){return Array.isArray(e)&&!Array.isArray(t)?e.map(function(e){return e+"_"+t}).join(","):Array.isArray(e)&&Array.isArray(t)?e.map(function(e,i){return e+"_"+t[i]}).join(","):Array.isArray(e)||Array.isArray(t)?!Array.isArray(e)&&Array.isArray(t)?t.map(function(t){return e+"_"+t}).join(","):void 0:e+"_"+t}function p(){var t=e.defer();return i.getReports().then(function(e){if(!e)return void t.resolve(null);for(var i=0;i<e.length;i++)ie.push(e[i]);t.resolve(ie)})["catch"](function(e){return t.reject(e)}),t.promise}function h(){var t=e.defer();return Y("Polygons_view")?(i.getPolygons().then(function(e){if(!e)return void t.resolve(null);for(var i=0;i<e.length;i++)ne.push(e[i]);t.resolve(ne)}),t.promise):void t.resolve(null)}function g(e,t){var i="number"==typeof e||"string"==typeof e?scheduler.getEvent(e):e,c=getMinAndMaxHoursToDisplay(),l=i.start_date.getHours(),u=i.end_date.getHours();scheduler._min_date<=i.start&&i.start<scheduler._max_date?scheduler.setCurrentView(scheduler._min_date):scheduler.setCurrentView(new Date(i.start)),setTimeout(function(){if(t=t||scheduler._mode,0===i.end_date.getHours()&&i.end_date.getDate()>i.start_date.getDate()&&(u=24),"MonthlyView"===t)return void alert(customLabels.serviceCantDisplayMonthlyMsg);if("ZoomLevel2"!==scheduler._mode&&(c.min>u||c.max<=l))return void alert(customLabels.serviceCantDisplayMsg);for(var d=!0,v=scheduler.serverList("resources"),p=0;p<v.length;p++)for(var h=0;h<v[p].children.length;h++)if(i.resourceId.indexOf(v[p].children[h].key)>-1){d=!1;break}if(d)return void alert(customLabels.resource_filtered_out);var g=scheduler.getRenderedEvent(e);if(showSecondarySTMs&&i.ServiceTerritoryId&&i.resourceId.indexOf(",")>-1){for(var f=i.resourceId.split(","),S=f[0],b=0;b<f.length;b++)if(f[b].indexOf(i.ServiceTerritoryId)>-1){S=f[b];break}g=m(e,S.split("_")[1])||g}if($(g).removeClass("ShowEventEffect"),i&&(!scheduler.checkEvent("onBeforeEventDisplay")||scheduler.callEvent("onBeforeEventDisplay",[i,t]))){var y=scheduler.config.scroll_hour;scheduler.config.scroll_hour=i.start_date.getHours();var _=scheduler.config.preserve_scroll;if(scheduler.config.preserve_scroll=!1,(i.start_date<scheduler._min_date||i.start_date>scheduler._max_date)&&(a.areContractorsSupported()&&i.resourceContractor?scheduler.setCurrentView(new Date(i.start),t):scheduler.setCurrentView(new Date(i.start),t)),scheduler.config.scroll_hour=y,scheduler.config.preserve_scroll=_,a.areContractorsSupported()){var T=!0;if(i.resourceContractor){var w=scheduler.getEvents(i.start,i.finish);for(p=0;p<w.length;p++)if(w[p].resourceId==i.resourceId&&"contractorcapacity"==w[p].type&&w[p].timePeriod==s.GetUserSettingsProperty("View_Capacity_Type__c")){i=w[p],e=w[p].id,g=scheduler.getRenderedEvent(e),$(g).removeClass("ShowEventEffect"),T=!1;break}if(T)return void alert(customLabels.is_assigned_to_contractor.replaceAll(i.name,i.resourceName)+".\n"+customLabels.This_capacity_duration_is_filtered_out+".\n"+customLabels.To_change_the_capacity_duration)}}scheduler.matrix&&scheduler.matrix[t]&&(scheduler._els.dhx_cal_data[0].scrollTop=0,scheduler._els.dhx_cal_data[0].scrollTop=getAbsoluteTop(scheduler.getRenderedEvent(i.id))-getAbsoluteTop(scheduler._els.dhx_cal_data[0])-20),scheduler.callEvent("onAfterEventDisplay",[i,t]),g=scheduler.getRenderedEvent(e),$(g).addClass("ShowEventEffect"),r(function(){o.calculateKpis(),n.$broadcast("afterShowEvent")},400)}},200)}function m(e,t){for(var i=scheduler._rendered,n=0;n<i.length;n++){var r=i[n];if(r.getAttribute("event_id")==e&&r.children[0].getAttribute("territory_id")==t)return r}}function f(e,t){var i=864e5*t;return new Date(e.getTime()+i)}function S(e){var t=new Date(e);switch(scheduler._mode){case"ZoomLevel2":t=f(t,1);break;case"ZoomLevel3":t=f(t,1);break;case"ZoomLevel4":t=f(t,2);break;case"ZoomLevel5":t=f(t,3);break;case"ZoomLevel6":t=f(t,7);break;case"MonthlyView":t=f(t,30);break;case"MTDView":t=f(t,35)}return{start:new Date(e),end:t}}function b(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:!1;"undefined"==typeof n&&(n=null),re.push({title:e,text:t,action:function(){i(n),this.show=!r},when:new Date,unread:!0,param:n,show:!0})}function y(e,t){switch(e){case t.NONE:return"serviceList_new";case t.SCHEDULED:return"serviceList_assigned";case t.DISPATCHED:return"serviceList_dispatched";case t.IN_PROGRESS:return"serviceList_travel";case t.COMPLETED:return"serviceList_completed";case t.COULD_NOT_COMPLETE:return"serviceList_couldnt_complete";case t.CANCELED:return"serviceList_cancelled";default:return"serviceList_other"}}function _(e,t){return e.start>t.start?1:e.start.getTime()==t.start.getTime()?0:-1}function T(e,t){var i={},n=[];e.start>=t.start&&e.start<t.finish?(i.start=e.start,e.finish<t.finish?i.finish=e.finish:(i.finish=t.finish,n.push({start:t.finish,finish:e.finish,isStart:!1}))):e.finish>t.start&&e.finish<=t.finish?(e.start>t.start?i.start=e.start:(i.start=t.start,n.push({start:e.start,finish:t.start,isStart:!0})),i.finish=e.finish):e.start<t.start&&e.finish>t.finish?(i=angular.copy(t),n.push({start:e.start,finish:t.start,isStart:!0}),n.push({start:t.finish,finish:e.finish,isStart:!1})):i=null;for(var r=[],s=0;s<n.length;s++){var a=n[s];a.start.getTime()!=a.finish.getTime()&&r.push(a)}return{intersection:i,remainderFrom1:r}}function w(e){return!Object.keys(e).length}function L(e){if(e){var t={};return e.Type==le.Reference&&(t.resourceOnServiceTT=!0),t}}function C(e,t){if(t.Type==le.Reference){var i=t.JsAPIName.replace("__r","__c");k(e[i])}}function k(e){var t=A(null,e);t||window.open("../"+e,"_blank")}function D(e){return"string"==typeof e?t.trustAsHtml(e):null}function A(e,t){return a.isInConsole()?(e&&e.preventDefault(),sforce.console.generateConsoleUrl(["/"+t],function(e){e.success?sforce.console.openConsoleUrl(null,e.consoleUrl,!0):I(t)}),!0):!1}function R(e){sforce.console.getEnclosingPrimaryTabId(function(t){var i=t.id;sforce.console.openSubtab(i,"/"+e,!0)})}function I(e){sforce.console.openPrimaryTab(null,"/"+e,!0)}function F(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}function x(e){var t={weekday:"short",month:"long",day:"numeric",year:"numeric"},i=new Date(e);i.setHours(12);try{return i.toLocaleDateString(userLocale.replace("_","-"),t)}catch(n){return null}}function M(e,t,i){var n=E(e,t);return N(n.tz(i))}function O(e){return-moment.tz.zone(userTimeZone).offset(E(e,userTimeZone).valueOf())}function P(e,t){if(!t)return null;var i=c.territories[t],n=c.operatingHours[i.operatingHours].timezone;return-moment.tz.zone(n).offset(E(e,n).valueOf())}function E(e,t){return moment.tz({year:e.getFullYear(),month:e.getMonth(),date:e.getDate(),hours:e.getHours(),minutes:e.getMinutes()},t)}function N(e){return new Date(e.year(),e.month(),e.date(),e.hours(),e.minutes())}function G(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i].id);return t}function B(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i]);return t}function H(e,t){var i=e.$root.$$phase;"$apply"===i||"$digest"===i?t&&"function"==typeof t&&t():e.$apply(t)}function V(e){var t=0;if(e.resourceBeforeDrag=e.resourceId,e.eventBeforeDrag=angular.copy(e),e.isScheduled())t=e.finish.getTime()-e.start.getTime();else switch(e.durationType){case de.minutes:t=60*e.estDuration*1e3;break;case de.hours:t=60*e.estDuration*60*1e3;break;case de.days:t=24*e.estDuration*60*60*1e3;break;default:t=6e4}return t}function U(e,t){var i=Array.isArray(e)?e.concat():[e];t+=i.reduce(function(e,t){return scheduler._events[t]?e+","+scheduler._events[t].resource:e},"");for(var n in scheduler._events){var r=scheduler._events[n];"service"===r.type&&-1!=t.indexOf(r.resource)&&(i.push(r.id),r.relatedTo&&i.push(r.relatedTo),r.relatedFather&&i.push(r.relatedFather),r.relatedService2&&i.push(r.relatedService2),r.relatedService1&&i.push(r.relatedService1))}return i}function j(e,t,i){var n=[];e=Array.isArray(e)?e:[e];var r=e.join(",");for(var s in scheduler._events){var a=scheduler._events[s];"service"===a.type&&r.indexOf(a.serviceTerritory)&&isIntersect(a.start_date,a.end_date,t,i)&&(n.push(a.id),a.relatedTo&&n.push(a.relatedTo),a.relatedFather&&n.push(a.relatedFather),a.relatedService2&&n.push(a.relatedService2),a.relatedService1&&n.push(a.relatedService1))}return n}function z(e,t){var i=[];for(var n in scheduler._events){var r=scheduler._events[n];"service"===r.type&&isIntersect(r.start_date,r.end_date,e,t)&&(i.push(r.id),r.relatedTo&&i.push(r.relatedTo),r.relatedFather&&i.push(r.relatedFather),r.relatedService2&&i.push(r.relatedService2),r.relatedService1&&i.push(r.relatedService1))}return i}function q(){r(function(){var e=$(".gm-style-iw"),t=e.next();t.css({right:"12px",left:"",opacity:1})},0)}function W(e){return'<svg aria-hidden="true" class="slds-icon contextMenuIcon"><use xlink:href="'+e+'"></use></svg>'}function K(e){return'<svg aria-hidden="true" class="slds-icon contextMenuIcon"><use width="17px" height="17px" xlink:href="'+e+'"></use></svg>'}function Z(){var e=s.GetUserSettingsProperty("locations");return e?e:[]}function J(e,t,i,n){if(60>e)return n.replaceAll([e]);var r=e%60,s=Math.round(e/60);return 0===r?i.replaceAll([s]):t.replace("$0",s).replace("$1",r)}function Y(e){return customPermissions[e]}function X(){return"undefined"!=typeof sforce&&sforce&&!!sforce.one}function Q(e){return 0===e.indexOf("FSL__")?e.substr(5,e.length):e}var ee=void 0,te=[],ie=[],ne=[],re=[],se={},ae={},oe={},ce={},le={DateTime:"DATETIME",Date:"DATE",String:"STRING",TextArea:"TEXTAREA",Picklist:"PICKLIST",Reference:"REFERENCE",Currency:"CURRENCY",Phone:"PHONE"},ue={show:!0},de={minutes:"Minutes",hours:"Hours",days:"Days"},ve=[],pe=e.defer(),he=!1;return i.getCustomActions().then(function(e){e.forEach(function(e){var t=e[fieldNames.CustomGanttAction.Permission];window.customPermissions[t]&&ve.push(new d(e))}),pe.resolve(ve)}),i.getAllFormulaFields().then(function(e){ee=e}),i.getWorkOrderPriority().then(function(e){te.push.apply(te,_toConsumableArray(e))}),function(){se.startHour=s.GetUserSettingsProperty("Gantt_View_Start_Hour__c"),null==se.startHour&&(se.startHour=0),se.finishHour=s.GetUserSettingsProperty("Gantt_View_Finish_Hour__c"),null==se.finishHour&&(se.finishHour=24),se.filterCandidates=s.GetUserSettingsProperty("Filter_Candidates__c"),null==se.filterCandidates&&(se.filterCandidates=!0),se.servicesPerPage=s.GetUserSettingsProperty("Services_Per_Page__c"),null==se.servicesPerPage&&(se.servicesPerPage="75"),se.resourceRowHeight=s.GetUserSettingsProperty("Resource_Row_Height__c"),null==se.resourceRowHeight&&(se.resourceRowHeight="medium"),se.capacityDuration=s.GetUserSettingsProperty("View_Capacity_Type__c"),null==se.capacityDuration&&(se.capacityDuration="Day"),se.backHorizon=s.GetUserSettingsProperty("Scheduling_horizon_limit__c"),null==se.backHorizon&&(se.backHorizon=14),se.loadOnToday=s.GetUserSettingsProperty("Load_On_Today__c"),null==se.loadOnToday&&(se.loadOnToday=!0)}(),i.getCustomizationFiles().then(function(e){if(e&&e.CSS){var t=jQuery("<link>");t.attr({rel:"stylesheet",type:"text/css",href:e.CSS}),$("head").append(t)}e&&e.JS&&$.ajax({url:e.JS,dataType:"script"})}),window.openConsoleTabFromModal=function(e){a.isInConsole()&&sforce.console.generateConsoleUrl([e],function(t){t.success?sforce.console.openConsoleUrl(null,t.consoleUrl,!0):I(e)})},String.prototype.replaceAll=function(){for(var e=this,t=arguments.length,i=Array(t),n=0;t>n;n++)i[n]=arguments[n];for(var r=0;r<i.length;r++)e=e.replace("$"+r,i[r]);return e},i.getStatusFlow().then(function(e){if(e){angular.merge(ae,e);for(var t in ae)ae[t]=ae[t].sort()}})["catch"](function(e){console.warn("could not get status flow :("),console.log(e)}),i.getStatusTranslations().then(function(e){angular.merge(oe,e),window.statusTranslations=oe})["catch"](function(e){console.warn("could not get status translations :("),console.log(e)}),i.getStatuses().then(function(e){angular.merge(ce,e)})["catch"](function(e){console.warn("could not get status :("),console.log(e)}),{getFilteredLocations:Z,getSVGIconHTMLCustom:K,getSVGIconHTML:W,getRelatedServices:U,getServicesOfLocations:j,getServicesBetweenDates:z,getServiceDuration:V,safeApply:H,formatDayToString:F,showOnGantt:g,openConsoleTab:A,trust:D,openLink:C,openSObjectLink:k,openLightningSubtab:R,openLightningPrimaryTab:I,getServiceInfoRowClass:L,isEmpty:w,generateResourceId:v,addNotification:b,addDaysToDate:f,setDatesByStartAndMode:S,sortByTime:_,getReports:p,getPolygons:h,intersectDates:T,getCSSClassForContext:y,fieldsTypes:le,ganttSettings:se,butlerNotifications:function(){return re},getIdsOfSObjectsAbsence:B,showServiceList:ue,checkBoxFields:function(){return ee},woPriorities:te,durationTypes:de,statusFlow:ae,statusTranslations:oe,statuses:ce,convertDateBetweenTimeZones:M,convertDtToMomentDt:E,convertMomentDtToDt:N,getUserOffset:O,getLocationOffset:P,setMapCloseButtonPosition:q,getIdsOfSObjects:G,hoursMinutes:J,hasCustomPermission:Y,formatDateWithDayOfWeek:x,isLightning:X,getCustomActions:function(e){return ve.filter(function(t){return t.section===e})},customActionsPromise:pe.promise,removeFSLNamespace:Q,crewsFilter:he}}e.$inject=["$q","$sce","sfdcService","$rootScope","$timeout","userSettingsManager","StateService","kpiCalculationsService","ResourcesAndTerritoriesService","$injector"],angular.module("serviceExpert").factory("utils",e)}(),function(){angular.module("serviceExpert").factory("sfdcService",["$q","$rootScope","userSettingsManager",function(e,t,i){function n(){var e=i.GetUserSettingsProperty("locations");return e?e:[]}function r(){return JSON.parse(i.GetUserSettingsProperty("Show_Orphan_Services__c"))}var s={servicesArray:[],servicesObjs:{},activeRequests:{active:0},activeRuleCheckRequests:{active:0},firstTimeGettingEmployees:function(){return a}},a=e.defer();s.getUnPrivilegeUserSettingsFields=function(){var t=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getUnPrivilegeUserSettingsFields,function(e,i){i.status?(s.activeRequests.active-=1,t.resolve(e)):(s.activeRequests.active-=1,t.reject(i))},{buffer:!0,escape:!0,timeout:12e4}),t.promise},s.isStreamingShouldBeActive=function(){var t=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.isStreamingShouldBeActive,function(e,i){i.status?(s.activeRequests.active-=1,t.resolve(e)):(s.activeRequests.active-=1,t.reject(i))},{buffer:!0,escape:!0,timeout:12e4}),t.promise},s.getAllFormulaFields=function(){var t=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getAllFormulaFields,function(e,i){i.status?(s.activeRequests.active-=1,t.resolve(e)):(s.activeRequests.active-=1,t.reject(i))},{buffer:!0,escape:!1,timeout:12e4}),t.promise};var o=null;s.getServiceListFields=function(){return null==o&&(o=e.defer(),s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceListFields,function(e,t){t.status?(s.activeRequests.active-=1,o.resolve(e)):(s.activeRequests.active-=1,o.reject(t))},{buffer:!0,escape:!1,timeout:12e4})),o.promise};var c=null;s.getGanttToolTipFields=function(){return null==c&&(c=e.defer(),s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceGanttTooltipFields,function(e,t){t.status?(s.activeRequests.active-=1,c.resolve(e)):(s.activeRequests.active-=1,c.reject(t))},{buffer:!0,escape:!1,timeout:12e4})),c.promise};var l=null;s.getServiceMiniFormFields=function(){return null==l&&(l=e.defer(),s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceMiniFormFields,function(e,t){t.status?(s.activeRequests.active-=1,l.resolve(e)):(s.activeRequests.active-=1,l.reject(t))},{buffer:!0,escape:!1,timeout:12e4})),l.promise};var u=null;s.getServiceMapInfoWindowFields=function(){return null==u&&(u=e.defer(),s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceMapInfoWindowFields,function(e,t){t.status?(s.activeRequests.active-=1,u.resolve(e)):(s.activeRequests.active-=1,u.reject(t))},{buffer:!0,escape:!1,timeout:12e4})),u.promise};var d=null;s.getServiceCapacityColumns=function(){return null==d&&(d=e.defer(),s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceCapacityColumns,function(e,t){t.status?(s.activeRequests.active-=1,d.resolve(e)):(s.activeRequests.active-=1,d.reject(t))},{buffer:!0,escape:!1,timeout:12e4})),d.promise},s.getPolicies=function(){var t=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getPolicies,function(e,i){i.status?(s.activeRequests.active-=1,t.resolve(e)):(s.activeRequests.active-=1,t.reject(i))},{buffer:!0,escape:!1,timeout:12e4}),t.promise},s.sortServicesByPriority=function(t){var i=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.sortServicesByPriority,t,function(e,t){t.status?(s.activeRequests.active-=1,i.resolve(e)):(s.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},s.checkRules=function(i,n){var r=e.defer();return s.activeRuleCheckRequests.active+=1,t.policy||(t.policy=null),n||(n=t.policy),Visualforce.remoting.Manager.invokeAction(RemoteActions.checkRules,i,n,function(e,t){t.status?(s.activeRuleCheckRequests.active-=1,r.resolve(e)):(s.activeRuleCheckRequests.active-=1,r.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),r.promise},s.getOptimiztionRequestsUpdate=function(t){var i=e.defer(),r=n();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getOptimiztionRequestsUpdate,t,r,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!0,escape:!1,timeout:12e4}),i.promise},s.getGanttServiceOnAssignedResourceUpdate=function(t){var i=e.defer(),r=n();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getGanttServiceOnAssignedResourceUpdate,t,r,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},s.getUpdatedAbsences=function(t){var i=e.defer(),r=n();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getUpdatedAbsences,t,r,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},s.getDeletedAbsences=function(t){var i=e.defer(),r=n();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getDeletedAbsences,t,r,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},s.getUpdatedServices=function(t,i){var r=e.defer(),s=n();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getUpdatedServices,t,i,s,function(e,t){t.status?r.resolve(e):r.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),r.promise},s.getUpdatedResourceCapacities=function(t){var i=e.defer(),r=n();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getUpdatedResourceCapacities,t,r,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},s.getLivePositionsStreaming=function(t){var i=e.defer(),r=n();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getLivePositionsStreaming,t,r,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},s.getDelta=function(t){var i=e.defer(),r=n();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getDelta,t,r,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},s.postToChatter=function(t,i){var n=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.postToChatter,t,i,function(e,t){t.status?(s.activeRequests.active-=1,n.resolve(e)):(s.activeRequests.active-=1,n.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),n.promise},s.getLivePositions=function(){var t=e.defer();s.activeRequests.active+=1;var i=n();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getLivePositions,i,function(e,i){i.status?(t.resolve(e),s.activeRequests.active-=1):(t.reject(i),s.activeRequests.active-=1)},{buffer:!1,escape:!1,timeout:12e4}),t.promise},s.getSlots=function(t,i){var n=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getSlots,t,i,function(e,t){var i={};i.value=e,i.eventType=t.type,"exception"==t.type&&(i.event=t,n.resolve(i),s.activeRequests.active-=1),t.status?(n.resolve(i),s.activeRequests.active-=1):(n.reject(t),s.activeRequests.active-=1)},{buffer:!0,escape:!1,timeout:12e4}),n.promise},s.getSkills=function(){var t=e.defer();n();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getSkills,function(e,i){i.status?(t.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},s.getPolygons=function(){var t=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getPolygons,function(e,i){i.status?(t.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},s.savePolygon=function(t,i,n,r,a){var o=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.savePolygon,t,i,n,r,a,function(e,t){t.status?(o.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,o.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),o.promise},s.deletePolygon=function(t){var i=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.deletePolygon,t,function(e,t){t.status?(i.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},s.getLocale=function(){var t=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getLocale,function(e,i){i.status?(t.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,t.reject(i))},{buffer:!0,escape:!1,timeout:12e4}),t.promise},s.autoScheduleService=function(t,i){var r=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.autoScheduleService,t,i,n(),function(e,t){t.status?(r.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,r.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),r.promise},s.getDictionaries=function(){var t=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getDictionaries,function(e,i){i.status?(t.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,t.reject(i))},{buffer:!0,escape:!1,timeout:12e4}),t.promise},s.unscheduleServicesByServicesId=function(t){var i=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.unscheduleServicesByServicesId,t,function(e,t){t.status?(i.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},s.unscheduleServicesByLocationsId=function(t,i,n){var r=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.unscheduleServicesByLocationsId,t,i,n,function(e,t){t.status?(r.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,r.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),r.promise},s.getLocationsCurrentTime=function(t,i,n){var r=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getLocationsCurrentTime,function(e,t){t.status?(r.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,r.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),r.promise},s.getEmployeeAbsenceTypes=function(){var t=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getEmployeeAbsenceTypes,function(e,i){i.status?(t.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,t.reject(i))},{buffer:!0,escape:!1,timeout:12e4}),t.promise},s.getWorkOrderPriority=function(){var t=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getWorkOrderPriority,function(e,i){i.status?(t.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,t.reject(i))},{buffer:!0,escape:!1,timeout:12e4}),t.promise},s.getReports=function(){var t=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getReportsWithGeolocationCols,function(e,i){i.status?(t.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,t.reject(i))},{buffer:!0,escape:!1,timeout:12e4}),t.promise},s.getReportRowsForMap=function(t){var i=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getReportRowsForMap,t,function(e,t){t.status?(i.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},s.runOptimization=function(t,i,n,r,a,o,c){var l=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runOptimization,t,i,n,r,a,o,c,function(e,t){t.status?(l.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,l.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),l.promise},s.runRDOptimization=function(t,i,n,r,a,o,c,l){var u=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runRDOptimization,t,i,n,r,a,o,c,l,function(e,t){t.status?(u.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,u.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),u.promise},s.getRequestObject=function(t){var i=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getRequestObject,t,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!0,escape:!1,timeout:12e4}),i.promise},s.getCustomizationFiles=function(){var t=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getCustomizationFiles,function(e,i){i.status?t.resolve(e):t.reject(i)},{buffer:!0,escape:!1,timeout:12e4}),t.promise},s.getOptimizationsRequest=function(){var t=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getOptimizationsRequest,function(e,i){i.status?t.resolve(e):t.reject(i)},{buffer:!0,escape:!1,timeout:12e4}),t.promise},s.getResourceFieldSetFields=function(){var t=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getResourceFieldSetFields,function(e,i){i.status?t.resolve(e):t.reject(i)},{buffer:!0,escape:!1,timeout:12e4}),t.promise},s.getStatusTranslations=function(){var t=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getStatusTranslations,function(e,i){i.status?t.resolve(e):t.reject(i)},{buffer:!0,escape:!1,timeout:12e4}),t.promise},s.getResourcePicklistValues=function(t){var i=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.getResourcePicklistValues,t,function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!0,escape:!1,timeout:12e4}),i.promise},s.GetResourcesAndTerritories=function(t){var i=e.defer();return Visualforce.remoting.Manager.invokeAction(RemoteActions.GetResourcesAndTerritories,t||n(),function(e,t){t.status?i.resolve(e):i.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),i.promise},s.GetTimePhasedObjects=function(t,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,c=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.GetTimePhasedObjects,t,i,n(),r,a,o,maxServicesToLoadEachBulkInGantt,maxAbsencesToLoadEachBulkInGantt,function(e,t){s.activeRequests.active-=1,t.status?c.resolve(e):c.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),c.promise},s.loadServiceAppointmentsToList=function(t,i,a,o){var c=e.defer(),l=r();return s.activeRequests.active+=1,0>a&&(a=100),Visualforce.remoting.Manager.invokeAction(RemoteActions.LoadServiceAppointmentsToServiceList,t,n(),l,i,a,o,function(e,t){t.status?(c.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,c.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),c.promise},s.loadServicesInBulk=function(t,i,s,a,o){var c=e.defer(),l=r();return Visualforce.remoting.Manager.invokeAction(RemoteActions.loadServicesInBulk,t,n(),l,i,s,a,o,function(e,t){t.status?c.resolve(e):c.reject(t)},{buffer:!1,escape:!1,timeout:12e4}),c.promise},s.saveChangesToAbsence=function(t,i,r,a,o){var c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,d=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null,v=e.defer();
return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.saveChangesToAbsence,t,i,r,a,o,c,l,u,d,n(),function(e,t){t.status?(v.resolve(e),s.activeRequests.active-=1):(v.reject(t),s.activeRequests.active-=1)},{buffer:!0,escape:!1,timeout:12e4}),v.promise},s.saveChangesToServiceAppointment=function(t,i,r,a,o,c,l,u,d,v,p,h){var g=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.saveChangesToServiceAppointment,t,i,r,a,o,c,l,u,d,v,p,h,n(),function(e,t){t.status?(g.resolve(e),s.activeRequests.active-=1):(g.reject(t),s.activeRequests.active-=1)},{buffer:!0,escape:!1,timeout:12e4}),g.promise},s.changeStatusServicesByServicesId=function(t,i){var n=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.changeStatusServicesByServicesId,t,i,function(e,t){t.status?(n.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,n.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),n.promise},s.changeStatusServicesByLocationsId=function(t,i,n,r){var a=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.changeStatusServicesByLocationsId,t,i,n,r,function(e,t){t.status?(a.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,a.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),a.promise},s.deleteResourceAbsence=function(t){var i=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.deleteResourceAbsence,t,function(e,t){t.status?(i.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},s.getStatusFlow=function(){var t=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getStatusFlow,function(e,i){i.status?(t.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,t.reject(i))},{buffer:!0,escape:!1,timeout:12e4}),t.promise},s.getStatuses=function(){var t=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getStatuses,function(e,i){i.status?(t.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,t.reject(i))},{buffer:!0,escape:!1,timeout:12e4}),t.promise},s.changePin=function(t,i){var n=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.changePins,t,i,function(e,t){t.status?(n.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,n.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),n.promise},s.setServiceAppointmentsInJeopardy=function(t){var i=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.setServiceAppointmentsInJeopardy,t,function(e,t){t.status?(i.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},s.getOptimizationRequests=function(){var t=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getOptimizationRequests,n(),r(),function(e,i){i.status?(t.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,t.reject(i))},{buffer:!0,escape:!1,timeout:12e4}),t.promise},s.runFillInSchedule=function(t,i,n){var r=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runFillInSchedule,t,i,n,function(e,t){t.status?(r.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,r.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),r.promise},s.runFixOverlaps=function(t,i,n){var r=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runFixOverlaps,t,i,n,function(e,t){t.status?(r.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,r.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),r.promise},s.runGroupNearby=function(t,i){var n=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runGroupNearby,t,i,function(e,t){t.status?(n.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,n.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),n.promise},s.runReshuffle=function(t,i){var n=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runReshuffle,t,i,function(e,t){t.status?(n.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,n.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),n.promise},s.getResourceActualRoute=function(t,i){var n=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getResourceActualRoute,t,i,function(e,t){t.status?(n.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,n.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),n.promise},s.getFslOperation=function(t){var i=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getFslOperation,t,function(e,t){t.status?(i.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},s.getServicesById=function(t){var i=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServicesById,t,function(e,t){t.status?(i.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},s.getGanttFilters=function(){var t=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getGanttFilters,function(e,i){i.status?(t.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,t.reject(i))},{buffer:!0,escape:!1,timeout:12e4}),t.promise};var v=null;return s.getGanttFilterFields=function(){return null==v&&(v=e.defer(),s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getGanttFilterFields,function(e,t){t.status?(s.activeRequests.active-=1,v.resolve(e)):(s.activeRequests.active-=1,v.reject(t))},{buffer:!0,escape:!1,timeout:12e4})),v.promise},s.getFilterById=function(t){var i=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getFilterById,t,function(e,t){t.status?(i.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},s.hideFilter=function(t){var i=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.hideFilter,t,function(e,t){t.status?(i.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},s.deleteFilter=function(t){var i=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.deleteFilter,t,function(e,t){t.status?(i.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,i.reject(t))},{buffer:!0,escape:!1,timeout:12e4}),i.promise},s.userHasAdminPermissions=function(){var t=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.userHasAdminPermissions,function(e,i){i.status?(t.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},s.getGanttPalettes=function(){var t=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getGanttPalettes,function(e,i){i.status?(s.activeRequests.active-=1,t.resolve(e)):(s.activeRequests.active-=1,t.reject(i))},{buffer:!1,escape:!1,timeout:12e4}),t.promise},s.getServiceFieldsMap=function(){var t=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getServiceFieldsMap,function(e,i){i.status?(s.activeRequests.active-=1,t.resolve(e)):(s.activeRequests.active-=1,t.reject(i))},{buffer:!0,escape:!1,timeout:12e4}),t.promise},s.searchServiceByIdOrName=function(t){var i=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.searchServiceByIdOrName,t,function(e,t){t.status?(i.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,i.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),i.promise},s.runCustomServiceAction=function(t,i,n,r){var a=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runCustomServiceAction,t,i,n,r,function(e,t){t.status?(a.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,a.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),a.promise},s.runCustomAbsenceAction=function(t,i,n,r,a){var o=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runCustomAbsenceAction,t,i,n,r,a,function(e,t){t.status?(o.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,o.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),o.promise},s.runCustomResourceAction=function(t,i,n,r,a){var o=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.runCustomResourceAction,t,i,n,r,a,function(e,t){t.status?(o.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,o.reject(t))},{buffer:!1,escape:!1,timeout:12e4}),o.promise},s.getCustomActions=function(){var t=e.defer();return s.activeRequests.active+=1,Visualforce.remoting.Manager.invokeAction(RemoteActions.getCustomActions,function(e,i){i.status?(t.resolve(e),s.activeRequests.active-=1):(s.activeRequests.active-=1,t.reject(i))},{buffer:!0,escape:!1,timeout:12e4}),t.promise},s}])}(),function(){function e(e,t,i,n,r,s){function a(a){u=e.$new(!0),u.lightboxAbsence=t.resourceAbsences()[a],u.selectedTab="details",u.urls={chatter:i.trustAsResourceUrl(customAbsenceChatterPage+"?id="+a).toString(),details:i.trustAsResourceUrl(customAbsencePage+"?id="+a).toString()},u.changeTab=c,u.closeLightbox=o,u.chatterAvailable=fieldTrackingEnabled.absence,u.openConsoleTab=r.openConsoleTab;var d=l();d.find("#AbsenceLightbox").draggable({handle:"#AbsenceLightboxHeader"}),s.setLightBoxStatus(),u.$on("$destroy",function(){return d.remove()}),u.$on("keypress",function(e,t){27==t.which&&u.$evalAsync(u.closeLightbox)}),n(d)(u),r.safeApply(u,function(){angular.element("body").append(d)})}function o(){s.setLightBoxStatus(!1),u.$destroy()}function c(e){e!==u.selectedTab&&(u.selectedTab=e)}function l(){return angular.element('<div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="AbsenceLightbox">\n\n                        <div class="lightboxHeaderContainer" id="AbsenceLightboxHeader">\n\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n\n                            <h1 class="lightboxHeader">\n                                <i ng-show="lightboxAbsence.type == \'na\'">'+customLabels.NA+":</i>\n                                <i ng-show=\"lightboxAbsence.type == 'break'\">"+customLabels.Break+":</i>\n                                {{ lightboxAbsence.name }}\n                            </h1>\n\n                            <span ng-click=\"changeTab('details')\" ng-class=\"{lightboxSelectedTab: selectedTab == 'details'}\">\n                                "+customLabels.Details+'\n                            </span>\n\n                            <span ng-show="chatterAvailable" ng-click="changeTab(\'chatter\')" ng-class="{lightboxSelectedTab: selectedTab == \'chatter\'}">\n                                '+customLabels.Chatter+'\n                            </span>\n\n                            <div class="ExtendedForm">\n                                <a ng-click="openConsoleTab($event,lightboxAbsence.id)" target="_blank" href="../{{ lightboxAbsence.id }}" title="'+customLabels.ExtandedForm+'">\n                                    <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                        \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                    \u2028</svg>\n                                </a>\n                            </div>\n                        </div>\n\n                        <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'details\'" ng-src="{{ urls.details }}"></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'chatter\'" ng-src="{{ urls.chatter }}" ng-if="chatterAvailable"></iframe>\n                        \n                        <div id="lightbox-loading-cover">\n                            <img src="'+lsdIcons.spinnerGif+'" />\n                            '+customLabels.loading+"\n                        </div>\n\n                    </div>\n                </div>")}var u=null;return{open:a}}e.$inject=["$rootScope","TimePhasedDataService","$sce","$compile","utils","StateService"],angular.module("serviceExpert").factory("AbsenceLightboxService",e)}(),function(){function e(e,t,i,n,r,s){function a(r,a){var o=e.defer(),c=new Date(a.start_date.getTime()+1e3*a.travelTo),l=new Date(a.end_date.getTime()-1e3*a.travelFrom);if(useLocationTimezone){var u=t.getIntersectingSrstOffset(a,a.getGanttResource()),d=s.getUserOffset(c),v=s.getUserOffset(l);c.setMinutes(c.getMinutes()+d-u),l.setMinutes(l.getMinutes()+v-u)}return i.saveChangesToAbsence(a.id,a.getGanttResource(),c,l,a.absenceType,a.ganttLabel,a.snapToId||null,a.snapToType||null,a.snapDirection||null).then(function(e){n.handleDeltaResponse(e),e.error?o.reject([e,r]):o.resolve()})["catch"](function(e){o.reject([e,r])}),o.promise}function o(r){var a=e.defer();if(useLocationTimezone){var o=t.getIntersectingSrstOffset(r,r.resource),c=s.getUserOffset(r.start_date),l=s.getUserOffset(r.end_date);r.start_date.setMinutes(r.start_date.getMinutes()+c-o),r.end_date.setMinutes(r.end_date.getMinutes()+l-o)}return i.saveChangesToAbsence(null,r.resource,r.start_date,r.end_date,r.absenceType,r.ganttLabel,r.snapToId||null,r.snapToType||null,r.snapDirection||null).then(function(e){n.handleDeltaResponse(e),e.error?a.reject(e):a.resolve()})["catch"](function(e){a.reject(e)}),a.promise}function c(t){var r=e.defer();return i.deleteResourceAbsence(t).then(function(e){e?n.getDelta():s.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.Failed_To_Delete_Break,null,null)})["catch"](function(e){r.reject(e)}),r.promise}function l(){var t=e.defer();return i.getEmployeeAbsenceTypes().then(function(e){e&&(u=e,t.resolve(u))})["catch"](function(e){t.reject(e)}),t.promise}var u={};return{saveChangesToAbsence:a,saveNewAbsence:o,deleteAbsence:c,getEmployeeAbsenceTypes:l}}e.$inject=["$q","TimePhasedDataService","sfdcService","DeltaService","servicesService","utils"],angular.module("serviceExpert").factory("AbsencesService",e)}(),function(){function e(e,t,i,n,r,s,a,o,c){function l(){_=t.$new(!0),_.$on("keypress",function(e,t){27==t.which&&_.$evalAsync(_.closeLightbox)});var a=r.GetUserSettingsProperty("locations");_.filteredLocations=a.map(function(e){return i.territories[e]}),_.selectedCount=n.countSelectedServices(),_.contractorSupport=s.areContractorsSupported(),g(),_.dateSelectFinishWidget=d,_.dateSelectStartWidget=v,_.validateDatesStart=p,_.validateDatesEnd=h,_.targetServices=0==_.selectedCount?"locations":"selectedServices",_.bulkState="form",_.bulkDispatch=b,_.results={},_.toggleFlag=m,_.isFlagged=f,_.getServiceName=S,_.selectedLocations={},_.nothingToDispatch=!1,_.isAmpm=isAMPM?"ampm":"24",_.selectedMashu=customLabels.x_selected;var o=y();o.find("#BulkActionsLightbox").draggable({handle:"#UnschduleLightboxHeader"}),angular.element("body").append(o),_.closeLightbox=u,_.$on("$destroy",function(){return o.remove()}),e(o)(_),o.show(),s.setLightBoxStatus()}function u(){"running"!==_.bulkState&&(s.setLightBoxStatus(!1),_.$destroy())}function d(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(_.actionFinish),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(_.endMinutes)),i.setHours(parseInt(_.endHour)),i<_.actionStart?alert(customLabels.finishAfterStart):_.actionFinish=i,scheduler.destroyCalendar(),_.$apply()}})}function v(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(_.actionStart),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(_.startMinutes)),i.setHours(parseInt(_.startHour)),i>_.actionFinish?alert(customLabels.startBeforeEnd):_.actionStart=i,scheduler.destroyCalendar(),_.$apply()}})}function p(){var e=new Date(_.actionStart);e.setMinutes(parseInt(_.startMinutes)),e.setHours(parseInt(_.startHour)),e>=_.actionFinish?(alert(customLabels.startBeforeEnd),_.startMinutes=_.actionStart.getMinutes(),_.startHour=_.actionStart.getHours().toString()):_.actionStart=e}function h(){var e=new Date(_.actionFinish);e.setMinutes(parseInt(_.endMinutes)),e.setHours(parseInt(_.endHour)),e<=_.actionStart?(alert(customLabels.finishAfterStart),_.endMinutes=_.actionFinish.getMinutes().toString(),_.endHour=_.actionFinish.getHours().toString()):_.actionFinish=e}function g(){_.minutes=T,_.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],_.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),_.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),_.startHour="0",_.endHour="0",_.startMinutes="0",_.endMinutes="0"}function m(e){a.flagged[e]=!a.flagged[e]}function f(e){return a.flagged[e]}function S(e){return o.serviceAppointments()[e].name}function b(){var e=[],t=void 0,i=void 0;if("locations"===_.targetServices){t=_.actionStart,i=_.actionFinish,t.setHours(_.startHour),t.setMinutes(_.startMinutes),i.setHours(_.endHour),i.setMinutes(_.endMinutes);for(var r in _.selectedLocations)_.selectedLocations[r]&&e.push(r);if(0===e.length)return void alert(customLabels.noLocationWasSelected)}else e=n.getSelected();s.setBulkActionRunning(),_.bulkState="running",a.changeStatus(e,c.DISPATCHED,t,i).then(function(t){if(t.nothingToDispatch)return void(_.nothingToDispatch=!0);a.drawServicesAndAbsences(t.services),_.results.dispatched=[],e="locations"===_.targetServices?t.services.map(function(e){return e.id}):e;for(var i=0;i<e.length;i++)o.serviceAppointments()[e[i]].status===c.DISPATCHED&&_.results.dispatched.push(o.serviceAppointments()[e[i]]);_.results.failed=Object.keys(t.failedResults).length>0?t.failedResults:null})["catch"](function(e){console.warn("bulk dispatch failed :("),console.log(e)})["finally"](function(){s.setBulkActionRunning(!1),_.bulkState="finished"})}function y(){var e=customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n							</select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>');return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="BulkActionsLightbox">\n\n                    <div ng-show="bulkState != \'running\'" class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox" id="CloseDispatchLightbox">\n                            \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                        \u2028</svg>\n                        <h1 class="light-box-header">'+customLabels.BulkDispatch+'</h1>\n                    </div>\n\n                    \n                    <div id="ori-ohev-banim" ng-show="bulkState == \'finished\'">\n                        <div ng-show="bulkState == \'finished\'">\n    \n                            <div ng-show="nothingToDispatch" class="BulkLightNotFound">'+customLabels.NothingToUnschduleLightbox+'</div>\n    \n                            <div ng-show="results.dispatched.length" class="lightboxResultContainer dispatchResultsContainer1">\n    \n                                <div class="unscheduleTableTitle">'+customLabels.SuccessfullyDispatched+'</div>\n    \n                                <div ng-repeat="dispatced in results.dispatched" class="lightboxTableRow">\n                                    {{ dispatced.name }}\n                                    <div ng-click="toggleFlag(dispatced.id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(dispatced.id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(dispatced.id)">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">'+customLabels.FailToDispatch+'</div>\n                                <div ng-repeat="(id, failedReason) in results.failed" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span>{{ failedReason.errorMessage }}</span>\n    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+'</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n    \n                        </div>\n                    </div>\n\n                    <div ng-show="bulkState == \'running\'" class="bulkActionRunningContainer">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.DispatchingPleaseWait+'\n                    </div>\n\n\n                    <div ng-show="bulkState == \'form\'">\n\n                        <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.DispatchLightboxText+'</p>\n\n                                <div class="selectedTargetServices" ng-class="{ disabledBulkSection: selectedCount == 0 }">\n                                    <input ng-model="targetServices" type="radio" ng-disabled="selectedCount == 0" name="bulkUnscheduleRadio" id="bulkUnschduleBySelectedRadio" value="selectedServices" />\n                                    <label for="bulkUnschduleBySelectedRadio">'+customLabels.Selected_services+' <span ng-show="selectedCount > 0">({{ selectedMashu | replaceLabels : selectedCount }})</span></label>\n                                </div>\n\n                                <div class="selectedTargetLocations">\n                                    <input ng-model="targetServices" type="radio" name="bulkUnscheduleRadio" id="bulkUnschduleByLocationRadio" value="locations" />\n                                    <label for="bulkUnschduleByLocationRadio">'+customLabels.ChooseLocationsLB+'</label>\n                                </div>\n\n                                <div id="bulkLocationNames" ng-class="{\'disabled-area\': targetServices != \'locations\'}">\n                                    <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                        <input ng-model="selectedLocations[location.id]" type="checkbox" ng-disabled="targetServices != \'locations\'" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                        <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                    </div>\n                                </div>\n\n                                <div style="margin-top: 10px;" ng-show="!contractorSupport" ng-class="{\'disabled-area\': targetServices != \'locations\'}">\n                                    <input ng-model="includeContractorServices" ng-disabled="targetServices != \'locations\'" type="checkbox" id="BulkUnscheduleContractorServices" name="BulkUnscheduleContractorServices" />\n                                    <label for="BulkUnscheduleContractorServices">'+customLabels.Include_services_assigned_to_contractors+"</label>\n                                </div>\n\n                                <div class=\"bulkOptimizeOptions\" ng-class=\"{'disabled-area': targetServices != 'locations'}\">\n                                    "+e+'\n                                </div>\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <div class="lightboxSaveButton" ng-click="bulkDispatch()">'+customLabels.Dispatch+"</div>\n                            </div>\n\n                        </div>\n                    </div>\n\n                </div>\n            ")}for(var _=null,T=[],w=0;60>w;w++)T.push(w);return{open:l}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","ServiceSelectorService","userSettingsManager","StateService","servicesService","TimePhasedDataService","SERVICE_STATUS"],angular.module("serviceExpert").factory("bulkDispatchService",e)}(),function(){function e(e,t,i,n,r){function s(n,s){d=r.get("servicesService"),v=t.$new(!0),v.getServiceName=c,v.results={success:[],failed:Object.keys(n.failedResults).length>0?n.failedResults:null},v.labels=s,v.toggleFlag=a,v.isFlagged=o;for(var p=0;p<n.services.length;p++)n.failedResults[n.services[p].Id]||v.results.success.push(n.services[p].Id);v.$on("keypress",function(e,t){27==t.which&&v.$evalAsync(v.closeLightbox)});var h=u();h.find("#BulkActionsLightbox").draggable({handle:"#UnschduleLightboxHeader"}),angular.element("body").append(h),v.closeLightbox=l,v.$on("$destroy",function(){return h.remove()}),e(h)(v),h.show(),i.setLightBoxStatus()}function a(e){d.flagged[e]=!d.flagged[e]}function o(e){return d.flagged[e]}function c(e){return n.serviceAppointments()[e].name}function l(){i.setLightBoxStatus(!1),v.$destroy()}function u(){return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="BulkActionsLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.BulkActionResults+'</h1>\n                        </div>\n\n                        <div class="resultsContainerOverflow">\n                            <div ng-show="results.success && results.success.length" class="lightboxResultContainer">\n    \n                                <div class="unscheduleTableTitle">{{labels.success}}</div>\n    \n                                <div ng-repeat="id in results.success" class="lightboxTableRow">\n                                    {{ getServiceName(id) }}\n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed && results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">{{labels.fail}}</div>\n                                <div ng-repeat="(id, failedReason) in results.failed" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span class="BulkResultLine">{{ failedReason.errorMessage }}</span>\n    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+"</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                </div>\n            ")}for(var d=null,v=null,p=[],h=0;60>h;h++)p.push(h);return{open:s}}e.$inject=["$compile","$rootScope","StateService","TimePhasedDataService","$injector"],angular.module("serviceExpert").factory("bulkResultsService",e)}(),function(){function e(e,t,i,n,r){function s(n){var s=null;v=r.get("servicesService"),s=t.$new(!0),s.isAdmin=!1,void 0==window.userHasAdminPermissions?sfdcService.userHasAdminPermissions().then(function(e){e?window.userHasAdminPermissions=s.isAdmin=!0:window.userHasAdminPermissions=!1}):s.isAdmin=window.userHasAdminPermissions,s.toggleFlag=c,s.isFlagged=l,s.results=n,s.getService=o,s.isError=a,s.successfullyScheduled=0,s.globalSelectedCount=Object.keys(n).length,s.generatePartialResult=function(e){return customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)},s.replaceLabelsForSebas=function(){return customLabels.x_services_scheduled_of_y_here_are_results.replaceAll(s.successfullyScheduled,s.globalSelectedCount)};for(var p in n)"scheduled"===n[p].textResult&&s.successfullyScheduled++;s.$on("keypress",function(e,t){27==t.which&&s.$evalAsync(s.closeLightbox)}),s.closeLightbox=u,s.$on("$destroy",function(){return h.remove()});var h=d();h.find("#BulkActionsLightbox").draggable({handle:"#UnschduleLightboxHeader"}),e(h)(s),angular.element("body").append(h),h.show(),i.setLightBoxStatus()}function a(e){return angular.isObject(e)}function o(e){return n.serviceAppointments()[e]}function c(e){v.flagged[e]=!v.flagged[e]}function l(e){return v.flagged[e]}function u(e){i.setLightBoxStatus(!1),e.$destroy()}function d(){return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="BulkActionsLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox(this)" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.BulkScheduleResults+'</h1>\n                        </div>\n\n                        <div style="padding:0 15px">\n                        \n                            <p>{{ replaceLabelsForSebas() }}</p>\n            \n                            <div id="ResultTableHeader">\n                                <span>'+customLabels.ID+'</span>\n                                <span id="ResultHeaderStart">'+customLabels.Start+"</span>\n                                <span>"+customLabels.Finish+'</span>\n                                <span id="ResultResourceHeader">'+customLabels.Resource+'</span>\n                            </div>\n            \n                            <div id="ScheduledResultsTable">\n                                <div ng-repeat="(id,res) in results" class="ScheduleResultRow">\n                                \n                                    <span class="scheduledResultColName">{{ getService(id).name }}</span>\n                                    <span class="scheduledResultDate" ng-if="res.textResult == \'scheduled\'">{{getService(id).start | amDateFormat:\'lll\'}}</span>\n                                    <span class="scheduledResultDate" ng-if="res.textResult == \'scheduled\'">{{getService(id).finish | amDateFormat:\'lll\'}}</span>\n                                    <span class="scheduledResultDate" ng-if="res.textResult == \'scheduled\'">{{getService(id).resourceName}}</span>\n                                    <span class="ScheduleResultUnscheduled" ng-if="isError(res)">{{ res.msg }}</span>\n                                    <!--<span class="ScheduleResultUnscheduled" ng-if="isError(res)">'+customLabels.NoCandidates+'</span>-->\n                                    <span class="ScheduleResultUnscheduled" ng-if="res.textResult == \'no candidates\'">'+customLabels.NoCandidates+'</span>\n                                    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+'</span>\n                                    </div>\n                                    \n                                    <div class="PartialResultsBulk" ng-show="res.partialResults.length > 0" ng-init="res.showDetails = false;">\n                                        <div>'+customLabels.particalCouldntProcessAll+' <u ng-show="isAdmin" ng-click="res.showDetails = !res.showDetails">'+customLabels.ShowDetails+'</u></div>\n            \n                                        <div ng-show="res.showDetails">\n                                            <ul>\n                                                <li ng-repeat="partial in res.partialResults">\n                                                    {{ generatePartialResult(partial) }}\n                                                </li>\n                                            </ul>\n                                        </div>\n                                    </div>\n                                    \n                                </div>\n                            </div>\n                            \n                        </div>\n                    </div>\n\n                </div>\n            ');
}var v=null;return{open:s}}e.$inject=["$compile","$rootScope","StateService","TimePhasedDataService","$injector"],angular.module("serviceExpert").factory("bulkScheduleResultsService",e)}(),function(){function e(e,t,i,n,r,s,a,o){function c(){h=i.$new(!0),h.isInConsole=s.isInConsole(),h.actionName="Schedule",h.currentSchedulingIndex=0,h.successfullyScheduled=0,h.afterSchedulingServiceObjects={},h.close=l,h.showResults=u,h.progressBarStyle=d,h.getLabel=function(e){return customLabels[e]};var e=p();angular.element("body").append(e),h.$on("$destroy",function(){return e.remove()}),t(e)(h),e.show()}function l(){h.$destroy()}function u(){a.open(h.afterSchedulingServiceObjects),h.$destroy()}function d(){return{width:(h.currentSchedulingIndex+1)/h.globalSelectedCount*100+"%"}}function v(t){0===t.length||s.isScheduleRunning||(h&&h.$destroy(),c(),s.isScheduleRunning=!0,h.globalSelectedCount=t.length,n.sortServicesByPriority(t).then(function(t){function i(e){s.schedulingRunningFor[o[e].id]=!0,n.autoScheduleService(o[e].id).then(function(t){n.drawServicesAndAbsences(t.services,t.absences),h.afterSchedulingServiceObjects[o[e].id]={},h.afterSchedulingServiceObjects[o[e].id].partialResults=t.partialResults,h.afterSchedulingServiceObjects[o[e].id].textResult="no candidates",t.services.forEach(function(t){t.id===o[e].id&&(h.afterSchedulingServiceObjects[o[e].id].textResult="scheduled",h.successfullyScheduled++)})})["catch"](function(t){var i={};i.msg=t.message,h.afterSchedulingServiceObjects[o[e].id]=i})["finally"](function(){if(h.currentSchedulingIndex++,s.schedulingRunningFor[o[e].id]=!1,e+1<h.globalSelectedCount&&a[e+1].resolve(e+1),e+1===h.globalSelectedCount){var t=[];for(var i in scheduler._events)"service"===scheduler._events[i].type&&t.push(i);t.length>0&&n.checkRules(t).then(n.drawViolationsOnGantt),s.isScheduleRunning=!1}})}var a=[],o=[];t.forEach(function(e){o.push(r.serviceAppointments()[e.ServiceId])}),h.globalSelectedServiceObjects=o;for(var c=0;c<h.globalSelectedCount;c++){var l=e.defer();l.promise.then(i),a.push(l)}a[0].resolve(0)}))}function p(){return angular.element('\n            <div id="SchedulingInProgress" class="slideInProgressBox" ng-class="{SchedulingInProgressConsole: isInConsole}">\n\n				<div ng-show="currentSchedulingIndex != globalSelectedCount">\n					<i class="fa fa-spinner fa-spin"></i> '+customLabels.Scheduling_Services+'\n					<div class="ProgressBar">\n						<div ng-style="progressBarStyle()"></div>\n					</div>\n\n					<div ng-cloak class="ProgressBarLabel">{{ getLabel(\'Scheduling_service\') | replaceLabels : (currentSchedulingIndex+1) : globalSelectedCount }}</div>\n				</div>\n\n				<div ng-show="currentSchedulingIndex == globalSelectedCount">\n					<i class="fa fa-check"></i> '+customLabels.Scheduling_Complete+'\n					<div ng-cloak class="HowManyWereScheduled">{{  getLabel(\'Scheduled_x_out_of_y\') | replaceLabels : successfullyScheduled : globalSelectedCount }}</div>\n					<span ng-cloak class="InProgressAction" ng-click="close()">'+customLabels.Close+'</span>\n					<span ng-cloak class="InProgressAction" ng-click="showResults()">'+customLabels.View_services+"</span>\n				</div>\n\n			</div>")}var h=null;return{schedule:v}}e.$inject=["$q","$compile","$rootScope","servicesService","TimePhasedDataService","StateService","bulkScheduleResultsService","utils"],angular.module("serviceExpert").factory("bulkScheduleService",e)}(),function(){function e(e,t,i,n,r,s,a,o){function c(){y=t.$new(!0),y.$on("keypress",function(e,t){27==t.which&&y.$evalAsync(y.closeLightbox)});var a=r.GetUserSettingsProperty("locations");y.filteredLocations=a.map(function(e){return i.territories[e]}),y.selectedCount=n.countSelectedServices(),y.contractorSupport=s.areContractorsSupported(),h(),y.dateSelectFinishWidget=u,y.dateSelectStartWidget=d,y.validateDatesStart=v,y.validateDatesEnd=p,y.targetServices=0==y.selectedCount?"locations":"selectedServices",y.bulkState="form",y.bulkUnschedule=S,y.results={},y.toggleFlag=g,y.isFlagged=m,y.getServiceName=f,y.selectedLocations={},y.nothingToUnschedule=!1,y.isAmpm=isAMPM?"ampm":"24",y.exception=null;var o=b();o.find("#UnschduleLightbox").draggable({handle:"#UnschduleLightboxHeader"}),angular.element("body").append(o),y.closeLightbox=l,y.getCustomLabel=function(e){return customLabels[e]},y.$on("$destroy",function(){return o.remove()}),e(o)(y),o.show(),s.setLightBoxStatus()}function l(){"running"!==y.bulkState&&(s.setLightBoxStatus(!1),y.$destroy())}function u(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(y.actionFinish),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(y.endMinutes)),i.setHours(parseInt(y.endHour)),i<y.actionStart?alert(customLabels.finishAfterStart):y.actionFinish=i,scheduler.destroyCalendar(),y.$apply()}})}function d(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(y.actionStart),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(y.startMinutes)),i.setHours(parseInt(y.startHour)),i>y.actionFinish?alert(customLabels.startBeforeEnd):y.actionStart=i,scheduler.destroyCalendar(),y.$apply()}})}function v(){var e=new Date(y.actionStart);e.setMinutes(parseInt(y.startMinutes)),e.setHours(parseInt(y.startHour)),e>=y.actionFinish?(alert(customLabels.startBeforeEnd),y.startMinutes=y.actionStart.getMinutes(),y.startHour=y.actionStart.getHours().toString()):y.actionStart=e}function p(){var e=new Date(y.actionFinish);e.setMinutes(parseInt(y.endMinutes)),e.setHours(parseInt(y.endHour)),e<=y.actionStart?(alert(customLabels.finishAfterStart),y.endMinutes=y.actionFinish.getMinutes().toString(),y.endHour=y.actionFinish.getHours().toString()):y.actionFinish=e}function h(){y.minutes=_,y.hours24=[24,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],y.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),y.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),y.startHour="0",y.endHour="0",y.startMinutes="0",y.endMinutes="0"}function g(e){a.flagged[e]=!a.flagged[e]}function m(e){return a.flagged[e]}function f(e){return o.serviceAppointments()[e].name}function S(){var e=[],t=void 0,i=void 0;if("locations"===y.targetServices){t=y.actionStart,i=y.actionFinish,t.setHours(y.startHour),t.setMinutes(y.startMinutes),i.setHours(y.endHour),i.setMinutes(y.endMinutes);for(var r in y.selectedLocations)y.selectedLocations[r]&&e.push(r);if(0===e.length)return void alert(customLabels.noLocationWasSelected)}else e=n.getSelected();s.setBulkActionRunning(),y.bulkState="running",a.unscheduleServices(e,t,i).then(function(t){if(t.nothingToUnschedule)return void(y.nothingToUnschedule=!0);a.drawServicesAndAbsences(t.services,t.absences,[],t.capacities),y.results.unscheduled=[],e="locations"===y.targetServices?t.services.map(function(e){return e.id}):e;for(var i=0;i<e.length;i++)o.serviceAppointments()[e[i]].isScheduled()||y.results.unscheduled.push(o.serviceAppointments()[e[i]]);y.results.failed=Object.keys(t.failedResults).length>0?t.failedResults:null})["catch"](function(e){console.warn("bulk unschedule failed :("),console.log(e),y.exception=e})["finally"](function(){s.setBulkActionRunning(!1),y.bulkState="finished"})}function b(){var e=customLabels.starting_from_x_until_y.replace("$0",'<u id="bulkStartUnschedule" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartUnschedule\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n                            </select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesStart()" ng-model="startMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>').replace("$1",'<u id="bulkFinishUnschedule" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishUnschedule\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>\n							<select class="selectOnBulk RightArrowForSelect bulkActionSelectLb bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endHour">\n							    <option ng-if="h != 24" ng-repeat="h in hours24" value="{{h}}">{{ h | ampmOr24:isAmpm }}</option>\n							</select>\n							<select class="minutesSelect selectOnBulk RightArrowForSelect bulkActionSelectLb" ng-change="validateDatesEnd()" ng-model="endMinutes">\n							    <option ng-repeat="m in minutes" value="{{m}}" ng-bind="m"></option>\n							</select>');return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="BulkActionsLightbox">\n\n                    <div ng-show="bulkState != \'running\'" class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                            \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                        \u2028</svg>\n                        <h1 class="light-box-header">'+customLabels.BulkUnschedule+'</h1>\n                    </div>\n\n                    <div ng-show="bulkState == \'finished\'">\n\n\n                        <div ng-show="nothingToUnschedule" class="BulkLightNotFound">'+customLabels.NothingToUnschduleLightbox+'</div>\n\n                        <div class="resultsContainerOverflow class="unschedule_res_thingy_qa_halash">\n                        \n                            <div class="bulk-exception" ng-show="exception">\n                                <svg aria-hidden="true" class="slds-icon kpiIcon">\n                                    \u2028<use xlink:href="'+lsdIcons.violation+'"></use>\n                                \u2028</svg>\n                                {{ exception.message }} \n                            </div>\n                        \n                            <div ng-show="results.unscheduled.length" class="lightboxResultContainer">\n    \n                                <div class="unscheduleTableTitle">'+customLabels.SuccessfullyUnscheduled+'</div>\n    \n                                <div ng-repeat="unscheduled in results.unscheduled track by $index" class="lightboxTableRow">\n                                    {{ unscheduled.name }}\n                                    <div ng-click="toggleFlag(unscheduled.id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(unscheduled.id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(unscheduled.id)">'+customLabels.Flag+'</span>\n                                    </div>\n                                </div>\n                            </div>\n    \n                            <div ng-show="results.failed" class="lightboxResultContainer">\n                                <div class="unscheduleTableTitle">'+customLabels.FailToUnschedule+'</div>\n                                <div ng-repeat="(id, failedReason) in results.failed track by $index" class="lightboxTableRow">\n                                    <span class="BulkLightboxServiceName">{{ getServiceName(id) }}</span>\n                                    <span>{{ failedReason.errorMessage }}</span>\n    \n                                    <div ng-click="toggleFlag(id)" class="bulkActionLightboxFlag">\n                                        <span ng-show="isFlagged(id)">'+customLabels.Unflag+'</span>\n                                        <span ng-show="!isFlagged(id)">'+customLabels.Flag+'</span>\n                                    </div>\n    \n                                </div>\n                            </div>\n                        </div>\n\n                    </div>\n\n                    <div ng-show="bulkState == \'running\'" class="bulkActionRunningContainer">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.UnschedulingPleaseWait+'\n                    </div>\n\n                    <div ng-show="bulkState == \'form\'">\n\n                        <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.UnscheduleLightboxText+'</p>\n\n                                <div class="selectedTargetServices" ng-class="{ disabledBulkSection: selectedCount == 0 }">\n                                    <input ng-model="targetServices" type="radio" ng-disabled="selectedCount == 0" name="bulkUnscheduleRadio" id="bulkUnschduleBySelectedRadio" value="selectedServices" />\n                                    <label for="bulkUnschduleBySelectedRadio">'+customLabels.Selected_services+' <span ng-show="selectedCount > 0">({{ getCustomLabel(\'x_selected\') | replaceLabels : selectedCount }})</span></label>\n                                </div>\n\n                                <div class="selectedTargetLocations">\n                                    <input ng-model="targetServices" type="radio" name="bulkUnscheduleRadio" id="bulkUnschduleByLocationRadio" value="locations" />\n                                    <label for="bulkUnschduleByLocationRadio">'+customLabels.ChooseLocationsLB+'</label>\n                                </div>\n\n                                <div id="bulkLocationNames">\n                                    <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                        <input ng-model="selectedLocations[location.id]" type="checkbox" ng-disabled="targetServices != \'locations\'" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                        <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                    </div>\n                                </div>\n\n                                <div style="margin-top: 10px;" ng-show="!contractorSupport">\n                                    <input ng-model="includeContractorServices" ng-disabled="targetServices != \'locations\'" type="checkbox" id="BulkUnscheduleContractorServices" name="BulkUnscheduleContractorServices" />\n                                    <label for="BulkUnscheduleContractorServices">'+customLabels.Include_services_assigned_to_contractors+'</label>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    '+e+'\n                                </div>\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <div class="lightboxSaveButton" ng-click="bulkUnschedule()">'+customLabels.Unschedule+"</div>\n                            </div>\n\n                        </div>\n                    </div>\n\n                </div>\n            ")}for(var y=null,_=[],T=0;60>T;T++)_.push(T);return{open:c}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","ServiceSelectorService","userSettingsManager","StateService","servicesService","TimePhasedDataService"],angular.module("serviceExpert").factory("bulkUnscheduleService",e)}(),function(){angular.module("serviceExpert").factory("calendarsService",["ResourcesAndTerritoriesService","TimePhasedDataService","$rootScope","utils",function(e,t,i,n){function r(){f={},S={},b={},y.resourceToWorkingDates=b}function s(i,r,s){for(var o=new Date(i),c=null;r>o;){var l=n.formatDayToString(o);if(!f[l]){f[l]=!0,c||(c=m(t.resourcesAndTerritories()));var u=new Date(o);u.setDate(u.getDate()+1);for(var d in e.getResources())a(new Date(o),new Date(u),d,c[d])}o.setDate(o.getDate()+1)}}function a(t,i,r,s,a){var l={P:[],R:[],S:[]},u={};for(var v in s){for(var p=s[v].slice(),f=n.generateResourceId(r,v),b=t,y=0;y<p.length;y++){var _=p[y],T=n.intersectDates({start:b,finish:i},_);if(l[_.type].push(_),"S"!=_.type){if(T.intersection){for(var w=0;w<T.remainderFrom1.length;w++){var L=T.remainderFrom1[w];L.isStart&&g(L.start,L.finish,f)}if("R"!=_.type||S[_.id]||a||h(_,s,r),b=T.intersection.finish,e.allTerritories[v]){var C=_.operatingHours||e.allTerritories[v].operatingHours;C?d(T.intersection.start,T.intersection.finish,C,f,a):g(T.intersection.start,T.intersection.finish,f)}}}else u[_.serviceTerritory]=_}b.getTime()==i.getTime()||u[f.split("_")[1]]||g(b,i,f)}if(showSecondarySTMs&&!n.isEmpty(u)&&!a){var k=o(l,r,u),D=m(k);c(t,i,r,D[r],!0)}}function o(e,t,i){var r={};r[t]={};for(var s=0;s<e.P.length;s++){var a=e.P[s];if(0!=e.R.length)for(var o=0;o<e.R.length;o++){var c=e.R[o],l=n.intersectDates(a,c);if(l.intersection||(r[t][a.id]=a),l.remainderFrom1.length>0)for(var u=0;u<l.remainderFrom1.length;u++){var d=angular.copy(a);d.start=l.remainderFrom1[u].start,d.finish=l.remainderFrom1[u].finish,r[t][a.id+"_"+u]=d}if(!r[t][c.id]){var v=angular.copy(c);v.serviceTerritory=a.serviceTerritory,r[t][v.id]=v}}else r[t][a.id]=a}var p={};p[t]={};for(var h=0;h<e.S.length;h++){var g=e.S[h];for(var m in r[t]){var f=r[t][m],S=n.intersectDates(f,g);if(S.intersection){var b=angular.copy(f);b.start=S.intersection.start,b.finish=S.intersection.finish,window.isShowSecondaryOperatingHours&&g.operatingHours&&(b.operatingHours=g.operatingHours),b.ohTerr=b.serviceTerritory,b.serviceTerritory=g.serviceTerritory,p[t][m+"_"+h]=b}}}return p}function c(t,i,r,s,a){for(var o in s){for(var c=s[o].slice(),l=n.generateResourceId(r,o),u=t,v=0;v<c.length;v++){var p=c[v],h=n.intersectDates({start:u,finish:i},p);if(h.intersection){for(var m=0;m<h.remainderFrom1.length;m++){var f=h.remainderFrom1[m];f.isStart&&g(f.start,f.finish,l)}u=h.intersection.finish;var S=void 0;try{S=p.operatingHours?p.operatingHours:e.allTerritories[p.ohTerr]?e.allTerritories[p.ohTerr].operatingHours:p.serviceTerritory__r?p.serviceTerritory__r.OperatingHoursId:void 0}catch(b){S=null}if(S){var y=void 0;e.getOperatingHours()[S]||(y=p.serviceTerritory__r.OperatingHours),d(h.intersection.start,h.intersection.finish,S,l,a,y)}else g(h.intersection.start,h.intersection.finish,l)}}u.getTime()!=i.getTime()&&g(u,i,l)}}function l(e,t){return n.convertDtToMomentDt(e,t)}function u(e){return n.convertMomentDtToDt(e)}function d(e,t,i,n,r){d(e,t,i,n,r,null)}function d(t,i,r,s,a,o){var c=e.getOperatingHours()[r]||o,d=c.timezone,h=useLocationTimezone?d:userTimeZone;if(a&&useLocationTimezone)for(var m=s.split(","),f=0;f<m.length;f++){var S=m[f].split("_")[1],b=e.territories[S].operatingHours;h=e.getOperatingHours()[b].timezone}for(var y=l(t,h),_=l(i,h),T=(y.clone().tz(d),_.clone().tz(d),u(y)),w=u(_),L=T,C=[y.clone().add(-1,"days"),y.clone(),y.clone().add(1,"days")],k=0;k<C.length;k++)for(var D=C[k],A=c.slots[D.get("day")]||[],R=0;R<A.length;R++){var I=A[R],F=v(D,I,"startHour","startMinute",d,h,a),x=v(D,I,"endHour","endMinute",d,h,a),M=n.intersectDates({start:F,finish:x},{start:T,finish:w}).intersection;M&&(F=M.start,x=M.finish,"Extended"==I.type?(g(L,F,s,null),g(F,x,s,I.type)):g(L,F,s,I.type),p(F,x,I.type,s),L=x)}g(L,w,s,null)}function v(e,t,i,n,r,s,a){var o=u(e);o.setHours(t[i]),o.setMinutes(t[n]);var c=useLocationTimezone?r:userTimeZone;a&&useLocationTimezone&&(c=s);var d=l(o,r),v=u(d.tz(c));return v}function p(e,t,i,r){var s=(t.getTime()-e.getTime())/6e4,a=b[r];a||(a={},b[r]=a);var o=n.formatDayToString(e),c=a[o];c||(c={regular:0,overtime:0},a[o]=c),"Extended"==i?c.overtime+=s:c.regular+=s}function h(t,i,r){var s=[];if(showSecondarySTMs)for(var a in i)for(var o=0;o<i[a].length;o++)"S"!=i[a][o].type&&-1==s.indexOf(a)&&s.push(a);else s=Object.keys(i);s.splice(s.indexOf(t.serviceTerritory),1);var c=t.serviceTerritory;if(e.territories[c])var d=e.territories[c].operatingHours,v=e.getOperatingHours()[d].timezone;for(var p=0;p<s.length;p++){var h=[n.generateResourceId(r,s[p])];S[t.id]=!0;var g=t.start,m=t.finish;if(useLocationTimezone&&e.territories[s[p]]){var f=e.territories[s[p]].operatingHours,b=e.getOperatingHours()[f].timezone;g=u(l(g,v).tz(b)),m=u(l(m,v).tz(b))}var y=e.territories[t.serviceTerritory]?e.territories[t.serviceTerritory].name:null,T=null,w=null;y?(T=customLabels.Relocated_to.replace("$0",_.escape(y)),w=_.escape(customLabels.Relocated_to_many_params.replaceAll(y||customLabels.Relocated_No_Permissions,moment(g).format("llll"),moment(m).format("llll")))):(T=customLabels.Relocated_No_Permissions,w=_.escape(customLabels.Relocated_to_no_permissions_many_params.replaceAll(moment(g).format("llll"),moment(m).format("llll"))));var L="relocation",C="relocation_monthly";scheduler.addMarkedTimespan({start_date:g,end_date:m,sections:{ZoomLevel2:h,ZoomLevel3:h,ZoomLevel4:h,ZoomLevel5:h,ZoomLevel6:h},html:"<div class='relocatedLabel' title='"+w+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.relocation+"'></use></svg> "+T+"</div>",css:L}),scheduler.addMarkedTimespan({start_date:g,end_date:m,sections:{MonthlyView:h,MTDView:h},html:"<div class='relocatedLabel' title='"+w+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.relocation+"'></use></svg></div>",css:C})}}function g(e,t,i,n){if(e.getTime()!=t.getTime()){var r={};for(var s in scheduler.matrix)"MonthlyView"!==s&&(r[s]=i.indexOf(",")>-1?i.split(","):[i]);var a="gray_section";"Extended"==n&&(a="overtime_section"),scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:r,css:a})}}function m(e){var i={},r=e||t.resourcesByPrimariesAndRelocations();for(var s in r){var a=r[s],o={};i[s]=o;for(var c in a){var l=a[c],u=o[l.serviceTerritory];u||(u=[],o[l.serviceTerritory]=u),u.push({start:l.effectiveStartDate||l.start,finish:l.effectiveEndDate||l.finish,serviceTerritory:l.serviceTerritory,operatingHours:l.operatingHours,type:l.serviceTerritoryType||l.type,id:l.id,ohTerr:l.ohTerr||null,serviceTerritory__r:l.serviceTerritory__r||null})}for(var d in o){var v=o[d];v.sort(n.sortByTime)}}return i}var f={},S={},b={};i.$on("gotNewTimePhasedObjects",function(e,t){s(t.start,t.finish,t.resourceToServiceCrewMembers)});var y={resourceToWorkingDates:b,relocationsOnGantt:S,reset:r};return y}])}(),function(){function e(e,t,i,n,r,s,a,o,c,l,u){function d(n){_=e.$new(!0),_.lightboxCapacity=i.resourceCapacities()[n],_.fieldsTypes=s.fieldsTypes,_.selectedTab="details",_.kpiStart=_.lightboxCapacity.start_date,_.kpiEnd=_.lightboxCapacity.end_date,_.servicesScheduledToCapacity={},_.tableSort={orderByField:"",reverse:!1},_.flaggedServices=t.flagged,_.invokedActionFor={},_.SERVICE_CATEGORY=c,_.currentMenu=null,_.closeLightbox=v,_.openConsoleTab=s.openConsoleTab,_.formatKpitText=h,_.getObjectKeys=g,_.flagService=m,_.unscheduleServices=S,_.postToChatter=f,_.getStatusClass=s.getCSSClassForContext,_.violationsTooltip=b,u.fieldsSetFields().then(function(e){_.servicesListFields=e.CapacityServiceColumns,_.tableSort.orderByField=_.servicesListFields[0].FullAPIName}),_.order=function(e,t){_.tableSort.orderByField=e,_.tableSort.reverse=t},_.getRefFieldID=function(e,t){var i=t.FullAPIName.replace("__r","__c");return e[i]},_.setCurrentMenu=function(e){_.currentMenu==e?_.currentMenu=null:_.currentMenu=e},p(n);var o=y();o.find("#ContractorCapacityLightbox").draggable({handle:"#ContractorCapacityLightboxHeader"}),angular.element("body").append(o),a.setLightBoxStatus(),_.$on("$destroy",function(){return o.remove()}),_.$on("keypress",function(e,t){27==t.which&&_.$evalAsync(_.closeLightbox)}),r(o)(_),s.safeApply(_)}function v(){a.setLightBoxStatus(!1),_.$destroy()}function p(e){_.capacityKpi={hoursCapacity:0,hoursInUse:0,completed:0,jeopardy:0,workItemsCapacity:0,workItemsAllocated:0};var t=scheduler.getEvent(e),i=scheduler.getEvents(t.start_date,t.end_date);_.servicesScheduledToCapacity={},_.capacityKpi.hoursCapacity=t.hoursPerTimePeriod?t.hoursPerTimePeriod:0,_.capacityKpi.hoursInUse=t.hoursInUse?t.hoursInUse:0,_.capacityKpi.completed=0,_.capacityKpi.jeopardy=0,_.capacityKpi.violations=0,_.capacityKpi.workItemsCapacity=t.workItemsPerTimePeriod?t.workItemsPerTimePeriod:0,_.capacityKpi.workItemsAllocated=t.workItemsAllocated?t.workItemsAllocated:0,_.capacityKpi.total=0;for(var n=0;n<i.length;n++)i[n].resourceId==t.resourceId&&"service"==i[n].type&&i[n].start.getTime()>=t.start_date.getTime()&&i[n].start.getTime()<=t.end_date.getTime()&&(_.capacityKpi.total++,i[n].statusCategory==c.COMPLETED&&_.capacityKpi.completed++,i[n].jeopardy&&_.capacityKpi.jeopardy++,i[n].violations&&_.capacityKpi.violations++,_.servicesScheduledToCapacity[i[n].id]=i[n])}function h(){return customLabels.KPIsAreCalculatedFromTo.replaceAll(moment(_.kpiStart).format("llll"),moment(_.kpiEnd).format("llll"))}function g(e){return Object.keys(e).length>0?Object.keys(e):0}function m(e){return t.flagged[e]?void(t.flagged[e]&&(t.flagged[e]=!t.flagged[e])):void(t.flagged[e]=!0)}function f(e,i){return""===i&&(i=prompt(customLabels.msg_to_post_to_chatter,"")),""===i?void alert(customLabels.no_empty_msg_to_chatter):(t.recentlyUsed[e]=!0,void t.postToChatter([e],i).then(function(e){}))}function S(e){if(!confirm(customLabels.are_you_sure_unschedule))return!0;var n=[],r=[];e.forEach(function(e){_.invokedActionFor[e]=!0,r.push(i.serviceAppointments()[e]),n.push(i.serviceAppointments()[e].resource),t.recentlyUsed[e]=!0}),t.unscheduleServices(e).then(function(i){t.drawServicesAndAbsences(i.services,i.absences,[],i.capacities),p(_.lightboxCapacity.id),_.invokedActionFor[e[0]]=!1})["catch"](function(t){s.addNotification(customLabels.Action_Could_Not_Be_Performed,t.message||customLabels.user_is_not_allowed_to_perform_action),_.invokedActionFor[e[0]]=!1})}function b(e){if(e.violations){for(var t="",i=0;i<e.violations.length;i++)t+=e.violations[i].RuleName+" - "+e.violations[i].ViolationString+"\n";return t&&(t=t.substring(0,t.length-1)),t}}function y(){return angular.element('<div class="LightboxBlackContainer">\n				<div class="LightboxContainer" id="ContractorCapacityLightbox">\n\n					<div class="lightboxHeaderContainer" id="ContractorCapacityLightboxHeader">\n\n						<svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n							\u2028<use xlink:href="'+lsdIcons.close+'"></use>\n						</svg>\n\n						<h1 class="lightboxHeader">\n							<i>'+customLabels.Capacity+':</i>\n							{{ lightboxCapacity.name }}\n						</h1>\n\n						<span class="lightboxSelectedTab">\n							'+customLabels.Details+'\n						</span>\n\n						<div class="ExtendedForm">\n							<a ng-click="openConsoleTab($event,lightboxCapacity.id)" target="_blank" href="../{{ lightboxCapacity.id }}" title="'+customLabels.ExtandedForm+'">\n								<svg aria-hidden="true" class="slds-icon openExternalIcon">\n									\u2028<use xlink:href="'+lsdIcons.external+'"></use>\n								\u2028</svg>\n							</a>\n						</div>\n					</div>\n\n					<div id="KPIforCapacity" class="KPIforCapacity">\n						<div class="kpiIndicator" ng-show="capacityKpi.hoursCapacity > 0">\n							<div class="kpiResourceValue">\n								<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n									\u2028<use xlink:href="'+lsdIcons.clock+'"></use>\n								\u2028</svg>\n								{{ capacityKpi.hoursInUse }}/{{ capacityKpi.hoursCapacity }}</div>\n							'+customLabels.Hours_Capacity+'\n						</div>\n\n						<div class="kpiIndicator" ng-show="capacityKpi.workItemsCapacity > 0">\n							<div class="kpiResourceValue">\n								<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n									\u2028<use xlink:href="'+lsdIcons.standard_objects+'"></use>\n								\u2028</svg>\n								{{ capacityKpi.workItemsAllocated }}/{{ capacityKpi.workItemsCapacity }}</div>\n							'+customLabels.Services_Capacity+'\n						</div>\n\n						<div class="kpiIndicator">\n							<div class="kpiResourceValue">\n								<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n									\u2028<use xlink:href="'+lsdIcons.violation+'"></use>\n								\u2028</svg>\n								<!--<i class="fa fa-warning"></i>-->\n								{{ capacityKpi.violations }}</div>\n							'+customLabels.Violations+'\n						</div>\n\n						<div class="kpiIndicator">\n							<div class="kpiResourceValue">\n								<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n									\u2028<use xlink:href="'+lsdIcons.jeopardy+'"></use>\n								\u2028</svg>\n								{{ capacityKpi.jeopardy }}</div>\n							'+customLabels.In_Jeopardy+'\n						</div>\n\n						<div class="kpiIndicator">\n							<div class="kpiResourceValue">\n								<svg aria-hidden="true" class="slds-icon kpiResourceIcon">\n									\u2028<use xlink:href="'+lsdIcons.completed+'"></use>\n								\u2028</svg>\n\n								{{ capacityKpi.completed }}/{{ capacityKpi.total }}</div>\n							'+customLabels.Completed+'\n						</div>\n\n						<div class="KpiRange">{{formatKpitText()}}</div>\n					</div>\n                    <div id="ContractorCapacityButtons">\n                            <span class="capacityServiceUnscheduleAll" ng-show="getObjectKeys(servicesScheduledToCapacity).length > 0" ng-click="unscheduleServices(getObjectKeys(servicesScheduledToCapacity))">\n                                <i class="fa fa-ban"></i>\n                                 '+customLabels.Unschedule_All+'\n                            </span>\n                        </div>\n					<div id="ContractorCapacityLightboxContent">\n					\n                            <div class="NoServicesFound" ng-show="!getObjectKeys(servicesScheduledToCapacity)">\n                                <i class="fa fa-times"></i>\n                                <div>'+customLabels.No_services+'</div>\n                            </div>\n                        \n                        <table id="CapacityServicesTable" ng-show="getObjectKeys(servicesScheduledToCapacity).length > 0">\n                          <thead>\n                            <tr class="table-header">\n                                <th></th>\n                                <th></th>\n                                <th></th>\n                                <th ng-attr-title="{{field.Label}}" ng-repeat="field in servicesListFields" ng-class="{sortCapacityServicesBy: tableSort.orderByField == field.FullAPIName}" class="truncate capacityServiceColName" ng-click="tableSort.reverse=!tableSort.reverse;order(field.FullAPIName, tableSort.reverse)">\n                                    <span class="">{{field.Label}}</span>\n                                    <span ng-show="tableSort.orderByField == field.FullAPIName">\n                                        <span>\n                                            <svg ng-show ="!tableSort.reverse" aria-hidden="true" class="slds-icon arrowIcon">\n                                              <use xlink:href="'+lsdIcons.arrowup+'"></use>\n                                            </svg>\n                                            <svg ng-show ="tableSort.reverse" aria-hidden="true" class="slds-icon arrowIcon">\n                                              <use xlink:href="'+lsdIcons.arrowdown+'"></use>\n                                            </svg>\n                                        </span>\n                                    </span>\n                                </th>\n                            </tr>\n                          </thead>\n                          <tbody>\n                            <tr ng-repeat="(key, capacityService) in servicesScheduledToCapacity | orderObjectBy:tableSort.orderByField:tableSort.reverse" class="capacityServiceRow">\n                                <td style="background:{{capacityService.ganttColor}}" class="TaskStatusColor {{ getStatusClass(capacityService.statusCategory, SERVICE_CATEGORY) }}" ></td>\n                                <td class="moreOptions">\n                                    <div class="serviceCapacityActionsButton" title="Actions" ng-click="setCurrentMenu($index)">\n                                          <svg class="slds-icon carretDownIcon" aria-hidden="true" ng-show="!invokedActionFor[capacityService.id]">\n                                                <use xlink:href="'+lsdIcons.down+'"></use>\n                                          </svg>\n                                          <img class="capacityServiceLoading"\n                                             src="'+lsdIcons.spinnerGif+'"\n                                             ng-show="invokedActionFor[capacityService.id]"/>\n                                    </div>   \n                                    <div id="actions-menu-{{$index}}" class="serviceCapacityActions" ng-show="currentMenu == $index">\n                                        <a class="saSingleAction" ng-click="openConsoleTab($event,capacityService.id); setCurrentMenu($index);" target="_blank" href="../{{ capacityService.id }}">'+customLabels.Details+'</a>\n                                        <div class="saSingleAction" ng-click="flagService(capacityService.id); setCurrentMenu($index);">\n                                            <span ng-show="!flaggedServices[capacityService.id]">'+customLabels.Flag+'</span>\n                                            <span ng-show="flaggedServices[capacityService.id]">'+customLabels.Unflag+'</span>\n                                        </div>\n                                        <div class="saSingleAction" ng-click="unscheduleServices([capacityService.id]); setCurrentMenu($index);">'+customLabels.Unschedule+'</div>\n                                        <div class="saSingleAction" ng-click="postToChatter(capacityService.id, \'\'); setCurrentMenu($index);">'+customLabels.Chatter+'</div>\n                                    </div>\n                                </td>\n                                <td class="iconOnServiceRow"\n                                        title="{{ violationsTooltip(capacityService) }}"\n                                        ng-class="{\'serviceList_jeopardy\': capacityService.jeopardy, \'serviceList_violations\': !capacityService.jeopardy && capacityService.violations}">\n                                        <i class="fa fa-bell" ng-if="capacityService.jeopardy"></i>\n                                        <i class="fa fa-warning" ng-if="capacityService.violations && !capacityService.jeopardy"></i>\n                                </td>\n                                <td ng-attr-title="{{capacityService | displayFieldSetField : field}}" ng-repeat="field in servicesListFields" class="truncate">\n                                    <span ng-show="field.Type != fieldsTypes.Reference" title="{{capacityService | displayFieldSetField : field}}">{{capacityService | displayFieldSetField : field}}</span>\n                                    <a ng-show="field.Type == fieldsTypes.Reference" ng-click="openConsoleTab($event, getRefFieldID(capacityService, field))" target="_blank" href="../{{ getRefFieldID(capacityService, field) }}" title="{{capacityService | displayFieldSetField : field}}">\n                                        {{capacityService | displayFieldSetField : field}}\n                                    </a>\n\n                                </td>\n                            </tr>\n                          </tbody>\n                        </table>\n\n\n					</div>\n				</div>\n			</div>');
}var _=null;return{open:d}}e.$inject=["$rootScope","servicesService","TimePhasedDataService","$sce","$compile","utils","StateService","SERVICE_STATUS","SERVICE_CATEGORY","DeltaService","FieldSetFieldsService"],angular.module("serviceExpert").factory("CapacityLightboxService",e)}(),function(){function e(e,t,i,n,r,s,a){function o(){r.getStreamingActiveState()===!1&&e.getDelta(v).then(d)["catch"](function(e){console.warn(e)})}function c(e){h.optimizationRequests.forEach(function(t){return t([e])})}function l(e,t){return h[e]&&h[e].push(t)}function u(e,t){h[e].splice(h[e].indexOf(t),1)}function d(e){v=e.updateTime;var t=[];if(e.deletedAbsence&&e.deletedAbsence.length>0||e.updatedAbsence&&e.updatedAbsence.length>0){var a={};if(e.deletedAbsence.length>0&&(a.deleted=i.deleteTimePhaseData(e.deletedAbsence,"na").absences,t.push.apply(t,_toConsumableArray(s.getRelatedServices(a.deleted)))),e.updatedAbsence.length>0){a.updated=i.updateTimePhaseData(e.updatedAbsence,"na").absences;var o=a.updated.map(function(e){return e.resource}).join(",");t.push.apply(t,_toConsumableArray(s.getRelatedServices(s.getIdsOfSObjects(a.updated),o)))}(a.updated||a.deleted)&&h.absences.forEach(function(e){return e(a)})}if(e.updatedGanttServices&&e.updatedGanttServices.length>0||e.deletedGanttServices&&e.deletedGanttServices.length>0){var c={};e.deletedGanttServices.length>0&&(c.deleted=i.deleteTimePhaseData(e.deletedGanttServices,"service").services,t.push.apply(t,_toConsumableArray(s.getRelatedServices(c.deleted)))),e.updatedGanttServices.length>0&&(c.updated=i.updateTimePhaseData(e.updatedGanttServices,"service").services,t.push.apply(t,_toConsumableArray(s.getRelatedServices(s.getIdsOfSObjects(c.updated))))),(c.updated||c.deleted)&&h.services.forEach(function(e){return e(c)})}if(e.updatedLivePositions){var l=n.updatePositions(e.updatedLivePositions);l.isUpdated&&h.positions.forEach(function(e){return e(l.dic)})}if(t.length>0&&h.rules.forEach(function(e){return e(t)}),r.areContractorsSupported&&(e.deletedCapacities&&e.deletedCapacities.length>0||e.updatedCapacities&&e.updatedCapacities.length>0)){var u={};e.deletedCapacities.length>0&&(u.deleted=i.deleteTimePhaseData(e.deletedCapacities,"capacity").capacities),e.updatedCapacities.length>0&&(u.updated=i.updateTimePhaseData(e.updatedCapacities,"capacity").capacities),(u.updated||u.deleted)&&h.capacities.forEach(function(e){return e(u)})}r.isOptimizationEnabled&&e.optimizationRequests&&e.optimizationRequests.length>0&&h.optimizationRequests.forEach(function(t){return t(e.optimizationRequests)})}var v=null,p=deltaInterval||10,h={services:[],absences:[],capacities:[],positions:[],optimizationRequests:[],rules:[]};return t(o,1e3*p),{register:l,unRegister:u,getDelta:o,updateOptimizationRequest:c,handleDeltaResponse:d}}e.$inject=["sfdcService","$interval","TimePhasedDataService","LastKnownPositionService","StateService","utils","MstResolver"],angular.module("serviceExpert").factory("DeltaService",e)}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){function e(e,t){var i=e.defer(),n={};return e.all([t.getServiceListFields(),t.getServiceMiniFormFields(),t.getServiceMapInfoWindowFields(),t.getGanttToolTipFields(),t.getServiceCapacityColumns(),t.getGanttFilterFields()]).then(function(e){if(n={ListColumns:e[0],ListExpanded:e[1],MapInfo:e[2],GanttToolTip:e[3],CapacityServiceColumns:e[4],ganttFilter:e[5]},"object"!==_typeof(GanttService.prototype.allFieldSets)){GanttService.prototype.allFieldSets=n;var t={};for(var r in GanttService.prototype.allFieldSets)for(var s=GanttService.prototype.allFieldSets[r],a=0;a<s.length;a++)t[s[a].APIName]=s[a];GanttService.prototype.allFieldSetsSet=t}i.resolve(n)})["catch"](function(e){i.reject(),console.warn("FieldSetFieldsService: unable to get service appointment field sets")}),{fieldsSetFields:function(){return i.promise}}}e.$inject=["$q","sfdcService"],angular.module("serviceExpert").factory("FieldSetFieldsService",e)}(),function(){function e(e,t){function i(e,t){if(!e){e="";for(var i in t)e+=i+" AND ";return n(e.substr(0,e.length-5))}return n(e)}function n(e){for(var t=e,i=1;10>=i;i++)if(1===i&&e.indexOf("1")>-1){var n=t.indexOf(1),r=t.indexOf(10);-1!==n&&n===r&&(n=t.lastIndexOf(1)),t=t.substr(0,n)+"{1} "+t.substr(n+2)}else-1!==t.indexOf(i)&&(t=t.replace(i,"{"+i+"}"));return t}function r(e){var t=null;return v.forEach(function(i){t=i.Id===e?i:t}),t}function s(i){var n=e.defer();return t.getFilterById(i).then(function(e){for(var t=c(e),i=!0,r=0;r<v.length;r++)if(v[r].Id===t.Id){v[r]=t,i=!1;break}i&&v.push(t),n.resolve(t)}),n.promise}function a(i){var n=e.defer();return t.deleteFilter(i).then(function(e){for(var t=-1,r=0;r<v.length;r++)if(v[r].Id===i){t=r;break}-1!==t&&v.splice(t,1),n.resolve(i)}),n.promise}function o(i){var n=e.defer();return t.hideFilter(i).then(function(e){for(var t=-1,r=0;r<v.length;r++)if(v[r].Id===i){t=r;break}-1!==t&&v.splice(t,1),n.resolve(i)}),n.promise}function c(e){return{Id:e.Id,Name:e[fieldNames.GanttFilter.Name],Description:e[fieldNames.GanttFilter.Description],Days_after_horizon:e[fieldNames.GanttFilter.Days_after_horizon],Days_before_horizon:e[fieldNames.GanttFilter.Days_before_horizon],Criterias:JSON.parse(e[fieldNames.GanttFilter.Criterias]),List_only_appointments_on_the_gantt:e[fieldNames.GanttFilter.List_only_appointments_on_the_gantt],Logic:i(e[fieldNames.GanttFilter.Logic],JSON.parse(e[fieldNames.GanttFilter.Criterias])),Public:e[fieldNames.GanttFilter.Public],Hidden:e[fieldNames.GanttFilter.Hidden],CreatedById:e.CreatedById,Displayed_Fields:e[fieldNames.GanttFilter.Displayed_Fields]?JSON.parse(e[fieldNames.GanttFilter.Displayed_Fields]):null}}function l(e){p=Object.assign(e,{})}function u(){return p}var d=e.defer(),v=[],p={};return useNewFilters&&t.getGanttFilters().then(function(e){var t=[];e.forEach(function(e){t.push(c(e))}),v=t,d.resolve(t)}),{filtersPromise:d.promise,getFilterById:r,getFilterFromSalesforce:s,deleteFilter:a,hideFilter:o,setFilterMap:l,getFilterMap:u}}e.$inject=["$q","sfdcService"],angular.module("serviceExpert").factory("GanttFilterService",e)}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){function e(e,t,i,n,r,s){function a(){var i=e.defer();return void 0!==D?setTimeout(function(){i.resolve(D)},0):t.getServiceFieldsMap().then(function(e){D={};for(var t in e)D[t]=JSON.parse(e[t].replace(/&quot;/g,'"'));i.resolve(D)})["catch"](function(e){i.reject(e)}),i.promise}function o(){var n=e.defer();return t.getGanttPalettes().then(function(e){for(var t={},r=0;r<e.length;r++){var s={};if(s.Id=e[r].Id,s.Name=e[r][fieldNames.GanttServicePalette.Name],s.ServiceProperty=e[r][fieldNames.GanttServicePalette.ServiceProperty],s.ServicePropertyNoNamespace=i.removeFSLNamespace(s.ServiceProperty),void 0!==e[r][fieldNames.GanttServicePalette.ColorScheme])try{s.ColorScheme=JSON.parse(e[r][fieldNames.GanttServicePalette.ColorScheme])}catch(a){s.ColorScheme=void 0}else s.ColorScheme=void 0;s.Description=e[r][fieldNames.GanttServicePalette.Description],s.ColorLevel=e[r][fieldNames.GanttServicePalette.ColorLevel],s.Active=e[r][fieldNames.GanttServicePalette.Active],t[s.Id]=s}n.resolve(t)})["catch"](function(e){n.reject(e)}),n.promise}function c(e){if(void 0!==A){var t=D[A.ServiceProperty];switch(t.Type){case FieldTypes.BOOLEAN:d(e);break;case FieldTypes.PICKLIST:v(e);break;case FieldTypes.DATETIME:case FieldTypes.DATE:p(e);break;case FieldTypes.DOUBLE:case FieldTypes.INTEGER:case FieldTypes.PERCENT:h(e);break;case FieldTypes.LOCATION:g(e);break;case FieldTypes.ADDRESS:m(e);break;default:console.log("Other")}}}function l(t,i){var r=e.defer();if(void 0===A||A.Id!==t.Id){n.SetUserSettingsProperty("Gantt_Palette__c",t.Id),A=t;var s=D[A.ServiceProperty];switch(f(s.Type),s.Type){case FieldTypes.BOOLEAN:u(i,d);break;case FieldTypes.PICKLIST:u(i,v);break;case FieldTypes.DATETIME:case FieldTypes.DATE:u(i,p);break;case FieldTypes.DOUBLE:case FieldTypes.INTEGER:case FieldTypes.PERCENT:u(i,h);break;case FieldTypes.LOCATION:u(i,g);break;case FieldTypes.ADDRESS:u(i,m);break;default:console.log("Other")}r.resolve()}else r.resolve();return r.promise}function u(e,t){for(var i in e)t(e[i])}function d(e){e.ganttPaletteColor&&e.ganttPaletteColor.palleteId===A.Id||(e.fields[A.ServicePropertyNoNamespace]===!0?e.ganttPaletteColor={color:A.ColorScheme.max.color,palleteId:A.Id}:e.ganttPaletteColor={color:A.ColorScheme.min.color,palleteId:A.Id})}function v(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==A.Id){var t,i=e.fields[A.ServicePropertyNoNamespace];t=void 0===i?A.ColorScheme.empty:A.ColorScheme.picklist[A.ServiceProperty][i],e.ganttPaletteColor={color:t,palleteId:A.Id}}}function p(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==A.Id){var t=e.fields[A.ServicePropertyNoNamespace];if(useLocationTimezone){var i=void 0;if(e.resourceId){var n=s.getRelevantSTMToGanttService(e);n&&n.operatingHours?i=n.operatingHours:n.serviceTerritory&&(i=r.territories[n.serviceTerritory].operatingHours)}else e.ServiceTerritoryId&&(i=r.territories[e.ServiceTerritoryId].operatingHours);var a=r.getOperatingHours()[i],o=a?a.timezone:userTimeZone;t=k(new Date(t),o,userTimeZone).getTime()}var c=void 0,l=void 0,u=void 0,d=void 0,v=void 0;if(void 0===t)c=A.ColorScheme.empty;else{for(var p in R){if(R[p].start<t&&t<=R[p].end){c=p;break}(void 0===l||R[p].start<=l)&&(l=R[p].start,d=p),(void 0===u||R[p].end>u)&&(u=R[p].end,v=p)}void 0===c&&(c=t>u?v:d)}e.ganttPaletteColor={color:c,palleteId:A.Id}}}function h(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==A.Id){var t=e.fields[A.ServicePropertyNoNamespace],i=void 0,n=void 0,r=void 0,s=void 0,a=void 0;if(void 0===t)i=A.ColorScheme.empty;else{for(var o in R){if(R[o].start<t&&t<=R[o].end){i=o;break}(void 0===n||R[o].start<=n)&&(n=R[o].start,s=o),(void 0===r||R[o].end>r)&&(r=R[o].end,a=o)}void 0===i&&(i=t>r?a:s)}e.ganttPaletteColor={color:i,palleteId:A.Id}}}function g(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==A.Id){var t=e.fields[A.ServicePropertyNoNamespace],i=void 0,n=void 0,r=void 0,s=void 0,a=void 0;if(void 0===A.ColorScheme.geolocation.latitude||void 0===A.ColorScheme.geolocation.longitude)i=A.ColorScheme.empty;else{var o=w(A.ColorScheme.geolocation.latitude,A.ColorScheme.geolocation.longitude,t.latitude,t.longitude);for(var c in R){if(R[c].start<o&&o<=R[c].end){i=c;break}(void 0===n||R[c].start<=n)&&(n=R[c].start,s=c),(void 0===r||R[c].end>r)&&(r=R[c].end,a=c)}void 0===i&&(i=o>r?a:s)}e.ganttPaletteColor={color:i,palleteId:A.Id}}}function m(e){if(!e.ganttPaletteColor||e.ganttPaletteColor.palleteId!==A.Id){var t=(e.fields[A.ServicePropertyNoNamespace],void 0),i=void 0,n=void 0,r=void 0,s=void 0;if(void 0===A.ColorScheme.geolocation.latitude||void 0===A.ColorScheme.geolocation.longitude)t=A.ColorScheme.empty;else{var a=w(A.ColorScheme.geolocation.latitude,A.ColorScheme.geolocation.longitude,e.latitude,e.longitude);for(var o in R){if(R[o].start<a&&a<=R[o].end){t=o;break}(void 0===i||R[o].start<=i)&&(i=R[o].start,r=o),(void 0===n||R[o].end>n)&&(n=R[o].end,s=o)}void 0===t&&(t=a>n?s:r)}e.ganttPaletteColor={color:t,palleteId:A.Id}}}function f(e){var t,i,n=!1;if(R={},(FieldTypes.DATETIME===e||FieldTypes.DATE===e)&&(i=b(A.ColorScheme.min.value,A.ColorScheme.max.value,A.ColorScheme.min.type,A.ColorScheme.max.type,A.ColorLevel),n=!0),(FieldTypes.DOUBLE===e||FieldTypes.LOCATION===e||FieldTypes.ADDRESS===e)&&(i=_(A.ColorScheme.min.value,A.ColorScheme.max.value,A.ColorLevel),n=!0),(FieldTypes.INTEGER===e||FieldTypes.PERCENT===e)&&(i=T(A.ColorScheme.min.value,A.ColorScheme.max.value,A.ColorLevel),n=!0),n){t=S(A.ColorScheme.min.color,A.ColorScheme.max.color,A.ColorLevel);for(var r=0;r<t.length;r++)R[t[r]]=i[r]}}function S(e,t,i){for(var n=[],r=e.substr(1,2),s=e.substr(3,4).substr(0,2),a=e.substr(5,6),o=t.substr(1,2),c=t.substr(3,4).substr(0,2),l=t.substr(5,6),u=parseInt(r,16),d=parseInt(s,16),v=parseInt(a,16),p=parseInt(o,16),h=parseInt(c,16),g=parseInt(l,16),m=p-u,f=m/i,S=h-d,b=S/i,y=g-v,_=y/i,T=0;i>T;T++){var w=Math.round(Math.abs(u+f*T))%256,L=Math.round(Math.abs(d+b*T))%256,C=Math.round(Math.abs(v+_*T))%256,k=w.toString(16);1===k.length&&(k="0"+k);var D=L.toString(16);1===D.length&&(D="0"+D);var A=C.toString(16);1===A.length&&(A="0"+A);var R="#"+k+D+A;n.push(R)}return n}function b(e,t,n,r,s){for(var a=i.convertMomentDtToDt(moment().tz(userTimeZone)),o=y(n,e),c=y(r,t),l=a.getTime()+o,u=a.getTime()+c,d=(u-l)/s,v=[],p=0;s>p;p++){var h=l+p*d,g=l+(p+1)*d,m={start:h,end:g};v.push(m)}return v}function y(e,t){var i;switch(e){case"Seconds":i=1e3*t;break;case"Minutes":i=60*t*1e3;break;case"Hours":i=60*t*60*1e3;break;case"Days":i=24*t*60*60*1e3}return i}function _(e,t,i){e=parseFloat(e),t=parseFloat(t);for(var n=(t-e)/i,r=[],s=0;i>s;s++){var a=e+s*n,o=e+(s+1)*n,c={start:a,end:o};r.push(c)}return r}function T(e,t,i){e=parseInt(e),t=parseInt(t);var n=(t-e)/i;n=Math.round(n);for(var r=[],s=0;i>s;s++){var a=e+s*n,o=e+(s+1)*n,c={start:a,end:o};r.push(c)}return r}function w(e,t,i,n){var r=Math.PI*e/180,s=Math.PI*i/180,a=t-n,o=Math.PI*a/180,c=Math.sin(r)*Math.sin(s)+Math.cos(r)*Math.cos(s)*Math.cos(o);return c=Math.acos(c),c=180*c/Math.PI,c=60*c*1.1515,"km"===distanceUnit?1.609344*c:.8684*c}function L(){A=void 0,window.paletteViewActive=!1}function C(e){if(null==e)return!0;if(e.length>0)return!1;if(0===e.length)return!0;if("object"!==("undefined"==typeof e?"undefined":_typeof(e)))return!0;for(var t in e)if(hasOwnProperty.call(e,t))return!1;return!0}function k(e,t,n){return i.convertDateBetweenTimeZones(e,t,n)}var D=void 0,A=void 0,R=void 0;return{serviceFieldsMap:a,applyNewPaletteForGantt:l,getGanttPalettes:o,updateGanttServicePaletteColor:c,resetCurrentPalette:L,isEmpty:C}}e.$inject=["$q","sfdcService","utils","userSettingsManager","ResourcesAndTerritoriesService","TimePhasedDataService"],angular.module("serviceExpert").factory("GanttPalettesService",e)}(),function(){function e(e,t,i,n,r){function s(){return l.closeLightbox()}function a(s,a){if(!l){l=e.$new(!0),l.url=t.trustAsResourceUrl(a).toString(),l.title=s,l.closeLightbox=o;var u=c();u.find("#ResourceLightbox").draggable({handle:"#ResourceLightboxHeader"}),u.find("#ResourceLightbox").resizable({minHeight:560,minWidth:940,maxWidth:940,handles:"s"}),angular.element("body").append(u),r.setLightBoxStatus(),l.$on("$destroy",function(){return u.remove()}),l.$on("keypress",function(e,t){27==t.which&&l.$evalAsync(l.closeLightbox)}),i(u)(l),n.safeApply(l)}}function o(){l.killWatch&&l.killWatch(),r.setLightBoxStatus(!1),l.$destroy(),l=null}function c(){return angular.element('<div class="LightboxBlackContainer ng-cloack">\n                    <div class="LightboxContainer ng-cloak" id="ResourceLightbox">\n\n                        <div class="lightboxHeaderContainer lightbox-general" id="ResourceLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            \n                            <h1 class="lightboxHeader" id="resourceName" ng-bind="title"></h1>\n                        </div>\n                        \n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ url }}" class="resourceLightboxIframe"></iframe>\n                        \n                        <div id="lightbox-loading-cover">\n                            <img src="'+lsdIcons.spinnerGif+'" />\n                            '+customLabels.loading+"\n                        </div>\n\n                    </div>\n                </div>")}var l=null;return window.addEventListener("message",function(e){"closeLightbox"===e.data&&s()},!1),{open:a,closeLightboxFromOutside:s}}e.$inject=["$rootScope","$sce","$compile","utils","StateService"],angular.module("serviceExpert").factory("GeneralLightbox",e)}(),function(){function e(e,t,i,n,r,s,a,o,c,l,u,d,v,p){function h(t){W&&m(),W=e.$new(!0),K=null,W.StateService=a,W.gettingSlots=!0,W.closePanel=m,W.getResourceField=b,W.generateMstText=G,W.formatDateIntervalFinish=_,W.formatDateInterval=y,W.service=i.serviceAppointments()[t],W.generateResultText=w,W.allSlotsArray=null,W.slotsTimespansIds=[],W.trustHtml=s.trust,W.jumpToDate=I,W.GRADES=J,W.scheduleToSlot=H,W.replaceLabels=F,W.openLightbox=x,W.showOnGantt=M,W.formatDateHeader=T,W.notifyWhenDoneGettingSlots=C,W.shouldNotify=!1,W.scheduledActionInvoked=!1,W.groupSlotsBy="Resource",W.roundGrade=f,W.bestSlot=null,W.gotSlots=!0,W.exception=null,W.isMst=!1,W.mstPromise=null,W.schedulingTakesLong=!1,W.rawTimespans=[],W.partialResults=[],W.showPartialData=!1,W.generateAsyncLabel=E,W.formatTooltipHeader=O,W.formatAsapObjective=P,W.isAdmin=!1,void 0==window.userHasAdminPermissions?n.userHasAdminPermissions().then(function(e){e?window.userHasAdminPermissions=W.isAdmin=!0:window.userHasAdminPermissions=!1}):W.isAdmin=window.userHasAdminPermissions,W.generatePartialResult=function(e){return customLabels.partialResults[e.Operation].replaceAll(e.Processed,e.Total)},Z||L(t);var o=N();angular.element("#LeftSideContainer").prepend(o),W.$on("$destroy",function(){return o.remove()}),window.__closeLeftSideTerritories&&window.__closeLeftSideTerritories(),r(o)(W),s.safeApply(W)}function g(e){Z=!0,h(e.fslOperation.result.Service.Id),"exception"===e.eventType&&k(e),k({value:e.fslOperation.result},!0),Z=!1}function m(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!0;W&&(K=null,t&&e.$broadcast("GotSlotsEnded"),showCandidates.on=!1,showCandidates.id=null,S(),updateViewDebounced(),t&&W.$destroy())}function f(e){return Math.round(e)}function S(){for(var e=0;e<W.slotsTimespansIds.length;e++)scheduler.deleteMarkedTimespan(W.slotsTimespansIds[e])}function b(e,t){return e&&o.getResources()[e]?o.getResources()[e][t]:null}function y(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!1,i=60*new Date(e).getTimezoneOffset()*1e3,n=new Date(e+i);return t?moment(n).format("LT"):moment(n).format("llll")}function _(e,t){var i=60*new Date(e).getTimezoneOffset()*1e3,n=new Date(e+i),r=new Date(t+i);return r.getDate()!==n.getDate()?moment(n).format("llll"):moment(n).format("LT")}function T(e){var t=e.split("_"),i=new Date(t[2],t[1],t[0],0,0,0,0);return moment(i).format("LL")}function w(e){if(e){var t=0,i=0;return e.forEach(function(e){t++,i+=e.SchedulingOptions.length}),customLabels.getSlotsExpText.replaceAll("<b>"+t+"</b>","<b>"+i+"</b>","<b>"+W.service.name+"</b>","<b>"+y(W.bestSlot.Interval.Start)+"</b>","<b>"+W.bestSlot.Resource.m_resource.Name+"</b>","<b>"+Math.round(W.bestSlot.Grade)+"</b>")}}function L(e){console.time("getting slots"),n.getSlots(e,a.selectedPolicyId).then(function(e){return e.value.FSLOperationId?(console.log("get candidates with MST"),W.isMst=!0,t(function(){return W.schedulingTakesLong=!0},1e3*q),void(W.mstPromise=d.getUpdates(e.value.FSLOperationId).then(function(e){return console.log(e),console.log(e.fslOperation.result),console.timeEnd("getting slots"),W.shouldNotify||k({value:e.fslOperation.result},!0),e})["catch"](function(e){console.error(e);var t={message:e.message||e};return W.shouldNotify||k({eventType:"exception",event:t}),p.reject({eventType:"exception",event:t})}))):void k(e)})["catch"](function(e){console.warn("could not get candidates"),console.log(e),W.shouldNotify||k({eventType:"exception",event:event})})}function C(){W.shouldNotify=!0,W.mstPromise.then(function(e){s.addNotification(customLabels.MstFinishedGettingSlots.replace("$0",W.service.AppointmentNumber),customLabels.MstFinishedGettingSlotsMessage,function(){g(e)},null,!0)})["catch"](function(e){console.error(e),s.addNotification(customLabels.MstFinishedGettingSlots.replace("$0",W.service.AppointmentNumber),e,function(){})}),m(!0)}function k(e){if(W.gettingSlots=!1,"exception"===e.eventType)return W.gotSlots=!1,void(W.exception=e.event);if(W.partialResults=e.value.PartialResults||[],R(e.value),W.gotSlots){W.allSlotsArray=[],W.slotsByDateObject={},K={};for(var t in e.value.ResourceIDToScheduleData){var i=e.value.ResourceIDToScheduleData[t];W.allSlotsArray.push(i);for(var n=0;n<i.SchedulingOptions.length;n++){var r=new Date(i.SchedulingOptions[n].Interval.Start),s=60*new Date(i.SchedulingOptions[n].Interval.Start).getTimezoneOffset()*1e3;K[t]=!0,r.setMilliseconds(r.getMilliseconds()+s);var a=j(r);W.slotsByDateObject[a]=W.slotsByDateObject[a]||[],i.SchedulingOptions[n].Resource=e.value.ResourceIDToScheduleData[t].Resource,W.slotsByDateObject[a].push(i.SchedulingOptions[n])}}W.allSlotsArray.sort(function(e,t){return e.Resource.m_resource.Name>t.Resource.m_resource.Name?1:e.Resource.m_resource.Name<t.Resource.m_resource.Name?-1:0});for(var o=0;o<W.allSlotsArray.length;o++)W.allSlotsArray[o].highest=D(W.allSlotsArray[o].SchedulingOptions);for(var c in W.slotsByDateObject){var l=W.slotsByDateObject[c];l.sort(function(e,t){return e.Interval.Start>t.Interval.Start?1:e.Interval.Start<t.Interval.Start?-1:0}),l.highest=D(l),W.bestSlot?W.bestSlot.Grade<l.highest.Grade&&(W.bestSlot=l.highest):W.bestSlot=l.highest}setTimeout(function(){return angular.element("#slotsSentence").html(w(W.allSlotsArray))},100)}}function D(e){for(var t=0,i=e,n=i[0],r=0;r<i.length;r++)i[t].Grade<i[r].Grade&&(t=r,n=i[r]);return n}function A(e){var t=60*new Date(e.Start).getTimezoneOffset()*1e3,i=60*new Date(e.Finish).getTimezoneOffset()*1e3;return{startDate:new Date(e.Start+t),endDate:new Date(e.Finish+i)}}function R(t){var n="",r=null,o=!1;for(var c in t.ResourceIDToScheduleData)if(t.ResourceIDToScheduleData[c].SchedulingOptions)for(var l=t.ResourceIDToScheduleData[c].SchedulingOptions,u=0;u<l.length;u++){var d=A(l[u].Interval),v=i.getResoruceGanttIdByDate(c,d.startDate);if(showSecondarySTMs&&W.service.ServiceTerritoryId&&(v=i.getResoruceGanttIdByDateAndTerritory(c,d.startDate,W.service.ServiceTerritoryId)),v){0===u&&(n+=t.ResourceIDToScheduleData[c].Resource.m_resource.Name+", ",o=!0),(d.startDate<r||null===r)&&(r=new Date(d.startDate));for(var p in scheduler.matrix){var h={};h[p]=v.indexOf(",")>-1?v.split(","):[v];var g="";l[u].MSTOptions&&(g=(new Date).getTime()+Math.floor(1e5*Math.random()),window.mstOptions=window.mstOptions||{},window.mstOptions[g]=l[u].MSTOptions);var m=.11+parseInt(l[u].Grade)/100*.64,f="background-color: rgba(118, 226, 164,"+m+");",S=l[u].Grade<0?"":Math.round(l[u].Grade)+"/100",b=customLabels.CandidateGradeGantt.replaceAll(moment(d.startDate).format("dddd LT"),moment(d.endDate).format("dddd LT"),S),y={start_date:d.startDate,end_date:d.endDate,sections:h,html:"<div oncontextmenu='scheduleSlot(event, \""+W.service.id+'", "'+d.startDate.getTime()+'", "'+v+'", "'+a.selectedPolicyId+'", "'+g+"\")', title='"+b+"' style='"+f+"'><span class='slotText'>"+S+"</span></div>",css:"slotMark"};W.rawTimespans.push(y)}}}if(o){var _=s.setDatesByStartAndMode(r);_.start.setDate(_.start.getDate()-1),_.end.setDate(_.end.getDate()+1),i.getTimePhasedObjects(_.start,_.end).then(function(){for(var e=0;e<W.rawTimespans.length;e++)W.slotsTimespansIds.push(scheduler.addMarkedTimespan(W.rawTimespans[e]));updateViewDebounced()}),showCandidates.on=!0,showCandidates.id=W.service.id,s.ganttSettings&&s.ganttSettings.filterCandidates&&(W.service.resourceId&&-1===n.indexOf(W.service.resourceName)&&(n+=W.service.resourceName+", "),n=n.substr(0,n.length-2)),e.$broadcast("GotSlots",{resourceToFilter:n,minDateOfCandidate:r}),scheduler.setCurrentView(r)}else W.gotSlots=!1}function I(t){e.$broadcast("JumpToDate",new Date(t))}function F(e,t){var i;return(i=customLabels[e]).replaceAll.apply(i,_toConsumableArray(t))}function x(){c.open(W.service.id)}function M(){s.showOnGantt(W.service.id)}function O(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1,t=0;return W.allSlotsArray.forEach(function(e){return t+=e.SchedulingOptions.length}),customLabels.AB_Explanation_Header.replace("{0}",e).replace("{1}",t)}function P(e){var t=parseInt(e);return moment.tz(t,userTimeZone).format("llll")}function E(){return W.service.Use_Async_Logic?customLabels.ServiceUsingAsync:customLabels.MstTakingLongTime}function N(){var e='\n                <div id="GetSlotsPanel" xmlns="http://www.w3.org/1999/html">\n\n                    <div class="slots-panel-title">\n                        {{ replaceLabels(\'ShowingCandidatesTo\', [service.name] ) }}\n                        <div class="clear-slots" ng-click="closePanel()">'+customLabels.HideSlots+'</div>\n                    </div>\n\n\n                    <div ng-show="gettingSlots" class="getting-slots">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.FindingCandidates+'\n                        \n                        <div class="get-slots-mst" ng-show="isMst && schedulingTakesLong">\n                            {{ generateAsyncLabel() }}\n                            <div class="get-slots-mst-button" ng-click="notifyWhenDoneGettingSlots()">'+customLabels.MstNotifyMeWhenDone+'</div>\n                        </div>\n                    </div>\n                    \n                    \n                    <div ng-show="exception" class="get-slots-error">\n                        <svg aria-hidden="true" class="slds-icon">\n                          \u2028<use xlink:href=\''+lsdIcons.violation+"'></use>\n                        \u2028</svg>\n                        {{ exception.message }}\n                        \n                        <div>"+customLabels.ContactSysAdmin+'</div>\n                    </div>\n                    \n                    <div ng-show="!gotSlots && !exception" class="get-slots-error">\n                        <i class="fa fa-frown-o"></i>\n                        \n                        <div>'+customLabels.noCandidatesMessageGantt+'</div>\n                        \n                        <div id="AN-PartialResults" ng-show="partialResults.length > 0">\n                            <div>'+customLabels.particalCouldntProcessAll+' <u ng-show="isAdmin" ng-click="showPartialData = !showPartialData">'+customLabels.ShowDetails+'</u></div>\n\n                            <div ng-show="showPartialData">\n                                <ul>\n                                    <li ng-repeat="partial in partialResults">\n                                        {{ generatePartialResult(partial) }}\n                                    </li>\n\n                                </ul>\n                            </div>\n                        </div>\n                        \n                    </div>\n\n\n\n\n                    <div class="slots-results-recommendations" ng-if="allSlotsArray" ng-show="gotSlots">\n                        <span id="slotsSentence"></span>\n                        <div class="assign-to-recommended" ng-click="scheduleToSlot(bestSlot.Interval.Start, bestSlot.Resource.m_resource.Id, StateService.selectedPolicyId,bestSlot.Interval)">'+customLabels.AssignToRecommended+'</div>\n                    </div>\n\n\n\n                    <div class="slots-grouping" ng-show="allSlotsArray" ng-show="gotSlots">\n                        <span class="truncate groupSlotsBy" title="'+customLabels.GroupSlotsBy+'">'+customLabels.GroupSlotsBy+'</span>\n                        <input type="radio" id="groupByResource" name="groupBy" ng-model="groupSlotsBy" value="Resource" checked="checked">\n                        <label class="groupSlotsBy slots-groupByResource truncate" for="groupByResource" title="'+customLabels.Resource+'">'+customLabels.Resource+'</label>\n                        <input type="radio" id="groupByName" name="groupBy" ng-model="groupSlotsBy" value="Date">\n                        <label class="groupSlotsBy truncate slots-groupByName" for="groupByName" title="'+customLabels.Date+'">'+customLabels.Date+'</label>\n\n                        <div class="button-on-grouping" ng-show="service.isScheduled()" ng-click="showOnGantt()" title="'+customLabels.Show_on_gantt+'">\n                            <svg aria-hidden="true" class="slds-icon quickActionIcon">\n                                \u2028<use xlink:href="'+lsdIcons.table+'"></use>\n                            \u2028</svg>\n                        </div>\n\n                        <div class="button-on-grouping" ng-click="openLightbox()" title="'+customLabels.OpenDetailsWindow+'">\n                            <svg aria-hidden="true" class="slds-icon quickActionIcon">\n                                \u2028<use xlink:href="'+lsdIcons.info+'"></use>\n                            \u2028</svg>\n                        </div>\n                    </div>\n\n\n                    <div id="Slots-List-In-Panel" ng-show="gotSlots">\n                    \n                        <div id="AN-PartialResults" ng-show="partialResults.length > 0">\n                            <div>'+customLabels.particalCouldntProcessAll+' <u ng-show="isAdmin" ng-click="showPartialData = !showPartialData">'+customLabels.ShowDetails+'</u></div>\n\n                            <div ng-show="showPartialData">\n                                <ul>\n                                    <li ng-repeat="partial in partialResults">\n                                        {{ generatePartialResult(partial) }}\n                                    </li>\n\n                                </ul>\n                            </div>\n                        </div>\n                        \n                        \n                        \n                    \n                        <div ng-repeat="candidate in allSlotsArray" class="resource-slot-row" ng-init="candidate.showSlots = false" ng-show="groupSlotsBy == \'Resource\'">\n    \n                            <div ng-show="getResourceField(candidate.Resource.m_resource.Id, \'name\')" class="candidates-container-row" ng-click="candidate.showSlots = !candidate.showSlots">\n                                <div ng-show="getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\') == null && getResourceField(candidate.Resource.m_resource.Id, \'serviceCrew\') == undefined" class="ResourcePhotoIcon"></div>\n                                <div ng-show="getResourceField(candidate.Resource.m_resource.Id, \'serviceCrew\') != undefined && getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\') == null" class="ResourcePhotoIcon CrewPhotoIcon"></div>\n                                <img ng-show="getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\') != null" ng-src="{{getResourceField(candidate.Resource.m_resource.Id, \'pictureLink\')}}" class="ResourcePhotoIcon" />\n                                <h1>{{ getResourceField(candidate.Resource.m_resource.Id, \'name\') }}</h1>\n                                {{ replaceLabels(\'Xoptions\', [candidate.SchedulingOptions.length] ) }}\n                                \n                                <div ng-show="candidate.highest.Grade > -1" class="slot-grade slots-highest-grade" ng-class=\'{\n                                                "GS-grade-excellent": candidate.highest.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": candidate.highest.Grade >= GRADES.GOOD && candidate.highest.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": candidate.highest.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(candidate.highest.Grade)}}/100\n                                </div>\n                            </div>\n    \n                            <div ng-repeat="intervalItem in candidate.SchedulingOptions" class="time-interval" ng-init="intervalItem.showExplain[\'Resource\'] = false; intervalItem.showExplain[\'Date\'] = false;" ng-show="candidate.showSlots">\n                               \n                                <svg class="AN-InfoIcon slds-icon" aria-hidden="true" ng-show="intervalItem.Grades && intervalItem.Grades.length > 0" ng-click="intervalItem.showExplain[groupSlotsBy] = !intervalItem.showExplain[groupSlotsBy]; $event.stopPropagation();">\n                                    <use xlink:href="'+lsdIcons.info+'"></use>\n                                </svg>\n                               \n                                <span class="jump-to-date" title="Jump to date" ng-click="jumpToDate(intervalItem.Interval.Start)">{{ formatDateInterval(intervalItem.Interval.Start) }}</span>\n    \n                                <div class="slot-grade" ng-show="intervalItem.Grade > -1" ng-class=\'{\n                                                "GS-grade-excellent": intervalItem.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": intervalItem.Grade >= GRADES.GOOD && intervalItem.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": intervalItem.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(intervalItem.Grade)}}/100\n                                </div>\n    \n                                <div ng-click="scheduleToSlot(intervalItem.Interval.Start, candidate.Resource.m_resource.Id, StateService.selectedPolicyId, intervalItem)" class="schedule-to-slot">'+customLabels.Schedule+'</div>\n                                \n                                \n                                <div class="mst-interval-for-tapuhi truncate" ng-show="intervalItem.MSTOptions">\n                                    {{generateMstText(intervalItem.MSTOptions)}}\n                                </div>\n                                \n                                \n                                \n                                <div class="gs-explain-container" ng-show="intervalItem.showExplain[groupSlotsBy] && intervalItem.Grades && intervalItem.Grades.length > 0" >\n                                    <div class="AN-SlotSingleInfo" ng-repeat="info in intervalItem.Grades" ng-if="info.Text">\n                                        <div class="AN-ObjectGrade" ng-class="{\n                                            \'AN-ObjectGradeGood\': info.Grade >= GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeAverage\': info.Grade >= GRADES.GOOD && info.Grade < GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeBad\': info.Grade <= GRADES.GOOD,\n                                        }"></div>\n                                        <b>{{info.HeaderText}}</b><br/>\n                                        <span ng-if="info.ObjectiveRecordTypeName !== \'Objective_Asap\'">{{ info.Text }}</span>\n                                        <span ng-if="info.ObjectiveRecordTypeName === \'Objective_Asap\'">{{ formatAsapObjective(info.Text) }}</span>\n                                    </div>\n                                </div>\n                                \n                               \n                            </div>\n    \n                        </div>\n                        \n                       \n                       \n                        <div ng-repeat="(date,slots) in slotsByDateObject" class="resource-slot-row" ng-init="candidate.showSlots = false" ng-show="groupSlotsBy == \'Date\'">\n    \n                            <div class="candidates-container-row date-title-container" ng-click="slots.showDatesSlots = !slots.showDatesSlots">\n                                <h1>{{ formatDateHeader(date) }}</h1>\n                                {{ replaceLabels(\'Xoptions\', [slots.length] ) }}\n                                \n                                        <div class="slot-grade slots-highest-grade" ng-show="slots.highest.Grade > -1" ng-class=\'{\n                                                "GS-grade-excellent": slots.highest.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": slots.highest.Grade >= GRADES.GOOD && slots.highest.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": slots.highest.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(slots.highest.Grade)}}/100\n                                        </div>\n                            </div>\n    \n                            <div ng-repeat="intervalItem in slots" class="time-interval" ng-show="slots.showDatesSlots">\n                            \n                                <svg class="AN-InfoIcon slds-icon" aria-hidden="true" ng-show="intervalItem.Grades && intervalItem.Grades.length > 0" ng-click="intervalItem.showExplain[groupSlotsBy] = !intervalItem.showExplain[groupSlotsBy]; $event.stopPropagation();">\n                                    <use xlink:href="'+lsdIcons.info+'"></use>\n                                </svg>\n                            \n                                <span class="jump-to-date" title="Jump to date" ng-click="jumpToDate(intervalItem.Interval.Start)">{{ formatDateInterval(intervalItem.Interval.Start, true)}}</span>\n                                <span> ({{intervalItem.Resource.m_resource.Name}})</span>\n    \n                                <div class="slot-grade" ng-show="intervalItem.Grade > -1" ng-class=\'{\n                                                "GS-grade-excellent": intervalItem.Grade >= GRADES.EXCELLENT,\n                                                "GS-grade-good": intervalItem.Grade >= GRADES.GOOD && intervalItem.Grade < GRADES.EXCELLENT,\n                                                "GS-grade-ok": intervalItem.Grade < GRADES.GOOD}\'>\n    \n                                                {{roundGrade(intervalItem.Grade)}}/100\n                                </div>\n    \n                                <div ng-click="scheduleToSlot(intervalItem.Interval.Start, intervalItem.Resource.m_resource.Id, StateService.selectedPolicyId, intervalItem)" class="schedule-to-slot">'+customLabels.Schedule+'</div>\n                                \n                                <div class="mst-interval-for-tapuhi truncate" ng-show="intervalItem.MSTOptions">\n                                    {{generateMstText(intervalItem.MSTOptions)}}\n                                </div>\n                                \n                                \n                                \n                                <div class="gs-explain-container" ng-show="intervalItem.showExplain[groupSlotsBy] && intervalItem.Grades && intervalItem.Grades.length > 0" >\n                                    <div class="AN-SlotSingleInfo" ng-repeat="info in intervalItem.Grades" ng-if="info.Text">\n                                        <div class="AN-ObjectGrade" ng-class="{\n                                            \'AN-ObjectGradeGood\': info.Grade >= GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeAverage\': info.Grade >= GRADES.GOOD && info.Grade < GRADES.EXCELLENT,\n                                            \'AN-ObjectGradeBad\': info.Grade <= GRADES.GOOD,\n                                        }"></div>\n                                        <b>{{info.HeaderText}}</b><br/>\n                                        <span ng-if="info.ObjectiveRecordTypeName !== \'Objective_Asap\'">{{ info.Text }}</span>\n                                        <span ng-if="info.ObjectiveRecordTypeName === \'Objective_Asap\'">{{ formatAsapObjective(info.Text) }}</span>\n                                    </div>\n                                </div>\n                                \n                                \n                                \n                            </div>\n    \n                        </div>\n\n                </div>\n            ';
return angular.element(e)}function G(e){var t="";for(var n in e)t=customLabels.MstCandidatesGanttLine.replace("$0",i.serviceAppointments()[n].name).replace("$1",y(e[n].Interval.Start)).replace("$2",e[n].Resource.m_resource.Name);return t}function B(e,t,r){var s=e.Interval.Start,o=e.Interval.Finish,c=e.Resource.m_resource.Id,d=i.serviceAppointments()[t],p=60*new Date(s).getTimezoneOffset()*1e3,h=i.getResoruceGanttIdByDate(c,s);return s+=p,o+=p,d?(V(d,s,h,r),void l.saveChangesToServiceAppointment(d,d).then(function(e){u.calculateKpis()})):(s=new Date(s),o=new Date(o),n.saveChangesToServiceAppointment(t,c,null,s,o,a.selectedPolicyId,"AutomaticGetSlots"),void v.getDelta())}function H(t,n,r,a){if(!W.scheduledActionInvoked){if(W.scheduledActionInvoked=!0,a.MSTOptions&&Object.keys(a.MSTOptions).length>0)for(var o in a.MSTOptions)B(a.MSTOptions[o],o,r);var c=W.service,d=60*new Date(t).getTimezoneOffset()*1e3;t+=d,c.resourceBeforeDrag=c.resourceId,c.eventBeforeDrag=angular.copy(c);var v=i.getResoruceGanttIdByDate(n,t);V(c,t,v,r),scheduler._events[c.id]?(scheduler.updateEvent(c.id),scheduler.callEvent("onEventChanged",[c.id,scheduler.getEvent(c.id)]),setTimeout(function(){scheduler.callEvent("onDragEnd")},1200),m()):l.saveChangesToServiceAppointment(c,c).then(function(i){u.calculateKpis(),e.$broadcast("JumpToDate",new Date(parseInt(t)))})["catch"](function(e){console.warn("Couldn't update service. "+e[0]+" "+e[2]),s.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2])})["finally"](function(){e.$broadcast("JumpToDate",new Date(parseInt(t))),m()}),m()}}function V(e,t,i,n){var r=s.getServiceDuration(e);e.start=new Date(t),e.finish=new Date(t+r),e.start_date=new Date(t),e.end_date=new Date(t+r),e.travelTo=0,e.travelFrom=0,i&&(e.resourceId=i),e.policyUsed=n,e.scheduleMode="AutomaticGetSlots"}function U(e,t){for(var i in mstOptions[e])B(mstOptions[e][i],i,t)}function j(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}function z(){return K}var q=2,W=null,K=null,Z=!1,J={STAR:candidatesGrades.ideal,EXCELLENT:candidatesGrades.ideal,GOOD:candidatesGrades.reecommended};return window.scheduleSlot=function(t,i,n,r,a,o){t.preventDefault(),$("#ScheduleOnSlot").remove(),$('<div id="ScheduleOnSlot">'+customLabels.ScheduleHere+"</div>").css("left",t.clientX-30+"px").css("top",t.clientY+5+"px").on("click",function(){o&&U(o,a);var t=W.service;t&&(t.resourceBeforeDrag=t.resourceId,t.eventBeforeDrag=angular.copy(t),!t.start||t.start.getTime()===parseInt(n)&&t.resourceId===r?t.start||V(t,parseInt(n),r,a):V(t,parseInt(n),r,a),$("#ScheduleOnSlot").remove(),scheduler._events[t.id]?(scheduler.updateEvent(t.id),scheduler.callEvent("onEventChanged",[t.id,scheduler.getEvent(t.id)]),setTimeout(function(){scheduler.callEvent("onDragEnd")},1200),m()):l.saveChangesToServiceAppointment(t,t).then(function(t){u.calculateKpis(),e.$broadcast("JumpToDate",new Date(parseInt(n)))})["catch"](function(e){console.warn("Couldn't update service. "+e[0]+" "+e[2]),s.addNotification(customLabels.Action_Could_Not_Be_Performed,e[2])})["finally"](function(){e.$broadcast("JumpToDate",new Date(parseInt(n))),m()}))}).appendTo("body")},$("body").on("click",function(){$("#ScheduleOnSlot").remove()}),{get:h,close:m,getCandidatesIds:z}}e.$inject=["$rootScope","$timeout","TimePhasedDataService","sfdcService","$compile","utils","StateService","ResourcesAndTerritoriesService","ServiceAppointmentLightboxService","servicesService","kpiCalculationsService","MstResolver","DeltaService","$q"],angular.module("serviceExpert").factory("GetSlotsService",e)}(),function(){function e(e,t,i,n){function r(e){var t={},i=!1;for(var r in e){var s=new LastKnownPosition(e[r]),o=void 0;e[r].ServiceCrewMembers&&e[r].ServiceCrewMembers[0].IsLeader&&(o=n.getCrewToResources()[e[r].ServiceCrewMembers[0].ServiceCrewId]),(!a[s.id]||a[s.id].lastModifiedDate<s.lastModifiedDate)&&(t[r]=s,a[r]=s,i=!0,o&&(t[o.Id]=s,a[o.Id]=s))}return{dic:t,isUpdated:i}}function s(){return t.getLivePositions().then(function(e){for(var t in e)a[t]=new LastKnownPosition(e[t]);return a})}var a={};return{getLastKnownPositions:s,updatePositions:r,lastKnownPositions:function(){return a}}}e.$inject=["$q","sfdcService","utils","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("LastKnownPositionService",e)}(),function(){function e(e,t,i,n,r,s,a,o,c,l,u,d,v,p){function h(){y.showTree=n.GetUserSettingsProperty("ShowFavoriteTerritoriesTab__c")&&!0,y.favorites=n.GetUserSettingsProperty("FavoriteTerritories__c")?JSON.parse(n.GetUserSettingsProperty("FavoriteTerritories__c")):[],T.show()}function g(e,t){for(var i=null,n=0;n<e.length;n++){if(e[n].id===t)return e[n];if(i=g(e[n].items,t))return i}return i}function m(e,t){for(var i=0;i<e.items.length;i++)y.locationFilter[e.items[i].id]=t,m(e.items[i],t)}function f(){return angular.element('\n                        <div class="LightboxContainer LeftSiteLocationFiltering" id="LocationFilteringLightbox">\n\n                            <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.LocationFilteringParagraph+'</p>\n                                <p id="secondary-notice" ng-show="showSecondaryTimezoneNotice">'+customLabels.Stms_with_different_tz+'</p>\n                                \n                                \n                                <div class="territories-list-type-tabs">\n                                    <div ng-click="showTree = true; saveTabDebounced()" ng-class="{\'active-territory-tab\' : showTree}">'+customLabels.TerritoriesTree+'</div>\n                                    <div ng-click="showTree = false; saveTabDebounced()" ng-class="{\'active-territory-tab\' : !showTree}">'+customLabels.Favorites+'</div>\n                                </div>\n\n                                <div class="LocationsTreeContainer">\n                                \n                                    <div class="addBorderBottom">\n                                        <input type="checkbox" ng-model="showOrphanServices" id="servicesNoLocations" />\n                                        <label for="servicesNoLocations">'+customLabels.unassosiated_filtering+'</label><br/>\n                                    </div>\n\n                                    <input id="locationFilteringSearch" type="text" ng-model="locationSearchTerm.text" placeholder="'+customLabels.Search_location+'" />\n                                    <span class="selectAllLocations" ng-click="selectAllLocations(true)" title="'+customLabels.Select_all+'">'+customLabels.All+'</span>\n                                    <span class="selectAllLocations" ng-click="selectAllLocations(false)" title="'+customLabels.Select_none+'">'+customLabels.None+'</span>\n                                \n                                \n                  \n                                        \n                                    <div ng-show="showTree" id="LocationsTree">\n                                        <div ng-repeat="l in filteredLocations = (locationsFlat | filter:locationSearchTerm)" class="locationFilterRow" ng-style="{{ styleForLocationTree(l.depth) }}" ng-click="selectLocation(l.id)">\n                                            <input type="checkbox" ng-model="locationFilter[l.id]" id="location_{{ l.id }}" />\n                                            \n                                            <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(l.id)}" ng-click="toggleFavorite(l.id)">\n                                                \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                            \u2028</svg>\n                                            \n                                            <label for="location_{{ l.id }}" ng-bind="l.text"></label>\n                                            \n                                            <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(l.id)">'+customLabels.SwitchTerritory+'</span>\n                                            \n                                        </div>\n                                    </div>\n                              \n                                    \n                                    <div ng-hide="showTree" id="LocationsTree">\n                                    \n                                        <div ng-repeat="l in filteredLocations = (locationsFlat | filter:locationSearchTerm)" ng-show="isTerritoryInFavorite(l.id)" class="locationFilterRow">\n                                            <input type="checkbox" ng-model="locationFilter[l.id]" id="location_f_{{ l.id }}" />\n                                            \n                                            <svg aria-hidden="true" class="slds-icon favorite-territory" ng-class="{\'territory-is-fav\': isTerritoryInFavorite(l.id)}" ng-click="toggleFavorite(l.id)">\n                                                \u2028<use xlink:href="'+lsdIcons.favorite+'"></use>\n                                            \u2028</svg>\n                                            \n                                            <label for="location_f_{{ l.id }}" ng-bind="l.text"></label>\n                                            \n                                            <span title="'+customLabels.SwitchTerritoryHelp+'" class="switch-location" ng-click="switchToTerritory(l.id)">'+customLabels.SwitchTerritory+'</span>\n                                            \n                                        </div>\n                                    </div>\n                                    \n\n                                </div>\n\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <div class="lightboxSaveButton" ng-click="applyFilterLocation()">'+customLabels.Save+'</div>\n                                <div class="lightboxSaveButton cancelButtonAndClose" ng-click="closeLightbox()">'+customLabels.Cancel+"</div>\n                            </div>\n\n                        </div>\n                ")}function S(){return y.locationsFlat}function b(){return y.territoriesSortedByTree}var y=t.$new(!0),T=f().hide();T.find("#LocationFilteringLightbox").draggable({handle:"#LocationFilteringLightboxHeader"}),angular.element("#LeftSideContainer").append(T),p.close(),y.trust=s.trust,y.showOrphanServices=!0,y.locationSearchTerm="",y.showLocationFiltering=!1,y.noLocationsLoad=!1,y.locationFilter={},y.locationFilterCopy={},y.locationsFlat=[],y.territoriesSortedByTree=[],y.showTree=!0,y.showSecondaryTimezoneNotice=showSecondarySTMs&&useLocationTimezone,y.showTree=n.GetUserSettingsProperty("ShowFavoriteTerritoriesTab__c")&&!0,y.favorites=n.GetUserSettingsProperty("FavoriteTerritories__c")?JSON.parse(n.GetUserSettingsProperty("FavoriteTerritories__c")):[];var w=_.debounce(function(){n.SetUserSettingsProperty("FavoriteTerritories__c",JSON.stringify(y.favorites))},800);return y.saveTabDebounced=_.debounce(function(){n.SetUserSettingsProperty("ShowFavoriteTerritoriesTab__c",!y.showTree)},800),e(T)(y),y.toggleFavorite=function(e){var t=y.favorites.indexOf(e);t>-1?y.favorites.splice(t,1):y.favorites.push(e),w()},y.isTerritoryInFavorite=function(e){return y.favorites.includes(e)},y.closeLightbox=function(){if(!y.noLocationsLoad){for(var e in y.locationFilterCopy)y.locationFilter[e]=y.locationFilterCopy[e];y.showOrphanServices=y.showOrphanServicesOldValue,T.hide(),window.__closeLeftSideTerritories=null}},window.__closeLeftSideTerritories=y.closeLightbox,y.styleForLocationTree=function(e){return{"margin-left":20*e+"px"}},y.switchToTerritory=function(e){for(var t in y.locationFilter)y.locationFilter[t]=!1;y.locationFilter[e]=!0,y.applyFilterLocation()},y.applyFilterLocation=function(){var e=[],r=[];for(var p in y.locationFilter)y.locationFilter[p]?e.push(p):r.push(p);return 0===e.length?void alert(customLabels.One_loaded_location):(y.noLocationsLoad=!1,angular.extend(y.locationFilterCopy,y.locationFilter),y.showOrphanServicesOldValue=y.showOrphanServices,o.isLoadingNewLocations=!0,v.resetCurrentPalette(),n.SetUserSettingProperties(y.parseLocationSettings(JSON.stringify(e),y.showOrphanServices)).then(function(){return y.reload?void window.window.location.reload():(l.reset(),i.reset(),scheduler._events={},scheduler.deleteMarkedTimespan(),a.reset(),c.reset(),u.reset(),d.reset(),void i.getResourceAndTerritories().then(function(){var i=new Date(scheduler.getState().min_date),n=new Date(scheduler.getState().max_date);i.setDate(i.getDate()-1),n.setDate(n.getDate()+1),a.getTimePhasedObjects(i,n).then(function(){updateViewDebounced(),t.$broadcast("gotNewResources",{show:e}),o.isLoadingNewLocations=!1})}))})["catch"](function(e){for(var t=customLabels.territories_r_failure_msg+"\n",i=JSON.parse(e.FailedLocations),n=0;n<i.length;n++)t+=i[n].Name+"\n";s.addNotification(customLabels.territories_r_failure,t),o.isLoadingNewLocations=!1}),void y.closeLightbox())},y.parseLocationSettings=function(e,t){return{locations:e,Show_Orphan_Services__c:t}},y.selectLocation=function(e){var t=y.locationFilter[e],i=g(y.locationsTree,e);i&&m(i,t)},y.selectAllLocations=function(e){angular.forEach(y.filteredLocations,function(t){y.locationFilter[t.id]=e})},y.selectAllFavoriteLocations=function(e){angular.forEach(y.filteredLocations,function(t){y.isTerritoryInFavorite(t.id)&&(y.locationFilter[t.id]=e)})},{open:h,getFlatTerritoriesArray:S,getTerritoriesSortedByTree:b}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","userSettingsManager","sfdcService","utils","TimePhasedDataService","StateService","calendarsService","monthlyViewHelperService","ResourceCrewsService","ResourceCapacitiesService","GanttPalettesService","GetSlotsService"],angular.module("serviceExpert").factory("LeftSideLocationFilteringService",e)}(),function(){function e(e,t,i,n,r){function s(s,o,l,u,d){var v=e.defer(),p=a(o,l,u),h=i.addDaysToDate(p.date,-p.horizon+1),g=c(s,l,u);return t.loadServicesInBulk(p.date,p.horizon,numberOfServicesToLoadInEachBulk,g,d).then(function(e){var t=[];e.ganttServiceAppointments.forEach(function(e){e.AssignedResource&&!scheduler._events[e.Id]&&t.push(e.Id)}),Array.isArray(e.stms)&&e.stms.length>0&&n.updateTimePhaseData(e.stms,"stm");var s=n.updateTimePhaseData(e.ganttServiceAppointments,"service"),a=n.resourcesAndTerritories(),o={needToCheckRules:t,scheduledServices:[],unscheduledServices:[],remainingCount:e.remainingCount,fetchedFromDate:h,horizon:p,totalFetched:e.ganttServiceAppointments.length,lastFetchedId:e.ganttServiceAppointments[e.ganttServiceAppointments.length-1]?e.ganttServiceAppointments[e.ganttServiceAppointments.length-1].Id:null};s.services.forEach(function(e){e.isScheduled()?(e.setGanttResource(a,i.generateResourceId),o.scheduledServices.push(e)):(scheduler._events[e.id]&&delete scheduler._events[e.id],o.unscheduledServices.push(e))}),r.drawServicesAndAbsences(o.scheduledServices,[],[],[]),v.resolve(o)})["catch"](function(e){v.reject(e),console.warn("loadServicesInBulk: something went wrong"),i.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action)}),v.promise}function a(e,t,n){var r=void 0,s=void 0,a=i.addDaysToDate(t,-n+1),o=t;if(e[a]){for(s=a;o>=s&&e[s];)s=i.addDaysToDate(s,1);return r=(o.getTime()-s.getTime())/864e5,r++,{date:o,horizon:r}}for(s=o;s>=a&&e[s];)s=i.addDaysToDate(s,-1);return r=(s.getTime()-a.getTime())/864e5,r++,{date:s,horizon:r}}function o(e,t,n){var r=i.addDaysToDate(t,-n);return e.earlyStart&&e.earlyStart>r&&e.earlyStart<=t?!0:e.dueDate&&e.dueDate>r&&e.dueDate<=t?!0:e.appStart&&e.appStart>r&&e.appStart<=t?!0:e.appEnd&&e.appEnd>r&&e.appEnd<=t?!0:e.finish&&e.finish>r&&e.finish<=t?!0:e.start&&e.start>r&&e.start<=t?!0:!1}function c(e,t,i){var n=[];for(var r in e)o(e[r],t,i)&&n.push(r);return n}return{getBackHorizonToFetch:a,loadServicesInBulk:s}}e.$inject=["$q","sfdcService","utils","TimePhasedDataService","servicesService"],angular.module("serviceExpert").factory("LoadServiceListService",e)}(),function(){function e(e,t,i,n,r,s,a,o,c,l,u,d,v){function p(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!1;_.reload=e,T.show(),o.setLightBoxStatus()}function h(e,t,i){if(e.depth=t,i.push(e),e.items)for(var n=0,r=e.items.length;r>n;n++)e.items[n].depth=t,h(e.items[n],t+1,i)}function g(e,t){for(var i=null,n=0;n<e.length;n++){if(e[n].id===t)return e[n];if(i=g(e[n].items,t))return i}return i}function m(e,t){for(var i=0;i<e.items.length;i++)_.locationFilter[e.items[i].id]=t,m(e.items[i],t)}function f(e,t){var i=Object.keys(e).map(function(t){return e[t]}).sort(function(e,i){var n=0,r=0;return t.forEach(function(t,s){t.id===e.id&&(n=s),t.id===i.id&&(r=s)}),n>r?1:r>n?-1:0});return i}function S(){return angular.element('<div class="LightboxBlackContainer">\n                        <div class="LightboxContainer" id="LocationFilteringLightbox">\n\n                            <div class="lightboxHeaderContainer" id="LocationFilteringLightboxHeader">\n                                <h1 class="light-box-header">'+customLabels.Location_filtering+'</h1>\n                                <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox" ng-hide="noLocationsLoad">\n                                    \u2028\u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                                </svg>\n                            </div>\n\n                            <div class="lightboxContentContainer">\n\n                                <p>'+customLabels.LocationFilteringParagraph+'</p>\n             \n                                <div class="LocationsTreeContainer">\n                                    <p id="secondary-notice" ng-show="showSecondaryTimezoneNotice">'+customLabels.Stms_with_different_tz+'</p>\n\n                                    <div class="locationFilterRow addBorderBottom">\n                                        <input type="checkbox" ng-model="showOrphanServices" id="servicesNoLocations" />\n                                        <label for="servicesNoLocations">'+customLabels.unassosiated_filtering+'</label><br/>\n                                    </div>\n\n                                    <input id="locationFilteringSearch" type="text" ng-model="locationSearchTerm.text" placeholder="'+customLabels.Search_location+'" />\n                                    <span class="selectAllLocations" ng-click="selectAllLocations(true)" title="'+customLabels.Select_all+'">'+customLabels.All+'</span>\n                                    <span class="selectAllLocations" ng-click="selectAllLocations(false)" title="'+customLabels.Select_none+'">'+customLabels.None+'</span>\n\n                                    <div ng-repeat="l in filteredLocations = (locationsFlat | filter:locationSearchTerm)" class="locationFilterRow" ng-style="{{ styleForLocationTree(l.depth) }}" ng-click="selectLocation(l.id)">\n                                        <input type="checkbox" ng-model="locationFilter[l.id]" id="location_{{ l.id }}" />\n                                        <label for="location_{{ l.id }}" ng-bind="l.text"></label><br/>\n                                    </div>\n\n                                </div>\n\n                            </div>\n\n                            <div class="lightboxControllers">\n                                <div class="lightboxSaveButton" ng-click="applyFilterLocation()">'+customLabels.Save+"</div>\n                            </div>\n\n                        </div>\n                    </div>")}function b(){return _.locationsFlat}function y(){return _.territoriesSortedByTree}var _=t.$new(!0),T=S().hide();return T.find("#LocationFilteringLightbox").draggable({handle:"#LocationFilteringLightboxHeader"}),angular.element("body").append(T),_.trust=s.trust,_.showOrphanServices=!0,_.locationSearchTerm="",_.showLocationFiltering=!1,_.noLocationsLoad=!1,_.locationFilter={},_.locationFilterCopy={},_.locationsFlat=[],_.territoriesSortedByTree=[],_.showSecondaryTimezoneNotice=showSecondarySTMs&&useLocationTimezone,e(T)(_),_.$on("keypress",function(e,t){27===t.which&&_.closeLightbox()}),window.__openLocationFilteringAndReload=function(){return p(!0)},_.closeLightbox=function(){if(!_.noLocationsLoad){for(var e in _.locationFilterCopy)_.locationFilter[e]=_.locationFilterCopy[e];_.showOrphanServices=_.showOrphanServicesOldValue,T.hide(),o.setLightBoxStatus(!1)}},_.styleForLocationTree=function(e){return{"margin-left":20*e+"px"}},i.promises.territories().then(function(){function e(n){if(n.id&&n.parent){if(t[n.parent.id])return n.parent;var r={};return i.allTerritories[n.parent.id]&&(r={id:i.allTerritories[n.parent.id].id,parent:i.allTerritories[n.parent.id].parentTerritory?i.allTerritories[n.parent.id].parentTerritory:0}),e(r)}}var t={},a=[],o=[],c=[];for(var l in i.territories)t[l]={id:l,parent:i.territories[l].parentTerritory?i.territories[l].parentTerritory:0,text:i.territories[l].name,items:[]};for(var u in t){var d=t[u],v=e(d);0!==d.parent&&v?t[v.id].items.push(d):a.push(d)}_.locationsTree=a;for(var g=0;g<a.length;g++)h(a[g],0,_.locationsFlat);_.showOrphanServices=JSON.parse(n.GetUserSettingsProperty("Show_Orphan_Services__c")),_.showOrphanServicesOldValue=_.showOrphanServices,_.territoriesSortedByTree=f(i.territories,_.locationsFlat),null!=n.GetUserSettingsProperty("locations")&&(o=n.GetUserSettingsProperty("locations")),r.getUnPrivilegeUserSettingsFields().then(function(e){if(e.length>1){for(var t=customLabels.Unprivileged_Usersettings_Fields_Msg.split("{1}"),i=t[0],n="",r=3,a=0;a<e.length&&r>a;++a)n+="<br>"+e[a];if(r<e.length){var o=e.length-r;n+="<br>",i+=t[1].replace("{2}",o)}i=i.replace("{0}",n),s.addNotification(customLabels.Unprivileged_Usersettings_Fields,i)}})["catch"](function(e){console.warn("GetUserSettingsProperty failed :-("),console.error(e)});for(var m=0;m<_.locationsFlat.length;m++){if(0===o.length)return _.showLocationFiltering=!0,_.noLocationsLoad=!0,void p();_.noLocationsLoad=!1,_.locationFilter[_.locationsFlat[m].id]=o.indexOf(_.locationsFlat[m].id)>-1,_.locationFilter[_.locationsFlat[m].id]&&c.push(_.locationsFlat[m].id)}_.locationFilterCopy=angular.copy(_.locationFilter),n.SetUserSettingsProperty("locations",JSON.stringify(c))}),_.applyFilterLocation=function(){var e=[],r=[];for(var p in _.locationFilter)_.locationFilter[p]?e.push(p):r.push(p);return 0===e.length?void alert(customLabels.One_loaded_location):(_.noLocationsLoad=!1,angular.extend(_.locationFilterCopy,_.locationFilter),_.showOrphanServicesOldValue=_.showOrphanServices,o.isLoadingNewLocations=!0,v.resetCurrentPalette(),n.SetUserSettingProperties(_.parseLocationSettings(JSON.stringify(e),_.showOrphanServices)).then(function(){return _.reload?void window.window.location.reload():(l.reset(),i.reset(),scheduler._events={},scheduler.deleteMarkedTimespan(),a.reset(),c.reset(),u.reset(),d.reset(),void i.getResourceAndTerritories().then(function(){var i=new Date(scheduler.getState().min_date),n=new Date(scheduler.getState().max_date);i.setDate(i.getDate()-1),n.setDate(n.getDate()+1),a.getTimePhasedObjects(i,n).then(function(){updateViewDebounced(),t.$broadcast("gotNewResources",{show:e}),o.isLoadingNewLocations=!1})}))})["catch"](function(e){for(var t=customLabels.territories_r_failure_msg+"\n",i=JSON.parse(e.FailedLocations),n=0;n<i.length;n++)t+=i[n].Name+"\n";s.addNotification(customLabels.territories_r_failure,t),o.isLoadingNewLocations=!1}),void _.closeLightbox())},_.parseLocationSettings=function(e,t){return{locations:e,Show_Orphan_Services__c:t}},_.selectLocation=function(e){var t=_.locationFilter[e],i=g(_.locationsTree,e);i&&m(i,t)},_.selectAllLocations=function(e){angular.forEach(_.filteredLocations,function(t){_.locationFilter[t.id]=e})},{open:p,getFlatTerritoriesArray:b,getTerritoriesSortedByTree:y}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","userSettingsManager","sfdcService","utils","TimePhasedDataService","StateService","calendarsService","monthlyViewHelperService","ResourceCrewsService","ResourceCapacitiesService","GanttPalettesService"],angular.module("serviceExpert").factory("LocationFilteringService",e)}(),function(){function e(e,t,i,n,r,s,a,o){function c(){f=t.$new(!0),f.$on("keypress",function(e,t){27==t.which&&f.$evalAsync(f.closeLightbox)});var s=n.GetUserSettingsProperty("locations");f.filteredLocations=s.map(function(e){return i.territories[e]}),h(),f.dateSelectFinishWidget=u,f.dateSelectStartWidget=d,f.validateDatesStart=v,f.validateDatesEnd=p,f.optimizeAllServices="all",f.runOptimizion=g,f.selectedLocations={},f.checkBoxFields=a.checkBoxFields,f.optimizeSelectedFilter="noFilter",f.orphanServices=!1,f.policyOptions=r.policies,f.selectedPolicy=f.policyOptions[0];for(var o=0;o<r.policies.length;o++)if(r.policies[o].Id===r.selectedPolicyId){f.selectedPolicy=r.policies[o];break}var c=m();c.find("#BulkActionsLightbox").draggable({handle:"#UnschduleLightboxHeader"}),angular.element("body").append(c),f.closeLightbox=l,f.$on("$destroy",function(){return c.remove()}),e(c)(f),c.show(),r.setLightBoxStatus()}function l(){r.setLightBoxStatus(!1),f.$destroy()}function u(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(f.actionFinish),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(f.endMinutes)),i.setHours(parseInt(f.endHour)),i<f.actionStart?alert(customLabels.finishAfterStart):f.actionFinish=i,scheduler.destroyCalendar(),f.$apply()}})}function d(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(f.actionStart),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(f.startMinutes)),i.setHours(parseInt(f.startHour)),i>f.actionFinish?alert(customLabels.startBeforeEnd):f.actionStart=i,scheduler.destroyCalendar(),f.$apply()}})}function v(){var e=new Date(f.actionStart);e.setMinutes(parseInt(f.startMinutes)),e.setHours(parseInt(f.startHour)),e>=f.actionFinish?(alert(customLabels.startBeforeEnd),f.startMinutes=f.actionStart.getMinutes(),f.startHour=f.actionStart.getHours().toString()):f.actionStart=e}function p(){var e=new Date(f.actionFinish);e.setMinutes(parseInt(f.endMinutes)),e.setHours(parseInt(f.endHour)),e<=f.actionStart?(alert(customLabels.finishAfterStart),f.endMinutes=f.actionFinish.getMinutes().toString(),f.endHour=f.actionFinish.getHours().toString()):f.actionFinish=e}function h(){f.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),f.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),f.startHour="0",f.endHour="0",f.startMinutes="0",f.endMinutes="0"}function g(){var e=[],t=void 0,i=void 0,n=void 0,s=void 0;for(var c in f.selectedLocations)f.selectedLocations[c]&&e.push(c);return 0===e.length?void alert(customLabels.noLocationWasSelected):(t=f.actionStart,i=f.actionFinish,i.setDate(i.getDate()+1),n="noFilter"===f.optimizeSelectedFilter?null:f.optimizeSelectedFilter,s="all"===f.optimizeAllServices,r.setBulkActionRunning(),o.runOptimization(t,i,e,s,f.orphanServices,f.selectedPolicy.Id,n).then(function(e){e?o.getRequestObject(e).then(function(e){e[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?a.addNotification(customLabels.Optimization_Request_Sent,customLabels.Optimization_sent_details,function(e){a.openSObjectLink("../"+e)},e.Id):a.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){a.openSObjectLink("../"+e)},e.Id)}):a.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)})["catch"](function(e){console.warn("runOptimization failed :("),console.log(e)})["finally"](function(){r.setBulkActionRunning(!1)}),void f.closeLightbox())}function m(){var e=customLabels.starting_from_x_until_y_including_z_services.replace("$0",'<u id="bulkStartOptimize" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>').replace("$1",'<u id="bulkFinishOptimize" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>').replace("$2",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="optimizeAllServices">\n								<option value="all">'+customLabels.All+'</option>\n								<option value="unscheduled">'+customLabels.UnscheduledCapital+"</option>\n							</select>"),t='<div id="PolicyInOptimize">'+customLabels.Use_the_following_policy_x_and_y.replace("$0",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="selectedPolicy" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions"></select>').replace("$1",'<select ng-model="optimizeSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n								 	<option ng-repeat="(fieldName, fieldLbl) in checkBoxFields()" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n								 	<option value="noFilter">'+customLabels.None+"</option>\n								 </select>")+"</div>";return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="BulkActionsLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.Optimize+'</h1>\n                        </div>\n\n\n                        <div class="lightboxContentContainer">\n\n                            <p class="bulkExplain">'+customLabels.SelectServicesOptimize+'</p>\n\n                            <div class="selectedTargetLocations">\n                                <label for="bulkRadioSelectedIds">'+customLabels.ChooseLocationsLB+'</label>\n                            </div>\n\n\n                            <div id="bulkLocationNames">\n                                <div ng-repeat="location in filteredLocations track by $index" class="BulkActionLocationName">\n                                    <input ng-model="selectedLocations[location.id]" type="checkbox" id="bulkLocationUnschedule_{{ location.id }}"/>\n                                    <label title="{{ location.name }}" for="bulkLocationUnschedule_{{ location.id }}">{{location.name}}</label>\n                                </div>\n\n                                <div>\n                                    <input ng-model="orphanServices" type="checkbox" name="orphanLocationsOptimize" id="orphanLocationsOptimize" />\n                                    <label for="orphanLocationsOptimize">'+customLabels.IncludeServicesNoLocations+'</label>\n                                </div>\n                            </div>\n\n\n                            <div class="bulkOptimizeOptions">\n                                '+e+"\n                                "+t+'\n                            </div>\n\n                        </div>\n\n                        <div class="lightboxControllers">\n                            <div class="lightboxSaveButton" ng-click="runOptimizion()">'+customLabels.Optimize+"</div>\n                        </div>\n\n\n                    </div>\n                </div>\n            ")}for(var f=null,S=[],b=0;60>b;b++)S.push(b);return{open:c}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","userSettingsManager","StateService","servicesService","utils","sfdcService"],
angular.module("serviceExpert").factory("optimizeLightboxService",e)}(),function(){function e(e,t,i,n,r,s,a,o){function c(n){S=t.$new(!0),S.$on("keypress",function(e,t){27==t.which&&S.$evalAsync(S.closeLightbox)}),S.resource=i.getResources()[n];var s=JSON.parse(localStorage.getItem(sfdcUser+"_RSO"))||{},o=r.selectedPolicyId;s.selectedPolicy&&(o=s.selectedPolicy.Id),h(),S.dateSelectFinishWidget=u,S.dateSelectStartWidget=d,S.validateDatesStart=v,S.validateDatesEnd=p,S.optimizeAllServices=s.optimizeAllServices||"all",S.runOptimizion=g,S.checkBoxFields=a.checkBoxFields(),S.optimizeSelectedFilter=s.optimizeSelectedFilter||Object.keys(S.checkBoxFields)[0],S.optimizeCalloutSelectedFilter=s.optimizeCalloutSelectedFilter||Object.keys(S.checkBoxFields)[0],S.scheduleOnlyResourceFutureJobs=void 0!=s.scheduleOnlyResourceFutureJobs?s.scheduleOnlyResourceFutureJobs:!0,S.policyOptions=r.policies;for(var c=0;c<r.policies.length;c++)if(r.policies[c].Id===o){S.selectedPolicy=r.policies[c];break}var m=f();m.find("#BulkActionsLightbox").draggable({handle:"#UnschduleLightboxHeader"}),angular.element("body").append(m),S.closeLightbox=l,S.$on("$destroy",function(){return m.remove()}),e(m)(S),m.show(),r.setLightBoxStatus()}function l(){r.setLightBoxStatus(!1),S.$destroy()}function u(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(S.actionFinish),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(S.endMinutes)),i.setHours(parseInt(S.endHour)),i<S.actionStart?alert(customLabels.finishAfterStart):S.actionFinish=i,scheduler.destroyCalendar(),S.$apply()}})}function d(e){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:e,date:new Date(S.actionStart),navigation:!0,handler:function(e,t){var i=new Date(e);i.setMinutes(parseInt(S.startMinutes)),i.setHours(parseInt(S.startHour)),i>S.actionFinish?alert(customLabels.startBeforeEnd):S.actionStart=i,scheduler.destroyCalendar(),S.$apply()}})}function v(){var e=new Date(S.actionStart);e.setMinutes(parseInt(S.startMinutes)),e.setHours(parseInt(S.startHour)),e>=S.actionFinish?(alert(customLabels.startBeforeEnd),S.startMinutes=S.actionStart.getMinutes(),S.startHour=S.actionStart.getHours().toString()):S.actionStart=e}function p(){var e=new Date(S.actionFinish);e.setMinutes(parseInt(S.endMinutes)),e.setHours(parseInt(S.endHour)),e<=S.actionStart?(alert(customLabels.finishAfterStart),S.endMinutes=S.actionFinish.getMinutes().toString(),S.endHour=S.actionFinish.getHours().toString()):S.actionFinish=e}function h(){S.actionStart=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),S.actionFinish=new Date(scheduler.getState().max_date.getFullYear(),scheduler.getState().max_date.getMonth(),scheduler.getState().max_date.getDate(),0,0,0),S.startHour="0",S.endHour="0",S.startMinutes="0",S.endMinutes="0"}function g(){var e=void 0,t=void 0,i=void 0,n=void 0,s=void 0;e=S.actionStart,t=S.actionFinish,t.setDate(t.getDate()+1),n=S.optimizeSelectedFilter,i=S.optimizeCalloutSelectedFilter,s="all"===S.optimizeAllServices,m(),r.setBulkActionRunning(),o.runRDOptimization(S.resource.id,e,t,s,S.scheduleOnlyResourceFutureJobs,S.selectedPolicy.Id,n,i).then(function(e){e?o.getRequestObject(e).then(function(e){e[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?a.addNotification(customLabels.Optimization_Request_Sent,customLabels.Optimization_sent_details,function(e){a.openSObjectLink("../"+e)},e.Id):a.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){a.openSObjectLink("../"+e)},e.Id)}):a.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)})["catch"](function(e){console.warn("runOptimization failed :("),console.log(e),a.addNotification(customLabels.Optimization_Failed,e.message)})["finally"](function(){r.setBulkActionRunning(!1)}),S.closeLightbox()}function m(){var e={optimizeAllServices:S.optimizeAllServices,scheduleOnlyResourceFutureJobs:S.scheduleOnlyResourceFutureJobs,selectedPolicy:S.selectedPolicy,optimizeSelectedFilter:S.optimizeSelectedFilter,optimizeCalloutSelectedFilter:S.optimizeCalloutSelectedFilter};localStorage.setItem(sfdcUser+"_RSO",JSON.stringify(e))}function f(){var e=customLabels.starting_from_x_until_y_including_z_services.replace("$0",'<u id="bulkStartOptimize" class="bulkDatePicker" ng-click="dateSelectStartWidget(\'bulkStartOptimize\')" ng-bind="actionStart | amDateFormat:\'ll\'"></u>').replace("$1",'<u id="bulkFinishOptimize" class="bulkDatePicker" ng-click="dateSelectFinishWidget(\'bulkFinishOptimize\')" ng-bind="actionFinish | amDateFormat:\'ll\'"></u>').replace("$2",'<select class="bulkStatusWidth RightArrowForSelect" ng-model="optimizeAllServices">\n								<option value="all">'+customLabels.All+'</option>\n								<option value="unscheduled">'+customLabels.UnscheduledCapital+"</option>\n							</select>"),t='<div id="ResourceToOptimize">'+customLabels.OptimizeTheFollowingResourceDay.replace("$0",'<span class="rdoResourceName">{{resource.name}}</span>')+"</div>",i=customLabels.OptimizeOnlySAsAssignedTo.replace("$0",'<span class="rdoResourceName" ng-class="{disabledonlyAssignTo: !scheduleOnlyResourceFutureJobs}">{{resource.name}}</span>');return angular.element('\n                <div class="LightboxBlackContainer">\n                    <div class="LightboxContainer" id="BulkActionsLightbox">\n\n                        <div class="lightboxHeaderContainer" id="UnschduleLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <h1 class="light-box-header">'+customLabels.RDOptimize+'</h1>\n                        </div>\n\n\n                        <div class="lightboxContentContainer">\n\n                            <p class="bulkExplain">'+customLabels.SetTheParametersForRDO+'</p>\n\n                            <div class="bulkOptimizeOptions">\n                                '+t+'\n                            </div>\n                            <div class="bulkOptimizeOptions">\n                                '+e+'\n                            </div>\n\n                            <div class="horizontalSeperator">\n                                <div class="configureRDO">'+customLabels.Configure+'</div>\n                            </div>\n\n                            <div class="bulkOptimizeOptionsContainer">\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.OptimizePolicyText+'\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <select class="bulkStatusWidth RightArrowForSelect" ng-model="selectedPolicy" ng-change="changePolicy()" ng-options="policy.Name for policy in policyOptions">\n                                        </select>\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.OptimizeFilterText+'\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <select ng-model="optimizeSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n                                            <option ng-repeat="(fieldName, fieldLbl) in checkBoxFields" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n                                        </select>\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel" ng-class="{disabledonlyAssignTo: !scheduleOnlyResourceFutureJobs}">\n                                        '+i+'\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <input ng-model="scheduleOnlyResourceFutureJobs" type="checkbox" name="scheduleOnlyResourceFutureSa" id="scheduleOnlyResourceFutureSa" />\n                                    </div>\n                                </div>\n\n                                <div class="bulkOptimizeOptions">\n                                    <div class="settingLabel">\n                                        '+customLabels.OptimizeKeepTheFollowingSAsScheduled+'\n                                    </div>\n\n                                    <div class="optimizationOptionValue">\n                                        <select ng-model="optimizeCalloutSelectedFilter" class="bulkStatusWidth RightArrowForSelect">\n                                            <option ng-repeat="(fieldName, fieldLbl) in checkBoxFields" value="{{fieldName}}" ng-bind="fieldLbl"></option>\n                                         </select>\n                                    </div>\n                                </div>\n                            </div>\n\n                        </div>\n\n                        <div class="lightboxControllers">\n                            <div class="lightboxSaveButton" ng-click="runOptimizion()">'+customLabels.Optimize+"</div>\n                        </div>\n\n\n                    </div>\n                </div>\n            ")}var S=null;return{open:c}}e.$inject=["$compile","$rootScope","ResourcesAndTerritoriesService","userSettingsManager","StateService","servicesService","utils","sfdcService"],angular.module("serviceExpert").factory("rdOptimizeLightboxService",e)}(),function(){function e(e,t){function i(i,n){e.register(i,n),t.register(i,n)}function n(i,n){e.unRegister(i,n),t.unRegister(i,n)}return{register:i,unRegister:n}}e.$inject=["DeltaService","StreamingAPIService"],angular.module("serviceExpert").factory("RegisterService",e)}(),function(){angular.module("serviceExpert").factory("ResourceCapacitiesService",["ResourcesAndTerritoriesService","TimePhasedDataService","$rootScope","utils","StateService",function(e,t,i,n,r){function s(){l={}}function a(e,t){for(var i=new Date(e),r=null;t>i;){var s=n.formatDayToString(i);if(!l[s]){l[s]=!0,r||(r=c());var a=new Date(i);a.setDate(a.getDate()+1);for(var u=0;u<=r.length;u++)o(new Date(i),new Date(a),r[u])}i.setDate(i.getDate()+1)}}function o(e,t,i){if(e.getTime()!=t.getTime()){var n={};for(var r in scheduler.matrix)n[r]=[i];var s="capacityPattern";scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:n,css:s})}}function c(){for(var i=[],r=t.resourcesAndTerritories(),s=e.getCapacityBasedResources(),a=0;a<=s.length;a++){var o=s[a],c=r[o];for(var l in c){var u=c[l];i.push(n.generateResourceId(o,u.serviceTerritory))}}return i}var l={};return i.$on("gotNewTimePhasedObjects",function(e,t){r.areContractorsSupported()&&Object.keys(t.resourcesAndTerritories).length&&a(t.start,t.finish)}),{reset:s}}])}(),function(){angular.module("serviceExpert").factory("ResourceCrewsService",["ResourcesAndTerritoriesService","TimePhasedDataService","$rootScope","utils","StateService",function(e,t,i,n,r){function s(){m={}}function a(e,t,i){for(var r=new Date(e),s=void 0;t>r;){var a=n.formatDayToString(r);if(!m[a]){void 0===s&&(s=h(i.serviceCrewMembers)),m[a]=!0;var c=new Date(r);c.setDate(c.getDate()+1);for(var l in s)o(new Date(r),new Date(c),s[l])}r.setDate(r.getDate()+1)}}function o(e,t,i){if(e.getTime()!==t.getTime()){var n;n=i.member.ganttLabel?i.member.ganttLabel:customLabels.XCrewMember.replaceAll(i.member.serviceCrew__r.Name),c(e,t,i,n,"S"),c(e,t,i,n,"R"),l(e,t,i,n)}}function c(e,t,i,r,s){var a=i.territoriesByType[s];if(void 0!==a&&(showSecondarySTMs||"R"===s))for(var o=0;o<a.length;o++){var c,l,u=a[o],d=useLocationTimezone?u.operatingHours.TimeZone:userTimeZone;useLocationTimezone?(c=p(u.start,u.operatingHours.TimeZone,d),l=p(u.finish,u.operatingHours.TimeZone,d)):(c=u.start,l=u.finish);var h=n.intersectDates({start:c,finish:l},{start:e,finish:t}).intersection;if(null!==h){var g=p(i.member.startDate,"GMT",d),m=p(i.member.endDate,"GMT",d),f=n.intersectDates({start:h.start,finish:h.finish},{start:g,finish:m}).intersection;null!==f&&v(f.start,f.finish,u.sectionsToDraw,"crewMember",r,"crewLabelStyle")}}}function l(e,t,i,r){var s=i.territoriesByType.P,a=i.territoriesByType.R;if(void 0===a)d(e,t,i,r);else if(void 0!==s)for(var o=0;o<s.length;o++){var c=!1,l=s[o],h=useLocationTimezone?l.operatingHours.TimeZone:userTimeZone,g=p(i.member.startDate,"GMT",h),m=p(i.member.endDate,"GMT",h),f=n.intersectDates({start:g,finish:m},{start:e,finish:t}).intersection;if(null!==f){var S=n.intersectDates({start:l.start,finish:l.finish},{start:f.start,finish:f.finish}).intersection;if(null!==S){for(var b=0;b<a.length;b++){var y=a[b],_=useLocationTimezone?y.operatingHours.TimeZone:userTimeZone,T=p(y.start,_,h),w=p(y.finish,_,h),L=n.intersectDates({start:T,finish:w},{start:e,finish:t}).intersection;if(null!==L){var C=n.intersectDates({start:L.start,finish:L.finish},{start:S.start,finish:S.finish}).intersection;null!==C&&(u(C,S,l.sectionsToDraw,r),c=!0)}}c||null===S||v(S.start,S.finish,l.sectionsToDraw,"crewMember",r,"crewLabelStyle")}}}}function u(e,t,i,n){t.start.getTime()<e.start.getTime()&&v(t.start,e.start,i,"crewMember",n,"crewLabelStyle"),e.finish.getTime()<t.finish.getTime()&&v(e.finish,t.finish,i,"crewMember",n,"crewLabelStyle")}function d(e,t,i,r){var s=i.territoriesByType.P;if(void 0!==s)for(var a=0;a<s.length;a++){var o=s[a],c=useLocationTimezone?o.operatingHours.TimeZone:userTimeZone,l=p(i.member.startDate,"GMT",c),u=p(i.member.endDate,"GMT",c),d=n.intersectDates({start:e,finish:t},{start:l,finish:u}).intersection;if(null!==d){var h=n.intersectDates({start:o.start,finish:o.finish},{start:d.start,finish:d.finish}).intersection;null!==h&&v(h.start,h.finish,o.sectionsToDraw,"crewMember",r,"crewLabelStyle")}}}function v(e,t,i,n,r,s){scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:i.daily,css:n,html:"<div class='"+s+"' title='"+r+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.crewMember+"'></use></svg> "+r+" </div>"}),scheduler.addMarkedTimespan({start_date:e,end_date:t,sections:i.monthly,html:"<div class='relocatedLabel' title='"+r+"'><svg aria-hidden='true' class='slds-icon relocationIcon'><use xlink:href='"+lsdIcons.crewMember+"'></use></svg></div>",css:"crewmember_monthly"})}function p(e,t,i){return n.convertDateBetweenTimeZones(e,t,i)}function h(e){var i={},r=t.resourcesAndTerritories();for(var s in e){void 0===i[s]&&(i[s]={},i[s].territoriesByType={},i[s].member=e[s]);var a=r[e[s].serviceResource];for(var o in a){var c=a[o],l=n.generateResourceId(e[s].serviceResource,c.serviceTerritory);void 0===i[s].territoriesByType[c.serviceTerritoryType]&&(i[s].territoriesByType[c.serviceTerritoryType]=[]),i[s].territoriesByType[c.serviceTerritoryType].push({start:c.effectiveStartDate,finish:c.effectiveEndDate,serviceTerritory:c.serviceTerritory,operatingHours:c.serviceTerritory__r.OperatingHours,type:c.serviceTerritoryType,id:c.id,section:l,sectionsToDraw:g(l)})}void 0!==i[s].territoriesByType.P&&i[s].territoriesByType.P.sort(n.sortByTime),void 0!==i[s].territoriesByType.R&&i[s].territoriesByType.R.sort(n.sortByTime),void 0!==i[s].territoriesByType.S&&i[s].territoriesByType.S.sort(n.sortByTime)}return i}function g(e){var t={monthly:{},daily:{}};for(var i in scheduler.matrix)"MonthlyView"===i||"MTDView"==i?t.monthly[i]=[e]:t.daily[i]=[e];return t}var m={};return i.$on("gotNewTimePhasedObjects",function(e,t){r.areCrewsSupported()&&Object.keys(t.serviceCrewMembers).length&&a(t.start,t.finish,t)}),{reset:s}}])}(),function(){angular.module("serviceExpert").factory("resourceFilterHelper",["$q","sfdcService","$sce","userSettingsManager",function(e,t,i,n){function r(){return m.crewsSelectionOptions.crewFilteringOptions}function s(){return h}function a(){return g}function o(e,t){var i=m.picklistOptions.indexOf(e);-1===i?m.picklistOptions.push(e):m.picklistOptions.splice(i,1)}function c(){if(m.selectedPicklist&&(m.picklistOptions.length||m.picklistNullValues))return!0;for(var e in m.resourceFilteringOptions)if(m.resourceFilteringOptions[e])return!0;return!1}function l(){m.selectedPicklist="select_a_field",m.length=0,m.picklistOptions.length=0,m.picklistNullValues=!1;for(var e in m.resourceFilteringOptions)m.resourceFilteringOptions[e]=!1}function u(){for(var e in m.resourceFilteringOptions)m.resourceFilteringOptions[e]=!0}function d(e){var t="",i="",n=customLabels.SelectAfieldToResourceFilter;e&&(t="<b>"+customLabels.CurrentlyWorking+"</b>");for(var r in h)"BOOLEAN"===h[r][1]&&m.resourceFilteringOptions[h[r][2]]?""===t?t="<b>"+h[r][0]+"</b>":t+=" and <b>"+h[r][0]+"</b>":"PICKLIST"===h[r][1]&&m.selectedPicklist===h[r][2]&&(i=m.picklistOptions.join("</b> "+customLabels.or+" <b>"),i.length>0&&(i="<b>"+h[r][0]+"</b> is <b>"+i+"</b>"),m.picklistNullValues&&(""===i?i="<b>"+customLabels.None+"</b>":i+=" "+customLabels.or+" <b>"+customLabels.None+"</b>"));return""!==t&&""!==i?n=customLabels.Resources_That_Are_x_and_y.replaceAll(t,i):""===t&&""!==i?n=customLabels.Resources_That_Are_x.replaceAll(i):""!==t&&""==i&&(n=customLabels.Resources_That_Are_x.replaceAll(t)),n}var v={sortBy:customLabels.name,asc:!0,showWorkingResource:!1,booleanFields:{},picklistField:"select_a_field",picklistOptions:[],picklistOptionsModel:[],picklistNullValues:!1,crewsOption:customLabels.showAll},p=JSON.parse(n.GetUserSettingsProperty("Resource_Filter__c"))||v,h=null,g=null,m={selectedPicklist:p.picklistField,resourceFilteringOptions:p.booleanFields,picklistOptionsModel:p.picklistOptionsModel,picklistOptions:p.picklistOptions,picklistNullValues:p.picklistNullValues,crewsSelectionOptions:{selectedPicklist:p.crewsOption,crewFilteringOptions:[customLabels.showAll,customLabels.hideCrewMembers,customLabels.showCrewsAndCrewMembers,customLabels.showOnlyCrews,customLabels.hideCrewsAndCrewMembers]}},f=t.getResourceFieldSetFields().then(function(e){h=e,h.Name=["Name","STRING","Name"];for(var t in h)"BOOLEAN"===h[t][1]&&(m.resourceFilteringOptions[t]=p.booleanFields[t]);monthlyViewSettings.isMonthlyAvailable&&(h.__Utilization__=[customLabels.AggregatedUtilization,"UTILIZATION","__Utilization__"])});return f.then(function(){var e=[];for(var i in h)"PICKLIST"===h[i][1]&&e.push(i);t.getResourcePicklistValues(e).then(function(e){g=e,$("#resourceExplainCrap").html(d(p.showWorkingResource))})}),{getResourceFieldset:s,getCrewFilteringOptions:r,getPicklistNames:a,selectionInfo:m,updateSelectedPicklist:o,resetFilter:l,setAll:u,generateFilterExplanation:d,isResourceFilterApplied:c,resourceFieldToSortyBy:p.sortBy,resourceCrewFilter:m.crewsSelectionOptions.selectedPicklist,resourceCrewDefaultFilter:customLabels.showAll,descending:p.asc,showWorkingResource:p.showWorkingResource}}])}(),function(){function e(e,t,i,n,r,s,a,o,c,l,u,d,v){function p(o,c){if(!z){z=e.$new(!0),z.lightboxResource=t.getResources()[o],z.terMemberKey=c||a.getResoruceGanttIdByDate(o,scheduler.getState().min_date),z.selectedTab="details",z.urls={related:i.trustAsResourceUrl(customResourceRelatedListLightboxPage+"?id="+o).toString(),chatter:i.trustAsResourceUrl(customResourceChatter+"?id="+o).toString(),details:i.trustAsResourceUrl(customResourceLightboxPage+"?id="+o).toString(),calendar:i.trustAsResourceUrl("vf079_ResourceCalendar?id="+o).toString()},z.urls.custom1=CustomResourceTab1?i.trustAsResourceUrl(CustomResourceTab1+"?id="+o).toString():null,z.urls.custom2=CustomResourceTab2?i.trustAsResourceUrl(CustomResourceTab2+"?id="+o).toString():null,z.changeTab=m,z.closeLightbox=h,z.chatterAvailable=fieldTrackingEnabled.resource,z.formatTravel=_,z.openConsoleTab=r.openConsoleTab,z.formatKpitText=T,z.formatDateToTime=w,z.formatCapacityKpitText=L,z.getContractorCapacityStatus=G,z.isMapEnabled=s.isMapEnabled(),z.contractorSupport=s.areContractorsSupported(),z.isDaily="ZoomLevel3"==scheduler._mode?!0:!1,z.actualRoute=null,z.showActual=!0,z.toggleShowRoute=E,z.toggleActualVisibilityWhenMapTabClicked=U,z.boundOnCaruselItem=S,z.showSideRoute=!0,z.zoomOutToFitAll=b,z.slideToggle=y,z.currentlyShowingOnMap=null,z.changeDate=O,z.getColorByStatus=g,z.showAbsencesOnMap=window.showAbsencesOnMap,Chart.defaults.global.colours=["#16325c","#DCDCDC","#F7464A","#46BFBD","#FDB45C","#949FB1","#4D5360"],z.donutCharts=null,z.haveItemsToShowOnSideRoute=function(e){for(var t=0;t<e.length;t++)if("na"===e[t].type||"service"===e[t].type)return!0;return!1},z.isMapEnabled&&C(),f(o),G(o);var l=j();l.find("#ResourceLightbox").draggable({handle:"#ResourceLightboxHeader"}),angular.element("body").append(l),s.setLightBoxStatus(),z.$on("$destroy",function(){return l.remove()}),z.$on("keypress",function(e,t){27==t.which&&z.$evalAsync(z.closeLightbox)}),n(l)(z),r.safeApply(z),v.getResourceActualRoute(z.lightboxResource.id,scheduler.getState().min_date).then(function(e){P(e),setTimeout(function(){z.actualRoute.setMap(z.map)},1500)})}}function h(){z.killWatch&&z.killWatch(),s.setLightBoxStatus(!1),z.$destroy(),z=null}function g(e){if(e.ganttColor)return e.ganttColor;switch(e.statusCategory){case l.NONE:return"#a5e2d6";case l.SCHEDULED:return"#F9D058";case l.DISPATCHED:return"#8DD8FA";case l.IN_PROGRESS:return"#D68EF9";case l.COMPLETED:return"#95D055";case l.COULD_NOT_COMPLETE:return"#f58556";case l.CANCELED:return"#BEBCBA";default:return"#B7C9EA"}}function m(e){e!==z.selectedTab&&(z.selectedTab=e)}function f(e){var t=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date);z.resourceKpi={total:0,completed:0,violations:0,jeopardy:0,avgTravelTime:0,totalScheduledDuration:0};for(var i=0;i<t.length;i++)t[i].resource==e&&("na"===t[i].type&&(z.resourceKpi.avgTravelTime+=t[i].travelTo+t[i].travelFrom),"service"===t[i].type&&(z.resourceKpi.total++,t[i].statusCategory==l.COMPLETED&&z.resourceKpi.completed++,t[i].violations&&z.resourceKpi.violations++,t[i].jeopardy&&z.resourceKpi.jeopardy++,z.resourceKpi.avgTravelTime+=t[i].travelTo+t[i].travelFrom,t[i].start_date&&t[i].end_date&&(z.resourceKpi.totalScheduledDuration+=(t[i].finish-t[i].start)/1e3)));t.length>0&&z.resourceKpi.total>0?z.resourceKpi.avgTravelTime=Math.floor(z.resourceKpi.avgTravelTime/60/z.resourceKpi.total):z.resourceKpi.avgTravelTime=0}function S(e){z.currentlyShowingOnMap=e.id;var t=new google.maps.LatLng(e.coords.latitude,e.coords.longitude);z.map.setCenter(t),z.map.setZoom(13)}function b(){z.bounds.isEmpty()||z.map.fitBounds(z.bounds),z.currentlyShowingOnMap=null}function y(){$("#mapCarouselWrapper").slideToggle("slow",function(){}),z.showSideRoute=!z.showSideRoute}function _(e){var t=Math.floor(e/60/60),i=Math.floor(e/60%60);return t+customLabels.kpi_h+" "+i+customLabels.kpi_m}function T(){return z.isDaily?customLabels.KPIsAreCalculatedFrom.replaceAll(moment(scheduler._min_date).format("ll"),moment(scheduler._max_date).format("ll")):customLabels.KPIsAreCalculatedFromTo.replaceAll(moment(scheduler._min_date).format("ll"),moment(scheduler._max_date).format("ll"))}function w(e){return e?moment(e).format("LT"):null}function L(e,t){return""===e||""===t?"":customLabels.Between_x_and_y.replaceAll(moment(e).format("ll"),moment(t).format("ll"))}function C(){z.getServiceInfoRowClass=r.getServiceInfoRowClass,z.firstMapShow=!0,z.showRoute=!0,z.showTrafficLayer=!1,z.showServices=!0,z.mapControl={},z.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER},fullscreenControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM}},z.serviceInfoWindow={show:!1},z.livePosInfoWindow={show:!1},z.resourceInfoWindow={show:!1},z.absenceInfoWindow={show:!1},z.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)},resource:{pixelOffset:new google.maps.Size(0,-38)},absence:{pixelOffset:new google.maps.Size(0,-38)}},z.resourceServicesDate=scheduler.getState().min_date,z.markersArray=[],d.fieldsSetFields().then(function(e){z.serviceFields=e.MapInfo}),z.killWatch=z.$watch("selectedTab",function(e){"map"==e&&o(function(){if(z.map=z.mapControl.getGMap(),google.maps.event.trigger(z.map,"resize"),z.firstMapShow){z.firstMapShow=!1;var e=z.map.getStreetView(),t={fullscreenControl:!1,addressControlOptions:{position:google.maps.ControlPosition.BOTTOM_CENTER}};e.setOptions(t),z.firstMapShow=!1,z.generateMarkersAndRoute()}},0)}),z.generateMarkersAndRoute=D,z.openDatePicker=M,z.routeToggled=function(){z.generateMarkersAndRoute();var e=z.showRoute?z.map:null;z.polyLineGoogleObj&&z.polyLineGoogleObj.setMap(e),z.directionsDisplay&&z.directionsDisplay.setMap(e)},z.markerClicked=function(e,t,i){k(i)},z.markerCloseClicked=function(){z.serviceInfoWindow.show=!1,z.livePosInfoWindow.show=!1,z.absenceInfoWindow={show:!1},z.resourceInfoWindow.show=!1,z.$apply()},z.openFieldSetLink=function(e,t){r.openLink(e,t)},z.openLink=function(e){r.openSObjectLink(e)}}function k(e){var t=e.type;switch(z.serviceInfoWindow.show=!1,z.absenceInfoWindow.show=!1,z.livePosInfoWindow.show=!1,z.resourceInfoWindow.show=!1,z.currentMarker=e,t){case"service":z.serviceInfoWindow.show=!0;break;case"lastKnownPosition":z.livePosInfoWindow.show=!0;break;case"resource":z.resourceInfoWindow.show=!0;break;case"na":case"break":z.absenceInfoWindow.show=!0}o(function(){z.$apply(),r.setMapCloseButtonPosition()},0)}function D(e){z.resourceSLRPath={stroke:{weight:2,color:"#16325C"},path:[],geodesic:!0,toggle:!0},z.polyLinePath={path:[],geodesic:z.resourceSLRPath.geodesic,strokeColor:z.resourceSLRPath.stroke.color,strokeWeight:z.resourceSLRPath.stroke.weight,strokeOpacity:1},z.markersArray=[],z.bounds=new google.maps.LatLngBounds;var i=F();z.resourceServices=x();var n={};if(i)if(i.latitude)n={latitude:i.latitude,longitude:i.longitude};else{var r=t.territories[i.serviceTerritory];r.latitude&&(n={latitude:r.latitude,longitude:r.longitude})}var s=null;n.latitude&&(z.markersArray.push({id:i.serviceResource,type:"resource",coords:n,markerOptions:{icon:staticResources.homebase_png},resourceName:z.lightboxResource.name}),s=new google.maps.LatLng(n.latitude,n.longitude),z.polyLinePath.path.push(s),z.bounds.extend(s));for(var a=0;a<z.resourceServices.length;a++){var o=z.resourceServices[a];if(o.latitude){if(z.showServices){var c="service"===o.type?staticResources.service_png:staticResources.resource_absence_icon,l={id:o.id,type:o.type,coords:{latitude:o.latitude,longitude:o.longitude},markerOptions:{icon:c,labelContent:"<span>"+(a+1)+"</span>"+moment(o.start).format("LT"),labelClass:"ResourceMapServiceMarkerLabel",zIndex:200},item:o};z.markersArray.push(l)}var u=new google.maps.LatLng(o.latitude,o.longitude);z.bounds.extend(u),z.resourceSLRPath.path.push({location:u,stopover:!0}),z.polyLinePath.path.push(u)}}if(n.latitude&&z.polyLinePath.path.push(s),!e){if(z.showRoute)if(allowStreetLevelRouting&&z.resourceSLRPath.path.length>0){var d=new google.maps.DirectionsService;d.route({origin:s?s:z.resourceSLRPath.path[0].location,destination:s?s:z.resourceSLRPath.path[z.resourceSLRPath.path.length-1].location,waypoints:z.resourceSLRPath.path,travelMode:google.maps.TravelMode.DRIVING},function(e,t){t===google.maps.DirectionsStatus.OK?(z.polyLineGoogleObj&&(z.polyLineGoogleObj.setMap(null),z.polyLineGoogleObj=null),z.directionsDisplay||(z.directionsDisplay=new google.maps.DirectionsRenderer({suppressMarkers:!0})),z.directionsDisplay.setMap(z.map),z.directionsDisplay.setDirections(e)):(window.alert("Directions request failed due to "+t),A())})}else A();else z.polyLineGoogleObj?z.polyLineGoogleObj.setMap(null):z.directionsDisplay&&z.directionsDisplay.setMap(null);var v=new google.maps.LatLng(37.794024,-122.394837);z.bounds.isEmpty()?z.map.setCenter(v):z.map.fitBounds(z.bounds)}R()}function A(){z.directionsDisplay&&(z.directionsDisplay.setMap(null),z.directionsDisplay=null),z.polyLineGoogleObj&&z.polyLineGoogleObj.setMap(null),z.polyLineGoogleObj=new google.maps.Polyline(z.polyLinePath),z.polyLineGoogleObj.setMap(z.map)}function R(){var e=u.lastKnownPositions();for(var t in e)I(e[t])}function I(e){var i=t.getResources()[e.id],n={id:e.id+"_position",markerOptions:{icon:staticResources.livepos_png},type:"lastKnownPosition",resourceId:e.id,coords:{latitude:e.latitude,longitude:e.longitude},item:angular.extend(angular.copy(e),{resourceName:i.name})};n.item.lastModifiedDate=r.convertDateBetweenTimeZones(n.item.lastModifiedDate,"UTC",userTimeZone),z.markersArray.push(n)}function F(){var e=z.resourceServicesDate,t=new Date(e);t.setHours(24,0,0,0);var i=a.resourcesAndTerritories();for(var n in i){var s=i[n];for(var o in s){var c=s[o];if(r.generateResourceId(c.serviceResource,c.serviceTerritory)==z.terMemberKey&&isIntersect(e,t,c.effectiveStartDate,c.effectiveEndDate))return c}}return null}function x(){var e=z.resourceServicesDate,t=new Date(e);t.setHours(24,0,0,0);var i=scheduler.getEvents(e,t),n=i.filter(function(e){return e.resourceId.indexOf(z.terMemberKey)>-1&&e.latitude&&("service"===e.type||z.showAbsencesOnMap&&"na"===e.type)}).sort(function(e,t){return e.start.getTime()-t.start.getTime()});return n}function M(){scheduler.isCalendarVisible()?scheduler.destroyCalendar():scheduler.renderCalendar({position:"resourceServicesDateStart",date:new Date(z.resourceServicesDate),navigation:!0,handler:function(e,t){z.$apply(function(){z.resourceServicesDate=e,z.generateMarkersAndRoute(),v.getResourceActualRoute(z.lightboxResource.id,e).then(P)}),scheduler.destroyCalendar()}})}function O(e){z.resourceServicesDate.setDate(z.resourceServicesDate.getDate()+e),z.generateMarkersAndRoute(),v.getResourceActualRoute(z.lightboxResource.id,z.resourceServicesDate).then(P)}function P(e){z.actualRoute&&(z.actualRoute.visible=!1,z.actualRoute.setMap(z.map));var t={},i=[];e.forEach(function(e){("LastKnownLatitude"===e.Field||"LastKnownLongitude"===e.Field)&&(t[e.CreatedDate]=t[e.CreatedDate]||{},t[e.CreatedDate][e.Field.indexOf("Long")>-1?"lng":"lat"]=e.NewValue,t[e.CreatedDate].date=e.CreatedDate)});for(var n in t)i.push(t[n]);z.actualRoute=new google.maps.Polyline({path:i,geodesic:!0,strokeColor:"#ff73bf",strokeOpacity:1,strokeWeight:3}),N()&&z.actualRoute.setMap(z.map)}function E(){z.actualRoute&&(z.actualRoute.visible=z.showActual,z.actualRoute.setMap(z.map))}function N(){return z.showActual}function G(e){for(var t=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),i=[],n=[],r=0;r<t.length;r++)t[r].resource==e&&"contractorcapacity"==t[r].type&&("Week"==t[r].timePeriod&&i.push(t[r]),"Month"==t[r].timePeriod&&n.push(t[r]));z.donutCharts=B(),setTimeout(function(){H(i[0],n[0])},1e3)}function B(){var e={segmentShowStroke:!1,segmentStrokeColor:"#fff",segmentStrokeWidth:2,percentageInnerCutout:75,animation:!0,animationSteps:100,animationEasing:"easeOutSine",animateRotate:!0,animateScale:!1,showTooltips:!0};return{labels:[customLabels.Hours_Used,customLabels.Hours_Available],weekly:{data:[],percentage:"",start:"",end:"",show:!1,options:e},monthly:{data:[],percentage:"",start:"",end:"",show:!1,options:e}}}function H(e,t){var i;e?(i=e.hoursPerTimePeriod-e.hoursInUse,0>i&&(i=0),z.donutCharts.weekly.data=[e.hoursInUse,i],z.donutCharts.weekly.percentage=V(e.hoursInUse,e.hoursPerTimePeriod)+"%",z.donutCharts.weekly.start=e.start_date,z.donutCharts.weekly.end=e.end_date,z.donutCharts.weekly.show=!0):(z.donutCharts.weekly.data=[0,10],z.donutCharts.weekly.show=!1,z.donutCharts.weekly.options.showTooltips=!1,
z.donutCharts.weekly.start=z.kpiStart,z.donutCharts.weekly.end=z.kpiEnd),t?(i=t.hoursPerTimePeriod-t.hoursInUse,0>i&&(i=0),z.donutCharts.monthly.data=[t.hoursInUse,i],z.donutCharts.monthly.percentage=V(t.hoursInUse,t.hoursPerTimePeriod)+"%",z.donutCharts.monthly.start=t.start_date,z.donutCharts.monthly.end=t.end_date,z.donutCharts.monthly.show=!0):(z.donutCharts.monthly.data=[0,10],z.donutCharts.monthly.show=!1,z.donutCharts.monthly.options.showTooltips=!1,z.donutCharts.monthly.start=scheduler.getState().min_date,z.donutCharts.monthly.end=scheduler.getState().max_date)}function V(e,t){return parseFloat((e/t*100).toFixed(2))}function U(){o(function(){z.actualRoute&&z.actualRoute.setMap(z.map)},500)}function j(){return angular.element('<div class="LightboxBlackContainer ng-cloack">\n                    <div class="LightboxContainer ng-cloak" id="ResourceLightbox">\n\n                        <div class="lightboxHeaderContainer" id="ResourceLightboxHeader">\n                            <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n                            <img ng-show="lightboxResource.pictureLink" class="resourcePhotoLightbox" ng-src="{{ lightboxResource.pictureLink }}" alt="{{ lightboxResource.name }}" />\n                            <div ng-show="!lightboxResource.pictureLink" alt="{{ lightboxResource.name }}" class="ResourcePhotoIcon resourcePhotoLightbox"></div>\n\n                            <h1 class="lightboxHeader" id="resourceName" ng-bind="lightboxResource.name"></h1>\n                            <span ng-click="changeTab(\'details\')" ng-class="{lightboxSelectedTab: selectedTab == \'details\'}">\n                                '+customLabels.Details+"\n                            </span>\n\n                            <span ng-click=\"changeTab('relatedLists')\" ng-class=\"{lightboxSelectedTab: selectedTab == 'relatedLists'}\">\n                                "+customLabels.Related+'\n                            </span>\n\n                            <span ng-show="chatterAvailable" ng-click="changeTab(\'chatter\')" ng-class="{lightboxSelectedTab: selectedTab == \'chatter\'}">\n                                '+customLabels.Chatter+'\n                            </span>\n\n                            <span ng-if="isMapEnabled" ng-click="changeTab(\'map\'); " ng-class="{lightboxSelectedTab: selectedTab == \'map\'}">\n                                '+customLabels.Map+"\n                            </span>\n\n                            <span ng-click=\"changeTab('calendar')\" ng-class=\"{lightboxSelectedTab: selectedTab == 'calendar'}\">\n                                "+customLabels.Calendar+'\n                            </span>\n                            \n                            <span ng-show="urls.custom1" ng-click="changeTab(\'customTab1\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab1\'}">\n                                '+customLabels.CustomResourceTab1+'\n                            </span>\n                            \n                            <span ng-show="urls.custom2" ng-click="changeTab(\'customTab2\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab2\'}">\n                                '+customLabels.CustomResourceTab2+'\n                            </span>\n\n                            <div class="ExtendedForm">\n                                <a ng-click="openConsoleTab($event,lightboxResource.id)" target="_blank" href="../{{ lightboxResource.id }}" title="'+customLabels.ExtandedForm+'">\n                                    <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                        \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                    \u2028</svg>\n                                </a>\n                            </div>\n                        </div>\n\n                        <section ng-if="isMapEnabled" id="resourceLightboxMap" ng-show ="selectedTab == \'map\'">\n                            <ui-gmap-google-map pan="false" control="mapControl" center="{latitude: 0 ,longitude: 0}" options="mapOptions" zoom="16" class="map-canvas">\n                                <ui-gmap-markers click="markerClicked" models="markersArray" idKey="id" coords="\'coords\'" options="\'markerOptions\'"">\n                                </ui-gmap-markers>\n\n                                <ui-gmap-window show="serviceInfoWindow.show" ng-show="currentMarket.type === \'service\'" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.service" >\n                                    <div class="googleMapInfoWindowService">\n                                        <img class="mapTooltipIcon" src="'+staticResources.wo_icon_png+'"/>\n                                        <h1 class="truncate mapTooltipTitle">{{currentMarker.item | displayFieldSetField : serviceFields[0] }}</h1>\n\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[1] || serviceFields[1]">{{serviceFields[1].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[1])" ng-class="getServiceInfoRowClass(serviceFields[1])">{{currentMarker.item | displayFieldSetField : serviceFields[1]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[2] || serviceFields[2]">{{serviceFields[2].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[2])" ng-class="getServiceInfoRowClass(serviceFields[2])">{{currentMarker.item | displayFieldSetField : serviceFields[2]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[3] || serviceFields[3]">{{serviceFields[3].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[3])" ng-class="getServiceInfoRowClass(serviceFields[3])">{{currentMarker.item | displayFieldSetField : serviceFields[3]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[4] || serviceFields[4]">{{serviceFields[4].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[4])" ng-class="getServiceInfoRowClass(serviceFields[4])">{{currentMarker.item | displayFieldSetField : serviceFields[4]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[5] || serviceFields[5]">{{serviceFields[5].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[5])" ng-class="getServiceInfoRowClass(serviceFields[5])">{{currentMarker.item | displayFieldSetField : serviceFields[5]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[6] || serviceFields[6]">{{serviceFields[6].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[6])" ng-class="getServiceInfoRowClass(serviceFields[6])">{{currentMarker.item | displayFieldSetField : serviceFields[6]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[7] || serviceFields[7]">{{serviceFields[7].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[7])" ng-class="getServiceInfoRowClass(serviceFields[7])">{{currentMarker.item | displayFieldSetField : serviceFields[7]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[8] || serviceFields[8]">{{serviceFields[8].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[8])" ng-class="getServiceInfoRowClass(serviceFields[8])">{{currentMarker.item | displayFieldSetField : serviceFields[8]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[9] || serviceFields[9]">{{serviceFields[9].Label}}: <span ng-click="$parent.$parent.$parent.openFieldSetLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[9])" ng-class="getServiceInfoRowClass(serviceFields[9])">{{currentMarker.item | displayFieldSetField : serviceFields[9]}}</span></div>\n\n                                    </div>\n                                </ui-gmap-window>\n\n                                <ui-gmap-window show="resourceInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.resource">\n                                    <div class="googleMapInfoWindowHomebase">\n                                        <svg aria-hidden="true" class="slds-icon homebaseTooltipIcon">\n                                            \u2028<use xlink:href="'+lsdIcons.home+'"></use>\n                                        \u2028</svg>\n                                        <h1 class="truncate mapTooltipTitle"><span class="homebaseLabel">{{ "'+customLabels.homebase_of+'" | replaceLabels : currentMarker.resourceName }}</span></h1>\n                                        <div class="buttonOnMap"  ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.id)">'+customLabels.viewDetails+'</div>\n                                    </div>\n                                </ui-gmap-window>\n                                \n                                \n                                \n                                \n                                <ui-gmap-window show="absenceInfoWindow.show && showAbsencesOnMap" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.absence">\n                                    <div class="googleMapInfoWindowAbsence">\n                                        <svg aria-hidden="true" class="slds-icon absenceeTooltipIcon">\n                                            \u2028<use xlink:href="'+lsdIcons.absence+'"></use>\n                                        \u2028</svg>\n                                        <h1 class="truncate mapTooltipTitle"><span class="homebaseLabel">{{ $parent.$parent.currentMarker.item.name }}</span></h1>\n                                        <div>'+customLabels.Start_time+": {{ $parent.$parent.currentMarker.item.start | amDateFormat:'lll' }}</div>\n                                        <div>"+customLabels.Finish_time+": {{ $parent.$parent.currentMarker.item.end | amDateFormat:'lll' }}</div>\n                                        <div>"+customLabels.Reason+': {{ $parent.$parent.currentMarker.item.reason }}</div>\n                                        <div class="buttonOnMap"  ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.id)">'+customLabels.viewDetails+'</div>\n                                    </div>\n                                </ui-gmap-window>\n                                \n                               \n                                <ui-gmap-window show="livePosInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.livePos">\n                                    <div class="googleMapInfoWindowLivePos">\n                                        <svg aria-hidden="true" class="slds-icon livePosTooltipIcon">\n                                        \u2028	<use xlink:href="'+lsdIcons.user+'"></use>\n                                    \u2028	</svg>\n                                        <h1 class="truncate mapTooltipTitle" ng-bind="$parent.$parent.$parent.currentMarker.item.resourceName"></h1>\n                                        <div>'+customLabels.Last_seen+' {{ currentMarker.item.lastModifiedDate | amDateFormat:\'lll\' }}</div>\n                                        <div class="buttonOnMap"  ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.resourceId)">'+customLabels.viewDetails+'</div>\n                                    </div>\n                                </ui-gmap-window>\n\n                                <ui-gmap-layer type="TrafficLayer" show=\'showTrafficLayer\'></ui-gmap-layer>\n                                \n                            </ui-gmap-google-map>\n                            <div id="ResourceMapOptions">\n                                <div id="ResourceMapOptionsWrapper">\n                                    <input ng-model="$parent.showServices" ng-change="generateMarkersAndRoute(true)" type="checkbox" id="ResourceServicesFilter"></input>\n                                    <label for="ResourceServicesFilter">'+customLabels.Show_services_for+'</label>\n                                    <div class="resourceMapDateArrow" ng-click="changeDate(-1)">\n                                        <svg aria-hidden="true" class="slds-icon resourceMapChevronIcon">\n                                        \u2028   <use xlink:href="'+lsdIcons.chevronleft+'"></use>\n                                    \u2028   </svg>\n                                    </div>\n                                    <u id="resourceServicesDateStart" class="bulkDatePicker" ng-click ="openDatePicker()" >{{resourceServicesDate | amDateFormat:\'L\'}}</u>\n                                    <div class="resourceMapDateArrow" ng-click="changeDate(1)">\n                                        <svg aria-hidden="true" class="slds-icon resourceMapChevronIcon">\n                                        \u2028   <use xlink:href="'+lsdIcons.chevronright+'"></use>\n                                    \u2028   </svg>\n                                    </div>\n                                    <input ng-hide="lightboxResource.isCapacityBased && contractorSupport" ng-model="$parent.showRoute" ng-change="routeToggled()" type="checkbox" id="RouteFilter"></input>\n                                    <label ng-hide="lightboxResource.isCapacityBased && contractorSupport" for="RouteFilter">'+customLabels.Route+'</label>\n                                    <input ng-hide="lightboxResource.isCapacityBased && contractorSupport" ng-model="$parent.showActual" ng-change="toggleShowRoute()" type="checkbox" id="actualToggle"></input>\n                                    <label ng-hide="lightboxResource.isCapacityBased && contractorSupport" for="actualToggle">'+customLabels.ActualRoute+'</label>\n                                    <input ng-hide="lightboxResource.isCapacityBased && contractorSupport" ng-model="showTrafficLayer" type="checkbox" id="trafficToggle"></input>\n                                    <label ng-hide="lightboxResource.isCapacityBased && contractorSupport" for="trafficToggle">'+customLabels.Traffic+'</label>\n                                </div>\n                            </div>\n                            <div id="ResourceMapCarousel" ng-show="resourceServices.length > 0">\n                                <div id="toggleResourceMapServiceCarousel" ng-click="slideToggle()">\n                                    {{showSideRoute ? "'+customLabels.HideDetailedRoute+'" : "'+customLabels.ToggleDetailedRoute+'"}}\n                                </div>\n                                <div id="mapCarouselWrapper">\n                                    <div class="carouselArrow crouselLeft">\n                                        <svg aria-hidden="true" class="slds-icon arrowIcon">\u2028<use xlink:href="'+lsdIcons.chevronleft+'"></use>\u2028</svg>\n                                    </div>\n                                    <div class="carouselArrow crouselRight">\n                                        <svg aria-hidden="true" class="slds-icon arrowIcon">\u2028<use xlink:href="'+lsdIcons.chevronright+'"></use>\u2028</svg>                                \n                                    </div>\n                                    \n                                    \n                                    <div ng-hide="haveItemsToShowOnSideRoute(markersArray)">\n                                        There are no services or absences to show\n                                    </div>\n                                    \n                                    <div ng-repeat="marker in markersArray" class="carouselItem" ng-if=" marker.type === \'na\' || marker.type == \'service\'">\n                                    \n                                        <div ng-if="marker.type === \'na\'">\n                                            <span class="numberingOnMapRouteSide numberingOnMapRouteSideNA" title="'+customLabels.CenterOnMapp+'" ng-click="boundOnCaruselItem(marker)">{{$index}}</span>\n                                            <span class="appointment-times">{{formatDateToTime(marker.item.start)}} - {{formatDateToTime(marker.item.finish)}}</span>\n                                            <span class="appointment-number">{{marker.item.name}}</span>\n  \n                                            <div class="appointment-rows">\n                                                <div>'+customLabels.Start_time+": {{ marker.item.start | amDateFormat:'lll' }}</div>\n                                                <div>"+customLabels.Finish_time+": {{ marker.item.end | amDateFormat:'lll' }}</div>\n                                                <div>"+customLabels.Reason+': {{ marker.item.reason }}</div>\n                                            </div>\n                                        </div>\n                                    \n                                    \n                                        <div ng-if="marker.type == \'service\'">\n                                            <span class="numberingOnMapRouteSide" title="'+customLabels.CenterOnMapp+'" ng-click="boundOnCaruselItem(marker)" ng-style="{\'background-color\': getColorByStatus(marker.item)}">{{$index}}</span>\n                                            <span class="appointment-times">{{formatDateToTime(marker.item.start)}} - {{formatDateToTime(marker.item.finish)}}</span>\n                                            <span class="appointment-number">{{marker.item.AppointmentNumber}}</span>\n                                            <!-- <div class="boundOnMarker globalBlueButton" ng-click="boundOnCaruselItem(marker)" ng-hide="currentlyShowingOnMap == marker.id">\n                                                 <svg aria-hidden="true" class="slds-icon boundIcon">\u2028<use xlink:href="'+lsdIcons.checkin+'"></use>\u2028</svg>                                            \n                                            </div>\n                                            <div class="boundOnMarker globalBlueButton" ng-click="zoomOutToFitAll()" ng-show="currentlyShowingOnMap == marker.id">\n                                                 <svg aria-hidden="true" class="slds-icon boundIcon">\u2028<use xlink:href="'+lsdIcons.location+'"></use>\u2028</svg>                                            \n                                            </div>-->\n                                            <div class="appointment-rows">\n                                                <span ng-repeat="field in serviceFields" class="">\n                                                    <div ng-show="marker.item[field.JsAPIName]">{{field.Label}}: <span ng-click="openFieldSetLink(marker.item, field)" ng-class="getServiceInfoRowClass(field)">{{marker.item | displayFieldSetField : field}}</span></div>                                            \n                                                </span>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </section>\n\n                        <div class="capacitiesDonuts" ng-show="selectedTab == \'details\' && lightboxResource.isCapacityBased && contractorSupport">\n                            <div id="weeklyCapacity">\n                                <div id="weeklyDonutPercentage" class="donutPercentage">\n                                    <div ng-show="donutCharts.weekly.show" ng-bind="donutCharts.weekly.percentage"></div>\n                                    <div class="noCapacity" ng-show="!donutCharts.weekly.show">'+customLabels.No_Weekly_Capacity+'</div>\n                                    <div class="capacityTimeFrameLabel truncate" ng-show="donutCharts.weekly.show" title="'+customLabels.Weekly_Capacity+'">'+customLabels.Weekly_Capacity+'</div>\n                                </div>\n                                <canvas id="weeklyDoughnutChart"\n                                        class="chart chart-doughnut"\n                                        chart-options="donutCharts.weekly.options"\n                                        chart-data="donutCharts.weekly.data"\n                                        chart-labels="donutCharts.labels">\n                                </canvas>\n                                <div class="capacityRange">{{formatCapacityKpitText(donutCharts.weekly.start, donutCharts.weekly.end)}}</div>\n                            </div>\n\n                            <div id="monthlyCapacity">\n                                <div id="monthlyDonutPercentage" class="donutPercentage">\n                                    <div ng-show="donutCharts.monthly.show" ng-bind="donutCharts.monthly.percentage"></div>\n                                    <div class="noCapacity" ng-show="!donutCharts.monthly.show">'+customLabels.No_Monthly_Capacity+'</div>\n                                    <div class="capacityTimeFrameLabel truncate" ng-show="donutCharts.monthly.show" title="'+customLabels.Monthly_Capacity+'">'+customLabels.Monthly_Capacity+'</div> \n                                </div>\n                                <canvas id="monthlyDoughnutChart"\n                                        class="chart chart-doughnut"\n                                        chart-options="donutCharts.monthly.options"\n                                        chart-data="donutCharts.monthly.data"\n                                        chart-labels="donutCharts.labels">\n                                </canvas>\n                                <div class="capacityRange">{{formatCapacityKpitText(donutCharts.monthly.start, donutCharts.monthly.end)}}</div>\n                            </div>\n                        </div>\n\n                        <div id="KPIforResource" ng-show="selectedTab == \'details\'" ng-class="{KPIforResourceWithCapacity: (lightboxResource.isCapacityBased && contractorSupport)}">\n                            <div class="kpiIndicator" ng-show="!lightboxResource.isCapacityBased || (lightboxResource.isCapacityBased && !contractorSupport)">\n                                <div class="kpiResourceValue" >\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon">\u2028<use xlink:href="'+lsdIcons.clock+'"></use>\u2028</svg>\n                                    {{ formatTravel(resourceKpi.totalScheduledDuration) }}\n                                </div>\n\n                                '+customLabels.Total_Scheduled+'\n                            </div>\n\n                            <div class="kpiIndicator" ng-show="isMapEnabled && (!lightboxResource.isCapacityBased || (lightboxResource.isCapacityBased && !contractorSupport))">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIconTravel"><use xlink:href="'+lsdIcons.car+'"></use>\u2028</svg>\n                                    {{ formatTravel(resourceKpi.avgTravelTime * 60) }}\n                                </div>\n\n                                '+customLabels.Average_Travel+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon">\u2028<use xlink:href="'+lsdIcons.violation+'"></use>\u2028</svg>\n                                    {{ resourceKpi.violations }}\n                                </div>\n\n                                '+customLabels.Violations+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon"><use xlink:href="'+lsdIcons.jeopardy+'"></use>\u2028</svg>\n                                    {{ resourceKpi.jeopardy }}\n                                </div>\n                                 '+customLabels.In_Jeopardy+'\n                            </div>\n\n                            <div class="kpiIndicator">\n                                <div class="kpiResourceValue">\n                                    <svg aria-hidden="true" class="slds-icon kpiResourceIcon">\u2028<use xlink:href="'+lsdIcons.completed+'"></use>\u2028</svg>\n                                    {{ resourceKpi.completed }}/{{ resourceKpi.total }}\n                                </div>\n\n                                '+customLabels.Completed+'\n                            </div>\n\n                            <div class="KpiRange">{{formatKpitText()}}</div>\n                        </div>\n\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.details }}" id="detailsIframeResource" ng-class="{detailsIframeResourceContractor: lightboxResource.isCapacityBased && contractorSupport}" ng-show="selectedTab == \'details\'"></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.related }}" id="relatedListIframeResource" ng-show="selectedTab == \'relatedLists\'" ></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.chatter }}" ng-if="chatterAvailable" id="chatterIframeResource" ng-show="selectedTab == \'chatter\'" ></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-src="{{ urls.calendar }}" id="calendarIframeResource" ng-show="selectedTab == \'calendar\'" ></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom1" ng-show="selectedTab == \'customTab1\'" ng-src="{{ urls.custom1 }}" class="resourceLightboxIframe"></iframe>\n                        <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom2" ng-show="selectedTab == \'customTab2\'" ng-src="{{ urls.custom2 }}" class="resourceLightboxIframe"></iframe>\n                        \n                        <div id="lightbox-loading-cover">\n                            <img src="'+lsdIcons.spinnerGif+'" />\n                            '+customLabels.loading+"\n                        </div>\n\n                    </div>\n                </div>")}var z=null;return{open:p}}e.$inject=["$rootScope","ResourcesAndTerritoriesService","$sce","$compile","utils","StateService","TimePhasedDataService","$timeout","SERVICE_STATUS","SERVICE_CATEGORY","LastKnownPositionService","FieldSetFieldsService","sfdcService"],angular.module("serviceExpert").factory("ResourceLightboxService",e)}(),function(){function e(e,t,i,n,r,s,a,o,c,l,u){function d(r,s,a){b=e.$new(!0),b.menuResource=t.getResources()[r],b.resourceId=r,b.section=s,b.openResourceLightbox=p,b.runDynamicGanttFunction=h,b.hasCustomPermission=n.hasCustomPermission,b.showCrew=g,b.openResourceDayOptimizationLightbox=m,b.isCrew=!1,b.customActions=y,b.runCustomResourceAction=f,void 0!==t.getCrewResources()[r]&&(b.isCrew=!0);var o=S(),c=$($(a).closest(".resourceMenuBtn")),l=c.offset();angular.element("body").append(o),$(".resourceMenuContainer").css({top:l.top,left:l.left}),b.$on("$destroy",function(){return o.remove()}),angular.element("body").on("mousedown",function(e){for(var t=["resMenuSingleAction"],i=0;i<t.length;i++)if(e.target.classList.contains(t[i])||e.target.parentNode&&e.target.parentNode.classList.contains(t[i]))return;v(),e.stopPropagation(),angular.element("body").off("mousedown")}),i(o)(b),n.safeApply(b)}function v(){b.$destroy()}function p(){r.open(b.resourceId,b.section)}function h(e){var t=void 0,i=void 0;t=new Date(scheduler.getState().min_date.getFullYear(),scheduler.getState().min_date.getMonth(),scheduler.getState().min_date.getDate(),0,0,0),i=a.selectedPolicyId;var r={FillInSchedule:{FunctionName:s.runFillInSchedule,NotificationHeaderText:customLabels.x_request_sent.replaceAll(customLabels.Fill_in_Schedule),NotificationText:customLabels.RequestNotificationSent.replaceAll(customLabels.Fill_in_Schedule,b.menuResource.name,moment(t).format("L"))},FixOverlaps:{FunctionName:s.runFixOverlaps,NotificationHeaderText:customLabels.x_request_sent.replaceAll(customLabels.FixOverlaps),NotificationText:customLabels.RequestNotificationSent.replaceAll(customLabels.FixOverlaps,b.menuResource.name,moment(t).format("L"))}};if(useLocationTimezone){var l=t,u=addDaysToDate(t,1),d={start_date:l,end_date:u},p=c.getIntersectingSrstOffset(d,b.resourceId),h=n.getUserOffset(l);n.getUserOffset(u);t.setMinutes(l.getMinutes()+h-p)}var g=r[e].FunctionName;g(t,b.resourceId,i).then(function(t){t?(t[fieldNames.Optimization_Request.Status__c]!=customLabels.failed?n.addNotification(r[e].NotificationHeaderText,r[e].NotificationText,function(e){n.openSObjectLink("../"+e)},t.Id):n.addNotification(customLabels.Optimization_Failed,customLabels.error_in_opt,function(e){n.openSObjectLink("../"+e)},t.Id),o.updateOptimizationRequest(t)):n.addNotification(customLabels.Action_Could_Not_Be_Performed,customLabels.user_is_not_allowed_to_perform_action)}).then(function(){})["catch"](function(t){console.warn(e+" failed :("),console.log(t),n.addNotification(customLabels.Action_Could_Not_Be_Performed,t.message)})["finally"](function(){}),v()}function g(){var i=t.getResources(),n=c.currentCrewToShow;n={};var r=c.crewToServiceCrewMembers()[b.menuResource.serviceCrew];n[b.resourceId]=b.menuResource;for(var s in r)n[r[s].serviceResource]=i[r[s].serviceResource],void 0===n[r[s].serviceResource].members&&(n[r[s].serviceResource].members={}),n[r[s].serviceResource].members[s]=r[s];c.currentCrewToShow=n,v(),e.$broadcast("moveToCrewView")}function m(){l.open(b.resourceId)}function f(e){var t=null,i=window.__lastResourceClicked.key.split("_")[1],r=c.resourcesAndTerritories()[b.resourceId];for(var a in r)r[a].serviceTerritory===i&&(t=a);if(e.visualforce){var o=scheduler._min_date.getMonth()+1+"-"+scheduler._min_date.getDate()+"-"+scheduler._min_date.getFullYear(),l=scheduler._max_date.getMonth()+1+"-"+scheduler._max_date.getDate()+"-"+scheduler._max_date.getFullYear();return u.open(e.name,e.visualforce+"?id="+b.resourceId+"&stm="+t+"&start="+o+"&end="+l),void v()}s.runCustomResourceAction(e.className,b.resourceId,t,scheduler._min_date,scheduler._max_date).then(function(t){return n.addNotification(e.name,t,null,null)})["catch"](function(t){return n.addNotification(e.name,t.message,null,null)}),v()}function S(){return angular.element('\n                    <div id="resourceMenu" class="resourceMenuContainer">\n                        <div class="truncate resMenuSingleAction" ng-click="openResourceLightbox()" title="'+customLabels.Details+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.info+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.Details+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="openResourceDayOptimizationLightbox()" ng-hide="menuResource.isCapacityBased || !hasCustomPermission(\'Resource_Schedule_Optimization\')" title="'+customLabels.RDOptimize+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.magicwand+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.RDOptimize+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="runDynamicGanttFunction(\'FixOverlaps\')" ng-hide="menuResource.isCapacityBased || !hasCustomPermission(\'Fix_Overlaps\')" title="'+customLabels.FixOverlaps+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.crossfilter+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.FixOverlaps+'</div>\n                        <div class="truncate resMenuSingleAction" ng-click="runDynamicGanttFunction(\'FillInSchedule\')" ng-hide="!hasCustomPermission(\'Fill_in\')" title="'+customLabels.Fill_in_Schedule+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon resMenuSingleIcon">\n                                    <use xlink:href="'+lsdIcons.summarydetail+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.Fill_in_Schedule+'\n                        </div>\n                        <div class="truncate resMenuSingleAction" ng-click="showCrew()" ng-show="isCrew" title="'+customLabels.showCrewAndHisMemebers+'">\n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon crew-icon-menu">\n                                    <use xlink:href="'+lsdIcons.crew+'"></use>\n                                \u2028</svg>\n                            </div>\n                            '+customLabels.showCrew+'\n                        </div>\n                        \n                        \n                        <div ng-repeat="action in customActions" class="truncate resMenuSingleAction" ng-click="runCustomResourceAction(action)" title="{{action.name}}">\n                        \n                            <div class="resource-icon-container">\n                                <svg aria-hidden="true" class="slds-icon customResourceAction" ng-show="action.icon">\n                                    <use xlink:href="{{action.icon}}"></use>\n                                \u2028</svg>\n                            </div>\n                        \n                            {{action.name}}\n                        </div>\n                    </div>\n                ');
}var b=null,y=[];return n.customActionsPromise.then(function(){var e=n.getCustomActions("resource");y.push.apply(y,_toConsumableArray(e))}),{open:d}}e.$inject=["$rootScope","ResourcesAndTerritoriesService","$compile","utils","ResourceLightboxService","sfdcService","StateService","DeltaService","TimePhasedDataService","rdOptimizeLightboxService","GeneralLightbox"],angular.module("serviceExpert").factory("ResourceSmallMenu",e)}(),function(){function e(e,t){function i(){return v}function n(){return h}function r(){return p}function s(){return g}function a(){return m}function o(){var i=e.defer();return t.GetResourcesAndTerritories().then(function(e){i.resolve(),e.territories.forEach(function(e){e.IsActive&&(u[e.Id]=new ServiceTerritory(e)),d[e.Id]=new ServiceTerritory(e)}),e.resources.forEach(function(e){v[e.Id]=new ServiceResource(e),v[e.Id].isCapacityBased&&p.push(e.Id),v[e.Id].serviceCrew&&(g[e.Id]=e,m[v[e.Id].serviceCrew]=e)}),e.operatingHours.forEach(function(e){h[e.Id]=new OperatingHours(e)}),l.territories.resolve(u),l.resources.resolve(v),l.operatingHours.resolve(h)})["catch"](function(e){i.reject(e),l.resources.reject(),l.territories.reject(),l.operatingHours.reject(),console.warn("GetResourcesAndTeritorries: unable to load resources, territories, or operating hours"),bootstrap.handleError(e)}),i.promise}function c(){u={},v={},h={},p=[],g={},m={}}var l={territories:e.defer(),resources:e.defer(),operatingHours:e.defer()},u={},d={},v={},p=[],h={},g={},m={};return o(),{promises:{territories:function(){return l.territories.promise},resources:function(){return l.resources.promise},operatingHours:function(){return l.operatingHours.promise}},territories:u,allTerritories:d,getResources:i,operatingHours:h,getOperatingHours:n,getCapacityBasedResources:r,getCrewResources:s,getCrewToResources:a,contractorResources:p,crewResources:g,crewToResources:m,getResourceAndTerritories:o,reset:c}}e.$inject=["$q","sfdcService"],angular.module("serviceExpert").factory("ResourcesAndTerritoriesService",e)}(),function(){function e(e,t,i,n,r,s,a,o,c,l,u,d,v,p){function h(o){T=e.$new(!0),T.lightboxService=t.serviceAppointments()[o],T.selectedTab="service",T.urls={service:i.trustAsResourceUrl(customLightboxPage+"?id="+o).toString()},T.lightboxService.accountId&&(T.urls.account=i.trustAsResourceUrl(customAccountLightbox+"?id="+T.lightboxService.accountId).toString()),T.urls.service_chatter=i.trustAsResourceUrl(customServiceChatterLightbox+"?id="+T.lightboxService.id).toString(),T.lightboxService.parentRecordType===s.WORKORDER?(T.urls.wo=i.trustAsResourceUrl(customWoLightbox+"?id="+T.lightboxService.parentRecord).toString(),T.urls.wo_chatter=i.trustAsResourceUrl(customWoChatterLightbox+"?id="+T.lightboxService.parentRecord).toString(),T.urls.related=i.trustAsResourceUrl(customWoRelatedLightbox+"?id="+T.lightboxService.parentRecord).toString()):T.lightboxService.parentRecordType===s.LINEITEM?(T.urls.wo=i.trustAsResourceUrl(customWoliLightbox+"?id="+T.lightboxService.parentRecord).toString(),T.urls.wo_chatter=i.trustAsResourceUrl(customWoliChatterLightbox+"?id="+T.lightboxService.parentRecord).toString(),T.urls.related=i.trustAsResourceUrl(customWoliRelatedLightbox+"?id="+T.lightboxService.parentRecord).toString()):T.lightboxService.parentRecordType===s.ACCOUNT?(T.urls.related=null,T.urls.account=i.trustAsResourceUrl(customAccountLightbox+"?id="+T.lightboxService.parentRecord).toString()):T.urls.related=null,T.urls.custom1=CustomServiceTab1?i.trustAsResourceUrl(CustomServiceTab1+"?id="+T.lightboxService.id).toString():null,T.urls.custom2=CustomServiceTab2?i.trustAsResourceUrl(CustomServiceTab2+"?id="+T.lightboxService.id).toString():null,T.changeTab=y,T.isChatterAvailable=m,T.closeLightbox=b,T.chatterAvailable=fieldTrackingEnabled.service,T.openConsoleTab=r.openConsoleTab,T.isMapEnabled=a.isMapEnabled(),T.selectedSubTabWo="details",T.selectedSubTabService="details",T.showWOTab=f,T.getIdOfObjectInActiveTab=g,T.isMapEnabled&&S(),T.$on("$destroy",function(){return c.remove()}),T.$on("keypress",function(e,t){27==t.which&&T.$evalAsync(T.closeLightbox)});var c=_();c.find("#ServiceLightbox").draggable({handle:"#ServiceLightboxHeader"}),a.setLightBoxStatus(),n(c)(T),r.safeApply(T,function(){angular.element("body").append(c)})}function g(){switch(T.selectedTab){case"account":return T.lightboxService.accountId?T.lightboxService.accountId:T.lightboxService.id;case"wo":return T.lightboxService.parentRecord?T.lightboxService.parentRecord:T.lightboxService.id;default:return T.lightboxService.id}}function m(e){return"wo"===e&&"WorkOrder"===T.lightboxService.parentRecordType&&fieldTrackingEnabled.workorder?!0:"wo"===e&&"WorkOrderLineItem"===T.lightboxService.parentRecordType&&fieldTrackingEnabled.woli?!0:"service"===e&&fieldTrackingEnabled.service?!0:!1}function f(e){return e===s.LINEITEM||e===s.WORKORDER}function S(){function e(e){var t=e.type;switch(T.serviceInfoWindow.show=!1,T.livePosInfoWindow.show=!1,T.currentMarker=e,t){case"service":T.serviceInfoWindow.show=!0;break;case"lastKnownPosition":T.livePosInfoWindow.show=!0}o(function(){T.$apply(),r.setMapCloseButtonPosition()},0)}function t(){var e=u.lastKnownPositions();for(var t in e)i(e[t])}function i(e){var t=d.getResources()[e.id],i={id:e.id+"_position",icon:staticResources.livepos_png,type:"lastKnownPosition",resourceId:e.id,coords:{latitude:e.latitude,longitude:e.longitude},item:angular.extend(angular.copy(e),{resourceName:t.name})};T.allMarkersArray.push(i)}if(T.serviceIcon=staticResources.wo_icon_png,T.resourceIcon=lsdIcons.user,T.lastSeenLabel=customLabels.Last_seen,T.getServiceInfoRowClass=r.getServiceInfoRowClass,T.currentMarker={},T.map=null,T.mapControl={},T.allMarkersArray=[],T.mapOptions={zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP}},T.infoWindowOptions={service:{pixelOffset:new google.maps.Size(0,-38)},livePos:{pixelOffset:new google.maps.Size(0,-38)}},T.serviceInfoWindow={show:!1},T.livePosInfoWindow={show:!1},l.fieldsSetFields().then(function(e){T.serviceFields=e.MapInfo}),null!=T.lightboxService.latitude&&null!=T.lightboxService.longitude)var n=c(function(){if(!T.mapControl||T.mapControl.getGMap){c.cancel(n),T.map=T.mapControl.getGMap();var e=staticResources.service_png;T.lightboxService.statusCategory==p.COMPLETED&&(e=staticResources.service_completed_png),T.allMarkersArray.push({id:T.lightboxService.id,icon:e,type:"service",coords:{latitude:T.lightboxService.latitude,longitude:T.lightboxService.longitude},item:T.lightboxService}),t();var i=new google.maps.LatLng(T.lightboxService.latitude,T.lightboxService.longitude);T.map.setCenter(i)}},500);T.openLink=function(e,t){r.openLink(e,t)},T.markerCloseClicked=function(){T.serviceInfoWindow.show=!1,T.livePosInfoWindow.show=!1,T.$apply()},T.markerClicked=function(t,i,n){e(n)},T.killWatch=T.$watch("selectedTab",function(e){"map"==e&&o(function(){google.maps.event.trigger(T.map,"resize")},0)})}function b(){a.setLightBoxStatus(!1),T.killWatch&&T.killWatch(),T.$destroy()}function y(e){e!==T.selectedTab&&(T.selectedTab=e)}function _(){return angular.element('<div class="LightboxBlackContainer">\n                <div class="LightboxContainer" id="ServiceLightbox">\n\n                    <div class="lightboxHeaderContainer" id="ServiceLightboxHeader">\n\n                        <svg ng-click="closeLightbox()" aria-hidden="true" class="slds-icon CloseLightbox">\n                                \u2028<use xlink:href="'+lsdIcons.close+'"></use>\n                            \u2028</svg>\n\n                        <h1 class="lightboxHeader">{{lightboxService.name}}</h1>\n\n                        <span ng-click="changeTab(\'service\')" ng-class="{lightboxSelectedTab: selectedTab == \'service\'}">\n                            '+customLabels.Service+'\n                        </span>\n\n                        <span ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-click="changeTab(\'wo\')" ng-class="{lightboxSelectedTab: selectedTab == \'wo\'}">\n                            <div ng-show="lightboxService.parentRecordType === \'WorkOrder\'">'+customLabels.WorkOrder+"</div>\n                            <div ng-show=\"lightboxService.parentRecordType === 'WorkOrderLineItem'\">"+customLabels.Woli+'</div>\n                        </span>\n\n                        <span ng-show="urls.related" ng-click="changeTab(\'relatedList\')" ng-class="{lightboxSelectedTab: selectedTab == \'relatedList\'}">\n                            '+customLabels.Related+'\n                        </span>\n\n                        <span ng-if="isMapEnabled" ng-show="lightboxService.latitude && lightboxService.longitude" ng-click="changeTab(\'map\')" ng-class="{lightboxSelectedTab: selectedTab == \'map\'}">\n                            '+customLabels.Map+'\n                        </span>\n\n                        <span ng-show="urls.account" ng-click="changeTab(\'account\')" ng-class="{lightboxSelectedTab: selectedTab == \'account\'}">\n                            '+customLabels.Account+'\n                        </span>\n                        \n                        <span ng-show="urls.custom1" ng-click="changeTab(\'customTab1\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab1\'}">\n                            '+customLabels.CustomServiceTab1+'\n                        </span>\n                        \n                        <span ng-show="urls.custom2" ng-click="changeTab(\'customTab2\')" ng-class="{lightboxSelectedTab: selectedTab == \'customTab2\'}">\n                            '+customLabels.CustomServiceTab2+'\n                        </span>\n\n                        <div class="ExtendedForm">\n                            <a ng-click="openConsoleTab($event,getIdOfObjectInActiveTab())" target="_blank" href="../{{ getIdOfObjectInActiveTab() }}" title="'+customLabels.ExtandedForm+'">\n                                <svg aria-hidden="true" class="slds-icon openExternalIcon">\n                                    \u2028<use xlink:href="'+lsdIcons.external+'"></use>\n                                \u2028</svg>\n                            </a>\n                        </div>\n\n                    </div>\n                   \n                    <div class="InnerWoTabs" ng-show="isChatterAvailable(\'service\') && selectedTab == \'service\'">\n                        <div class="InnerLightboxTab" ng-class="{\'selected\': selectedSubTabService == \'details\'}" ng-click="selectedSubTabService=\'details\'"}">'+customLabels.Details+"</div>\n                        <div class=\"InnerLightboxTab\" ng-class=\"{'selected': selectedSubTabService == 'feed'}\" ng-click=\"selectedSubTabService='feed'\">"+customLabels.Feed+'</div>\n                        <div class="InnerLightboxHr"></div>\n                    </div>\n                    \n                    <div class="InnerWoTabs" ng-show="isChatterAvailable(\'wo\') && selectedTab == \'wo\'">\n                        <div class="InnerLightboxTab" ng-class="{\'selected\': selectedSubTabWo == \'details\'}" ng-click="selectedSubTabWo=\'details\'"}">'+customLabels.Details+"</div>\n                        <div class=\"InnerLightboxTab\" ng-class=\"{'selected': selectedSubTabWo == 'feed'}\" ng-click=\"selectedSubTabWo='feed'\">"+customLabels.Feed+'</div>\n                        <div class="InnerLightboxHr"></div>\n                    </div>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'wo\' && selectedSubTabWo == \'details\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'wo\')}" ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-src="{{ urls.wo }}"></iframe>\n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'wo\' && selectedSubTabWo == \'feed\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'wo\')}" ng-if="lightboxService.parentRecord && showWOTab(lightboxService.parentRecordType)" ng-src="{{ urls.wo_chatter }}"></iframe>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'service\' && selectedSubTabService == \'details\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'service\')}"  ng-src="{{ urls.service }}"></iframe>\n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'service\' && selectedSubTabService == \'feed\'" ng-class="{\'SubTabsIframe\' : isChatterAvailable(\'service\')}"  ng-src="{{ urls.service_chatter }}"></iframe>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'relatedList\' && urls.related" ng-src="{{ urls.related }}"></iframe>  \n                    <iframe onLoad="removeLightboxLoading()" ng-show="selectedTab == \'account\' && urls.account" ng-src="{{ urls.account }}"></iframe>\n                    \n                    <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom1" ng-show="selectedTab == \'customTab1\'" ng-src="{{ urls.custom1 }}"></iframe>\n                    <iframe onLoad="removeLightboxLoading()" ng-if="urls.custom2" ng-show="selectedTab == \'customTab2\'" ng-src="{{ urls.custom2 }}"></iframe>\n                    \n                    \n                    \n                    <div id="lightbox-loading-cover">\n                        <img src="'+lsdIcons.spinnerGif+'" />\n                        '+customLabels.loading+'\n                    </div>\n                    \n                    \n                    \n\n                    <section ng-if="isMapEnabled" id="serviceLightboxMap" ng-show ="selectedTab == \'map\'">\n                        <ui-gmap-google-map pan="false" control="mapControl" center="{latitude: 0 ,longitude: 0}" options="mapOptions" zoom="16" class="map-canvas">\n                            <ui-gmap-markers click="markerClicked" models="allMarkersArray" idKey="id" coords="\'coords\'" icon="\'icon\'">\n                            </ui-gmap-markers>\n\n                            <ui-gmap-window show="serviceInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.service" >\n                                    <div class="googleMapInfoWindowService">\n                                        <img class="mapTooltipIcon" ng-src="{{serviceIcon}}"/>\n                                        <h1 class="truncate mapTooltipTitle">{{currentMarker.item | displayFieldSetField : serviceFields[0] }}</h1>\n\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[1] || serviceFields[1]">{{serviceFields[1].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[1])" ng-class="getServiceInfoRowClass(serviceFields[1])">{{currentMarker.item | displayFieldSetField : serviceFields[1]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[2] || serviceFields[2]">{{serviceFields[2].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[2])" ng-class="getServiceInfoRowClass(serviceFields[2])">{{currentMarker.item | displayFieldSetField : serviceFields[2]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[3] || serviceFields[3]">{{serviceFields[3].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[3])" ng-class="getServiceInfoRowClass(serviceFields[3])">{{currentMarker.item | displayFieldSetField : serviceFields[3]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[4] || serviceFields[4]">{{serviceFields[4].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[4])" ng-class="getServiceInfoRowClass(serviceFields[4])">{{currentMarker.item | displayFieldSetField : serviceFields[4]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[5] || serviceFields[5]">{{serviceFields[5].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[5])" ng-class="getServiceInfoRowClass(serviceFields[5])">{{currentMarker.item | displayFieldSetField : serviceFields[5]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[6] || serviceFields[6]">{{serviceFields[6].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[6])" ng-class="getServiceInfoRowClass(serviceFields[6])">{{currentMarker.item | displayFieldSetField : serviceFields[6]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[7] || serviceFields[7]">{{serviceFields[7].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[7])" ng-class="getServiceInfoRowClass(serviceFields[7])">{{currentMarker.item | displayFieldSetField : serviceFields[7]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[8] || serviceFields[8]">{{serviceFields[8].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[8])" ng-class="getServiceInfoRowClass(serviceFields[8])">{{currentMarker.item | displayFieldSetField : serviceFields[8]}}</span></div>\n                                        <div ng-show="$parent.$parent.$parent.serviceFields[9] || serviceFields[9]">{{serviceFields[9].Label}}: <span ng-click="$parent.$parent.$parent.openLink($parent.$parent.$parent.currentMarker.item, $parent.$parent.$parent.serviceFields[9])" ng-class="getServiceInfoRowClass(serviceFields[9])">{{currentMarker.item | displayFieldSetField : serviceFields[9]}}</span></div>\n\n                                    </div>\n                            </ui-gmap-window>\n\n                            <ui-gmap-window show="livePosInfoWindow.show" closeClick="markerCloseClicked()" coords="currentMarker.coords" options="infoWindowOptions.livePos">\n                                <div class="googleMapInfoWindowLivePos">\n                                    <svg aria-hidden="true" class="slds-icon livePosTooltipIcon">\n                                    \u2028	<use xlink:href="{{resourceIcon}}"></use>\n                                \u2028	</svg>\n                                    <h1 class="truncate mapTooltipTitle" ng-bind="$parent.$parent.$parent.currentMarker.item.resourceName"></h1>\n                                    <div>{{lastSeenLabel}} {{ currentMarker.item.lastModifiedDate | amDateFormat:\'lll\' }}</div>\n                                </div>\n                            </ui-gmap-window>\n                        </ui-gmap-google-map>\n                    </section>\n\n                </div>\n            </div>')}var T=null;return{open:h}}e.$inject=["$rootScope","TimePhasedDataService","$sce","$compile","utils","PARENT_RECORD_TYPE","StateService","$timeout","$interval","FieldSetFieldsService","LastKnownPositionService","ResourcesAndTerritoriesService","SERVICE_STATUS","SERVICE_CATEGORY"],angular.module("serviceExpert").factory("ServiceAppointmentLightboxService",e)}(),function(){function e(e,t,i,n,r,s,a){function o(t,i,n,r){var s=r&&r[i.selectedFilter]&&r[i.selectedFilter].old;return useNewFilters&&!s?e("servicesListFilterNew")(t,i,n):e("servicesListFilter")(t,i,n,r)}function c(){for(var e in g)g[e]=!1}function l(){S=o(i.serviceAppointments(),m,f,a.getFilterMap());for(var e=0;e<S.length;e++)g[S[e].id]=!0}function u(){c();var e=angular.copy(m);e.selectedFilter="Violating","Custom filter"==m.selectedFilter&&(e.endDate=m.advancedFilter.maxDate),S=o(i.serviceAppointments(),m,f,a.getFilterMap()),S=o(S,e,f,a.getFilterMap());for(var t=0;t<S.length;t++)g[S[t].id]=!0}function d(){c();var e=angular.copy(m);e.selectedFilter="inJeopardy","Custom filter"==m.selectedFilter&&(e.endDate=m.advancedFilter.maxDate),S=o(i.serviceAppointments(),m,f,a.getFilterMap()),S=o(S,e,f,a.getFilterMap());for(var t=0;t<S.length;t++)g[S[t].id]=!0}function v(){c();var e=angular.copy(m);e.selectedFilter="Unscheduled","Custom filter"==m.selectedFilter&&(e.endDate=m.advancedFilter.maxDate),S=o(i.serviceAppointments(),m,f,a.getFilterMap()),S=o(S,e,f,a.getFilterMap());for(var t=0;t<S.length;t++)g[S[t].id]=!0}function p(){var e=0;for(var t in g)g[t]&&e++;return e}function h(){var e=[];for(var t in g)g[t]&&e.push(t);return e}var g={},m=t.filter,f=[],S={};return s.register("services",function(e){e.deleted&&e.deleted.forEach(function(e){return delete g[e]})}),n.getServiceListFields().then(function(e){f=e}),{SelectedServices:g,unselectAll:c,selectAll:l,selectViolations:u,selectInJeopardy:d,selectUnscheduled:v,countSelectedServices:p,getSelected:h}}e.$inject=["$filter","servicesService","TimePhasedDataService","sfdcService","DeltaService","RegisterService","GanttFilterService"],angular.module("serviceExpert").factory("ServiceSelectorService",e)}(),function(){function e(e,t,i){function n(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=i.getResources()[e];Array.isArray(t)||(t=[t]);for(var a=0,o=t.length;o>a;a++){if(!s.skills[t[a]])return!1;if(n&&r&&!isIntersect(n,r,s.skills[t[a]].effectiveStartDate,s.skills[t[a]].effectiveEndDate))return!1}return!0}var r=[],s={skills:e.defer()};return t.getSkills().then(function(e){for(var t=0;t<e.length;t++)r.push(e[t]);s.skills.resolve(r)})["catch"](function(e){s.skills.reject(e),console.log(e),console.warn("unable to get skill list")}),{skills:r,doesHaveSkills:n,promises:{skills:function(){return s.skills.promise}}}}e.$inject=["$q","sfdcService","ResourcesAndTerritoriesService"],angular.module("serviceExpert").factory("SkillsService",e)}(),function(){function e(e,t,i){function n(){return!0}function r(){return contractorSupport}function s(){return mapMode}function a(){return-1!=window.navigator.userAgent.indexOf("Mac OS X")}function o(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!0;_=e}function c(){return _}function l(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!0;T=e}function u(){return T}function d(e){C=e}function v(){return C}var p={};if(i.GetUserSettingsProperty("Toggled_Territories__c")){var h=JSON.parse(i.GetUserSettingsProperty("Toggled_Territories__c"));for(var g in h)p[g]=h[g]}var m={policies:e.defer()},f=userLocale?userLocale.split("_")[0]:"en",S=function(){return"undefined"!=typeof sforce?sforce.console.isInConsole():null},b=[],y=null,_=!1;t.getPolicies().then(function(e){b.push.apply(b,_toConsumableArray(e)),b.length>0?m.policies.resolve(b):m.policies.reject("no policies found")})["catch"](function(e){m.policies.reject(e)});var T=!1,w={},L=!1,C=!1;return{isOptimizationEnabled:isOptimizationEnabled,lang:f,isOSX:a,isInConsole:S,policies:b,selectedPolicyId:y,areContractorsSupported:r,isMapEnabled:s,setLightBoxStatus:l,isLightboxOpened:u,setBulkActionRunning:o,isBulkActionRunning:c,schedulingRunningFor:w,isScheduleRunning:L,ganttOpenedTerritories:p,areCrewsSupported:n,getStreamingActiveState:v,setStreamingActiveState:d,promises:{policies:function(){return m.policies.promise}}}}e.$inject=["$q","sfdcService","userSettingsManager"],angular.module("serviceExpert").factory("StateService",e)}(),function(){function e(e,t,i,n,r,s,a){function o(e){if(L||(L=!0,setTimeout(function(){var e=c();u(),l(e)},0)),e.channel.indexOf("AbsencesTopic")>-1)try{return void("deleted"==e.data.event.type?C.add(e.data.sobject.Id):k.add(e.data.sobject.Id))}catch(t){console.log("Streaming API failure : "+t)}if(e.channel.indexOf("ServicesTopic")>-1)try{return void("deleted"==e.data.event.type?D.add(e.data.sobject):A.add(e.data.sobject.Id))}catch(t){console.log("Streaming API failure : "+t)}if(e.channel.indexOf("CapacitiesTopic")>-1)try{return void("deleted"==e.data.event.type?R.add(e.data.sobject):I.add(e.data.sobject.Id))}catch(t){console.log("Streaming API failure : "+t)}if(e.channel.indexOf("LivePositionsTopic")>-1)try{return void F.add(e.data.sobject.Id)}catch(t){console.log("Streaming API failure : "+t)}if(e.channel.indexOf("AssignedResourcesTopic")>-1)try{return void x.add(e.data.sobject.Id)}catch(t){console.log("Streaming API failure : "+t)}if(e.channel.indexOf("OptReqTopic")>-1)try{return void M.add(e.data.sobject.Id)}catch(t){console.log("Streaming API failure : "+t)}if(e.channel.indexOf("TimeDependencyTopic")>-1)try{return void("deleted"==e.data.event.type?O.add(e.data.sobject.Id):(A.add(e.data.sobject[fieldNames.TimeDependency.ServiceAppointment1]),A.add(e.data.sobject[fieldNames.TimeDependency.ServiceAppointment2])))}catch(t){console.log("Streaming API failure : "+t)}}function c(){var e={};return e.deletedAbsencesArray=Array.from(C),e.updatedAbsencesArray=Array.from(k),e.deletedGanttServicesArray=Array.from(D),e.updatedGanttServicesArray=Array.from(A),e.deletedCapacitiesArray=Array.from(R),e.updatedCapacitiesArray=Array.from(I),e.resourcesIdsArray=Array.from(F),e.updatedAssignResourceArray=Array.from(x),e.updatedOptimizationRequestArray=Array.from(M),e.deletedTimeDependencyArray=Array.from(O),e}function l(t){var i=[];0!=t.updatedOptimizationRequestArray.length&&i.push(v(t.updatedOptimizationRequestArray)),0!=t.updatedAssignResourceArray.length&&i.push(p(t.updatedAssignResourceArray)),0!=t.resourcesIdsArray.length&&i.push(m(t.resourcesIdsArray)),0!=t.updatedCapacitiesArray.length&&i.push(g(t.updatedCapacitiesArray)),(0!=t.updatedGanttServicesArray.length||0!=t.deletedTimeDependencyArray.length)&&i.push(S(t.updatedGanttServicesArray,t.deletedTimeDependencyArray)),0!=t.updatedAbsencesArray.length&&i.push(b(t.updatedAbsencesArray)),0!=t.deletedAbsencesArray.length&&i.push(y(t.deletedAbsencesArray)),0!=t.deletedGanttServicesArray.length&&f(t.deletedGanttServicesArray),0!=t.deletedCapacitiesArray.length&&h(t.deletedCapacitiesArray),0!=i.length&&e.all(i).then(function(e){e.forEach(function(e){d(e)})})}function u(){L=!1,C.clear(),k.clear(),D.clear(),A.clear(),R.clear(),I.clear(),F.clear(),x.clear(),M.clear(),O.clear()}function d(e){e&&e.length>0&&w.rules.forEach(function(t){return t(e)})}function v(i){var n=e.defer();return t.getOptimiztionRequestsUpdate(i).then(function(e){s.isOptimizationEnabled&&e&&e.length>0&&w.optimizationRequests.forEach(function(t){return t(e)}),n.resolve()}),n.promise}function p(i){var r=e.defer();return t.getGanttServiceOnAssignedResourceUpdate(i).then(function(e){var t=[];if(e&&e.length>0){var i={};e.length>0&&(i.updated=n.updateTimePhaseData(e,"service").services,t.push.apply(t,_toConsumableArray(a.getRelatedServices(a.getIdsOfSObjects(i.updated))))),i.updated&&w.services.forEach(function(e){return e(i)})}r.resolve(t)}),r.promise}function h(e){if(e&&e.length>0){var t={};t.deleted=n.deleteTimePhaseData(e,"capacity").capacities,t.deleted&&w.capacities.forEach(function(e){return e(t)})}}function g(i){var r=e.defer();return t.getUpdatedResourceCapacities(i).then(function(e){if(e&&e.length>0){var t={};t.updated=n.updateTimePhaseData(e,"capacity").capacities,t.updated&&w.capacities.forEach(function(e){return e(t)})}r.resolve()}),r.promise}function m(i){var n=e.defer();return t.getLivePositionsStreaming(i).then(function(e){var t=r.updatePositions(e);t.isUpdated&&w.positions.forEach(function(e){return e(t.dic)}),n.resolve()}),n.promise}function f(e){var t=[];if(e&&e.length>0){var i={};i.deleted=n.deleteTimePhaseData(e,"service").services,t.push.apply(t,_toConsumableArray(a.getRelatedServices(i.deleted))),i.deleted&&w.services.forEach(function(e){return e(i)}),t.length>0&&w.rules.forEach(function(e){return e(t)})}}function S(i,r){var s=e.defer();return t.getUpdatedServices(i,r).then(function(e){var t=[];if(e&&e.length>0){var i={};e.length>0&&(i.updated=n.updateTimePhaseData(e,"service").services,t.push.apply(t,_toConsumableArray(a.getRelatedServices(a.getIdsOfSObjects(i.updated))))),i.updated&&w.services.forEach(function(e){return e(i)})}s.resolve(t)}),s.promise}function b(i){var r=e.defer();return t.getUpdatedAbsences(i).then(function(e){var t=[],i={};if(e.length>0){i.updated=n.updateTimePhaseData(e,"na").absences;var s=i.updated.map(function(e){return e.resource}).join(",");t.push.apply(t,_toConsumableArray(a.getRelatedServices(a.getIdsOfSObjects(i.updated),s))),(i.updated||i.deleted)&&w.absences.forEach(function(e){return e(i)})}r.resolve(t)}),r.promise}function y(i){var r=e.defer();return t.getDeletedAbsences(i).then(function(e){var t=[],i={};e.length>0&&(i.deleted=n.deleteTimePhaseData(e,"na").absences,t.push.apply(t,_toConsumableArray(a.getRelatedServices(i.deleted))),(i.updated||i.deleted)&&w.absences.forEach(function(e){return e(i)})),r.resolve(t)}),r.promise}function _(e,t){return w[e]&&w[e].push(t)}function T(e,t){w[e].splice(w[e].indexOf(t),1)}var w={services:[],absences:[],capacities:[],positions:[],optimizationRequests:[],rules:[]},L=!1,C=new Set,k=new Set,D=new Set,A=new Set,R=new Set,I=new Set,F=new Set,x=new Set,M=new Set,O=new Set;return{HandleNotification:o,register:_,unRegister:T}}e.$inject=["$q","sfdcService","$interval","TimePhasedDataService","LastKnownPositionService","StateService","utils"],angular.module("serviceExpert").factory("StreamingAPIService",e)}(),function(){function e(e,t,i,n,r){function s(e){var t="/topic/"+e,i=new cometdReplayExtension;i.setChannel(t),i.setReplay(c),$.cometd.registerExtension(e,i),u.push(i)}function a(){$.cometd.addListener("/meta/handshake",function(e){if(e.successful){console.log("Handshake successful!");for(var i=0;i<l.length;i++)s(l[i]),$.cometd.subscribe("/topic/"+l[i],t.HandleNotification,function(e){console.log(e),e.successful});n.setStreamingActiveState(!0)}else n.setStreamingActiveState(!1),r.getDelta(),console.warn("Handshake! error: "+e.error)}),$.cometd.addListener("/meta/connect",function(e){e.successful?n.setStreamingActiveState(!0):(console.warn("disconnected! error: "+e.error),console.log(e),n.setStreamingActiveState(!1),r.getDelta())});i.connectToPush()}function o(){try{1==n.getStreamingActiveState()?a():i.connectToPush()}catch(e){console.log(e)}}var c=-1,l=["ServicesTopic","AbsencesTopic","AssignedResourcesTopic","LivePositionsTopic","CapacitiesTopic","OptReqTopic","TimeDependencyTopic"],u=[];return{initStreaming:o}}e.$inject=["$q","StreamingAPIService","MstResolver","StateService","DeltaService"],angular.module("serviceExpert").factory("StreamingClientResolverService",e)}(),function(){function e(e,t,i,n,r){function s(e){return x[n.formatDayToString(e)]}function a(e,t){var i=!1;for(var n in T[e]){var r=T[e][n];isIntersect(t,t,r.effectiveStartDate,r.effectiveEndDate)&&(i=!0)}return i}function o(i,r){var s=e.defer();i.setDate(i.getDate()-window.daysToLoadOnGanttInit),r.setDate(r.getDate()+window.daysToLoadOnGanttInit),(0!==i.getMinutes()||0!==i.getHours())&&(i.setHours(0),i.setMinutes(0)),(0!==r.getMinutes()||0!==r.getHours())&&(r.setHours(0),r.setMinutes(0),r.setDate(r.getDate()+1));for(var a=!1,o=new Date(i);r>o;o.setDate(o.getDate()+1))if("undefined"==typeof x[n.formatDayToString(o)]){a=!0;break}if(!a)return s.resolve(),s.promise;var l=e.defer(),u=e.defer(),d=[];return c(l,i,r,!0,null,null,d),c(u,i,r,!1,null,null),e.all([u.promise,l.promise]).then(function(e){Object.keys(d).length>0&&t.$broadcast("timePhasedObjectsCheckRules",d),s.resolve(e)}),s.promise}function c(e,t,r,s,a,c,u){i.GetTimePhasedObjects(t,r,s,a,c).then(function(i){l(e,s,t,r,i,u);
})["catch"](function(e){return 0===_.initialPhasedData.promise.$$state.status&&_.initialPhasedData.reject(e),console.warn("GetTimePhasedObjects: something went wrong "+e.message),n.addNotification(customLabels.Action_Could_Not_Be_Performed,e.message||customLabels.user_is_not_allowed_to_perform_action),0===numberOfAllowedRecoveries?void console.log("maximum allowed times to recover reached"):(numberOfAllowedRecoveries--,s?(maxServicesToLoadEachBulkInGantt=Math.round(maxServicesToLoadEachBulkInGantt/2),console.log("%c getTimePhasedObjects - ENTERING RECOVERY MODE - NOW LOADING: "+maxServicesToLoadEachBulkInGantt+" SERVICES","background: #222; color: #bada55")):(maxAbsencesToLoadEachBulkInGantt=Math.round(maxAbsencesToLoadEachBulkInGantt/2),console.log("%c getTimePhasedObjects - ENTERING RECOVERY MODE - NOW LOADING: "+maxAbsencesToLoadEachBulkInGantt+" ABSENCES","background: #222; color: #bada55")),void o(t,r))})}function l(e,i,s,a,o,l){for(var d=r.get("monthlyViewHelperService"),v={resourcesAndTerritories:{},resourcesByPrimariesAndRelocations:{},resourceOperatingHours:{},serviceAppointments:{},resourceAbsences:{},resourceCapacities:{},serviceCrewMembers:{},start:s,finish:a},p=new Date(s);a>p;p.setDate(p.getDate()+1))x[n.formatDayToString(p)]=!0;if(0===_.initialPhasedData.promise.$$state.status&&_.initialPhasedData.resolve(),o.resourcesAndTerritories.forEach(function(e){var t=new ResourcesAndTerritories(e);T[t.serviceResource]=T[t.serviceResource]||{},T[t.serviceResource][t.id]=t,v.resourcesAndTerritories[t.serviceResource]=v.resourcesAndTerritories[t.serviceResource]||{},v.resourcesAndTerritories[t.serviceResource][t.id]=t,"S"!==t.serviceTerritoryType&&(w[t.serviceResource]=w[t.serviceResource]||{},w[t.serviceResource][t.id]=t,v.resourcesByPrimariesAndRelocations[t.serviceResource]=v.resourcesByPrimariesAndRelocations[t.serviceResource]||{},v.resourcesByPrimariesAndRelocations[t.serviceResource][t.id]=t)}),o.services.forEach(function(e){var t=new GanttService(e);(!L[t.id]||L[t.id].isChanged(t)||L[t.id].isChainChanged(t))&&(L[e.Id]=t,v.serviceAppointments[e.Id]=t,l.push(t.id),(monthlyViewSettings.isMonthlyAvailable&&!scheduler._events[t.id]||scheduler._events[e.Id])&&d.updateMonthlyCapacity(t))}),o.resourceAbsences.forEach(function(e){C[e.Id]&&e.LastModifiedDate===C[e.Id].lastModifiedDate||(C[e.Id]=new ResourceAbsence(e),v.resourceAbsences[e.Id]=C[e.Id],d.updateMonthlyCapacity(C[e.Id]))}),o.resourceCapacities.forEach(function(e){k[e.Id]&&e.LastModifiedDate===k[e.Id].lastModifiedDate||(k[e.Id]=new ResourceCapacity(e),useLocationTimezone||u(k[e.Id]),v.resourceCapacities[e.Id]=k[e.Id])}),o.serviceCrewMembers.forEach(function(e){D[e.Id]=new ServiceCrewMember(e),A[D[e.Id].serviceResource]||(A[D[e.Id].serviceResource]={}),R[D[e.Id].serviceCrew]||(R[D[e.Id].serviceCrew]={}),R[D[e.Id].serviceCrew][e.Id]=D[e.Id],A[D[e.Id].serviceResource][e.Id]=D[e.Id],v.serviceCrewMembers[e.Id]=D[e.Id]}),t.$broadcast("gotNewTimePhasedObjects",v),i&&o.services.length===maxServicesToLoadEachBulkInGantt){var h=o.services[o.services.length-1].Id;c(e,s,a,i,h,null,l)}else if(i||o.resourceAbsences.length!==maxAbsencesToLoadEachBulkInGantt)e.resolve();else{var g=o.resourceAbsences[o.resourceAbsences.length-1].Id;c(e,s,a,i,null,g)}}function u(e){var t=n.getUserOffset(e.start_date),i=n.getUserOffset(e.end_date),r=m(e,e.resource);e.start_date=e.start_date.setMinutes(e.start_date.getMinutes()+t-r),e.end_date=e.end_date.setMinutes(e.end_date.getMinutes()+i-r)}function d(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1,n=r.get("monthlyViewHelperService"),s=r.get("GanttPalettesService"),a={absences:[],services:[],capacities:[]};return Array.isArray(e)||(e=[e]),e.forEach(function(e){if("na"===t){if(i||C[e.Id]&&e.LastModifiedDate===C[e.Id].lastModifiedDate)return;C[e.Id]=new ResourceAbsence(e),a.absences.push(C[e.Id]),n.updateMonthlyCapacity(C[e.Id])}if("service"===t){var r=new GanttService(e);s.updateGanttServicePaletteColor(r),(i||!L[r.id]||L[r.id].isChanged(r)||L[r.id].isChainChanged(r))&&(L[e.Id]=r,a.services.push(r),scheduler._events[r.id]&&scheduler._events[r.id].violations&&r.isScheduled()&&(r.violations=scheduler._events[r.id].violations),(monthlyViewSettings.isMonthlyAvailable&&!scheduler._events[r.id]||scheduler._events[e.Id])&&n.updateMonthlyCapacity(r))}if("capacity"===t){if(k[e.Id]&&e.LastModifiedDate===k[e.Id].lastModifiedDate)return;k[e.Id]=new ResourceCapacity(e),useLocationTimezone||u(k[e.Id]),a.capacities.push(k[e.Id])}if("stm"===t){var o=new ResourcesAndTerritories(e);T[o.serviceResource]=T[o.serviceResource]||{},T[o.serviceResource][o.id]=o,"S"!==o.serviceTerritoryType&&(w[o.serviceResource]=w[o.serviceResource]||{},w[o.serviceResource][o.id]=o)}}),a}function v(e,t){var i=r.get("monthlyViewHelperService"),n={absences:[],services:[],capacities:[]};return Array.isArray(e)||(e=[e]),e.forEach(function(e){"na"===t?(C[e.Id]&&(C[e.Id].isDeleted=!0),C[e.Id]&&i.updateMonthlyCapacity(C[e.Id]),delete C[e.Id],n.absences.push(e.Id)):"service"===t?(L[e.Id]&&(L[e.Id].isDeleted=!0),i.updateMonthlyCapacity(L[e.Id]),delete L[e.Id],n.services.push(e.Id)):"capacity"===t&&(delete k[e.Id],n.capacities.push(e.Id))}),n}function p(){T={},w={},L={},C={},k={},D={},I={},A={},R={},x={}}function h(e,t){for(var i in T[e]){var r=T[e][i];if(r.effectiveStartDate<=t&&t<=r.effectiveEndDate&&"R"===r.serviceTerritoryType)return n.generateResourceId(e,r.serviceTerritory)}var s=[];for(var a in T[e]){var o=T[e][a];if(!showSecondarySTMs&&o.effectiveStartDate<=t&&t<=o.effectiveEndDate&&"P"===o.serviceTerritoryType)return n.generateResourceId(e,o.serviceTerritory);o.effectiveStartDate<=t&&t<=o.effectiveEndDate&&s.push(o.serviceTerritory)}return s.length>0?n.generateResourceId(e,s):null}function g(e,t,i){for(var r in T[e]){var s=T[e][r];if(s.effectiveStartDate<=t&&t<=s.effectiveEndDate&&"R"===s.serviceTerritoryType)return n.generateResourceId(e,s.serviceTerritory)}var a=null,o=null;for(var c in T[e]){var l=T[e][c];l.effectiveStartDate<=t&&t<=l.effectiveEndDate&&"P"===l.serviceTerritoryType&&(o=l.serviceTerritory),l.effectiveStartDate<=t&&t<=l.effectiveEndDate&&l.serviceTerritory===i&&(a=l.serviceTerritory)}return a?n.generateResourceId(e,a):n.generateResourceId(e,o)}function m(e,t){var i=T[t],r=null;for(var s in i){var a=i[s];if(isIntersect(a.effectiveStartDate,a.effectiveEndDate,e.start_date,e.end_date)&&(r=a,"R"===a.serviceTerritoryType))break}var o=r&&r.timezone?r.timezone:"GMT";return-moment.tz.zone(o).offset(n.convertDtToMomentDt(e.start_date,o).valueOf())}function f(e){if(e.resourceId){var t=e.resourceId.split("_")[0],i=(e.resourceId.split("_")[1],T[t]);for(var n in i){var r=i[n];if(isIntersect(r.effectiveStartDate,r.effectiveEndDate,e.start_date,e.end_date))return r}}return null}function S(e,t){var i=e.split("_")[0],n=e.split("_")[1],r=T[i]||{};for(var s in r){var a=r[s];if(a.serviceTerritory!==n&&"R"===a.serviceTerritoryType&&isIntersect(a.effectiveStartDate,a.effectiveEndDate,t,t))return!0}return!1}function b(e,t){var i=e.split("_")[0],n=e.split("_")[1],r=T[i]||{};for(var s in r){var a=r[s];if(a.serviceTerritory===n&&"S"===a.serviceTerritoryType&&isIntersect(a.effectiveStartDate,a.effectiveEndDate,t,t))return!0}return!1}function y(e,t){var i=e.split("_")[0],n=(e.split("_")[1],A[i]||{});for(var r in n){var s=n[r];if(isIntersect(s.startDate,s.endDate,t,t))return!0}return!1}var _={initialPhasedData:e.defer()},T={},w={},L={},C={},k={},D={},A={},R={},I={},F=!1,x={};return{resourcesAndTerritories:function(){return T},resourcesByPrimariesAndRelocations:function(){return w},serviceAppointments:function(){return L},resourceAbsences:function(){return C},resourceCapacities:function(){return k},resourceToServiceCrewMembers:function(){return A},crewToServiceCrewMembers:function(){return R},serviceCrewMembers:function(){return D},visitedDates:function(){return x},getRelevantSTMToGanttService:f,getTimePhasedObjects:o,updateTimePhaseData:d,deleteTimePhaseData:v,reset:p,getResoruceGanttIdByDate:h,getResoruceGanttIdByDateAndTerritory:g,getIntersectingSrstOffset:m,didVisitDay:s,isTimephaseAvailable:a,isResourceRelocated:S,isResourceSecondary:b,isResourceCrewMembers:y,isCrewViewActive:F,currentCrewToShow:I,promises:{initialPhasedData:_.initialPhasedData.promise}}}e.$inject=["$q","$rootScope","sfdcService","utils","$injector"],angular.module("serviceExpert").factory("TimePhasedDataService",e)}(),function(){function e(e,t,i){function n(){for(var e in s)s[e]=0}function r(){var r=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),a=0;n();for(var o=i.GetUserSettingsProperty("locations"),c=0;c<r.length;c++){var l=r[c],u=!0;if(showSecondarySTMs&&r[c].resourceId.indexOf(",")>-1){for(var d=r[c].resourceId.split(","),v=null,p=0;p<d.length;p++){var h=d[p].split("_")[1];if(o.indexOf(h)>-1){v=h;break}}if(!v)continue}else if(-1===o.indexOf(r[c].resourceId.split("_")[1]))continue;if("na"===l.type&&(s.avgTravelTime+=l.travelTo+l.travelFrom),"service"===l.type){if(e.areContractorsSupported()&&l.resourceContractor?u=!1:a++,s.total++,l.statusCategory===t.COMPLETED&&s.completed++,l.violations&&s.violations++,l.jeopardy&&s.jeopardy++,u)if(l.isMDT){var g=0;l.mdtTimes.travel.forEach(function(e){scheduler._min_date<=e.Start&&e.Finish<=scheduler._max_date&&(g+=e.Finish-e.Start)}),s.avgTravelTime+=g/1e3}else s.avgTravelTime+=l.travelTo+l.travelFrom;if(l.isMDT){var m=0;l.mdtTimes.working.forEach(function(e){scheduler._min_date<=e.Start&&e.Finish<=scheduler._max_date&&(m+=e.Finish-e.Start)}),s.totalScheduledDuration+=m/1e3}else s.totalScheduledDuration+=(l.finish-l.start)/1e3}}r.length>0&&s.total>0&&a>0?e.areContractorsSupported()?s.avgTravelTime=Math.floor(s.avgTravelTime/60/a):s.avgTravelTime=Math.floor(s.avgTravelTime/60/s.total):s.avgTravelTime=0}var s={total:0,completed:0,violations:0,jeopardy:0,avgTravelTime:0,totalScheduledDuration:0};return{calculateKpis:r,kpis:s}}e.$inject=["StateService","SERVICE_CATEGORY","userSettingsManager"],angular.module("serviceExpert").factory("kpiCalculationsService",e)}(),function(){function e(e,t,i,n,r,s,a,o){function c(e){if(e){e.setGanttResource(r.resourcesAndTerritories(),s.generateResourceId);var t=scheduler._events[e.id],i=null;if((e.resourceId||t)&&(!e.isMDT||e.mdtTimes)){if(t){var n=l(t.eventBeforeDrag||t);t.eventBeforeDrag&&(t.eventBeforeDrag=null),"service"===e.type||"na"===e.type?(i=t.resourceName===e.resourceName?e.resourceId:t.resourceBeforeDrag||t.resourceId,t.resourceBeforeDrag=null):"break"===e.type&&(i=t.resourceId),p(t.id,i,n.travelBeforeSum,"travel",!1),p(t.id,i,n.scheduledObjectSum,t.type,!1),p(t.id,i,n.travelAfterSum,"travel",!1)}if(!e.resourceId||e.isDeleted||e.locationRemovedMe)return void(e.locationRemovedMe&&(e.locationRemovedMe=!1));var a=l(e);p(e.id,e.resourceId,a.travelBeforeSum,"travel"),p(e.id,e.resourceId,a.scheduledObjectSum,e.type),p(e.id,e.resourceId,a.travelAfterSum,"travel")}}}function l(e){if(e.resourceId.indexOf(",")>-1)for(var t=e.resourceId.split(","),i=0;i<t.length;i++)k[t[i]]=k[t[i]]||{};else k[e.resourceId]=k[e.resourceId]||{};var n={start:new Date(e.start_date),finish:new Date(e.start)},r={start:new Date(e.start),finish:new Date(e.finish)},s={start:new Date(e.finish),finish:new Date(e.end_date)};return{travelBeforeSum:e.isMDT?u(e.mdtTimes.travel):u(n.start,n.finish),scheduledObjectSum:e.isMDT?u(e.mdtTimes.working):u(r.start,r.finish),travelAfterSum:e.isMDT?{}:u(s.start,s.finish)}}function u(e,t){var i={};if(!t)return e.forEach(function(e){t=new Date(e.Finish);for(var n=new Date(e.Start);t>n;n=v(n)){var r=v(n);r=r>t?t:r,i[d(n)]?i[d(n)]+=Math.round((r.getTime()-n.getTime())/1e3/60):i[d(n)]=Math.round((r.getTime()-n.getTime())/1e3/60)}}),i;for(var n=new Date(e);t>n;n=v(n)){var r=v(n);r=r>t?t:r,i[d(n)]=Math.round((r.getTime()-n.getTime())/1e3/60)}return i}function d(e){return e.getDate()+"_"+e.getMonth()+"_"+e.getFullYear()}function v(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate()+1,0,0,0,0)}function p(e,t,i,n){for(var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:!0,s=t.split(","),a=0;a<s.length;a++){t=s[a];for(var o in i)if(k[t]=k[t]||{},void 0===k[t][o]&&(k[t][o]=new h),r)k[t][o][n]+=i[o],-1===k[t][o].events.indexOf(e)&&k[t][o].events.push(e);else{k[t][o][n]-=i[o];var c=k[t][o].events.indexOf(e);c>-1&&k[t][o].events.splice(c,1)}}}function h(){this["break"]=0,this.na=0,this.service=0,this.travel=0,this.capacity=-1,this.overtime=0,this.events=[]}function g(t,i){var n=new h,s=null,a=d(i),o=t.key;if(n.capacity=0,contractorSupport&&t.contractor)return n;if(r.isResourceRelocated(o,i))return n;if(r.isResourceCrewMembers(o,i))return n;if(r.isResourceSecondary(o,i))return n;k[o]||(k[o]={}),k[o][a]&&(s=k[o][a]),s||(k[o][a]=new h,s=k[o][a]);var c=C;return e.resourceToWorkingDates[o]&&e.resourceToWorkingDates[o][a]&&(c=e.resourceToWorkingDates[o][a]),s&&(n["break"]+=s["break"],n.na+=s.na>c.regular?c.regular:s.na,n.service+=s.service,n.travel+=s.travel,n.capacity+=c.regular>-1?c.regular:0,n.overtime+=c.overtime),n}function m(t,i){var n=new h,s=d(i);n.capacity=0;for(var a=0;a<t.length;a++){var o=null,c=t[a].key;if(!(contractorSupport&&t[a].contractor||r.isResourceRelocated(c,i)||r.isResourceCrewMembers(c,i)||r.isResourceSecondary(c,i))){k[c]||(k[c]={}),k[c][s]&&(o=k[c][s]),o||(k[c][s]=new h,o=k[c][s]),-1===o.capacity;var l=C;e.resourceToWorkingDates[c]&&e.resourceToWorkingDates[c][s]&&(l=e.resourceToWorkingDates[c][s]),o&&(n["break"]+=o["break"],n.na+=o.na>l.regular?l.regular:o.na,n.service+=o.service,n.travel+=o.travel,n.capacity+=l.regular>-1?l.regular:0,n.overtime+=l.overtime)}}return n}function f(e){var t=0;A.services&&(t+=e.service),A.breaks&&(t+=e["break"]),A.na&&(t+=e.na),A.travel&&(t+=e.travel);var i=A.overtime?e.capacity+e.overtime:e.capacity;if(i>0){var n=t/i;return n=Math.round(100*n)}return null}function S(e,t,i,n){var r=0;A.services&&(r+=e.service),A.breaks&&(r+=e["break"]),A.na&&(r+=e.na),A.travel&&(r+=e.travel);var s=A.overtime?e.capacity+e.overtime:e.capacity;if(s>0){var a=r/s;a=Math.round(100*a);var o="";o=a<=monthlyViewSettings.high?"style='box-shadow: inset 0 -2px 0 rgb(24, 165, 146)'":a>monthlyViewSettings.high&&a<=monthlyViewSettings.critical?"style='box-shadow: inset 0 -2px 0 #FFEB3B'":"style='box-shadow: inset 0 -2px 0 rgb(236, 95, 84)'";var c="";return e.travel/s>monthlyViewSettings.highTravel/100&&(c='<svg aria-hidden="true" class="tooMuchTravel slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>'),"<div "+o+' onmouseout="removeMonthlyLocationTooltip()" onmouseover="createLocationMonthlyTooltip(event,\''+t+"', '"+i+"', '"+n+"')\">"+c+'<div class="monthlyViewHoursContainer">'+a+"%</div></div>"}return""}function b(e){var t=Math.floor(e/60),i=e%60;return 10>i&&(i="0"+i),{hours:t,minutes:i}}function y(e){return e.hours+"h "+e.minutes+"m"}function T(e){return customLabels.Start+": "+moment(e.start).format("llll")+"\n"+(customLabels.Finish+": "+moment(e.finish).format("llll"))}function w(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:C;if(e.service){var n=b(e.service);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.clock+'"></use></svg>\n                        '+y(n)+"\n                        <div>"+customLabels.TotalScheduled+"</div>\n                    </div>"}if(e.travel){var r=b(e.travel);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_travel_icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>\n                        '+y(r)+"\n                        <div>"+customLabels.TotalTravel+"</div>\n                    </div>"}if(e.na){var s=b(e.na);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.na+'"></use></svg>\n                        '+y(s)+"\n                        <div>"+customLabels.TotalNAs+"</div>\n                    </div>"}if(e["break"]){var a=b(e["break"]);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_travel_icon"><use xlink:href="'+lsdIcons.coffee+'"></use></svg>\n                        '+y(a)+"\n                        <div>"+customLabels.TotalBreaks+"</div>\n                    </div>"}e.capacity,e.overtime;if(i.regular){var o=b(i.regular);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.bucket+'"></use></svg>\n                        '+y(o)+"\n                        <div>"+customLabels.TotalCapacity+"</div>\n                    </div>"}if(i.overtime){var c=b(i.overtime);t+='\n                    <div class="monthlyView_tooltipKpi">\n                        <svg aria-hidden="true" class="slds-icon monthly_overtime_icon"><use xlink:href="'+lsdIcons.overtime+'"></use></svg>\n                        '+y(c)+"\n                        <div>"+customLabels.TotalOvertime+"</div>\n                    </div>"}return t}function L(){k={},D={}}var C={regular:0,overtime:0},k={},D={},A={services:!0,na:!0,travel:!0,breaks:!0,overtime:!0};if(o.GetUserSettingsProperty("Utilization_Properties__c")){var R=JSON.parse(o.GetUserSettingsProperty("Utilization_Properties__c"));for(var I in R)A[I]=R[I]}return scheduler.attachEvent("onSchedulerReady",function(){scheduler.attachEvent("onXScaleClick",function(e,t,i){"MonthlyView"===scheduler._mode&&scheduler.setCurrentView(t,"ZoomLevel3")}),scheduler.templates.MonthlyView_scalex_class=function(e){return"monthlyXScale"},scheduler.templates.MonthlyView_cell_value=function(t,i){var n=i.key;i.name;if(!contractorSupport||!i.contractor){if(i.children){var r=m(i.children,t);return D[i.key]||(D[i.key]={}),D[i.key][d(t)]=r,S(r,i.key,i.name,d(t))}if(k[n]&&k[i.key][d(t)]){var s=0,a=k[n][d(t)],o=C;if(e.resourceToWorkingDates[n]&&(o=e.resourceToWorkingDates[n][d(t)]||C),A.services&&(s+=a.service),A.breaks&&(s+=a["break"]),A.na){var c=a.na;a.na>o.regular&&(c=o.regular),s+=c}if(A.travel&&(s+=a.travel),0===s)return;var l=void 0,u=void 0,v=A.overtime?o.regular+o.overtime:o.regular;if(v>0){u=s/v,u=Math.round(100*u);var p="";return a.travel/v>monthlyViewSettings.highTravel/100&&(p='<svg aria-hidden="true" class="tooMuchTravel slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg>'),l="",l=u<=monthlyViewSettings.high?"rgba(125, 195, 125, "+u/100+")":u>monthlyViewSettings.high&&u<=monthlyViewSettings.critical?"rgba(242, 207, 91, "+(.11+u/100*.65)+")":"rgba(239, 110, 100, "+(.11+u/100*.65)+")","<div onclick=\"createMonthlyTooltip(event, '"+n+"', '"+d(t)+'\')" style="background: '+l+'">'+p+'<div class="monthlyViewHoursContainer">'+u+"%</div></div>"}return l="rgba(239, 110, 100, 1)","<div onclick=\"createMonthlyTooltip(event, '"+n+"', '"+d(t)+'\')" style="background: '+l+'"><div class="monthlyViewHoursContainer"><i class="fa fa-ban" /></div></div>'}}}}),window.createLocationMonthlyTooltip=function(e,t,i,n){$("#MonthlyLocationViewTooltip").remove(),$("#MonthlyViewTooltip").remove();var r=D[t][n],s="";s=w(r,s,{regular:r.capacity,overtime:r.overtime});var a=n.split("_");a=new Date(a[2],a[1],a[0],0,0,0,0),a=moment(a).format("ll");var o=window.innerHeight,c=window.innerWidth,l=e.clientX+340<=c?e.clientX:e.clientX-340;$('<div id="MonthlyLocationViewTooltip">\n                    <h1>'+_.escape(i)+" - "+_.escape(a)+'</h1>\n                    <div id="CapacityIconsContainer">'+s+"</div>\n               </div>").css("left",l+"px").css("top",e.clientY+5+"px").appendTo("body");var u=$("#MonthlyViewTooltip"),d=u.height();d+e.clientY>o&&u.css("top",e.clientY-d-20+"px")},window.removeMonthlyLocationTooltip=function(){$("#MonthlyLocationViewTooltip").remove()},window.createMonthlyTooltip=function(t,i,n){t.stopPropagation(),$("#MonthlyViewTooltip").remove(),$("#MonthlyLocationViewTooltip").remove();var r=a.getResources()[i.split("_")[0]].name,s=k[i][n],o="",c=C;e.resourceToWorkingDates[i]&&e.resourceToWorkingDates[i][n]&&(c=e.resourceToWorkingDates[i][n]),o=w(s,o,c);var l=s.events.sort(function(e,t){return scheduler._events[e].start_date.getTime()>scheduler._events[t].start_date.getTime()?-1:scheduler._events[e].start_date.getTime()<scheduler._events[t].start_date.getTime()?1:0}).map(function(e){var t="",i="";if(scheduler._events[e]&&"service"===scheduler._events[e].type){var n=flaggedServices[e]?customLabels.Unflag:customLabels.Flag;t="__monthlyViewFunctions.service('"+e+"')",i="<div onclick=\"__monthlyViewFunctions.flag(event, '"+e+'\')" class="monthlyViewFlag">'+n+"</div>"}else t="__monthlyViewFunctions.absence('"+e+"')";var r=" ";r+=scheduler._events[e]&&scheduler._events[e].jeopardy?"monthlyView_JeopardyTooltip":"",r+=scheduler._events[e]&&scheduler._events[e].violations&&!scheduler._events[e].jeopardy?"monthlyView_ViolationsTooltip":"";var s="";scheduler._events[e]&&"break"!==scheduler._events[e].type&&(s=Math.floor((scheduler._events[e].travelTo+scheduler._events[e].travelFrom)/60),s=""+y(b(s)),s='<svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.travel+'"></use></svg> '+s);var a=Math.floor((scheduler._events[e].finish-scheduler._events[e].start)/1e3/60);a=""+y(b(a)),a='<svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.clock+'"></use></svg> '+a;var o=""===s?"mytooltip_breakfix":"";return'\n                        <div class="'+r+' monthlyView_TooltipEventRow" title="'+T(scheduler._events[e])+'">\n                            <div class="monthlyView_EventName" onclick="'+t+'">'+scheduler._events[e].name+'</div>\n                            <div class="monthlyView_EventDate"><span class="mytooltip_duration '+o+'">'+a+'</span><span class="mytooltip_travel">'+s+"</span>"+i+"</div>\n                        </div>"}),u=n.split("_");u=new Date(u[2],u[1],u[0],0,0,0,0),u=moment(u).format("ll");var d=window.innerHeight,v=window.innerWidth,p=t.clientX+340<=v?t.clientX:t.clientX-340;$('<div id="MonthlyViewTooltip">\n                    <h1>\n                        '+_.escape(r)+" - "+u+'\n                        <svg aria-hidden="true" class="slds-icon"><use xlink:href="'+lsdIcons.close+'"></use></svg>\n                    </h1>\n                    <div id="CapacityIconsContainer">'+o+'</div>\n                    <div id="MonthlyTooltipListContainer">'+l.join("")+"</div>\n               </div>").css("left",p+"px").css("top",t.clientY+5+"px").appendTo("body");var h=$("#MonthlyViewTooltip"),g=h.height();g+t.clientY>d&&h.css("top",t.clientY-g-20+"px")},$("body").on("click",function(){$("#MonthlyViewTooltip").remove()}),window.__monthlyViewFunctions={service:function(e){n.open(e)},absence:function(e){i.open(e)},flag:function(e,i){e.currentTarget.innerHTML=e.currentTarget.innerHTML===customLabels.Flag?customLabels.Unflag:customLabels.Flag,e.stopPropagation(),t.$broadcast("flagService",i),t.$apply()}},{updateMonthlyCapacity:c,capacityCalculationFields:A,workingTimesByLocation:D,calculateLocation:m,calculateLocationUtilization:f,calculateDailyResourceCapacity:g,reset:L}}e.$inject=["calendarsService","$rootScope","AbsenceLightboxService","ServiceAppointmentLightboxService","TimePhasedDataService","utils","ResourcesAndTerritoriesService","userSettingsManager"],angular.module("serviceExpert").factory("monthlyViewHelperService",e)}(),function(){function e(){var e={fslOperationRemoteAction:null,getAsyncApexJobRemoteAction:null,apiVersion:"41.0",fieldNames:{Initiator:"Initiator__c",Request_Type:"Request_Type__c",ResultText:"ResultText__c"},autoConnect:!0};this.setConfig=function(t){return e=t},this.$get=function(i){return t(i,e)},this.$get.$inject=["$q"]}function t(e,t){function n(){$.cometd.addListener("/meta/handshake",function(e){if(e.successful){console.log("Handshake successful!");var t=new cometdReplayExtension;t.setChannel("/topic/MstCompletedChannel"),t.setReplay(d),$.cometd.registerExtension("myReplayExtensionName",t),$.cometd.subscribe("/topic/MstCompletedChannel",r)}else console.warn("Handshake! error: "+e.error)}),$.cometd.addListener("/meta/connect",function(e){e.successful||console.warn("disconnected! error: "+e.error)});$.cometd.init({url:window.location.protocol+"//"+window.location.hostname+(null!=window.location.port?":"+window.location.port:"")+"/cometd/"+t.apiVersion+"/",requestHeaders:{Authorization:"OAuth "+sessionId},maxBackoff:5e3,logLevel:"debug"})}function r(e){if("deleted"!==e.data.event.type){console.info("message from stream, type: "+e.data.event.type+", replayId: "+e.data.event.replayId+", fslOp: "+e.data.sobject.Id),d=e.data.event.replayId,u[e.data.sobject.Id]=e;var t=l[e.data.sobject.Id];t&&t.deferred.resolve(e)}}function s(e){var t=e.ResourceIDToScheduleData;for(var i in t)t[i].SchedulingOptions.forEach(function(e){e.Interval.Start=moment(e.Interval.Start).valueOf(),e.Interval.Finish=moment(e.Interval.Finish).valueOf();for(var t in e.MSTOptions)e.MSTOptions[t].Interval.Start=moment(e.MSTOptions[t].Interval.Start).valueOf(),e.MSTOptions[t].Interval.Finish=moment(e.MSTOptions[t].Interval.Finish).valueOf()})}function a(e){e.forEach(function(e){e.Interval.Start=moment(e.Interval.Start).valueOf(),e.Interval.Finish=moment(e.Interval.Finish).valueOf()})}function o(n){l[n]={time:(new Date).getTime(),deferred:e.defer(),mstPromise:e.defer(),asyncMethodCheckerTimeout:null,gotReply:!1};var r=l[n];return l[n].deferred.promise.then(function(e){t.fslOperationRemoteAction&&Visualforce.remoting.Manager.invokeAction(t.fslOperationRemoteAction,r.time,e.data.sobject.Id,function(e,i){i.status&&!e.fslOperation.fslOperation[t.fieldNames.ResultText]?(e.fslOperation.result=JSON.parse(e.fslOperation.result),"Get Candidates"===e.fslOperation.fslOperation[t.fieldNames.Request_Type]&&s(e.fslOperation.result),"Appointment Booking"===e.fslOperation.fslOperation[t.fieldNames.Request_Type]&&a(e.fslOperation.result.Slots),r.mstPromise.resolve(e)):e&&e.fslOperation&&e.fslOperation.fslOperation?r.mstPromise.reject(e.fslOperation.fslOperation[t.fieldNames.ResultText]):r.mstPromise.reject(i),r.gotReply=!0},{buffer:!1,escape:!1,timeout:12e4})}),u[n]&&(r.deferred.resolve(u[n]),delete u[n]),l[n].asyncMethodCheckerTimeout=setInterval(function(){c(n)},i),l[n].mstPromise.promise}function c(e){var i=l[e];Visualforce.remoting.Manager.invokeAction(t.getAsyncApexJobRemoteAction,e,function(e,t){return console.log(e),e?(("Aborted"===e.Status||"Failed"===e.Status)&&(i.gotReply||i.mstPromise.reject({message:e.ExtendedStatus}),clearInterval(i.asyncMethodCheckerTimeout)),void("Completed"===e.Status&&clearInterval(i.asyncMethodCheckerTimeout))):void clearInterval(i.asyncMethodCheckerTimeout)})}var l={},u={},d=-1;return function(){try{t.autoConnect&&n()}catch(e){console.log(e)}}(),{getUpdates:o,connectToPush:n,handleCometdConnection:r}}var i=7500;angular.module("MstResolver",[]).provider("MstResolver",e)}(),GanttService.prototype.setSchedulerProperties=function(){var e=void 0,t=void 0,i=void 0,n=void 0,r=void 0,s=void 0,a=void 0,o=void 0;this.schedStartTime&&(e=60*new Date(this.schedStartTime).getTimezoneOffset()*1e3),this.schedEndTime&&(t=60*new Date(this.schedEndTime).getTimezoneOffset()*1e3),this.dueDate&&(s=60*new Date(this.dueDate).getTimezoneOffset()*1e3),this.earliestStartTime&&(r=60*new Date(this.earliestStartTime).getTimezoneOffset()*1e3),this.arrivalWindowStartTime&&(a=60*new Date(this.arrivalWindowStartTime).getTimezoneOffset()*1e3),this.arrivalWindowEndTime&&(o=60*new Date(this.arrivalWindowEndTime).getTimezoneOffset()*1e3),this.actualStartTime&&(i=60*new Date(this.actualStartTime).getTimezoneOffset()*1e3),this.actualEndTime&&(n=60*new Date(this.actualEndTime).getTimezoneOffset()*1e3),this.text=this.ganttLabel?this.ganttLabel:this.name,this.start=this.schedStartTime?new Date(this.schedStartTime+e):null,this.finish=this.schedEndTime?new Date(this.schedEndTime+t):null,this.dueDate=this.dueDate?new Date(this.dueDate+s):null,this.earlyStart=this.earliestStartTime?new Date(this.earliestStartTime+r):null,this.appStart=this.arrivalWindowStartTime?new Date(this.arrivalWindowStartTime+a):null,this.appEnd=this.arrivalWindowEndTime?new Date(this.arrivalWindowEndTime+o):null,this.actualStartTime=this.actualStartTime?new Date(this.actualStartTime+i):null,this.actualEndTime=this.actualEndTime?new Date(this.actualEndTime+n):null,this.type="service",this.travelTo=this.travelTimeTo?60*parseInt(this.travelTimeTo):0,this.travelFrom=this.travelTimeFrom?60*parseInt(this.travelTimeFrom):0,this.estDuration=this.estDuration?parseFloat(this.estDuration):null},GanttService.prototype.setGanttResource=function(e,t){if(this.isScheduled()){var i=e[this.resource],n=[],r=void 0,s=void 0;this.resourceId=null,this.schedStartTime&&(r=60*new Date(this.schedStartTime).getTimezoneOffset()*1e3),this.schedEndTime&&(s=60*new Date(this.schedEndTime).getTimezoneOffset()*1e3),this.start_date=this.schedStartTime?new Date(this.schedStartTime+r):null,this.end_date=this.schedEndTime?new Date(this.schedEndTime+s):null;for(var a in i){var o=i[a];"R"===o.serviceTerritoryType&&(isIntersect(o.effectiveStartDate,o.effectiveEndDate,this.start_date,this.end_date)||!o.effectiveEndDate&&o.effectiveStartDate<this.end_date)&&n.push(o.serviceTerritory)}if(0===n.length)for(var c in i){var l=i[c];isIntersect(l.effectiveStartDate,l.effectiveEndDate,this.start_date,this.start_date)&&n.push(l.serviceTerritory)}else if(showSecondarySTMs)for(var u in i){var d=i[u];"S"===d.serviceTerritoryType&&isIntersect(d.effectiveStartDate,d.effectiveEndDate,this.start_date,this.end_date)&&n.push(d.serviceTerritory)}this.resourceId=t(this.resource,n),this.isScheduled()&&this.updateDatesBasedOnTravel()}},GanttService.prototype.updateDatesBasedOnTravel=function(){this.resourceId&&(this.travelFrom&&(this.travelFrom<=maxTravelTimeInSeconds?this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60)):(this.hiddenTravelFrom={hiddenMinutes:this.end_date.getMinutes()+Math.floor(this.travelFrom/60),hiddenTravel:this.travelFrom},this.travelFrom=maxTravelTimeInSeconds,this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60)))),this.travelTo&&(this.travelTo<=maxTravelTimeInSeconds?this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60)):(this.hiddenTravelTo={hiddenMinutes:this.start_date.getMinutes()-Math.floor(this.travelTo/60),hiddenTravel:this.travelTo},this.travelTo=maxTravelTimeInSeconds,this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60)))))},GanttService.prototype.isScheduled=function(){return this.resource&&this.schedEndTime&&this.schedStartTime},GanttService.prototype.getGanttResource=function(e){return e&&getGanttResourceWithSecondaryStms(this),this.resourceId?this.resourceId.substr(0,18):this.resourceId},GanttService.prototype.getGanttTerritory=function(){return this.resourceId?this.resourceId.substr(19,37):this.resourceId},GanttService.prototype.isChanged=function(e){return this.AssignedResourceLastModifiedDate!=e.AssignedResourceLastModifiedDate||this.ServiceAppointmentLastModifiedDate!=e.ServiceAppointmentLastModifiedDate},GanttService.prototype.isChainChanged=function(e){return this.isServiceInChain!=e.isServiceInChain||this.relatedService1!=e.relatedService1||this.relatedService2!=e.relatedService2},GanttService.prototype.minPriority=1e6,GanttService.copy=function(e){var t=new GanttService(null,!0);return angular.merge(t,e),t},GanttService.prototype.calculateMdtTimes=function(e){try{this.mdtTimes=JSON.parse(e);var t=1e3*(new Date).getTimezoneOffset()*60,i={travel:[],working:[]};this.mdtTimes.forEach(function(e){var n=moment.tz(e.Start,userTimeZone),r=moment.tz(e.Finish,userTimeZone);n=new Date(n.valueOf()-60*n._offset*1e3+t),r=new Date(r.valueOf()-60*r._offset*1e3+t),e.Start=n,e.Finish=r,"OperationalSlot"===e.Type?i.working.push(e):"Travel"===e.Type&&i.travel.push(e)}),this.mdtTimes=i}catch(n){this.mdtTimes={travel:[],working:[]}}},function(e){
var t={Sunday:0,Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6};e.TimeSlot=function(e){this.startHour=Math.floor(e[fieldNames.TimeSlot.StartTime]/1e3/60/60),this.startMinute=Math.ceil(e[fieldNames.TimeSlot.StartTime]/1e3/60/60%1*60),this.endHour=Math.floor(e[fieldNames.TimeSlot.EndTime]/1e3/60/60),this.endMinute=Math.ceil(e[fieldNames.TimeSlot.EndTime]/1e3/60/60%1*60),this.type=e[fieldNames.TimeSlot.Type],0==this.endHour&&(this.endHour=24)},e.OperatingHours=function(e){this.id=e.Id,this.name=e.Name,this.timezone=e[fieldNames.OperatingHours.Timezone],this.slots={};var i=e[fieldNames.OperatingHours.Time_Slots__r];i||(i=[]);for(var n=0;n<i.length;n++){var r=i[n],s=r[fieldNames.TimeSlot.DayOfWeek];s=t[s];var a=this.slots[s];a||(a=[],this.slots[s]=a),a.push(new TimeSlot(r))}}}(window),ResourceAbsence.prototype.setSchedulerProperties=function(){var e=void 0,t=void 0;this.start&&(e=60*new Date(this.start).getTimezoneOffset()*1e3),this.end&&(t=60*new Date(this.end).getTimezoneOffset()*1e3),this.start=new Date(this.start+e),this.finish=new Date(this.end+t),this.end=new Date(this.end+t)},ResourceAbsence.prototype.setGanttResource=function(e,t){var i=e[this.resource],n=[];if(this.resourceId=null,this.isScheduled()){this.start_date=this.start?new Date(this.start.getTime()):null,this.end_date=this.finish?new Date(this.finish.getTime()):null;for(var r in i){var s=i[r];"R"===s.serviceTerritoryType&&(isIntersect(s.effectiveStartDate,s.effectiveEndDate,this.start_date,this.end_date)||!s.effectiveEndDate&&s.effectiveStartDate<this.end_date)&&(n.includes(s.serviceTerritory)||n.push(s.serviceTerritory))}if(0===n.length)for(var a in i){var o=i[a];(isIntersect(o.effectiveStartDate,o.effectiveEndDate,this.start_date,this.end_date)||!o.effectiveEndDate&&o.effectiveStartDate<this.end_date)&&(n.includes(o.serviceTerritory)||n.push(o.serviceTerritory))}else if(showSecondarySTMs)for(var c in i){var l=i[c];"S"===l.serviceTerritoryType&&(isIntersect(l.effectiveStartDate,l.effectiveEndDate,this.start_date,this.end_date)||!l.effectiveEndDate&&l.effectiveStartDate<this.end_date)&&(n.includes(l.serviceTerritory)||n.push(l.serviceTerritory))}this.resourceId=t(this.resource,n),this.isScheduled()&&this.updateDatesBasedOnTravel()}},ResourceAbsence.prototype.updateDatesBasedOnTravel=function(){this.resourceId&&(this.travelFrom&&(this.travelFrom<=maxTravelTimeInSeconds?this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60)):(this.hiddenTravelFrom={hiddenMinutes:this.end_date.getMinutes()+Math.floor(this.travelFrom/60),hiddenTravel:this.travelFrom},this.travelFrom=maxTravelTimeInSeconds,this.end_date.setMinutes(this.end_date.getMinutes()+Math.floor(this.travelFrom/60)))),this.travelTo&&(this.travelTo<=maxTravelTimeInSeconds?this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60)):(this.hiddenTravelTo={hiddenMinutes:this.start_date.getMinutes()-Math.floor(this.travelTo/60),hiddenTravel:this.travelTo},this.travelTo=maxTravelTimeInSeconds,this.start_date.setMinutes(this.start_date.getMinutes()-Math.floor(this.travelTo/60)))))},ResourceAbsence.prototype.isScheduled=function(){return!!this.resource},ResourceAbsence.prototype.getGanttResource=function(){return this.resourceId?this.resourceId.substr(0,18):this.resourceId},ResourceCapacity.prototype.setSchedulerProperties=function(){var e=void 0,t=void 0;switch(this.start&&(e=60*new Date(this.start).getTimezoneOffset()*1e3),this.end&&(t=60*new Date(this.end).getTimezoneOffset()*1e3),this.start_date=this.start?new Date(this.start+e):null,this.end_date=this.end?new Date(this.end+t):null,this.timePeriod){case"Day":this.end_date=addDaysToDate(this.start_date,1);break;case"Week":this.end_date=addDaysToDate(this.start_date,7);break;case"Month":this.end_date=addDaysToDate(this.end_date,1)}this.hoursPerTimePeriod>0?this.text="<b>"+customLabels.booked.replaceAll(calcCapacityPercentage(this.hoursInUse,this.hoursPerTimePeriod)+"%")+"</b> (<b>"+customLabels.x_Hours_scheduled_out_of_y.replaceAll(this.hoursInUse,this.hoursPerTimePeriod)+"</b>)":this.workItemsPerTimePeriod>0&&(this.text="<b>"+customLabels.booked.replaceAll(calcCapacityPercentage(this.workItemsAllocated,this.workItemsPerTimePeriod)+"%")+"</b> (<b>"+customLabels.NumServicesScheduled.replaceAll(this.workItemsAllocated,this.workItemsPerTimePeriod)+"</b>)"),this.type="contractorcapacity"},ResourceCapacity.prototype.setGanttResource=function(e,t){var i=e[this.resource],n=[];for(var r in i){var s=i[r];(isIntersect(s.effectiveStartDate,s.effectiveEndDate,this.start_date,this.end_date)||!s.effectiveEndDate&&s.effectiveStartDate<this.end_date)&&n.push(s.serviceTerritory)}this.resourceId=t(this.resource,n)},ResourceCapacity.prototype.isScheduled=function(){return!!this.resource},ResourceCapacity.prototype.getGanttResource=function(){return this.resourceId?this.resourceId.substr(0,18):this.resourceId};var bootstrap={};bootstrap.loadUserSettings=function(){Visualforce.remoting.Manager.invokeAction(RemoteActions.IsUserSettingExist,function(e,t){t.status?0==t.result?Visualforce.remoting.Manager.invokeAction(RemoteActions.CreateNewUserSettingsLocStorage,localStorage.getItem(sfdcUser+"_serviceExpertLocations"),localStorage.getItem(sfdcUser+"_serviceExpertOrphan"),localStorage.getItem(sfdcUser+"_serviceExpertSettings"),localStorage.getItem(sfdcUser+"_serviceExpertFilters"),function(e,t){t.status&&(bootstrap.loadedUserSettings=JSON.parse(t.result),angular.bootstrap(document.getElementById("serviceExpertApp"),["serviceExpert"]))},{buffer:!1,escape:!1,timeout:12e4}):Visualforce.remoting.Manager.invokeAction(RemoteActions.GetCreateUserSettings,function(e,t){t.status?(bootstrap.loadedUserSettings=JSON.parse(t.result),angular.bootstrap(document.getElementById("serviceExpertApp"),["serviceExpert"])):bootstrap.handleError(t)},{buffer:!1,escape:!1,timeout:12e4}):bootstrap.handleError(t)},{buffer:!1,escape:!1,timeout:12e4})},bootstrap.Start=function(){bootstrap.UpdatePermissionSets()},bootstrap.UpdatePermissionSets=function(){Visualforce.remoting.Manager.invokeAction(RemoteActions.updatePermissionSets,function(e,t){if(null==e||void 0==e)bootstrap.loadUserSettings();else try{handleTabSettingAndRecordTypesPermissions(e).then(function(){bootstrap.loadUserSettings()})}catch(i){console.log(i),bootstrap.loadUserSettings()}})},bootstrap.UpdatePermissionSetsBootstrap=function(e,t){Visualforce.remoting.Manager.invokeAction(sharedRemoteActions.updatePermissionSets,function(i,n){if(null==i||void 0==i)angular.bootstrap(document.getElementById(e),[t]);else try{handleTabSettingAndRecordTypesPermissions(i).then(function(){angular.bootstrap(document.getElementById(e),[t])})}catch(r){console.log(r),angular.bootstrap(document.getElementById(e),[t])}})},bootstrap.handleError=function(e){var t={no_dispatcher_license_found:!0,Apex_CPU_time_limit_exceeded:!0},i=!1;for(var n in t)customLabels[n]==e.message&&(i=!0);cantLoadGantt(-1!=e.message.toLowerCase().indexOf("dml")?customLabels.no_dispatcher_permissions_found.replace("{0}",'<a href="vf066_settings#page=0&tab=1" target="_blank">').replace("{1}","</a>"):i?e.message:customLabels.dispatcher_console_error_loading+'<div class="otherMessage">'+e.message+"</div>")},function(){moment.defineLocale("en_NZ",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY LT",LLLL:"dddd, D MMMM YYYY LT"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},ordinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(e){var t=e%10,i=1===~~(e%100/10)?"th":1===t?"st":2===t?"nd":3===t?"rd":"th";return e+i},week:{dow:1,doy:4}})}();var globalStatuses={},globalCategories={},flaggedServices={},contextShown=!1,snapTo=!1,globalSelectedGanttServices={},capacityDurationFilter="Day",cachedDomElements={},violationDelimiter="&lt;br/&gt;",minHourToDisplay=0,maxHourToDisplay=24,includeWeekends=!1,gameOn=!1,ctrlPressed=!1,paletteViewActive=!1,showCandidates={on:!1,id:null},folderJustToggled=!1;$(function(){$("body").keydown(function(e){ctrlPressed=e.ctrlKey,updateTimesToSnapIn()}).keyup(function(e){ctrlPressed=!1,updateTimesToSnapIn()})}),$(function(){moment.locale(userLocale)}),$(function(){svg4everybody(),"function"==typeof srcUp&&$("body").css("margin","0")});var formatDateByLocaleWithDayOfTheWeek=function(e){var t=utils.formatDateWithDayOfWeek(e);if(t)return t;var i=["en_US"];return-1!=i.indexOf(userLocale)?moment(e).format("ddd, MMM D YYYY"):moment(e).format("LL")};scheduler.attachEvent("onSchedulerReady",function(){scheduler.templates.ZoomLevel1_second_scale_date=function(e){return formatDateByLocaleWithDayOfTheWeek(e)},scheduler.templates.MonthlyView_second_scale_date=function(e){return moment(e).format("MMM")},scheduler.templates.MDTView_second_scale_date=scheduler.templates.MonthlyView_second_scale_date,scheduler.templates.ZoomLevel2_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel3_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel4_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel5_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel6_second_scale_date=scheduler.templates.ZoomLevel1_second_scale_date,scheduler.templates.ZoomLevel2_date=function(e,t){return e.getDate()!==t.getDate()?formatDateByLocaleWithDayOfTheWeek(e)+" - "+formatDateByLocaleWithDayOfTheWeek(t):formatDateByLocaleWithDayOfTheWeek(e)},scheduler.templates.ZoomLevel3_date=function(e,t){return formatDateByLocaleWithDayOfTheWeek(e)},scheduler.templates.ZoomLevel4_date=function(e,t){var i=new Date(t);return i.setDate(i.getDate()-1),formatDateByLocaleWithDayOfTheWeek(e)+" - "+formatDateByLocaleWithDayOfTheWeek(i)},scheduler.templates.ZoomLevel5_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.ZoomLevel6_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.MonthlyView_date=scheduler.templates.ZoomLevel4_date,scheduler.templates.MDTView=scheduler.templates.ZoomLevel4_date}),$(function(){window.navigator.userAgent.indexOf("Edge")>-1&&(document.body.className+=" EdgeBrowser")});var BrickBreaker=function(){function e(){function e(e){var t=e.clientX-p.offsetLeft;t>0&&t<p.width&&(T=t-_/2)}function t(){h.beginPath(),h.arc(m,f,g,0,2*Math.PI),h.fillStyle="#0095DD",h.fill(),h.closePath()}function i(){h.beginPath(),h.rect(T,p.height-y,_,y),h.fillStyle="#0095DD",h.fill(),h.closePath()}function n(){for(var e=0;e<l.length;e++)if(0!=l[e].status){var t=l[e].left,i=l[e].top,n=l[e].width,r=l[e].height;h.beginPath(),h.rect(t,i,n,r),h.fillStyle=l[e].color,h.fill(),n>=40&&(h.font="10px Salesforce Sans",h.fillStyle="#000",h.fillText(l[e].name,t+5,i+10)),h.closePath()}}function r(){if(h.clearRect(0,0,p.width,p.height),n(),t(),i(),s(),o(),(m+S>p.width-g||g>m+S)&&(S=-S),g>f+b)b=-b;else if(f+b>p.height-g)if(m>T&&T+_>m)b=-b;else{if(k--,!k)return alert("GAME OVER - back to work"),void a();m=p.width/2,f=p.height-30,S=5,b=-5,T=(p.width-_)/2}w&&T<p.width-_?T+=7:L&&T>0&&(T-=7),m+=S,f+=b,requestAnimationFrame(r)}function s(){for(var e=0;e<l.length;e++){var t=l[e];if(1==t.status&&m>=t.left&&m<=t.left+t.width&&f>=t.top&&f<=t.top+t.height&&(b=-b,t.status=0,C+=10,C/10==l.length))return alert("You win, great... ¯\\_(ツ)_/¯. back to work"),void a()}}function a(){gameOn=!1,document.removeEventListener("mousemove",e),updateViewDebounced(),$("#bricks-overlay").remove()}function o(){h.font="16px Salesforce Sans",h.fillStyle="#0095DD",h.fillText("Score: "+C+", Lives: "+k,d/2,25)}function c(){for(var e={scheduled:"#F9D058","new":"#A5E2D6",dispatched:"#8DD8FA",inprogress:"#D68EF9",completed:"#95D055",incomplete:"#EA8288","default":"#B7C9EA"},t=[],i=scheduler.getEvents(scheduler.getState().min_date,scheduler.getState().max_date),n=0;n<i.length;n++){var r=i[n],s=void 0,a=void 0,o=$(scheduler.getRenderedEvent(r.id));o.visible()&&(a=$(o.children()[0]).width(),"service"==r.type?s=e[r.Status.toLowerCase().replace(" ","")]:"break"==r.type?(s="#5e698f",a=o.width()):"na"==r.type&&(s="#d7dfe7"),t.push({color:s,top:o.offset().top-264,left:o.offset().left-$("#LeftSideContainer").width()+8,width:a,height:scheduler.matrix.ZoomLevel3.event_dy-2,name:r.name,status:1}))}return t}var l=c();gameOn=!0,updateViewDebounced(),$("#GanttContainer").append('<div id="bricks-overlay" style="position:absolute; top:100px; z-index:100">\n                                            <canvas id="brick-canvas"></canvas>\n                                        </div>');var u=$(".dhx_cal_data"),d=u.width(),v=u.height(),p=document.getElementById("brick-canvas");p.width=d,p.height=v;var h=p.getContext("2d"),g=15,m=p.width/2,f=p.height-30,S=5,b=-5,y=15,_=95,T=($("body").width()-_)/2,w=!1,L=!1,C=0,k=3;$(".item").length>15?15:$(".item").length;return document.addEventListener("mousemove",e,!1),r(),"GAME ON!"}return $.fn.visible=function(e){var t=$(this),i=$(window),n=i.scrollTop(),r=n+i.height(),s=t.offset().top,a=s+t.height(),o=e===!0?a:s,c=e===!0?s:a;return r>=c&&o>=n},{play:e}}(),schedulerConfig=function(e){function t(){scheduler.createTimelineView({name:"ZoomLevel2",x_unit:"minute",x_date:p.dateFormat,x_step:30,x_size:16,x_start:0,x_length:6,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:p.resourceCellSize,second_scale:{x_unit:"day",x_date:p.dateTitleFormat},event_dy:p.eventHeight,dy:p.rowHeight,section_autoheight:!1,folder_dy:p.locationCellHeight,folder_events_available:!1,sort:p.sort})}function i(){scheduler.createTimelineView({name:"ZoomLevel3",x_unit:"minute",x_date:p.dateFormat,x_step:60,x_size:24,x_start:0,x_length:24,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:p.resourceCellSize,second_scale:{x_unit:"day",x_date:p.dateTitleFormat},event_dy:p.eventHeight,dy:p.rowHeight,section_autoheight:!1,folder_dy:p.locationCellHeight,folder_events_available:!1,sort:p.sort})}function n(){scheduler.createTimelineView({name:"ZoomLevel4",x_unit:"minute",x_date:p.dateFormat,x_step:120,x_size:24,x_start:0,x_length:12,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:p.resourceCellSize,second_scale:{x_unit:"day",x_date:p.dateTitleFormat},event_dy:p.eventHeight,dy:p.rowHeight,section_autoheight:!1,folder_dy:p.locationCellHeight,folder_events_available:!1,sort:p.sort})}function r(){scheduler.createTimelineView({name:"ZoomLevel5",x_unit:"minute",x_date:p.dateFormat,x_step:240,x_size:18,x_start:0,x_length:6,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:p.resourceCellSize,second_scale:{x_unit:"day",x_date:p.dateTitleFormat},event_dy:p.eventHeight,dy:p.rowHeight,section_autoheight:!1,folder_dy:p.locationCellHeight,folder_events_available:!1,sort:p.sort})}function s(){scheduler.createTimelineView({name:"ZoomLevel6",x_unit:"minute",x_date:p.dateFormat,x_step:360,x_size:28,x_start:0,x_length:4,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:p.resourceCellSize,second_scale:{x_unit:"day",x_date:p.dateTitleFormat},event_dy:p.eventHeight,dy:p.rowHeight,section_autoheight:!1,folder_dy:p.locationCellHeight,folder_events_available:!1,sort:p.sort})}function a(){scheduler.createTimelineView({name:"MonthlyView",x_unit:"day",x_date:"%d",x_step:1,x_size:14,x_start:0,x_length:1,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:p.resourceCellSize,second_scale:{x_unit:"month",x_date:"%M"},event_dy:p.eventHeight,dy:p.rowHeight,section_autoheight:!1,folder_dy:p.locationCellHeight,folder_events_available:!1,sort:p.sort})}function o(){scheduler.createTimelineView({name:"MTDView",x_unit:"day",x_date:"%d",x_step:1,x_size:35,x_start:0,x_length:1,y_unit:scheduler.serverList("resources",""),y_property:"resourceId",render:"tree",dx:p.resourceCellSize,second_scale:{x_unit:"month",x_date:"%M"},event_dy:p.eventHeight,dy:p.rowHeight,section_autoheight:!1,folder_dy:p.locationCellHeight,folder_events_available:!1,sort:p.sort})}function c(){t(),i(),n(),r(),s(),a(),o()}function l(){scheduler.config.drag_resize=!1,scheduler.config.multisection=!0,scheduler.config.multisection_shift_all=!1,scheduler.config.limit_drag_out=!1,scheduler.config.dblclick_create=!1,scheduler.config.mark_now=!1,scheduler.config.time_step=1,scheduler.dhtmlXTooltip.config.className="dhtmlXTooltip tooltip expertTooltip",scheduler.dhtmlXTooltip.config.timeout_to_display=375,scheduler.dhtmlXTooltip.config.delta_x=0,scheduler.dhtmlXTooltip.config.delta_y=0,scheduler.config.minicalendar.mark_events=!1,scheduler.config.preserve_length=!1}function u(e,t){var i=32;switch(e){case"xsmall":i=27;break;case"small":i=32;break;case"normal":i=39;break;case"large":i=46;break;default:i=39}if(scheduler.matrix.ZoomLevel3.dy!=i){for(var n in scheduler.matrix)scheduler.matrix[n].dy=i,scheduler.matrix[n].event_dy=i-4,scheduler.matrix[n].folder_dy=i+2;t&&scheduler._is_initialized()&&scheduler.setCurrentView()}}function d(e){scheduler.config.readonly=e}function v(e,t){var i=new Date(e.start_date),n=new Date(e.end_date),r=new Date(t.start_date),s=new Date(t.end_date);return"na"==e.type&&"na"!=t.type?(i>s||r>n)&&+i>+r?1:-1:"na"==t.type&&"na"!=e.type?r>n||i>s?+i>+r?1:-1:1:+i>+r?1:-1}var p={dateTitleFormat:"%D, %F %d",dateFormat:"%g:%i%A",resourceCellSize:170,locationCellHeight:44,rowHeight:46,eventHeight:42,sort:v};return{timelineConfigs:p,configTimelines:c,setRowHeights:u,setReadOnly:d,setConfigurations:l,sortEvents:v}}(schedulerConfig||{});scheduler.attachEvent("onSchedulerReady",function(){scheduler.templates.calendar_month=function(e){var t=["en_US","en_GB"];return-1!=t.indexOf(userLocale)?moment(e).format("MMMM YYYY"):moment(e).format("LL")},scheduler.templates.calendar_date=function(e){return moment(e).format("DD")},scheduler.templates.calendar_scale_date=function(e){return moment(e).format("ddd")},scheduler.templates.calendar_time=function(e){return moment(e).format("l")}});